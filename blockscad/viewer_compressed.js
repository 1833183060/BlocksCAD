// Do not edit this file; automatically generated by blockscad_build.py.
"use strict";
var OpenJsCad=OpenJsCad||{},CSG=CSG||{},CAG=CAG||{};OpenJsCad.log=function(e){var h=Date.now(),l=OpenJsCad.log.prevLogTime;l||(l=h);OpenJsCad.log.prevLogTime=h;e="["+(.001*(h-l)).toFixed(3)+"] "+e;if("object"==typeof console&&"function"==typeof console.log)console.log(e);else if("object"==typeof self&&"function"==typeof self.postMessage)self.postMessage({cmd:"log",txt:e});else throw Error("Cannot log");};
OpenJsCad.Viewer=function(e,h,l,n){var c=GL.create();this.gl=c;this.angleX=-60;this.angleY=0;this.angleZ=-45;this.viewpointX=0;this.viewpointY=-5;this.viewpointZ=n;this.touch={lastX:0,lastY:0,scale:0,ctrl:0,shiftTimer:null,shiftControl:null,cur:null};this.lineOverlay=this.drawLines=!1;c.canvas.width=h;c.canvas.height=l;c.viewport(0,0,h,l);c.matrixMode(c.PROJECTION);c.loadIdentity();c.perspective(45,h/l,.5,1E3);c.matrixMode(c.MODELVIEW);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);c.clearColor(.93,
.93,.93,1);c.enable(c.DEPTH_TEST);c.enable(c.CULL_FACE);c.polygonOffset(1,1);this.blackShader=new GL.Shader("void main() {gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;}","void main() {gl_FragColor = vec4(0.0, 0.0, 0.0, 0.1);}");this.lightingShader=new GL.Shader("varying vec3 color;varying float alpha;varying vec3 normal;varying vec3 light;void main() {const vec3 lightDir = vec3(1.0, 2.0, 3.0) / 3.741657386773941;light = lightDir;color = gl_Color.rgb;alpha = gl_Color.a;normal = gl_NormalMatrix * gl_Normal;gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;}",
"varying vec3 color;varying float alpha;varying vec3 normal;varying vec3 light;void main() {vec3 n = normalize(normal);float diffuse = max(0.0, dot(light, n));float specular = pow(max(0.0, -reflect(light, n).z), 10.0) * sqrt(diffuse);gl_FragColor = vec4(mix(color * (0.3 + 0.7 * diffuse), vec3(1.0), specular), alpha);}");var m=this,a=$('<div class="shift-scene"><div class="arrow arrow-left" /><div class="arrow arrow-right" /><div class="arrow arrow-top" /><div class="arrow arrow-bottom" /></div>');
this.touch.shiftControl=a;$(e).append(c.canvas).append(a).hammer({drag_lock_to_axis:!0}).on("transform",function(a){2<=a.gesture.touches.length&&(m.clearShift(),m.onTransform(a),a.preventDefault())}).on("touch",function(b){if("touch"!=b.gesture.pointerType)b.preventDefault();else if(1==b.gesture.touches.length){var d=b.gesture.center;m.touch.shiftTimer=setTimeout(function(){a.addClass("active").css({left:d.pageX+"px",top:d.pageY+"px"});m.touch.shiftTimer=null;m.touch.cur="shifting"},500)}else m.clearShift()}).on("drag",
function(a){if("touch"!=a.gesture.pointerType)a.preventDefault();else if(!m.touch.cur||"dragging"==m.touch.cur)m.clearShift(),m.onPanTilt(a);else if("shifting"==m.touch.cur)m.onShift(a)}).on("touchend",function(b){m.clearShift();m.touch.cur&&a.removeClass("active shift-horizontal shift-vertical")}).on("transformend dragstart dragend",function(a){if("transformend"==a.type&&"transforming"==m.touch.cur||"dragend"==a.type&&"shifting"==m.touch.cur||"dragend"==a.type&&"dragging"==m.touch.cur)m.touch.cur=
null;m.touch.lastX=0;m.touch.lastY=0;m.touch.scale=0});c.onmousemove=function(a){m.onMouseMove(a)};c.ondraw=function(){m.onDraw()};e.onresize=function(a){console.log("in container element resize");alert("canvas has been resized")};c.onmousewheel=function(a){var d=0;a.wheelDelta?d=a.wheelDelta:a.detail&&(d=-40*a.detail);d&&(a=Math.pow(1.003,-d),d=m.getZoom(),m.setZoom(d*a))};this.clear()};
OpenJsCad.Viewer.prototype={setCsg:function(e){this.meshes=OpenJsCad.Viewer.csgToMeshes(e);this.onDraw()},rendered_resize:function(e,h){this.gl.canvas.width=e;this.gl.canvas.height=h;this.gl.viewport(0,0,e,h);this.gl.matrixMode(this.gl.PROJECTION);this.gl.loadIdentity();this.gl.perspective(45,e/h,.5,1E3);this.gl.matrixMode(this.gl.MODELVIEW);this.onDraw()},viewReset:function(){var e=document.getElementById("viewMenu");"top"==e.value?(this.viewpointY=this.viewpointX=this.angleZ=this.angleY=this.angleX=
0,this.viewpointZ=100):"front"==e.value?(this.angleX=-90,this.viewpointY=this.viewpointX=this.angleZ=this.angleY=0,this.viewpointZ=100):"left"==e.value?(this.angleX=-90,this.angleY=0,this.angleZ=90,this.viewpointY=this.viewpointX=0,this.viewpointZ=100):"right"==e.value?(this.angleX=-90,this.angleY=0,this.angleZ=-90,this.viewpointY=this.viewpointX=0,this.viewpointZ=100):"bottom"==e.value?(this.angleX=180,this.viewpointY=this.viewpointX=this.angleZ=this.angleY=0,this.viewpointZ=100):"back"==e.value?
(this.angleX=-90,this.angleY=0,this.angleZ=180,this.viewpointY=this.viewpointX=0,this.viewpointZ=100):"diagonal"==e.value&&(this.angleX=-65,this.angleY=0,this.angleZ=-30,this.viewpointX=0,this.viewpointY=-5,this.viewpointZ=100);this.onDraw()},clear:function(){this.meshes=[];this.onDraw()},supported:function(){return!!this.gl},ZOOM_MAX:1E3,ZOOM_MIN:10,onZoomChanged:null,plate:!0,setZoom:function(e){e=Math.max(e,0);e=Math.min(e,1);this.viewpointZ=this.ZOOM_MIN+e*(this.ZOOM_MAX-this.ZOOM_MIN);if(this.onZoomChanged)this.onZoomChanged();
this.onDraw()},getZoom:function(){return(this.viewpointZ-this.ZOOM_MIN)/(this.ZOOM_MAX-this.ZOOM_MIN)},onMouseMove:function(e){if(e.dragging){var h=e.button;e.which&&(h=e.which);e.preventDefault();e.altKey||3==h?(this.angleY+=e.deltaX,this.angleX+=e.deltaY):e.shiftKey||2==h?(h=.005,this.viewpointX+=h*e.deltaX*this.viewpointZ,this.viewpointY-=h*e.deltaY*this.viewpointZ):e.ctrlKey?(h=Math.pow(1.006,e.deltaX+e.deltaY),e=this.getZoom(),this.setZoom(e*h)):(this.angleZ+=e.deltaX,this.angleX+=e.deltaY);
this.onDraw()}},clearShift:function(){this.touch.shiftTimer&&(clearTimeout(this.touch.shiftTimer),this.touch.shiftTimer=null);return this},onPanTilt:function(e){this.touch.cur="dragging";var h=0;!this.touch.lastY||"up"!=e.gesture.direction&&"down"!=e.gesture.direction?!this.touch.lastX||"left"!=e.gesture.direction&&"right"!=e.gesture.direction||(h=e.gesture.deltaX-this.touch.lastX,this.angleZ+=h):(h=e.gesture.deltaY-this.touch.lastY,this.angleX+=h);if(h)this.onDraw();this.touch.lastX=e.gesture.deltaX;
this.touch.lastY=e.gesture.deltaY},onShift:function(e){this.touch.cur="shifting";var h=0;!this.touch.lastY||"up"!=e.gesture.direction&&"down"!=e.gesture.direction||(this.touch.shiftControl.removeClass("shift-horizontal").addClass("shift-vertical").css("top",e.gesture.center.pageY+"px"),h=e.gesture.deltaY-this.touch.lastY,this.viewpointY-=.005*h*this.viewpointZ,this.angleX+=h);!this.touch.lastX||"left"!=e.gesture.direction&&"right"!=e.gesture.direction||(this.touch.shiftControl.removeClass("shift-vertical").addClass("shift-horizontal").css("left",
e.gesture.center.pageX+"px"),h=e.gesture.deltaX-this.touch.lastX,this.viewpointX+=.005*h*this.viewpointZ,this.angleZ+=h);if(h)this.onDraw();this.touch.lastX=e.gesture.deltaX;this.touch.lastY=e.gesture.deltaY},onTransform:function(e){this.touch.cur="transforming";if(this.touch.scale){var h=1/(1+e.gesture.scale-this.touch.scale),l=this.getZoom();this.setZoom(l*h)}this.touch.scale=e.gesture.scale;return this},onDraw:function(e){e=this.gl;e.makeCurrent();e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);
e.loadIdentity();e.translate(this.viewpointX,this.viewpointY,-this.viewpointZ);e.rotate(this.angleX,1,0,0);e.rotate(this.angleY,0,1,0);e.rotate(this.angleZ,0,0,1);e.enable(e.BLEND);this.lineOverlay||e.enable(e.POLYGON_OFFSET_FILL);for(var h=0;h<this.meshes.length;h++){var l=this.meshes[h];0<l.vertices.length&&this.lightingShader.draw(l,e.TRIANGLES)}this.lineOverlay||e.disable(e.POLYGON_OFFSET_FILL);e.disable(e.BLEND);if(this.drawLines){this.lineOverlay&&e.disable(e.DEPTH_TEST);e.enable(e.BLEND);for(h=
0;h<this.meshes.length;h++)l=this.meshes[h],0<l.vertices.length&&this.blackShader.draw(l,e.LINES);e.disable(e.BLEND);this.lineOverlay&&e.enable(e.DEPTH_TEST)}if(Blockscad.drawAxes){e.enable(e.BLEND);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);e.begin(e.LINES);if(this.plate){e.color(.8,.8,.8,.5);for(h=-100;100>=h;h++)h%10&&0!=h&&(e.vertex(-100,h,0),e.vertex(100,h,0),e.vertex(h,-100,0),e.vertex(h,100,0),e.vertex(-.5,0,h),e.vertex(.5,0,h),e.vertex(0,-.5,h),e.vertex(0,.5,h));e.color(.5,.5,.5,.5);for(h=
-100;100>=h;h+=10)0!=h&&(e.vertex(-100,h,0),e.vertex(100,h,0),e.vertex(h,-100,0),e.vertex(h,100,0),e.vertex(-1,0,h),e.vertex(1,0,h),e.vertex(0,-1,h),e.vertex(0,1,h))}e.color(1,.5,.5,1);e.vertex(-100,0,0);e.vertex(0,0,0);e.color(1,0,0,1);e.vertex(0,0,0);e.vertex(100,0,0);e.color(0,1,0,1);e.vertex(0,-100,0);e.vertex(0,0,0);e.color(0,.7,0,1);e.vertex(0,0,0);e.vertex(0,100,0);e.color(.4,.4,.7,1);e.vertex(0,0,-100);e.vertex(0,0,0);e.color(.1,.1,.3,1);e.vertex(0,0,0);e.vertex(0,0,100);e.color(0,0,0,1);
e.vertex(101,-1,0);e.vertex(103,1,0);e.vertex(101,1,0);e.vertex(103,-1,0);e.vertex(-1,104,0);e.vertex(0,103,0);e.vertex(0,103,0);e.vertex(1,104,0);e.vertex(0,101,0);e.vertex(0,103,0);e.vertex(-1,0,103);e.vertex(1,0,103);e.vertex(-1,0,101);e.vertex(1,0,101);e.vertex(-1,0,101);e.vertex(1,0,103);e.end();e.disable(e.BLEND)}}};
OpenJsCad.Viewer.csgToMeshes=function(e){var h=e.canonicalized();e=new GL.Mesh({normals:!0,colors:!0});for(var l=[e],n=[],c=[],m=[],h=h.toPolygons(),a=h.length,b=0;b<a;b++){var d=h[b],f=[1,.4,1,1];d.shared&&d.shared.color&&(f=d.shared.color);d.color&&(f=d.color);4>f.length&&f.push(1);for(var d=d.vertices.map(function(a){a.getTag();var b;b=n.length;n.push([a.pos.x,a.pos.y,a.pos.z]);c.push(f);return b}),k=2;k<d.length;k++)m.push([d[0],d[k-1],d[k]]);65E3<n.length&&(e.triangles=m,e.vertices=n,e.colors=
c,e.computeWireframe(),e.computeNormals(),e=new GL.Mesh({normals:!0,colors:!0}),m=[],c=[],n=[],l.push(e))}e.triangles=m;e.vertices=n;e.colors=c;e.computeWireframe();e.computeNormals();return l};OpenJsCad.makeAbsoluteUrl=function(e,h){if(!e.match(/^[a-z]+\:/i)){var l=h.split("/");0<l.length&&l.splice(l.length-1,1);var n=e.split("/"),c=[];l.concat(n).map(function(e){".."==e?0<c.length&&c.splice(c.length-1,1):c.push(e)});e="";for(l=0;l<c.length;l++)0<l&&(e+="/"),e+=c[l]}return e};
OpenJsCad.isChrome=function(){return 0<=navigator.userAgent.search("Chrome")};
OpenJsCad.runMainInWorker=function(e){try{if("function"!=typeof main)throw Error("Your jscad file should contain a function main() which returns a CSG solid or a CAG area.");OpenJsCad.log.prevLogTime=Date.now();var h=main(e);if("object"!=typeof h||!(h instanceof CSG||h instanceof CAG))throw Error("Nothing to Render");if(h.length){var l=h[0];l instanceof CAG&&(l=l.extrude({offset:[0,0,.1]}));for(e=1;e<h.length;e++){var n=h[e];n instanceof CAG&&(n=n.extrude({offset:[0,0,.1]}));l=l.unionForNonIntersecting(n)}h=
l}var c=h.toCompactBinary();self.postMessage({cmd:"rendered",result:c})}catch(m){self.postMessage({cmd:"error",err:m.toString()})}};
OpenJsCad.parseJsCadScriptSync=function(e,h,l){var n;n="//SYNC\n"+("_includePath = "+JSON.stringify(_includePath)+";\n");n+=e;l&&(n+="\n\n\n\n\n\n\n/* -------------------------------------------------------------------------\nOpenJsCad debugging\n\nAssuming you are running Chrome:\nF10 steps over an instruction\nF11 steps into an instruction\n",n+="F8  continues running\nPress the (||) button at the bottom to enable pausing whenever an error occurs\n",n+="Click on a line number to set or clear a breakpoint\n",
n+="For more information see: http://code.google.com/chrome/devtools/docs/overview.html\n\n",n+="------------------------------------------------------------------------- */\n",n+="\n\n// Now press F11 twice to enter your main() function:\n\n",n+="debugger;\n");n+="var me = "+JSON.stringify(me)+";\n";n+="return main("+JSON.stringify(h)+");";n+="function include(fn) {if(0) {_csg_libraries.push(fn);} else if(0) {var url = _includePath!=='undefined'?_includePath:'./';var index = url.indexOf('index.html');if(index!=-1) {url = url.substring(0,index);}importScripts(url+fn);} else {console.log('SYNC checking gMemFs for '+fn);if(gMemFs[fn]) {console.log('found locally & eval:',gMemFs[fn].name);eval(gMemFs[fn].source); return;}var xhr = new XMLHttpRequest();xhr.open('GET',_includePath+fn,false);console.log('include:'+_includePath+fn);xhr.onload = function() {var src = this.responseText;eval(src);};xhr.onerror = function() {};xhr.send();}}";
e=new Function(n);OpenJsCad.log.prevLogTime=Date.now();return e()};
OpenJsCad.parseJsCadScriptASync=function(e,h,l,n){var c=document.location.href.replace(/\?.*$/,""),m=c=c.replace(/#.*$/,"");null!=l.openJsCadPath&&(m=OpenJsCad.makeAbsoluteUrl(l.openJsCadPath,c));var a=[];null!=l.libraries&&(a=l.libraries);for(var b in gMemFs){l=gMemFs[b].source+"\nfunction include() { }\n";try{new Function(l)}catch(d){this.setError(b+": "+d.message)}}b="//ASYNC\n"+("var me = "+JSON.stringify(me)+";\n");b+="var _csg_baseurl="+JSON.stringify(c)+";\n";b+="var _includePath="+JSON.stringify(_includePath)+
";\n";b+="var gMemFs = [];\n";var c=!1,f,k;for(k in gMemFs){b+="// "+gMemFs[k].name+":\n";f||(f=k);if("main.jscad"==k||k.match(/\/main.jscad$/))f=k;b+='gMemFs["'+gMemFs[k].name+'"] = '+JSON.stringify(gMemFs[k].source)+";\n";c=!0}b=(c?b+("eval(gMemFs['"+f+"']);\n"):b+e)+"\n\n\n\n//// The following code is added by OpenJsCad + OpenJSCAD.org:\n";b+="var _csg_baselibraries="+JSON.stringify(["blockscad/viewer_compressed.js"])+";\n";b+="var _csg_libraries="+JSON.stringify(a)+";\n";b+="var _csg_openjscadurl="+
JSON.stringify(m)+";\n";b+="var _csg_makeAbsoluteURL="+OpenJsCad.makeAbsoluteUrl.toString()+";\n";b+="_csg_baselibraries = _csg_baselibraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_openjscadurl);});\n";b+="_csg_libraries = _csg_libraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_baseurl);});\n";b+="_csg_baselibraries.map(function(l){importScripts(l)});\n";b+="_csg_libraries.map(function(l){importScripts(l)});\n";b+="self.addEventListener('message', function(e) {if(e.data && e.data.cmd == 'render'){";
b+="  OpenJsCad.runMainInWorker("+JSON.stringify(h)+");";b+="}},false);\n";b=c?b+"function include(fn) { eval(gMemFs[fn]); }\n":b+"function include(fn) {if(0) {_csg_libraries.push(fn);} else if(1) {if(gMemFs[fn]) {eval(gMemFs[fn]); return;}var url = _csg_baseurl+_includePath;var index = url.indexOf('index.html');if(index!=-1) {url = url.substring(0,index);}importScripts(url+fn);} else {var xhr = new XMLHttpRequest();xhr.open('GET', _includePath+fn, true);xhr.onload = function() {return eval(this.responseText);};xhr.onerror = function() {};xhr.send();}}";
e=OpenJsCad.textToBlobUrl(b);if(!window.Worker)throw Error("Your browser doesn't support Web Workers. Please try the Chrome or Firefox browser instead.");e=new Worker(e);e.onmessage=function(a){if(a.data)if("rendered"==a.data.cmd){var b=a.data.result.class;if("CSG"==b)a=CSG.fromCompactBinary(a.data.result);else if("CAG"==b)a=CAG.fromCompactBinary(a.data.result);else throw Error("Cannot parse result");n(null,a)}else"error"==a.data.cmd?n(a.data.err,null):"log"==a.data.cmd&&console.log(a.data.txt)};
e.onerror=function(a){n("Error in line "+a.lineno+": "+a.message,null)};e.postMessage({cmd:"render"});return e};OpenJsCad.getWindowURL=function(){if(window.URL)return window.URL;if(window.webkitURL)return window.webkitURL;throw Error("Your browser doesn't support window.URL");};OpenJsCad.textToBlobUrl=function(e){var h=OpenJsCad.getWindowURL();e=new Blob([e]);h=h.createObjectURL(e);if(!h)throw Error("createObjectURL() failed");return h};
OpenJsCad.revokeBlobUrl=function(e){if(window.URL)window.URL.revokeObjectURL(e);else if(window.webkitURL)window.webkitURL.revokeObjectURL(e);else throw Error("Your browser doesn't support window.URL");};OpenJsCad.AlertUserOfUncaughtExceptions=function(){window.onerror=function(e,h,l){e=e.replace(/^Uncaught /i,"");alert(e+"\n\n("+h+" line "+l+")")}};
OpenJsCad.getParamDefinitions=function(e){var h=!0;e+="\nfunction include() {}";try{(new Function(e))()}catch(l){h=!1}var n=[];if(h&&(n=(new Function("if(typeof(getParameterDefinitions) == 'function') {return getParameterDefinitions();} else {return [];} "+e))(),"object"!=typeof n||"number"!=typeof n.length))throw Error("The getParameterDefinitions() function should return an array with the parameter definitions");return n};
OpenJsCad.Processor=function(e,h){this.containerdiv=e;this.onchange=h;this.zoomControl=this.viewer=this.viewerdiv=null;this.initialViewerDistance=100;this.processing=!1;this.currentObject=null;this.hasOutputFile=this.hasValidCurrentObject=!1;this.worker=null;this.paramDefinitions=[];this.paramControls=[];this.script=null;this.debugging=this.hasError=!1;this.options={};this.createElements()};
OpenJsCad.Processor.convertToSolid=function(e){if("object"==typeof e&&e instanceof CAG)e=e.extrude({offset:[0,0,.1]});else if(!("object"==typeof e&&e instanceof CSG))if(e.length){console.log("putting them together");for(var h=e[0],l=1;l<e.length;l++)h=h.unionForNonIntersecting(e[l]);e=h}else throw Error("Cannot convert to solid");return e};
OpenJsCad.Processor.prototype={createElements:function(){for(var e=this;5<this.containerdiv.children.length;)this.containerdiv.removeChild(5);var h=document.createElement("div");h.className="viewer";h.style.width="100%";h.style.height="100%";h.style.top="0px";h.style.position="absolute";h.style.zIndex="1";h.style.backgroundColor="rgb(200,200,200)";this.containerdiv.appendChild(h);this.viewerdiv=h;try{this.viewer=new OpenJsCad.Viewer(this.viewerdiv,h.offsetWidth,h.offsetHeight,this.initialViewerDistance)}catch(l){this.viewerdiv.innerHTML=
"<b><br><br>Error: "+l.toString()+"</b><br><br>OpenJsCad currently requires Google Chrome or Firefox with WebGL enabled"}this.abortbutton=document.getElementById("abortButton");this.renderbutton=document.getElementById("renderButton");this.ongoingrender=document.getElementById("render-ongoing");this.abortbutton.onclick=function(h){e.abort();$("#renderButton").prop("disabled",!1)};this.formatDropdown=document.getElementById("render-type");this.formatDropdown.onchange=function(h){e.currentFormat=e.formatDropdown.options[e.formatDropdown.selectedIndex].value;
e.updateDownloadLink()};this.generateOutputFileButton=document.getElementById("stlButton");this.generateOutputFileButton.onclick=function(h){e.generateOutputFile()};this.enableItems();this.clearViewer()},setCurrentObject:function(e){this.currentObject=e;if(this.viewer){var h=OpenJsCad.Processor.convertToSolid(e);this.viewer.setCsg(h);e.length&&(this.currentObject=h)}this.hasValidCurrentObject=!0;for($("#stl_buttons").show();0<this.formatDropdown.options.length;)this.formatDropdown.options.remove(0);
var l=this;this.supportedFormatsForCurrentObject().forEach(function(e){var c=document.createElement("option");c.setAttribute("value",e);c.appendChild(document.createTextNode(l.formatInfo(e).displayName));l.formatDropdown.options.add(c)});this.updateDownloadLink()},selectedFormat:function(){return this.formatDropdown.options[this.formatDropdown.selectedIndex].value},selectedFormatInfo:function(){return this.formatInfo(this.selectedFormat())},updateDownloadLink:function(){var e=this.selectedFormatInfo().extension;
this.generateOutputFileButton.innerHTML="Generate "+e.toUpperCase()},clearViewer:function(){this.clearOutputFile();this.setCurrentObject(new CSG);this.hasValidCurrentObject=!1;$("#stl_buttons").hide();this.enableItems()},abort:function(){if(this.processing&&(this.processing=!1,this.worker.terminate(),this.enableItems(),this.onchange))this.onchange()},enableItems:function(){this.abortbutton.style.display=this.processing?"block":"none";this.renderbutton.style.display=this.processing?"none":"block";
this.ongoingrender.style.display=this.processing?"block":"none"},setOpenJsCadPath:function(e){this.options.openJsCadPath=e},addLibrary:function(e){null==this.options.libraries&&(this.options.libraries=[]);this.options.libraries.push(e)},setError:function(e){this.hasError=""!=e;$("#error-message").text(e);this.enableItems()},setDebugging:function(e){this.debugging=e},setJsCad:function(e,h){h||(h="openjscad.jscad");h=h.replace(/\.jscad$/i,"");this.abort();this.clearViewer();this.script=null;this.setError("");
this.script=e;this.filename=h;this.rebuildSolid()},getParamValues:function(){return{}},rebuildSolid:function(){this.abort();this.setError("");this.clearViewer();this.processing=!0;$("#renderButton").html("Render");this.enableItems();var e=this,h=this.getParamValues(),l=this.debugging;if(!l)try{this.worker=OpenJsCad.parseJsCadScriptASync(this.script,h,this.options,function(a,b){e.processing=!1;e.worker=null;a?e.setError(a):e.setCurrentObject(b);if(e.onchange)e.onchange();e.enableItems()})}catch(n){console.log("async failed, try sync compute, error: "+
n.message),l=!0}if(l){try{var c=OpenJsCad.parseJsCadScriptSync(this.script,h,this.debugging);e.setCurrentObject(c);e.processing=!1}catch(m){e.processing=!1,(h=m.stack)||(h=m.toString()),e.setError(h)}e.enableItems();if(e.onchange)e.onchange()}},hasSolid:function(){return this.hasValidCurrentObject},isProcessing:function(){return this.processing},clearOutputFile:function(){if(this.hasOutputFile&&(this.outputFileBlobUrl&&(OpenJsCad.revokeBlobUrl(this.outputFileBlobUrl),this.outputFileBlobUrl=null),
this.enableItems(),this.onchange))this.onchange()},generateOutputFile:function(){this.clearOutputFile();this.hasValidCurrentObject&&this.generateAndSaveRenderedFile()},currentObjectToBlob:function(){var e=this.selectedFormat(),h;if("stla"==e)h=this.currentObject.toStlString(),h=new Blob([h],{type:this.formatInfo(e).mimetype});else if("stlb"==e)h=this.currentObject.toStlBinary({webBlob:!0});else if("amf"==e)h=this.currentObject.toAMFString({producer:"OpenJSCAD.org "+version,date:new Date}),h=new Blob([h],
{type:this.formatInfo(e).mimetype});else if("x3d"==e)h=this.currentObject.fixTJunctions().toX3D();else if("dxf"==e)h=this.currentObject.toDxf();else throw Error("Not supported");return h},supportedFormatsForCurrentObject:function(){if(this.currentObject instanceof CSG)return["stlb","stla","amf","x3d"];if(this.currentObject instanceof CAG)return["dxf"];throw Error("Not supported");},formatInfo:function(e){return{stla:{displayName:"STL (ASCII)",extension:"stl",mimetype:"application/sla"},stlb:{displayName:"STL (Binary)",
extension:"stl",mimetype:"application/sla"},amf:{displayName:"AMF",extension:"amf",mimetype:"application/amf+xml"},x3d:{displayName:"X3D",extension:"x3d",mimetype:"model/x3d+xml"},dxf:{displayName:"DXF",extension:"dxf",mimetype:"application/dxf"}}[e]},generateAndSaveRenderedFile:function(){var e=this.currentObjectToBlob(),h=this.selectedFormatInfo().extension,l=$("#project-name").val();l?saveAs(e,l+"."+h):alert("Could not save generated ",this.selectedFormatInfo().displayName," file.  Please give your project a name, then try again.")}};(function(e){function h(a,b){return a-b}function l(a,b,d){for(var c=0,k=a.length;k>c;){var g=Math.floor((c+k)/2);0<d(b,a[g])?c=g+1:k=g}a.splice(c,0,b)}function n(a,b){return a.index-b.index}var c=function(){this.polygons=[];this.properties=new c.Properties;this.isRetesselated=this.isCanonicalized=!0};c.defaultResolution2D=32;c.defaultResolution3D=12;c.fromPolygons=function(a){var b=new c;b.polygons=a;b.isCanonicalized=!1;b.isRetesselated=!1;return b};c.fromSlices=function(a){return(new c.Polygon.createFromPoints([[0,
0,0],[1,0,0],[1,1,0],[0,1,0]])).solidFromSlices(a)};c.fromObject=function(a){a=a.polygons.map(function(a){return c.Polygon.fromObject(a)});a=c.fromPolygons(a);return a=a.canonicalized()};c.fromCompactBinary=function(a){if("CSG"!=a["class"])throw Error("Not a CSG");for(var b=[],d=a.planeData,f=d.length/4,k=0,g,r,e,u,z=0;z<f;z++)g=d[k++],r=d[k++],e=d[k++],u=d[k++],g=c.Vector3D.Create(g,r,e),g=new c.Plane(g,u),b.push(g);d=[];f=a.vertexData;z=f.length/3;for(u=k=0;u<z;u++)g=f[k++],r=f[k++],e=f[k++],g=
c.Vector3D.Create(g,r,e),g=new c.Vertex(g),d.push(g);r=a.shared.map(function(a){return c.Polygon.Shared.fromObject(a)});e=[];f=a.numPolygons;z=a.numVerticesPerPolygon;u=a.polygonVertices;var x=a.polygonPlaneIndexes;a=a.polygonSharedIndexes;for(var p,h,F=k=0;F<f;F++){g=z[F];p=[];for(h=0;h<g;h++)p.push(d[u[k++]]);g=b[x[F]];h=r[a[F]];g=new c.Polygon(p,h,g);e.push(g)}b=c.fromPolygons(e);b.isCanonicalized=!0;b.isRetesselated=!0;return b};c.prototype={toPolygons:function(){return this.polygons},union:function(a){a instanceof
Array?(a=a.slice(0),a.push(this)):a=[this,a];for(var b=1;b<a.length;b+=2)a.push(a[b-1].unionSub(a[b]));return a[b-1].reTesselated().canonicalized()},unionSub:function(a,b,d){if(this.mayOverlap(a)){var f=new c.Tree(this.polygons),k=new c.Tree(a.polygons);f.clipTo(k,!1);k.clipTo(f);k.invert();k.clipTo(f);k.invert();f=f.allPolygons().concat(k.allPolygons());f=c.fromPolygons(f);f.properties=this.properties._merge(a.properties);b&&(f=f.reTesselated());d&&(f=f.canonicalized());return f}return this.unionForNonIntersecting(a)},
unionForNonIntersecting:function(a){var b=this.polygons.concat(a.polygons),b=c.fromPolygons(b);b.properties=this.properties._merge(a.properties);b.isCanonicalized=this.isCanonicalized&&a.isCanonicalized;b.isRetesselated=this.isRetesselated&&a.isRetesselated;return b},subtract:function(a){a=a instanceof Array?a:[a];for(var b=this,d=0;d<a.length;d++)var c=d==a.length-1,b=b.subtractSub(a[d],c,c);return b},subtractSub:function(a,b,d){var f=new c.Tree(this.polygons),k=new c.Tree(a.polygons);f.invert();
f.clipTo(k);k.clipTo(f,!0);f.addPolygons(k.allPolygons());f.invert();f=c.fromPolygons(f.allPolygons());f.properties=this.properties._merge(a.properties);b&&(f=f.reTesselated());d&&(f=f.canonicalized());return f},intersect:function(a){a=a instanceof Array?a:[a];for(var b=this,c=0;c<a.length;c++)var f=c==a.length-1,b=b.intersectSub(a[c],f,f);return b},intersectSub:function(a,b,d){var f=new c.Tree(this.polygons),k=new c.Tree(a.polygons);f.invert();k.clipTo(f);k.invert();f.clipTo(k);k.clipTo(f);f.addPolygons(k.allPolygons());
f.invert();f=c.fromPolygons(f.allPolygons());f.properties=this.properties._merge(a.properties);b&&(f=f.reTesselated());d&&(f=f.canonicalized());return f},hull:function(a){var b=function(a,b,d){d=d?d.minus(a):new c.Vector3D(0,0,1);this._normal=b.minus(a).cross(d).unit();this._d=this._normal.dot(a)};b.prototype={get normal(){return this._normal},get d(){return this._d},inside:function(a){return 0<=this._normal.dot(a)-this._d},getPlane:function(){return new c.Plane(this._normal,this._d)},toString:function(){return"[normal: "+
this._normal+"/d: "+this._d+"]"}};var d=function(a,b){this._start=a;this._end=b};d.prototype={get start(){return this._start},get end(){return this._end},equals:function(a){return this._start.equals(a._start)&&this._end.equals(a._end)||this._start.equals(a._end)&&this._end.equals(a._start)},toString:function(){return"[start: "+this._start+"/end: "+this._end+"]"}};var f=function(){this._data=[]};f.prototype={isEmpty:function(){return 0===this._data.length},get:function(){return this._data.pop()},put:function(a,
b){var c;c=b?new d(a,b):a;this._data.push(c)},putp:function(a,b){var c;c=b?new d(a,b):a;for(var f=0,k=this._data.length;f<k;++f)if(this._data[f].equals(c)){this._data.splice(f,1);return}this._data.push(c)},toString:function(){return this._data.toString()}};var k=function(a,c,d){this._a=a;this._b=c;this._c=d;this._halfSpace=new b(a,c,d);this._points=[]};k.prototype={get a(){return this._a},get b(){return this._b},get c(){return this._c},get points(){return this._points},inside:function(a){return this._halfSpace.inside(a)},
add:function(a){return this.inside(a)?(this._points.push(a),!0):!1},extreme:function(){for(var a=null,b=-Number.MAX_VALUE,c=0,d=this._points.length;c<d;++c){var f=this._points[c],k=this._halfSpace.normal.dot(f);k>b&&(a=f,b=k)}return a},getPolygon:function(){var a=[new c.Vertex(this._a),new c.Vertex(this._b),new c.Vertex(this._c)];return new c.Polygon(a,null,this._halfSpace.getPlane())},toString:function(){return"[a: "+this._a+"/b: "+this._b+"/c: "+this._c+"/halfSpace: "+this._halfSpace+"/points: "+
this._points+"]"}};var g=[];g.push(this);for(var r=0;r<a.length;r++)g.push(a[r]);for(r=0;r<g.length;r++)if(!(g[r]instanceof c))throw"ERROR: don't mix 2D and 3D shapes in hull";g=function(a){Array.isArray(a)||(a=[a]);var b={};a.map(function(a){a.reTesselated().polygons.map(function(a){a.vertices.map(function(a){b[a.getTag()]=a})})});a=[];for(var c in b)b.hasOwnProperty(c)&&(b[c].pos._x+=(Math.random()-.5)/1E3,b[c].pos._y+=(Math.random()-.5)/1E3,b[c].pos._z+=(Math.random()-.5)/1E3,a.push(b[c].pos));
return a}(g);(function(a){for(var b=0,c=a.length;b<c;++b){if(a[b].x+a[b].y+a[b].z>a[0].x+a[0].y+a[0].z){var d=a[0];a[0]=a[b];a[b]=d}a[b].x+a[b].y+a[b].z<a[1].x+a[1].y+a[1].z&&(d=a[1],a[1]=a[b],a[b]=d)}})(g);a=new b(g[0],g[1]);for(var e=g.length,r=3;r<e;++r)if(a.normal.dot(g[r])>a.normal.dot(g[2])){var u=g[2];g[2]=g[r];g[r]=u}var u=new k(g[0],g[1],g[2]),z=new k(g[0],g[2],g[1]);a=[u,z];for(r=3;r<e;++r)u.add(g[r])||z.add(g[r]);f=new f;for(r=0;r<a.length;++r)if(g=a[r])if(g=g.extreme()){e=[];for(u=0;u<
a.length;++u)(z=a[u])&&z.inside(g)&&(f.putp(z.a,z.b),f.putp(z.b,z.c),f.putp(z.c,z.a),e=e.concat(z.points),a[u]=null);for(;!f.isEmpty();){for(var u=f.get(),z=new k(u.start,u.end,g),h=[],u=e.length-1;0<=u;--u){var p=e[u];p===g||z.add(p)||h.push(p)}e=h;a.push(z)}}var q=[];a.map(function(a){a&&q.push(a.getPolygon())});return c.fromPolygons(q)},invert:function(){var a=this.polygons.map(function(a){return a.flipped()});return c.fromPolygons(a)},transform1:function(a){var b=this.polygons.map(function(b){return b.transform(a)}),
b=c.fromPolygons(b);b.properties=this.properties._transform(a);b.isRetesselated=this.isRetesselated;return b},transform:function(a){var b=a.isMirroring(),d={},f={},k=this.polygons.map(function(k){var r;r=k.plane;var e=r.getTag();e in f?r=f[e]:(r=r.transform(a),f[e]=r);e=k.vertices.map(function(b){var c=b.getTag();c in d?b=d[c]:(b=b.transform(a),d[c]=b);return b});b&&e.reverse();return new c.Polygon(e,k.shared,r)}),k=c.fromPolygons(k);k.properties=this.properties._transform(a);k.isRetesselated=this.isRetesselated;
k.isCanonicalized=this.isCanonicalized;return k},toString:function(){var a="CSG solid:\n";this.polygons.map(function(b){a+=b.toString()});return a},expand:function(a,b){var c=this.expandedShell(a,b,!0),c=c.reTesselated();c.properties=this.properties;return c},contract:function(a,b){var c=this.expandedShell(a,b,!1),c=this.subtract(c),c=c.reTesselated();c.properties=this.properties;return c},stretchAtPlane:function(a,b,d){a=c.Plane.fromNormalAndPoint(a,b);b=new c.OrthoNormalBasis(a);b=this.sectionCut(b).extrudeInOrthonormalBasis(b,
d);var f=this.cutByPlane(a),k=this.cutByPlane(a.flipped());return f.union([b,k.translate(a.normal.times(d))])},expandedShell:function(a,b,d){var f=this.reTesselated(),k;k=d?f:new c;f.polygons.map(function(b){var c=b.plane.normal.unit().times(2*a);b=b.translate(c.times(-.5)).extrude(c);k=k.unionSub(b,!1,!1)});var g={};f.polygons.map(function(a){for(var b=a.vertices.length,c=a.vertices[b-1],d=c.getTag(),f=0;f<b;f++){var k=a.vertices[f],r=k.getTag(),d=r<d?r+"-"+d:d+"-"+r;d in g?c=g[d]:(c={v1:c,v2:k,
planenormals:[]},g[d]=c);c.planenormals.push(a.plane.normal);d=r;c=k}});for(var r in g){var e=g[r],u=e.v1.pos,z=e.v2.pos;d=z.minus(u).unit();var x=e.planenormals[0].unit(),p=x.cross(d),q=[];for(d=0;d<b;d++)q.push(d*Math.PI*2/b);d=0;for(var m=e.planenormals.length;d<m;d++){var l=e.planenormals[d],t=p.dot(l),B=x.dot(l),n=Math.atan2(t,B);0>n&&(n+=2*Math.PI);q.push(n);n=Math.atan2(-t,-B);0>n&&(n+=2*Math.PI);q.push(n)}var q=q.sort(h),e=q.length,v,w,m=[],l=[],y=[];for(d=-1;d<e;d++)n=q[0>d?d+e:d],t=Math.sin(n),
B=Math.cos(n),B=x.times(B*a).plus(p.times(t*a)),t=u.plus(B),B=z.plus(B),n=!1,0<=d&&1E-5>t.distanceTo(v)&&(n=!0),n||(0<=d&&(m.push(new c.Vertex(t)),l.push(new c.Vertex(B)),v=[new c.Vertex(w),new c.Vertex(B),new c.Vertex(t),new c.Vertex(v)],v=new c.Polygon(v),y.push(v)),v=t,w=B);l.reverse();y.push(new c.Polygon(m));y.push(new c.Polygon(l));d=c.fromPolygons(y);k=k.unionSub(d,!1,!1)}var D={};f.polygons.map(function(a){a.vertices.map(function(b){var c=b.getTag();c in D?b=D[c]:(b={pos:b.pos,normals:[]},
D[c]=b);b.normals.push(a.plane.normal)})});for(var E in D){f=D[E];r=f.normals[0].unit();u=null;z=0;for(d=1;d<f.normals.length;d++)x=f.normals[d].unit(),v=r.cross(x).length(),.05<v&&v>z&&(z=v,u=x);u||(u=r.randomNonParallelVector());d=r.cross(u).unit();u=d.cross(r);d=c.sphere({center:f.pos,radius:a,resolution:b,axes:[r,d,u]});k=k.unionSub(d,!1,!1)}return k},canonicalized:function(){if(this.isCanonicalized)return this;var a=(new c.fuzzyCSGFactory).getCSG(this);a.isCanonicalized=!0;a.isRetesselated=this.isRetesselated;
a.properties=this.properties;return a},reTesselated:function(){if(this.isRetesselated)return this;var a={},b=this.isCanonicalized,d=new c.fuzzyCSGFactory;this.polygons.map(function(c){var f=c.plane,k=c.shared;b||(f=d.getPlane(f),k=d.getPolygonShared(k));f=f.getTag()+"/"+k.getTag();f in a?a[f].push(c):a[f]=[c]});var f=[],k;for(k in a){var g=a[k];if(2>g.length)f=f.concat(g);else{var r=[];c.reTesselateCoplanarPolygons(g,r);f=f.concat(r)}}f=c.fromPolygons(f);f.isRetesselated=!0;f.properties=this.properties;
return f},getBounds:function(){if(!this.cachedBoundingBox){for(var a=new c.Vector3D(0,0,0),b=new c.Vector3D(0,0,0),d=this.polygons,f=d.length,k=0;k<f;k++){var g=d[k].boundingBox();0===k?(a=g[0],b=g[1]):(a=a.min(g[0]),b=b.max(g[1]))}this.cachedBoundingBox=[a,b]}return this.cachedBoundingBox},mayOverlap:function(a){if(0===this.polygons.length||0===a.polygons.length)return!1;var b=this.getBounds();a=a.getBounds();return b[1].x<a[0].x||b[0].x>a[1].x||b[1].y<a[0].y||b[0].y>a[1].y||b[1].z<a[0].z||b[0].z>
a[1].z?!1:!0},cutByPlane:function(a){if(0===this.polygons.length)return new c;var b=a.normal.times(a.w),d=0;this.polygons.map(function(a){a.vertices.map(function(a){a=a.pos.distanceToSquared(b);a>d&&(d=a)})});var d=Math.sqrt(d),d=1.01*d,f=[],k=new c.OrthoNormalBasis(a);f.push(new c.Vertex(k.to3D(new c.Vector2D(d,-d))));f.push(new c.Vertex(k.to3D(new c.Vector2D(-d,-d))));f.push(new c.Vertex(k.to3D(new c.Vector2D(-d,d))));f.push(new c.Vertex(k.to3D(new c.Vector2D(d,d))));a=(new c.Polygon(f,null,a.flipped())).extrude(a.normal.times(-d));
a=this.intersect(a);a.properties=this.properties;return a},connectTo:function(a,b,c,f){a=a.getTransformationTo(b,c,f);return this.transform(a)},setShared:function(a){var b=this.polygons.map(function(b){return new c.Polygon(b.vertices,a,b.plane)}),b=c.fromPolygons(b);b.properties=this.properties;b.isRetesselated=this.isRetesselated;b.isCanonicalized=this.isCanonicalized;return b},setColor:function(a){var b=c.Polygon.Shared.fromColor.apply(this,arguments);return this.setShared(b)},toCompactBinary:function(){var a=
this.canonicalized(),b=a.polygons.length,c=0,f=0,k={},g=[],r=0,e={},u=0,z=[],h=[],p={},q=0;a.polygons.map(function(a){a.vertices.map(function(a){++c;var b=a.getTag();b in k||(k[b]=f++,g.push(a))});var b=a.plane.getTag();b in e||(e[b]=r++,z.push(a.plane));b=a.shared.getTag();b in p||(p[b]=q++,h.push(a.shared))});for(var m=new Uint32Array(b),l=new Uint32Array(b),t=new Uint32Array(c),n=new Uint32Array(b),C=new Float64Array(3*f),v=new Float64Array(4*r),w=0,u=0;u<b;++u){var y=a.polygons[u];m[u]=y.vertices.length;
y.vertices.map(function(a){a=a.getTag();a=k[a];t[w++]=a});var D=y.plane.getTag();n[u]=e[D];y=y.shared.getTag();l[u]=p[y]}var E=0;g.map(function(a){a=a.pos;C[E++]=a._x;C[E++]=a._y;C[E++]=a._z});var G=0;z.map(function(a){var b=a.normal;v[G++]=b._x;v[G++]=b._y;v[G++]=b._z;v[G++]=a.w});return{"class":"CSG",numPolygons:b,numVerticesPerPolygon:m,polygonPlaneIndexes:n,polygonSharedIndexes:l,polygonVertices:t,vertexData:C,planeData:v,shared:h}},toPointCloud:function(a){var b=this.reTesselated(),d=new c,f=
{};b.polygons.map(function(a){a.vertices.map(function(a){f[a.getTag()]=a.pos})});for(var k in f)b=c.cube({center:f[k],radius:a}),d=d.unionSub(b,!1,!1);return d=d.reTesselated()},getTransformationAndInverseTransformationToFlatLying:function(){if(0===this.polygons.length)return new c.Matrix4x4;var a=this.canonicalized(),b={};a.polygons.map(function(a){b[a.plane.getTag()]=a.plane});var d=new c.Vector3D(1,0,0),f=new c.Vector3D(0,1,0),k=new c.Vector3D(0,0,1),g=new c.Connector([0,0,0],[0,0,-1],d),r=new c.Connector([0,
0,0],[0,0,-1],f),e=!0,u=0,z=0,h,p,q;for(q in b){var m=b[q],l=m.normal.times(m.w),t;t=m.normal.cross(d).length();var n=m.normal.cross(f).length();t>n?(t=new c.Connector(l,m.normal,d),l=t.getTransformationTo(g,!1,0),t=g.getTransformationTo(t,!1,0)):(t=new c.Connector(l,m.normal,f),l=t.getTransformationTo(r,!1,0),t=r.getTransformationTo(t,!1,0));var n=a.transform(l),m=-m.normal.dot(k),C=n.getBounds(),n=C[1].z-C[0].z;e||(n<u?e=!0:n==u&&m>z&&(e=!0));e&&(u=new c.Vector3D([-.5*(C[1].x+C[0].x),-.5*(C[1].y+
C[0].y),-C[0].z]),l=l.multiply(c.Matrix4x4.translation(u)),t=c.Matrix4x4.translation(u.negated()).multiply(t),u=n,z=m,h=l,p=t);e=!1}return[h,p]},getTransformationToFlatLying:function(){return this.getTransformationAndInverseTransformationToFlatLying()[0]},lieFlat:function(){var a=this.getTransformationToFlatLying();return this.transform(a)},projectToOrthoNormalBasis:function(a){var b=[];this.polygons.filter(function(b){return b.plane.normal.minus(a.plane.normal).lengthSquared()<1E-5*1E-5}).map(function(c){c=
c.projectToOrthoNormalBasis(a);0<c.sides.length&&b.push(c)});return(new m).union(b)},sectionCut:function(a){var b=a.plane,d=a.plane.flipped(),b=new c.Plane(b.normal,b.w),d=new c.Plane(d.normal,d.w+5E-5),b=this.cutByPlane(b),b=b.cutByPlane(d);return b.projectToOrthoNormalBasis(a)},fixTJunctions:function(){for(var a=this.canonicalized(),b={},d=0;d<a.polygons.length;d++){var f=a.polygons[d],k=f.vertices.length;if(3<=k)for(var g=f.vertices[0],r=g.getTag(),e=0;e<k;e++){var u=e+1;u==k&&(u=0);var u=f.vertices[u],
z=u.getTag(),h=r+"/"+z,r=z+"/"+r;r in b?(g=b[r],g.splice(-1,1),0===g.length&&delete b[r]):(g={vertex0:g,vertex1:u,polygonindex:d},h in b?b[h].push(g):b[h]=[g]);g=u;r=z}}var p={},q={},k={},g=!0;for(h in b)g=!1,k[h]=!0,b[h].map(function(a){var b=a.vertex0.getTag();a=a.vertex1.getTag();b in p?p[b].push(h):p[b]=[h];a in q?q[a].push(h):q[a]=[h]});if(!g){var m=function(a,c,d){var f=a.getTag(),k=c.getTag(),g=f+"/"+k;if(!(g in b))throw Error("Assertion failed");for(var r=-1,e=b[g],u=0;u<e.length;u++){var h=
e[u];if(h.vertex0==a&&h.vertex1==c&&(null===d||h.polygonindex==d)){r=u;break}}if(0>r)throw Error("Assertion failed");e.splice(r,1);0===e.length&&delete b[g];r=p[f].indexOf(g);if(0>r)throw Error("Assertion failed");p[f].splice(r,1);0===p[f].length&&delete p[f];r=q[k].indexOf(g);if(0>r)throw Error("Assertion failed");q[k].splice(r,1);0===q[k].length&&delete q[k]},e=function(a,c,d){var f=a.getTag(),k=c.getTag();if(f==k)throw Error("Assertion failed");var g=f+"/"+k;if(k+"/"+f in b)return m(c,a,null),
null;a={vertex0:a,vertex1:c,polygonindex:d};g in b?b[g].push(a):b[g]=[a];f in p?p[f].push(g):p[f]=[g];k in q?q[k].push(g):q[k]=[g];return g},u=a.polygons.slice(0);for(;;){g=!0;for(h in b)g=!1,k[h]=!0;if(g)break;for(d=!1;;){g=null;for(h in k){g=h;break}if(null===g)break;f=!0;if(g in b){g=b[g];if(0===g.length)throw Error("Assertion failed");for(var g=g[0],l=0;2>l;l++){var t=0===l?g.vertex0:g.vertex1,z=0===l?g.vertex1:g.vertex0,n=t.getTag(),C=z.getTag(),v=[];0===l?n in q&&(v=q[n]):n in p&&(v=p[n]);for(var w=
0;w<v.length;w++){var r=b[v[w]][0],y=0===l?r.vertex0:r.vertex1,D=0===l?r.vertex1:r.vertex0,E=y.getTag();if(D.getTag()!=n)throw Error("Assertion failed");if(E==C){m(t,z,null);m(z,t,null);f=!1;l=2;d=!0;break}else{var D=t.pos,E=z.pos,y=y.pos.minus(D),G=E.minus(D).dot(y)/y.dot(y);if(0<G&&1>G&&1E-10>D.plus(y.times(G)).distanceToSquared(E)){d=r.polygonindex;f=u[d];t=r.vertex1.getTag();l=-1;for(n=0;n<f.vertices.length;n++)if(f.vertices[n].getTag()==t){l=n;break}if(0>l)throw Error("Assertion failed");t=f.vertices.slice(0);
t.splice(l,0,z);f=new c.Polygon(t,f.shared);u[d]=f;m(r.vertex0,r.vertex1,d);f=e(r.vertex0,z,d);z=e(z,r.vertex1,d);null!==f&&(k[f]=!0);null!==z&&(k[z]=!0);f=!1;l=2;d=!0;break}}}}}f&&delete k[h]}if(!d)break}g=c.fromPolygons(u);g.properties=a.properties;g.isCanonicalized=!0;g.isRetesselated=!0;a=g}g=!0;for(h in b){g=!1;break}g||OpenJsCad.log("!sidemapisempty");return a},toTriangles:function(){var a=[];this.polygons.forEach(function(b){for(var d=b.vertices[0],f=b.vertices.length-3;0<=f;f--)a.push(new c.Polygon([d,
b.vertices[f+1],b.vertices[f+2]],b.shared,b.plane))});return a},getFeatures:function(a){a instanceof Array||(a=[a]);var b=this.toTriangles().map(function(b){return b.getTetraFeatures(a)}).reduce(function(a,b){return b.map(function(b,c){return b+(0===a?0:a[c])})},0);return 1==b.length?b[0]:b}};c.parseOption=function(a,b,c){a&&b in a&&(c=a[b]);return c};c.parseOptionAs3DVector=function(a,b,d){a=c.parseOption(a,b,d);return a=new c.Vector3D(a)};c.parseOptionAs3DVectorList=function(a,b,d){return c.parseOption(a,
b,d).map(function(a){return new c.Vector3D(a)})};c.parseOptionAs2DVector=function(a,b,d){a=c.parseOption(a,b,d);return a=new c.Vector2D(a)};c.parseOptionAsFloat=function(a,b,d){a=c.parseOption(a,b,d);"string"==typeof a&&(a=Number(a));if(isNaN(a)||"number"!=typeof a)throw Error("Parameter "+b+" should be a number");return a};c.parseOptionAsInt=function(a,b,d){a=c.parseOption(a,b,d);a=Number(Math.floor(a));if(isNaN(a))throw Error("Parameter "+b+" should be a number");return a};c.parseOptionAsBool=function(a,
b,d){a=c.parseOption(a,b,d);"string"==typeof a&&("true"==a?a=!0:"false"==a?a=!1:0==a&&(a=!1));return!!a};c.cube=function(a){var b,d;a=a||{};if("corner1"in a||"corner2"in a){if("center"in a||"radius"in a)throw Error("cube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=c.parseOptionAs3DVector(a,"corner1",[0,0,0]);corner2=c.parseOptionAs3DVector(a,"corner2",[1,1,1]);b=corner1.plus(corner2).times(.5);d=corner2.minus(corner1).times(.5)}else b=c.parseOptionAs3DVector(a,
"center",[0,0,0]),d=c.parseOptionAs3DVector(a,"radius",[1,1,1]);if(0>=d.x||0>=d.y||0>=d.z)throw Error("Dimension should be positive");if(5E-4>d.x||5E-4>d.y||5E-4>d.z)return console.log("Throwing out a zero-length cube."),new c;a=c.fromPolygons([[[0,4,6,2],[-1,0,0]],[[1,3,7,5],[1,0,0]],[[0,1,5,4],[0,-1,0]],[[2,6,7,3],[0,1,0]],[[0,2,3,1],[0,0,-1]],[[4,5,7,6],[0,0,1]]].map(function(a){a=a[0].map(function(a){a=new c.Vector3D(b.x+d.x*(2*!!(a&1)-1),b.y+d.y*(2*!!(a&2)-1),b.z+d.z*(2*!!(a&4)-1));return new c.Vertex(a)});
return new c.Polygon(a,null)}));a.properties.cube=new c.Properties;a.properties.cube.center=new c.Vector3D(b);a.properties.cube.facecenters=[new c.Connector((new c.Vector3D([d.x,0,0])).plus(b),[1,0,0],[0,0,1]),new c.Connector((new c.Vector3D([-d.x,0,0])).plus(b),[-1,0,0],[0,0,1]),new c.Connector((new c.Vector3D([0,d.y,0])).plus(b),[0,1,0],[0,0,1]),new c.Connector((new c.Vector3D([0,-d.y,0])).plus(b),[0,-1,0],[0,0,1]),new c.Connector((new c.Vector3D([0,0,d.z])).plus(b),[0,0,1],[1,0,0]),new c.Connector((new c.Vector3D([0,
0,-d.z])).plus(b),[0,0,-1],[1,0,0])];return a};c.sphere=function(a){a=a||{};var b=c.parseOptionAs3DVector(a,"center",[0,0,0]),d=c.parseOptionAsFloat(a,"radius",1),f=c.parseOptionAsInt(a,"resolution",c.defaultResolution3D),k,g;if(0>=d)throw Error("Radius should be positive");if(5E-4>d)return console.log("Throwing out a zero-radius sphere."),new c;"axes"in a?(k=a.axes[0].unit().times(d),g=a.axes[1].unit().times(d),a=a.axes[2].unit().times(d)):(k=(new c.Vector3D([1,0,0])).times(d),g=(new c.Vector3D([0,
-1,0])).times(d),a=(new c.Vector3D([0,0,1])).times(d));4>f&&(f=4);for(var d=Math.round(f/4),r,e=[],u=0;u<=f;u++){var h=2*Math.PI*u/f,h=k.times(Math.cos(h)).plus(g.times(Math.sin(h)));if(0<u)for(var l=[],p,q,m=0;m<=d;m++){var l=.5*Math.PI*m/d,n=Math.cos(l),t=Math.sin(l);0<m&&(l=[],l.push(new c.Vertex(b.plus(r.times(p).minus(a.times(q))))),l.push(new c.Vertex(b.plus(h.times(p).minus(a.times(q))))),m<d&&l.push(new c.Vertex(b.plus(h.times(n).minus(a.times(t))))),l.push(new c.Vertex(b.plus(r.times(n).minus(a.times(t))))),
e.push(new c.Polygon(l)),l=[],l.push(new c.Vertex(b.plus(r.times(p).plus(a.times(q))))),l.push(new c.Vertex(b.plus(h.times(p).plus(a.times(q))))),m<d&&l.push(new c.Vertex(b.plus(h.times(n).plus(a.times(t))))),l.push(new c.Vertex(b.plus(r.times(n).plus(a.times(t))))),l.reverse(),e.push(new c.Polygon(l)));p=n;q=t}r=h}f=c.fromPolygons(e);f.properties.sphere=new c.Properties;f.properties.sphere.center=new c.Vector3D(b);f.properties.sphere.facepoint=b.plus(k);return f};c.cylinder=function(a){function b(a,
b,f){b=b*Math.PI*r/180;b=h.times(Math.cos(b)).plus(l.times(Math.sin(b)));a=d.plus(u.times(a)).plus(b.times(f));return new c.Vertex(a)}var d=c.parseOptionAs3DVector(a,"start",[0,-1,0]),f=c.parseOptionAs3DVector(a,"end",[0,1,0]),k=c.parseOptionAsFloat(a,"radius",1),g=c.parseOptionAsFloat(a,"radiusEnd",k),k=c.parseOptionAsFloat(a,"radiusStart",k),r=c.parseOptionAsFloat(a,"sectorAngle",360),r=360<r?r%360:r;if(0>g||0>k)throw Error("Radius should be non-negative");if(0===g&&0===k)throw Error("Either radiusStart or radiusEnd should be nonzero");
if(5E-4>Math.abs(f.z-d.z))return console.log("throwing out a zero-height cylinder"),new c;var e=c.parseOptionAsInt(a,"resolution",c.defaultResolution2D),u=f.minus(d);a=u.unit();var h=a.randomNonParallelVector().unit(),l=h.cross(a).unit(),p=new c.Vertex(d),m=new c.Vertex(f),n=[];if(0<r){for(var A=0;A<e;A++){var t=A/e,B=(A+1)/e;g==k?(n.push(new c.Polygon([p,b(0,t,g),b(0,B,g)])),n.push(new c.Polygon([b(0,B,g),b(0,t,g),b(1,t,g),b(1,B,g)])),n.push(new c.Polygon([m,b(1,B,g),b(1,t,g)]))):(0<k&&(n.push(new c.Polygon([p,
b(0,t,k),b(0,B,k)])),n.push(new c.Polygon([b(0,t,k),b(1,t,g),b(0,B,k)]))),0<g&&(n.push(new c.Polygon([m,b(1,B,g),b(1,t,g)])),n.push(new c.Polygon([b(1,t,g),b(1,B,g),b(0,B,k)]))))}360>r&&(n.push(new c.Polygon([p,m,b(0,0,k)])),n.push(new c.Polygon([b(0,0,k),m,b(1,0,g)])),n.push(new c.Polygon([p,b(0,1,k),m])),n.push(new c.Polygon([b(0,1,k),b(1,1,g),m])))}e=c.fromPolygons(n);e.properties.cylinder=new c.Properties;e.properties.cylinder.start=new c.Connector(d,a.negated(),h);e.properties.cylinder.end=new c.Connector(f,
a,h);f=d.plus(u.times(.5));g=h.rotate(d,a,-r/2).times((k+g)/2);k=g.cross(a);e.properties.cylinder.facepointH=new c.Connector(f.plus(g),g,a);e.properties.cylinder.facepointH90=new c.Connector(f.plus(k),k,a);return e};c.roundedCylinder=function(a){var b=c.parseOptionAs3DVector(a,"start",[0,-1,0]),d=c.parseOptionAs3DVector(a,"end",[0,1,0]),f=c.parseOptionAsFloat(a,"radius",1),k=d.minus(b),g;g=Math.abs(k.x)>Math.abs(k.y)?new c.Vector3D(0,1,0):new c.Vector3D(1,0,0);var r=c.parseOptionAs3DVector(a,"normal",
g);a=c.parseOptionAsInt(a,"resolution",c.defaultResolution3D);4>a&&(a=4);g=[];var e=Math.floor(.25*a);if(1E-10>k.length())return c.sphere({center:b,radius:f,resolution:a});for(var h=k.unit().times(f),k=h.cross(r).unit().times(f),f=k.cross(h).unit().times(f),z,r=0;r<=a;r++){var l=2*Math.PI*r/a,l=k.times(Math.cos(l)).plus(f.times(Math.sin(l)));if(0<r){var p=[];p.push(new c.Vertex(b.plus(l)));p.push(new c.Vertex(b.plus(z)));p.push(new c.Vertex(d.plus(z)));p.push(new c.Vertex(d.plus(l)));g.push(new c.Polygon(p));
for(var m,n,A=0;A<=e;A++){var p=.5*Math.PI*A/e,t=Math.cos(p),B=Math.sin(p);0<A&&(p=[],p.push(new c.Vertex(b.plus(z.times(m).minus(h.times(n))))),p.push(new c.Vertex(b.plus(l.times(m).minus(h.times(n))))),A<e&&p.push(new c.Vertex(b.plus(l.times(t).minus(h.times(B))))),p.push(new c.Vertex(b.plus(z.times(t).minus(h.times(B))))),g.push(new c.Polygon(p)),p=[],p.push(new c.Vertex(d.plus(z.times(m).plus(h.times(n))))),p.push(new c.Vertex(d.plus(l.times(m).plus(h.times(n))))),A<e&&p.push(new c.Vertex(d.plus(l.times(t).plus(h.times(B))))),
p.push(new c.Vertex(d.plus(z.times(t).plus(h.times(B))))),p.reverse(),g.push(new c.Polygon(p)));m=t;n=B}}z=l}z=c.fromPolygons(g);m=h.unit();n=k.unit();z.properties.roundedCylinder=new c.Properties;z.properties.roundedCylinder.start=new c.Connector(b,m.negated(),n);z.properties.roundedCylinder.end=new c.Connector(d,m,n);z.properties.roundedCylinder.facepoint=b.plus(k);return z};c.roundedCube=function(a){var b,d;a=a||{};if("corner1"in a||"corner2"in a){if("center"in a||"radius"in a)throw Error("roundedCube: should either give a radius and center parameter, or a corner1 and corner2 parameter");
corner1=c.parseOptionAs3DVector(a,"corner1",[0,0,0]);corner2=c.parseOptionAs3DVector(a,"corner2",[1,1,1]);b=corner1.plus(corner2).times(.5);d=corner2.minus(corner1).times(.5)}else b=c.parseOptionAs3DVector(a,"center",[0,0,0]),d=c.parseOptionAs3DVector(a,"radius",[1,1,1]);d=d.abs();var f=c.parseOptionAsInt(a,"resolution",c.defaultResolution3D);4>f&&(f=4);1==f%2&&8>f&&(f=8);a=c.parseOptionAs3DVector(a,"roundradius",[.2,.2,.2]);a=c.Vector3D.Create(Math.max(a.x,.01),Math.max(a.y,.01),Math.max(a.z,.01));
var k=d.minus(a);if(0>k.x||0>k.y||0>k.z)throw"roundradius <= radius!";f=c.sphere({radius:1,resolution:f});f=f.scale(a);1E-5<k.x&&(f=f.stretchAtPlane([1,0,0],[0,0,0],2*k.x));1E-5<k.y&&(f=f.stretchAtPlane([0,1,0],[0,0,0],2*k.y));1E-5<k.z&&(f=f.stretchAtPlane([0,0,1],[0,0,0],2*k.z));f=f.translate([-k.x+b.x,-k.y+b.y,-k.z+b.z]);f=f.reTesselated();f.properties.roundedCube=new c.Properties;f.properties.roundedCube.center=new c.Vertex(b);f.properties.roundedCube.facecenters=[new c.Connector((new c.Vector3D([d.x,
0,0])).plus(b),[1,0,0],[0,0,1]),new c.Connector((new c.Vector3D([-d.x,0,0])).plus(b),[-1,0,0],[0,0,1]),new c.Connector((new c.Vector3D([0,d.y,0])).plus(b),[0,1,0],[0,0,1]),new c.Connector((new c.Vector3D([0,-d.y,0])).plus(b),[0,-1,0],[0,0,1]),new c.Connector((new c.Vector3D([0,0,d.z])).plus(b),[0,0,1],[1,0,0]),new c.Connector((new c.Vector3D([0,0,-d.z])).plus(b),[0,0,-1],[1,0,0])];return f};c.polyhedron=function(a){a=a||{};if("points"in a!=="faces"in a)throw Error("polyhedron needs 'points' and 'faces' arrays");
var b=c.parseOptionAs3DVectorList(a,"points",[[1,1,0],[1,-1,0],[-1,-1,0],[-1,1,0],[0,0,1]]).map(function(a){return new c.Vertex(a)});a=c.parseOption(a,"faces",[[0,1,4],[1,2,4],[2,3,4],[3,0,4],[1,0,3],[2,1,3]]);a.forEach(function(a){a.reverse()});a=a.map(function(a){return new c.Polygon(a.map(function(a){return b[a]}))});return c.fromPolygons(a).reTesselated()};c.IsFloat=function(a){return!isNaN(a)||Infinity===a||-Infinity===a};c.solve2Linear=function(a,b,c,f,k,g){var r=1/(a*f-b*c);b=(k*f-b*g)*r;a=
(-k*c+a*g)*r;return[b,a]};c.Vector3D=function(a,b,d){if(3==arguments.length)this._x=parseFloat(a),this._y=parseFloat(b),this._z=parseFloat(d);else if(2==arguments.length)this._x=parseFloat(a),this._y=parseFloat(b),this._z=0;else{var f=!0;if(1==arguments.length)if("object"==typeof a)a instanceof c.Vector3D?(this._x=a._x,this._y=a._y,this._z=a._z):a instanceof c.Vector2D?(this._x=a._x,this._y=a._y,this._z=0):a instanceof Array?2>a.length||3<a.length?f=!1:(this._x=parseFloat(a[0]),this._y=parseFloat(a[1]),
this._z=3==a.length?parseFloat(a[2]):0):"x"in a&&"y"in a?(this._x=parseFloat(a.x),this._y=parseFloat(a.y),this._z="z"in a?parseFloat(a.z):0):f=!1;else{var k=parseFloat(a);this._z=this._y=this._x=k}else f=!1;f&&(c.IsFloat(this._x)&&c.IsFloat(this._y)&&c.IsFloat(this._z)||(f=!1));if(!f)throw Error("wrong arguments");}};c.Vector3D.Create=function(a,b,d){var f=Object.create(c.Vector3D.prototype);f._x=a;f._y=b;f._z=d;return f};c.Vector3D.prototype={get x(){return this._x},get y(){return this._y},get z(){return this._z},
set x(a){throw Error("Vector3D is immutable");},set y(a){throw Error("Vector3D is immutable");},set z(a){throw Error("Vector3D is immutable");},clone:function(){return c.Vector3D.Create(this._x,this._y,this._z)},negated:function(){return c.Vector3D.Create(-this._x,-this._y,-this._z)},abs:function(){return c.Vector3D.Create(Math.abs(this._x),Math.abs(this._y),Math.abs(this._z))},plus:function(a){return c.Vector3D.Create(this._x+a._x,this._y+a._y,this._z+a._z)},minus:function(a){return c.Vector3D.Create(this._x-
a._x,this._y-a._y,this._z-a._z)},times:function(a){return c.Vector3D.Create(this._x*a,this._y*a,this._z*a)},dividedBy:function(a){return c.Vector3D.Create(this._x/a,this._y/a,this._z/a)},dot:function(a){return this._x*a._x+this._y*a._y+this._z*a._z},lerp:function(a,b){return this.plus(a.minus(this).times(b))},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},unit:function(){return this.dividedBy(this.length())},cross:function(a){return c.Vector3D.Create(this._y*
a._z-this._z*a._y,this._z*a._x-this._x*a._z,this._x*a._y-this._y*a._x)},distanceTo:function(a){return this.minus(a).length()},distanceToSquared:function(a){return this.minus(a).lengthSquared()},equals:function(a){return this._x==a._x&&this._y==a._y&&this._z==a._z},multiply4x4:function(a){return a.leftMultiply1x3Vector(this)},transform:function(a){return a.leftMultiply1x3Vector(this)},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+", "+this._z.toFixed(2)+")"},randomNonParallelVector:function(){var a=
this.abs();return a._x<=a._y&&a._x<=a._z?c.Vector3D.Create(1,0,0):a._y<=a._x&&a._y<=a._z?c.Vector3D.Create(0,1,0):c.Vector3D.Create(0,0,1)},min:function(a){return c.Vector3D.Create(Math.min(this._x,a._x),Math.min(this._y,a._y),Math.min(this._z,a._z))},max:function(a){return c.Vector3D.Create(Math.max(this._x,a._x),Math.max(this._y,a._y),Math.max(this._z,a._z))}};c.Vertex=function(a){this.pos=a};c.Vertex.fromObject=function(a){a=new c.Vector3D(a.pos);return new c.Vertex(a)};c.Vertex.prototype={flipped:function(){return this},
getTag:function(){var a=this.tag;a||(this.tag=a=c.getTag());return a},interpolate:function(a,b){var d=this.pos.lerp(a.pos,b);return new c.Vertex(d)},transform:function(a){a=this.pos.multiply4x4(a);return new c.Vertex(a)},toString:function(){return this.pos.toString()}};c.Plane=function(a,b){this.normal=a;this.w=b};c.Plane.fromObject=function(a){var b=new c.Vector3D(a.normal);a=parseFloat(a.w);return new c.Plane(b,a)};c.Plane.EPSILON=1E-5;c.Plane.fromVector3Ds=function(a,b,d){b=b.minus(a).cross(d.minus(a)).unit();
return new c.Plane(b,b.dot(a))};c.Plane.anyPlaneFromVector3Ds=function(a,b,d){b=b.minus(a);d=d.minus(a);1E-5>b.length()&&(b=d.randomNonParallelVector());1E-5>d.length()&&(d=b.randomNonParallelVector());d=b.cross(d);1E-5>d.length()&&(d=b.randomNonParallelVector(),d=b.cross(d));d=d.unit();return new c.Plane(d,d.dot(a))};c.Plane.fromPoints=function(a,b,d){a=new c.Vector3D(a);b=new c.Vector3D(b);d=new c.Vector3D(d);return c.Plane.fromVector3Ds(a,b,d)};c.Plane.fromNormalAndPoint=function(a,b){a=new c.Vector3D(a);
b=new c.Vector3D(b);a=a.unit();var d=b.dot(a);return new c.Plane(a,d)};c.Plane.prototype={flipped:function(){return new c.Plane(this.normal.negated(),-this.w)},getTag:function(){var a=this.tag;a||(this.tag=a=c.getTag());return a},equals:function(a){return this.normal.equals(a.normal)&&this.w==a.w},transform:function(a){var b=a.isMirroring(),d=this.normal.randomNonParallelVector(),f=this.normal.cross(d),k=this.normal.cross(f),d=this.normal.times(this.w),f=d.plus(f),k=d.plus(k),d=d.multiply4x4(a),f=
f.multiply4x4(a),k=k.multiply4x4(a);a=c.Plane.fromVector3Ds(d,f,k);b&&(a=a.flipped());return a},splitPolygon:function(a){var b={type:null,front:null,back:null},d=this.normal,f=a.vertices,k=f.length;if(a.plane.equals(this))b.type=0;else{for(var g=c.Plane.EPSILON,r=this.w,e=!1,h=!1,l=[],m=-g,p=0;p<k;p++){var q=d.dot(f[p].pos)-r,n=0>q;l.push(n);q>g&&(e=!0);q<m&&(h=!0)}if(e||h)if(h)if(e){b.type=4;d=[];g=[];n=l[0];for(r=0;r<k;r++)e=f[r],m=r+1,m>=k&&(m=0),h=l[m],n==h?n?g.push(e):d.push(e):(m=this.splitLineBetweenPoints(e.pos,
f[m].pos),m=new c.Vertex(m),n?(g.push(e),g.push(m),d.push(m)):(d.push(e),d.push(m),g.push(m))),n=h;f=c.Plane.EPSILON*c.Plane.EPSILON;if(3<=g.length)for(k=g[g.length-1],r=0;r<g.length;r++)e=g[r],e.pos.distanceToSquared(k.pos)<f&&(g.splice(r,1),r--),k=e;if(3<=d.length)for(k=d[d.length-1],r=0;r<d.length;r++)e=d[r],e.pos.distanceToSquared(k.pos)<f&&(d.splice(r,1),r--),k=e;3<=d.length&&(b.front=new c.Polygon(d,a.shared,a.plane));3<=g.length&&(b.back=new c.Polygon(g,a.shared,a.plane))}else b.type=3;else b.type=
2;else q=d.dot(a.plane.normal),b.type=0<=q?0:1}return b},splitLineBetweenPoints:function(a,b){var c=b.minus(a),f=(this.w-this.normal.dot(a))/this.normal.dot(c);isNaN(f)&&(f=0);1<f&&(f=1);0>f&&(f=0);return a.plus(c.times(f))},intersectWithLine:function(a){return a.intersectWithPlane(this)},intersectWithPlane:function(a){return c.Line3D.fromPlanes(this,a)},signedDistanceToPoint:function(a){return this.normal.dot(a)-this.w},toString:function(){return"[normal: "+this.normal.toString()+", w: "+this.w+
"]"},mirrorPoint:function(a){var b=this.signedDistanceToPoint(a);return a.minus(this.normal.times(2*b))}};c.Polygon=function(a,b,d){this.vertices=a;b||(b=c.Polygon.defaultShared);this.shared=b;this.plane=3<=arguments.length?d:c.Plane.fromVector3Ds(a[0].pos,a[1].pos,a[2].pos)};c.Polygon.fromObject=function(a){var b=a.vertices.map(function(a){return c.Vertex.fromObject(a)}),d=c.Polygon.Shared.fromObject(a.shared);a=c.Plane.fromObject(a.plane);return new c.Polygon(b,d,a)};c.Polygon.prototype={checkIfConvex:function(){if(!c.Polygon.verticesConvex(this.vertices,
this.plane.normal))throw c.Polygon.verticesConvex(this.vertices,this.plane.normal),Error("Not convex!");},setColor:function(a){this.shared=c.Polygon.Shared.fromColor.apply(this,arguments);return this},getSignedVolume:function(){for(var a=0,b=0;b<this.vertices.length-2;b++)a+=this.vertices[0].pos.dot(this.vertices[b+1].pos.cross(this.vertices[b+2].pos));return a/6},getArea:function(){for(var a=0,b=0;b<this.vertices.length-2;b++)a+=this.vertices[b+1].pos.minus(this.vertices[0].pos).cross(this.vertices[b+
2].pos.minus(this.vertices[b+1].pos)).length();return a/2},getTetraFeatures:function(a){var b=[];a.forEach(function(a){"volume"==a?b.push(this.getSignedVolume()):"area"==a&&b.push(this.getArea())},this);return b},extrude:function(a){var b=[],d=this;0<d.plane.normal.dot(a)&&(d=d.flipped());b.push(d);a=d.translate(a);for(var f=this.vertices.length,k=0;k<f;k++){var g=[],e=k<f-1?k+1:0;g.push(d.vertices[k].pos);g.push(a.vertices[k].pos);g.push(a.vertices[e].pos);g.push(d.vertices[e].pos);g=c.Polygon.createFromPoints(g,
this.shared);b.push(g)}a=a.flipped();b.push(a);return c.fromPolygons(b)},translate:function(a){return this.transform(c.Matrix4x4.translation(a))},boundingSphere:function(){if(!this.cachedBoundingSphere){var a=this.boundingBox(),b=a[0].plus(a[1]).times(.5),a=a[1].minus(b).length();this.cachedBoundingSphere=[b,a]}return this.cachedBoundingSphere},boundingBox:function(){if(!this.cachedBoundingBox){var a,b,d=this.vertices,f=d.length;b=a=0===f?new c.Vector3D(0,0,0):d[0].pos;for(var k=1;k<f;k++){var g=
d[k].pos;a=a.min(g);b=b.max(g)}this.cachedBoundingBox=[a,b]}return this.cachedBoundingBox},flipped:function(){var a=this.vertices.map(function(a){return a.flipped()});a.reverse();var b=this.plane.flipped();return new c.Polygon(a,this.shared,b)},transform:function(a){var b=this.vertices.map(function(b){return b.transform(a)}),d=this.plane.transform(a);a.isMirroring()&&b.reverse();return new c.Polygon(b,this.shared,d)},toString:function(){var a="Polygon plane: "+this.plane.toString()+"\n";this.vertices.map(function(b){a+=
"  "+b.toString()+"\n"});return a},projectToOrthoNormalBasis:function(a){var b=this.vertices.map(function(b){return a.to2D(b.pos)}),b=m.fromPointsNoCheck(b),c=b.area();1E-5>Math.abs(c)?b=new m:0>c&&(b=b.flipped());return b},solidFromSlices:function(a){var b=[],d=null,f=null,k=null,g=null,e=2,h=!1,u,l=null;a&&(h=Boolean(a.loop),a.numslices&&(e=a.numslices),a.callback&&(u=a.callback));if(!u){var m=new c.Polygon.createFromPoints([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]);u=function(a,b){return 0==a||1==a?m.translate([0,
0,a]):null}}a=0;for(--e;a<=e;a++)if(d=u.call(this,a/e,a)){if(!(d instanceof c.Polygon))throw Error("CSG.Polygon.solidFromSlices callback error: CSG.Polygon expected");d.checkIfConvex();f?(null===l&&(l=0>f.plane.signedDistanceToPoint(d.vertices[0].pos)),this._addWalls(b,f,d,l)):k=d;f=d}g=d;h?k.vertices.length==g.vertices.length&&k.vertices.every(function(a,b){return a.pos.equals(g.vertices[b].pos)})||this._addWalls(b,g,k,l):(b.unshift(l?k:k.flipped()),b.push(l?g.flipped():g));return c.fromPolygons(b)},
_addWalls:function(a,b,d,f){b=b.vertices.slice(0);var k=d.vertices.slice(0);d=d.shared||null;b[0].pos.equals(b[b.length-1].pos)||b.push(b[0]);k[0].pos.equals(k[k.length-1].pos)||k.push(k[0]);f&&(b=b.reverse(),k=k.reverse());f=k.length-1;for(var g=b.length-1,e=f-g,h=0<e,u=0>e,l=[],e=Math.abs(e);0<e;e--)l.push({len:Infinity,index:-1});var m;if(u)for(e=0;e<g;e++){m=b[e].pos.distanceToSquared(b[e+1].pos);for(var p=l.length-1;0<=p;p--)if(l[p].len>m){l[p].len=m;l.index=p;break}}else if(h)for(e=0;e<f;e++)for(m=
k[e].pos.distanceToSquared(k[e+1].pos),p=l.length-1;0<=p;p--)if(l[p].len>m){l[p].len=m;l.index=p;break}l.sort(n);e=b[0];m=k[0];for(var q,F,A=p=0,t=f+g;p+A<t;){if(l.length)if(h&&A==l[0].index){q=k[++A];a.push(new c.Polygon([q,m,e],d));m=q;l.shift();continue}else if(u&&p==l[0].index){q=b[++p];a.push(new c.Polygon([m,e,q],d));e=q;l.shift();continue}q=p<g?m.pos.distanceToSquared(b[p+1].pos):Infinity;F=A<f?e.pos.distanceToSquared(k[A+1].pos):Infinity;q<=F?(q=b[++p],a.push(new c.Polygon([m,e,q],d)),e=q):
A<f&&(q=k[++A],a.push(new c.Polygon([q,m,e],d)),m=q)}return a}};c.Polygon.verticesConvex=function(a,b){var d=a.length;if(2<d)for(var f=a[d-2].pos,k=a[d-1].pos,g=0;g<d;g++){var e=a[g].pos;if(!c.Polygon.isConvexPoint(f,k,e,b))return!1;f=k;k=e}return!0};c.Polygon.createFromPoints=function(a,b,d){3>arguments.length&&new c.Vector3D(0,0,0);var f=[];a.map(function(a){a=new c.Vector3D(a);a=new c.Vertex(a);f.push(a)});return 3>arguments.length?new c.Polygon(f,b):new c.Polygon(f,b,d)};c.Polygon.isConvexPoint=
function(a,b,c,f){return 0<=b.minus(a).cross(c.minus(b)).dot(f)};c.Polygon.isStrictlyConvexPoint=function(a,b,c,f){return 1E-5<=b.minus(a).cross(c.minus(b)).dot(f)};c.Polygon.Shared=function(a){if(null!==a&&4!=a.length)throw Error("Expecting 4 element array");this.color=a};c.Polygon.Shared.fromObject=function(a){return new c.Polygon.Shared(a.color)};c.Polygon.Shared.fromColor=function(a){var b;if(1==arguments.length)b=arguments[0].slice();else{b=[];for(var d=0;d<arguments.length;d++)b.push(arguments[d])}if(3==
b.length)b.push(1);else if(4!=b.length)throw Error("setColor expects either an array with 3 or 4 elements, or 3 or 4 parameters.");return new c.Polygon.Shared(b)};c.Polygon.Shared.prototype={getTag:function(){var a=this.tag;a||(this.tag=a=c.getTag());return a},getHash:function(){return this.color?this.color.join("/"):"null"}};c.Polygon.defaultShared=new c.Polygon.Shared(null);c.PolygonTreeNode=function(){this.parent=null;this.children=[];this.polygon=null;this.removed=!1};c.PolygonTreeNode.prototype=
{addPolygons:function(a){if(!this.isRootNode())throw Error("Assertion failed");var b=this;a.map(function(a){b.addChild(a)})},remove:function(){if(!this.removed){this.removed=!0;var a=this.parent.children,b=a.indexOf(this);if(0>b)throw Error("Assertion failed");a.splice(b,1);this.parent.recursivelyInvalidatePolygon()}},isRemoved:function(){return this.removed},isRootNode:function(){return!this.parent},invert:function(){if(!this.isRootNode())throw Error("Assertion failed");this.invertSub()},getPolygon:function(){if(!this.polygon)throw Error("Assertion failed");
return this.polygon},getPolygons:function(a){var b=[this],c=[b],f,k,g,e;for(f=0;f<c.length;++f)for(b=c[f],k=0,g=b.length;k<g;k++)e=b[k],e.polygon?a.push(e.polygon):c.push(e.children)},splitByPlane:function(a,b,c,f,k){if(this.children.length){var g=[this.children],e,h,l,m,n;for(e=0;e<g.length;e++)for(n=g[e],h=0,l=n.length;h<l;h++)m=n[h],m.children.length?g.push(m.children):m._splitByPlane(a,b,c,f,k)}else this._splitByPlane(a,b,c,f,k)},_splitByPlane:function(a,b,c,f,k){var g=this.polygon;if(g){var e=
g.boundingSphere(),h=e[1]+1E-4,e=a.normal.dot(e[0])-a.w;if(e>h)f.push(this);else if(e<-h)k.push(this);else switch(a=a.splitPolygon(g),a.type){case 0:b.push(this);break;case 1:c.push(this);break;case 2:f.push(this);break;case 3:k.push(this);break;case 4:a.front&&(b=this.addChild(a.front),f.push(b)),a.back&&(f=this.addChild(a.back),k.push(f))}}},addChild:function(a){var b=new c.PolygonTreeNode;b.parent=this;b.polygon=a;this.children.push(b);return b},invertSub:function(){var a=[this],b=[a],c,f,k,g;
for(c=0;c<b.length;c++)for(a=b[c],f=0,k=a.length;f<k;f++)g=a[f],g.polygon&&(g.polygon=g.polygon.flipped()),b.push(g.children)},recursivelyInvalidatePolygon:function(){for(var a=this;a.polygon;)a.polygon=null,a.parent&&(a=a.parent)}};c.Tree=function(a){this.polygonTree=new c.PolygonTreeNode;this.rootnode=new c.Node(null);a&&this.addPolygons(a)};c.Tree.prototype={invert:function(){this.polygonTree.invert();this.rootnode.invert()},clipTo:function(a,b){this.rootnode.clipTo(a,b?!0:!1)},allPolygons:function(){var a=
[];this.polygonTree.getPolygons(a);return a},addPolygons:function(a){var b=this;a=a.map(function(a){return b.polygonTree.addChild(a)});this.rootnode.addPolygonTreeNodes(a)}};c.Node=function(a){this.back=this.front=this.plane=null;this.polygontreenodes=[];this.parent=a};c.Node.prototype={invert:function(){var a=[this],b,c;for(b=0;b<a.length;b++){c=a[b];c.plane&&(c.plane=c.plane.flipped());c.front&&a.push(c.front);c.back&&a.push(c.back);var f=c.front;c.front=c.back;c.back=f}},clipPolygons:function(a,
b){var c={node:this,polygontreenodes:a},f,k=[];do{f=c.node;a=c.polygontreenodes;if(f.plane){for(var c=[],g=[],e=b?c:g,h=f.plane,l=a.length,m=0;m<l;m++){var n=a[m];n.isRemoved()||n.splitByPlane(h,e,c,g,c)}f.front&&0<g.length&&k.push({node:f.front,polygontreenodes:g});g=c.length;if(f.back&&0<g)k.push({node:f.back,polygontreenodes:c});else for(var m=0;m<g;m++)c[m].remove()}c=k.pop()}while("undefined"!==typeof c)},clipTo:function(a,b){var c=this,f=[];do 0<c.polygontreenodes.length&&a.rootnode.clipPolygons(c.polygontreenodes,
b),c.front&&f.push(c.front),c.back&&f.push(c.back),c=f.pop();while("undefined"!==typeof c)},addPolygonTreeNodes:function(a){a={node:this,polygontreenodes:a};var b,d=[];do{b=a.node;a=a.polygontreenodes;if(0!==a.length){var f=b;if(!b.plane){var k=a[0].getPolygon().plane;b.plane=k}for(var k=[],g=[],e=0,h=a.length;e<h;++e)a[e].splitByPlane(f.plane,f.polygontreenodes,g,k,g);0<k.length&&(b.front||(b.front=new c.Node(b)),d.push({node:b.front,polygontreenodes:k}));0<g.length&&(b.back||(b.back=new c.Node(b)),
d.push({node:b.back,polygontreenodes:g}))}a=d.pop()}while("undefined"!==typeof a)},getParentPlaneNormals:function(a,b){0<b&&this.parent&&(a.push(this.parent.plane.normal),this.parent.getParentPlaneNormals(a,b-1))}};c.Matrix4x4=function(a){this.elements=1<=arguments.length?a:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};c.Matrix4x4.prototype={plus:function(a){for(var b=[],d=0;16>d;d++)b[d]=this.elements[d]+a.elements[d];return new c.Matrix4x4(b)},minus:function(a){for(var b=[],d=0;16>d;d++)b[d]=this.elements[d]-
a.elements[d];return new c.Matrix4x4(b)},multiply:function(a){var b=this.elements[0],d=this.elements[1],f=this.elements[2],k=this.elements[3],g=this.elements[4],e=this.elements[5],h=this.elements[6],l=this.elements[7],m=this.elements[8],n=this.elements[9],p=this.elements[10],q=this.elements[11],F=this.elements[12],A=this.elements[13],t=this.elements[14],B=this.elements[15],C=a.elements[0],v=a.elements[1],w=a.elements[2],y=a.elements[3],D=a.elements[4],E=a.elements[5],G=a.elements[6],H=a.elements[7],
J=a.elements[8],K=a.elements[9],M=a.elements[10],L=a.elements[11],N=a.elements[12],O=a.elements[13],P=a.elements[14];a=a.elements[15];var I=[];I[0]=b*C+d*D+f*J+k*N;I[1]=b*v+d*E+f*K+k*O;I[2]=b*w+d*G+f*M+k*P;I[3]=b*y+d*H+f*L+k*a;I[4]=g*C+e*D+h*J+l*N;I[5]=g*v+e*E+h*K+l*O;I[6]=g*w+e*G+h*M+l*P;I[7]=g*y+e*H+h*L+l*a;I[8]=m*C+n*D+p*J+q*N;I[9]=m*v+n*E+p*K+q*O;I[10]=m*w+n*G+p*M+q*P;I[11]=m*y+n*H+p*L+q*a;I[12]=F*C+A*D+t*J+B*N;I[13]=F*v+A*E+t*K+B*O;I[14]=F*w+A*G+t*M+B*P;I[15]=F*y+A*H+t*L+B*a;return new c.Matrix4x4(I)},
clone:function(){var a=this.elements.map(function(a){return a});return new c.Matrix4x4(a)},rightMultiply1x3Vector:function(a){var b=a._x,d=a._y,f=a._z;a=b*this.elements[0]+d*this.elements[1]+f*this.elements[2]+1*this.elements[3];var k=b*this.elements[4]+d*this.elements[5]+f*this.elements[6]+1*this.elements[7],g=b*this.elements[8]+d*this.elements[9]+f*this.elements[10]+1*this.elements[11],b=b*this.elements[12]+d*this.elements[13]+f*this.elements[14]+1*this.elements[15];1!=b&&(b=1/b,a*=b,k*=b,g*=b);
return new c.Vector3D(a,k,g)},leftMultiply1x3Vector:function(a){var b=a._x,d=a._y,f=a._z;a=b*this.elements[0]+d*this.elements[4]+f*this.elements[8]+1*this.elements[12];var k=b*this.elements[1]+d*this.elements[5]+f*this.elements[9]+1*this.elements[13],g=b*this.elements[2]+d*this.elements[6]+f*this.elements[10]+1*this.elements[14],b=b*this.elements[3]+d*this.elements[7]+f*this.elements[11]+1*this.elements[15];1!=b&&(b=1/b,a*=b,k*=b,g*=b);return new c.Vector3D(a,k,g)},rightMultiply1x2Vector:function(a){var b=
a.x,d=a.y;a=b*this.elements[0]+d*this.elements[1]+0*this.elements[2]+1*this.elements[3];var f=b*this.elements[4]+d*this.elements[5]+0*this.elements[6]+1*this.elements[7],b=b*this.elements[12]+d*this.elements[13]+0*this.elements[14]+1*this.elements[15];1!=b&&(b=1/b,a*=b,f*=b);return new c.Vector2D(a,f)},leftMultiply1x2Vector:function(a){var b=a.x,d=a.y;a=b*this.elements[0]+d*this.elements[4]+0*this.elements[8]+1*this.elements[12];var f=b*this.elements[1]+d*this.elements[5]+0*this.elements[9]+1*this.elements[13],
b=b*this.elements[3]+d*this.elements[7]+0*this.elements[11]+1*this.elements[15];1!=b&&(b=1/b,a*=b,f*=b);return new c.Vector2D(a,f)},isMirroring:function(){var a=new c.Vector3D(this.elements[0],this.elements[4],this.elements[8]),b=new c.Vector3D(this.elements[1],this.elements[5],this.elements[9]),d=new c.Vector3D(this.elements[2],this.elements[6],this.elements[10]);return 0>a.cross(b).dot(d)}};c.Matrix4x4.unity=function(){return new c.Matrix4x4};c.Matrix4x4.rotationX=function(a){var b=1/180*Math.PI*
a;a=Math.cos(b);b=Math.sin(b);return new c.Matrix4x4([1,0,0,0,0,a,b,0,0,-b,a,0,0,0,0,1])};c.Matrix4x4.rotationY=function(a){var b=1/180*Math.PI*a;a=Math.cos(b);b=Math.sin(b);return new c.Matrix4x4([a,0,-b,0,0,1,0,0,b,0,a,0,0,0,0,1])};c.Matrix4x4.rotationZ=function(a){var b=1/180*Math.PI*a;a=Math.cos(b);b=Math.sin(b);return new c.Matrix4x4([a,b,0,0,-b,a,0,0,0,0,1,0,0,0,0,1])};c.Matrix4x4.rotation=function(a,b,d){a=new c.Vector3D(a);b=new c.Vector3D(b);b=c.Plane.fromNormalAndPoint(b,a);b=new c.OrthoNormalBasis(b);
var f=c.Matrix4x4.translation(a.negated()),f=f.multiply(b.getProjectionMatrix()),f=f.multiply(c.Matrix4x4.rotationZ(d)),f=f.multiply(b.getInverseProjectionMatrix());return f=f.multiply(c.Matrix4x4.translation(a))};c.Matrix4x4.translation=function(a){a=new c.Vector3D(a);return new c.Matrix4x4([1,0,0,0,0,1,0,0,0,0,1,0,a.x,a.y,a.z,1])};c.Matrix4x4.mirroring=function(a){var b=a.normal.x,d=a.normal.y,f=a.normal.z;a=a.w;return new c.Matrix4x4([1-2*b*b,-2*d*b,-2*f*b,0,-2*b*d,1-2*d*d,-2*f*d,0,-2*b*f,-2*d*
f,1-2*f*f,0,-2*b*a,-2*d*a,-2*f*a,1])};c.Matrix4x4.scaling=function(a){a=new c.Vector3D(a);return new c.Matrix4x4([a.x,0,0,0,0,a.y,0,0,0,0,a.z,0,0,0,0,1])};c.Vector2D=function(a,b){if(2==arguments.length)this._x=parseFloat(a),this._y=parseFloat(b);else{var d=!0;if(1==arguments.length)if("object"==typeof a)a instanceof c.Vector2D?(this._x=a._x,this._y=a._y):a instanceof Array?(this._x=parseFloat(a[0]),this._y=parseFloat(a[1])):"x"in a&&"y"in a?(this._x=parseFloat(a.x),this._y=parseFloat(a.y)):d=!1;
else{var f=parseFloat(a);this._y=this._x=f}else d=!1;d&&(c.IsFloat(this._x)&&c.IsFloat(this._y)||(d=!1));if(!d)throw Error("wrong arguments");}};c.Vector2D.fromAngle=function(a){return c.Vector2D.fromAngleRadians(a)};c.Vector2D.fromAngleDegrees=function(a){return c.Vector2D.fromAngleRadians(Math.PI*a/180)};c.Vector2D.fromAngleRadians=function(a){return c.Vector2D.Create(Math.cos(a),Math.sin(a))};c.Vector2D.Create=function(a,b){var d=Object.create(c.Vector2D.prototype);d._x=a;d._y=b;return d};c.Vector2D.prototype=
{get x(){return this._x},get y(){return this._y},set x(a){throw Error("Vector2D is immutable");},set y(a){throw Error("Vector2D is immutable");},toVector3D:function(a){return new c.Vector3D(this._x,this._y,a)},equals:function(a){return this._x==a._x&&this._y==a._y},clone:function(){return c.Vector2D.Create(this._x,this._y)},negated:function(){return c.Vector2D.Create(-this._x,-this._y)},plus:function(a){return c.Vector2D.Create(this._x+a._x,this._y+a._y)},minus:function(a){return c.Vector2D.Create(this._x-
a._x,this._y-a._y)},times:function(a){return c.Vector2D.Create(this._x*a,this._y*a)},dividedBy:function(a){return c.Vector2D.Create(this._x/a,this._y/a)},dot:function(a){return this._x*a._x+this._y*a._y},lerp:function(a,b){return this.plus(a.minus(this).times(b))},length:function(){return Math.sqrt(this.dot(this))},distanceTo:function(a){return this.minus(a).length()},distanceToSquared:function(a){return this.minus(a).lengthSquared()},lengthSquared:function(){return this.dot(this)},unit:function(){return this.dividedBy(this.length())},
cross:function(a){return this._x*a._y-this._y*a._x},normal:function(){return c.Vector2D.Create(this._y,-this._x)},multiply4x4:function(a){return a.leftMultiply1x2Vector(this)},transform:function(a){return a.leftMultiply1x2Vector(this)},angle:function(){return this.angleRadians()},angleDegrees:function(){return 180*this.angleRadians()/Math.PI},angleRadians:function(){return Math.atan2(this._y,this._x)},min:function(a){return c.Vector2D.Create(Math.min(this._x,a._x),Math.min(this._y,a._y))},max:function(a){return c.Vector2D.Create(Math.max(this._x,
a._x),Math.max(this._y,a._y))},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+")"},abs:function(){return c.Vector2D.Create(Math.abs(this._x),Math.abs(this._y))}};c.Line2D=function(a,b){a=new c.Vector2D(a);b=parseFloat(b);var d=a.length();b*=d;this.normal=a=a.times(1/d);this.w=b};c.Line2D.fromPoints=function(a,b){a=new c.Vector2D(a);b=new c.Vector2D(b);var d=b.minus(a).normal().negated().unit(),f=a.dot(d);return new c.Line2D(d,f)};c.Line2D.prototype={reverse:function(){return new c.Line2D(this.normal.negated(),
-this.w)},equals:function(a){return a.normal.equals(this.normal)&&a.w==this.w},origin:function(){return this.normal.times(this.w)},direction:function(){return this.normal.normal()},xAtY:function(a){return(this.w-this.normal._y*a)/this.normal.x},absDistanceToPoint:function(a){a=new c.Vector2D(a);a=a.dot(this.normal);return Math.abs(a-this.w)},intersectWithLine:function(a){a=c.solve2Linear(this.normal.x,this.normal.y,a.normal.x,a.normal.y,this.w,a.w);return a=new c.Vector2D(a)},transform:function(a){var b=
new c.Vector2D(0,0),d=this.normal.times(this.w),b=b.multiply4x4(a),b=this.normal.multiply4x4(a).minus(b);a=d.multiply4x4(a);a=b.dot(a);return new c.Line2D(b,a)}};c.Line3D=function(a,b){a=new c.Vector3D(a);b=new c.Vector3D(b);this.point=a;this.direction=b.unit()};c.Line3D.fromPoints=function(a,b){a=new c.Vector3D(a);b=new c.Vector3D(b);var d=b.minus(a);return new c.Line3D(a,d)};c.Line3D.fromPlanes=function(a,b){var d=a.normal.cross(b.normal),f=d.length();if(1E-10>f)throw Error("Parallel planes");var d=
d.times(1/f),f=Math.abs(d.x),k=Math.abs(d.y),g=Math.abs(d.z);f>=k&&f>=g?(f=c.solve2Linear(a.normal.y,a.normal.z,b.normal.y,b.normal.z,a.w,b.w),f=new c.Vector3D(0,f[0],f[1])):k>=f&&k>=g?(f=c.solve2Linear(a.normal.x,a.normal.z,b.normal.x,b.normal.z,a.w,b.w),f=new c.Vector3D(f[0],0,f[1])):(f=c.solve2Linear(a.normal.x,a.normal.y,b.normal.x,b.normal.y,a.w,b.w),f=new c.Vector3D(f[0],f[1],0));return new c.Line3D(f,d)};c.Line3D.prototype={intersectWithPlane:function(a){a=(a.w-a.normal.dot(this.point))/a.normal.dot(this.direction);
return this.point.plus(this.direction.times(a))},clone:function(a){return new c.Line3D(this.point.clone(),this.direction.clone())},reverse:function(){return new c.Line3D(this.point.clone(),this.direction.negated())},transform:function(a){var b=this.point.multiply4x4(a);a=this.point.plus(this.direction).multiply4x4(a).minus(b);return new c.Line3D(b,a)},closestPointOnLine:function(a){a=new c.Vector3D(a);a=a.minus(this.point).dot(this.direction)/this.direction.dot(this.direction);return this.point.plus(this.direction.times(a))},
distanceToPoint:function(a){a=new c.Vector3D(a);var b=this.closestPointOnLine(a);return a.minus(b).length()},equals:function(a){return!this.direction.equals(a.direction)||1E-8<this.distanceToPoint(a.point)?!1:!0}};c.OrthoNormalBasis=function(a,b){b=2>arguments.length?a.normal.randomNonParallelVector():new c.Vector3D(b);this.v=a.normal.cross(b).unit();this.u=this.v.cross(a.normal);this.plane=a;this.planeorigin=a.normal.times(a.w)};c.OrthoNormalBasis.GetCartesian=function(a,b){var d=a+"/"+b,f;if("X/Y"==
d)d=[0,0,1],f=[1,0,0];else if("Y/-X"==d)d=[0,0,1],f=[0,1,0];else if("-X/-Y"==d)d=[0,0,1],f=[-1,0,0];else if("-Y/X"==d)d=[0,0,1],f=[0,-1,0];else if("-X/Y"==d)d=[0,0,-1],f=[-1,0,0];else if("-Y/-X"==d)d=[0,0,-1],f=[0,-1,0];else if("X/-Y"==d)d=[0,0,-1],f=[1,0,0];else if("Y/X"==d)d=[0,0,-1],f=[0,1,0];else if("X/Z"==d)d=[0,-1,0],f=[1,0,0];else if("Z/-X"==d)d=[0,-1,0],f=[0,0,1];else if("-X/-Z"==d)d=[0,-1,0],f=[-1,0,0];else if("-Z/X"==d)d=[0,-1,0],f=[0,0,-1];else if("-X/Z"==d)d=[0,1,0],f=[-1,0,0];else if("-Z/-X"==
d)d=[0,1,0],f=[0,0,-1];else if("X/-Z"==d)d=[0,1,0],f=[1,0,0];else if("Z/X"==d)d=[0,1,0],f=[0,0,1];else if("Y/Z"==d)d=[1,0,0],f=[0,1,0];else if("Z/-Y"==d)d=[1,0,0],f=[0,0,1];else if("-Y/-Z"==d)d=[1,0,0],f=[0,-1,0];else if("-Z/Y"==d)d=[1,0,0],f=[0,0,-1];else if("-Y/Z"==d)d=[-1,0,0],f=[0,-1,0];else if("-Z/-Y"==d)d=[-1,0,0],f=[0,0,-1];else if("Y/-Z"==d)d=[-1,0,0],f=[0,1,0];else if("Z/Y"==d)d=[-1,0,0],f=[0,0,1];else throw Error("CSG.OrthoNormalBasis.GetCartesian: invalid combination of axis identifiers. Should pass two string arguments from [X,Y,Z,-X,-Y,-Z], being two different axes.");
return new c.OrthoNormalBasis(new c.Plane(new c.Vector3D(d),0),new c.Vector3D(f))};c.OrthoNormalBasis.Z0Plane=function(){var a=new c.Plane(new c.Vector3D([0,0,1]),0);return new c.OrthoNormalBasis(a,new c.Vector3D([1,0,0]))};c.OrthoNormalBasis.prototype={getProjectionMatrix:function(){return new c.Matrix4x4([this.u.x,this.v.x,this.plane.normal.x,0,this.u.y,this.v.y,this.plane.normal.y,0,this.u.z,this.v.z,this.plane.normal.z,0,0,0,-this.plane.w,1])},getInverseProjectionMatrix:function(){var a=this.plane.normal.times(this.plane.w);
return new c.Matrix4x4([this.u.x,this.u.y,this.u.z,0,this.v.x,this.v.y,this.v.z,0,this.plane.normal.x,this.plane.normal.y,this.plane.normal.z,0,a.x,a.y,a.z,1])},to2D:function(a){return new c.Vector2D(a.dot(this.u),a.dot(this.v))},to3D:function(a){return this.planeorigin.plus(this.u.times(a.x)).plus(this.v.times(a.y))},line3Dto2D:function(a){var b=a.point;a=a.direction.plus(b);b=this.to2D(b);a=this.to2D(a);return c.Line2D.fromPoints(b,a)},line2Dto3D:function(a){var b=a.origin();a=a.direction().plus(b);
b=this.to3D(b);a=this.to3D(a);return c.Line3D.fromPoints(b,a)},transform:function(a){var b=this.plane.transform(a),d=this.u.transform(a);a=(new c.Vector3D(0,0,0)).transform(a);d=d.minus(a);return new c.OrthoNormalBasis(b,d)}};c.interpolateBetween2DPointsForY=function(a,b,c){c-=a.y;var f=b.y-a.y;0>f&&(c=-c,f=-f);return a.x+(0>=c?0:c>=f?1:1E-10>f?.5:c/f)*(b.x-a.x)};c.reTesselateCoplanarPolygons=function(a,b){var d=a.length;if(0<d){for(var f=a[0].plane,k=a[0].shared,g=new c.OrthoNormalBasis(f),e=[],
m=[],u={},n={},x={},p=1/1E-5*10,q=0;q<d;q++){var F=a[q],A=[],t=F.vertices.length,B=-1;if(0<t){for(var C,v,w=0;w<t;w++){var y=g.to2D(F.vertices[w].pos),D=Math.floor(y.y*p),E;D in x?E=x[D]:D+1 in x?E=x[D+1]:D-1 in x?E=x[D-1]:(E=y.y,x[D]=y.y);y=c.Vector2D.Create(y.x,E);A.push(y);y=y.y;if(0===w||y<C)C=y,B=w;if(0===w||y>v)v=y;y in n||(n[y]={});n[y][q]=!0}C>=v?(A=[],t=0,B=-1):(C in u||(u[C]=[]),u[C].push(q))}A.reverse();B=t-B-1;e.push(A);m.push(B)}var d=[],G;for(G in n)d.push(G);d.sort(h);x=[];p=[];for(F=
0;F<d.length;F++){B=[];D=d[F];G=Number(D);C=n[D];for(E=0;E<x.length;++E)if(w=x[E],q=w.polygonindex,C[q]){for(var A=e[q],t=A.length,q=w.leftvertexindex,H=w.rightvertexindex;;){v=q+1;v>=t&&(v=0);if(A[v].y!=G)break;q=v}y=H-1;0>y&&(y=t-1);A[y].y==G&&(H=y);q!=w.leftvertexindex&&q==H?(x.splice(E,1),--E):(w.leftvertexindex=q,w.rightvertexindex=H,w.topleft=A[q],w.topright=A[H],v=q+1,v>=t&&(v=0),w.bottomleft=A[v],y=H-1,0>y&&(y=t-1),w.bottomright=A[y])}if(F>=d.length-1)x=[],C=null;else{C=Number(d[F+1]);var J=
.5*(G+C),D=u[D],K;for(K in D){q=D[K];A=e[q];t=A.length;for(E=v=m[q];;){w=E+1;w>=t&&(w=0);if(A[w].y!=G)break;if(w==v)break;E=w}for(H=v;;){w=H-1;0>w&&(w=t-1);if(A[w].y!=G)break;if(w==E)break;H=w}v=E+1;v>=t&&(v=0);y=H-1;0>y&&(y=t-1);l(x,{polygonindex:q,leftvertexindex:E,rightvertexindex:H,topleft:A[E],topright:A[H],bottomleft:A[v],bottomright:A[y]},function(a,b){var d=c.interpolateBetween2DPointsForY(a.topleft,a.bottomleft,J),f=c.interpolateBetween2DPointsForY(b.topleft,b.bottomleft,J);return d>f?1:
d<f?-1:0})}}for(var M in x)w=x[M],q=w.polygonindex,A=e[q],t=A.length,v=c.interpolateBetween2DPointsForY(w.topleft,w.bottomleft,G),A=c.Vector2D.Create(v,G),v=c.interpolateBetween2DPointsForY(w.topright,w.bottomright,G),t=c.Vector2D.Create(v,G),v=c.interpolateBetween2DPointsForY(w.topleft,w.bottomleft,C),q=c.Vector2D.Create(v,C),v=c.interpolateBetween2DPointsForY(w.topright,w.bottomright,C),w=c.Vector2D.Create(v,C),w={topleft:A,topright:t,bottomleft:q,bottomright:w,leftline:c.Line2D.fromPoints(A,q),
rightline:c.Line2D.fromPoints(w,t)},0<B.length&&(q=B[B.length-1],A=w.topleft.distanceTo(q.topright),t=w.bottomleft.distanceTo(q.bottomright),1E-5>A&&1E-5>t&&(w.topleft=q.topleft,w.leftline=q.leftline,w.bottomleft=q.bottomleft,B.splice(B.length-1,1))),B.push(w);if(0<F){G={};C={};for(w=0;w<B.length;w++)for(v=B[w],q=0;q<p.length;q++)if(!C[q]&&(y=p[q],1E-5>y.bottomleft.distanceTo(v.topleft)&&1E-5>y.bottomright.distanceTo(v.topright))){C[q]=!0;A=v.leftline.direction().x-y.leftline.direction().x;t=v.rightline.direction().x-
y.rightline.direction().x;D=1E-5>Math.abs(A);t=(E=1E-5>Math.abs(t))||0<=t;(D||0<=A)&&t&&(v.outpolygon=y.outpolygon,v.leftlinecontinues=D,v.rightlinecontinues=E,G[q]=!0);break}for(q=0;q<p.length;q++)if(!G[q]){y=p[q];y.outpolygon.rightpoints.push(y.bottomright);1E-5<y.bottomright.distanceTo(y.bottomleft)&&y.outpolygon.leftpoints.push(y.bottomleft);y.outpolygon.leftpoints.reverse();var L=[];y.outpolygon.rightpoints.concat(y.outpolygon.leftpoints).map(function(a){a=g.to3D(a);a=new c.Vertex(a);L.push(a)});
w=new c.Polygon(L,k,f);b.push(w)}}for(w=0;w<B.length;w++)v=B[w],v.outpolygon?(v.leftlinecontinues||v.outpolygon.leftpoints.push(v.topleft),v.rightlinecontinues||v.outpolygon.rightpoints.push(v.topright)):(v.outpolygon={leftpoints:[],rightpoints:[]},v.outpolygon.leftpoints.push(v.topleft),1E-5<v.topleft.distanceTo(v.topright)&&v.outpolygon.rightpoints.push(v.topright));p=B}}};c.fuzzyFactory=function(a,b){this.lookuptable={};this.multiplier=1/b};c.fuzzyFactory.prototype={lookupOrCreate:function(a,b){var c=
"",f=this.multiplier;a.forEach(function(a){a=Math.round(a*f);c+=a+"/"});if(c in this.lookuptable)return this.lookuptable[c];for(var k=b(a),g=a.map(function(a){a=Math.floor(a*f);return[""+a+"/",""+(a+1)+"/"]}),e=1<<a.length,h=0;h<e;++h){var m=h,c="";g.forEach(function(a){c+=a[m&1];m>>=1});this.lookuptable[c]=k}return k}};c.fuzzyCSGFactory=function(){this.vertexfactory=new c.fuzzyFactory(3,1E-5);this.planefactory=new c.fuzzyFactory(4,1E-5);this.polygonsharedfactory={}};c.fuzzyCSGFactory.prototype={getPolygonShared:function(a){var b=
a.getHash();return b in this.polygonsharedfactory?this.polygonsharedfactory[b]:this.polygonsharedfactory[b]=a},getVertex:function(a){return this.vertexfactory.lookupOrCreate([a.pos._x,a.pos._y,a.pos._z],function(b){return a})},getPlane:function(a){return this.planefactory.lookupOrCreate([a.normal._x,a.normal._y,a.normal._z,a.w],function(b){return a})},getPolygon:function(a){var b=this.getPlane(a.plane),d=this.getPolygonShared(a.shared),f=this;a=a.vertices.map(function(a){return f.getVertex(a)});var k=
[];if(0<a.length){var g=a[a.length-1].getTag();a.forEach(function(a){var b=a.getTag();b!=g&&k.push(a);g=b})}3>k.length&&(k=[]);return new c.Polygon(k,d,b)},getCSG:function(a){var b=this,d=[];a.polygons.forEach(function(a){a=b.getPolygon(a);3<=a.vertices.length&&d.push(a)});return c.fromPolygons(d)}};c.staticTag=1;c.getTag=function(){return c.staticTag++};c.Properties=function(){};c.Properties.prototype={_transform:function(a){var b=new c.Properties;c.Properties.transformObj(this,b,a);return b},_merge:function(a){var b=
new c.Properties;c.Properties.cloneObj(this,b);c.Properties.addFrom(b,a);return b}};c.Properties.transformObj=function(a,b,d){for(var f in a)if("_transform"!=f&&"_merge"!=f){var k=a[f],g=k;"object"==typeof k&&("transform"in k&&"function"==typeof k.transform?g=k.transform(d):k instanceof Array?(g=[],c.Properties.transformObj(k,g,d)):k instanceof c.Properties&&(g=new c.Properties,c.Properties.transformObj(k,g,d)));b[f]=g}};c.Properties.cloneObj=function(a,b){for(var d in a)if("_transform"!=d&&"_merge"!=
d){var f=a[d],k=f;if("object"==typeof f)if(f instanceof Array)for(var k=[],g=0;g<f.length;g++)k.push(f[g]);else f instanceof c.Properties&&(k=new c.Properties,c.Properties.cloneObj(f,k));b[d]=k}};c.Properties.addFrom=function(a,b){for(var d in b)"_transform"!=d&&"_merge"!=d&&(d in a&&"object"==typeof a[d]&&a[d]instanceof c.Properties&&"object"==typeof b[d]&&b[d]instanceof c.Properties?c.Properties.addFrom(a[d],b[d]):d in a||(a[d]=b[d]))};c.Connector=function(a,b,d){this.point=new c.Vector3D(a);this.axisvector=
(new c.Vector3D(b)).unit();this.normalvector=(new c.Vector3D(d)).unit()};c.Connector.prototype={normalized:function(){var a=this.axisvector.unit(),b=this.normalvector.cross(a).unit(),b=a.cross(b);return new c.Connector(this.point,a,b)},transform:function(a){var b=this.point.multiply4x4(a),d=this.point.plus(this.axisvector).multiply4x4(a).minus(b);a=this.point.plus(this.normalvector).multiply4x4(a).minus(b);return new c.Connector(b,d,a)},getTransformationTo:function(a,b,d){b=b?!0:!1;d=d?Number(d):
0;var f=this.normalized();a=a.normalized();var k=c.Matrix4x4.translation(this.point.negated()),g=c.Plane.anyPlaneFromVector3Ds(new c.Vector3D(0,0,0),f.axisvector,a.axisvector),g=new c.OrthoNormalBasis(g),e=g.to2D(f.axisvector).angle(),h=g.to2D(a.axisvector).angle(),e=180*(h-e)/Math.PI;b&&(e+=180);k=k.multiply(g.getProjectionMatrix());k=k.multiply(c.Matrix4x4.rotationZ(e));k=k.multiply(g.getInverseProjectionMatrix());f=f.transform(k);b=c.Plane.fromNormalAndPoint(a.axisvector,new c.Vector3D(0,0,0));
b=new c.OrthoNormalBasis(b);e=b.to2D(f.normalvector).angle();h=b.to2D(a.normalvector).angle();e=180*(h-e)/Math.PI;e+=d;k=k.multiply(b.getProjectionMatrix());k=k.multiply(c.Matrix4x4.rotationZ(e));k=k.multiply(b.getInverseProjectionMatrix());return k=k.multiply(c.Matrix4x4.translation(a.point))},axisLine:function(){return new c.Line3D(this.point,this.axisvector)},extend:function(a){a=this.point.plus(this.axisvector.unit().times(a));return new c.Connector(a,this.axisvector,this.normalvector)}};c.ConnectorList=
function(a){this.connectors_=a?a.slice():[]};c.ConnectorList.defaultNormal=[0,0,1];c.ConnectorList.fromPath2D=function(a,b,d){if(3===arguments.length)return c.ConnectorList._fromPath2DTangents(a,b,d);if(2==arguments.length)return c.ConnectorList._fromPath2DExplicit(a,b);throw"call with path2D and either 2 direction vectors, or a function returning direction vectors";};c.ConnectorList._fromPath2DTangents=function(a,b,d){var f,k=a.points.length,g=new c.ConnectorList([new c.Connector(a.points[0],b,c.ConnectorList.defaultNormal)]);
a.points.slice(1,k-1).forEach(function(b,d){f=a.points[d+2].minus(a.points[d]).toVector3D(0);g.appendConnector(new c.Connector(b.toVector3D(0),f,c.ConnectorList.defaultNormal))},this);g.appendConnector(new c.Connector(a.points[k-1],d,c.ConnectorList.defaultNormal));g.closed=a.closed;return g};c.ConnectorList._fromPath2DExplicit=function(a,b){function d(a,b,c){"function"==typeof a&&(a=a(b,c));return a}var f=new c.ConnectorList(a.points.map(function(a,f){return new c.Connector(a.toVector3D(0),c.Vector3D.Create(1,
0,0).rotateZ(d(b,a,f)),c.ConnectorList.defaultNormal)},this));f.closed=a.closed;return f};c.ConnectorList.prototype={setClosed:function(a){this.closed=!!closed},appendConnector:function(a){this.connectors_.push(a)},followWith:function(a){function b(a,b){"function"==typeof a&&(a=a(b.point,b.axisvector,b.normalvector));return a}this.verify();var d=[],f,k=this.connectors_[this.connectors_.length-1],e=b(a,k);this.connectors_.forEach(function(c,h){f=b(a,c);h||this.closed?d.push.apply(d,e._toWallPolygons({toConnector1:k,
toConnector2:c,cag:f})):d.push.apply(d,f._toPlanePolygons({toConnector:c,flipped:!0}));h!=this.connectors_.length-1||this.closed||d.push.apply(d,f._toPlanePolygons({toConnector:c}));e=f;k=c},this);return c.fromPolygons(d).reTesselated().canonicalized()},verify:function(){for(var a,b,c=0;c<this.connectors_.length-1;c++){a=this.connectors_[c];b=this.connectors_[c+1];if(0>=b.point.minus(a.point).dot(a.axisvector))throw"Invalid ConnectorList. Each connectors position needs to be within a <90deg range of previous connectors axisvector";
if(0>=a.axisvector.dot(b.axisvector))throw"invalid ConnectorList. No neighboring connectors axisvectors may span a >=90deg angle";}}};c.Path2D=function(a,b){b=!!b;a=a||[];var d=null;b&&0<a.length&&(d=new c.Vector2D(a[a.length-1]));var f=[];a.map(function(a){a=new c.Vector2D(a);var b=!1;null!==d&&(b=1E-5>a.distanceTo(d));b||f.push(a);d=a});this.points=f;this.closed=b};c.Path2D.arc=function(a){var b=c.parseOptionAs2DVector(a,"center",0),d=c.parseOptionAsFloat(a,"radius",1),f=c.parseOptionAsFloat(a,
"startangle",0),k=c.parseOptionAsFloat(a,"endangle",360),e=c.parseOptionAsInt(a,"resolution",c.defaultResolution2D);for(a=c.parseOptionAsBool(a,"maketangent",!1);720<=k-f;)k-=360;for(;-720>=k-f;)k+=360;var h=[],m,l=Math.abs(k-f);if(1E-5>l)m=c.Vector2D.fromAngle(f/180*Math.PI).times(d),h.push(m.plus(b));else{e=Math.floor(e*l/360)+1;l=.5*e/l;.25<l&&(l=.25);for(var n=a?e+2:e,x=0;x<=n;x++)m=x,a&&(m=(x-1)*(e-2*l)/e+l,0>m&&(m=0),m>e&&(m=e)),m=c.Vector2D.fromAngle((f+m*(k-f)/e)/180*Math.PI).times(d),h.push(m.plus(b))}return new c.Path2D(h,
!1)};c.Path2D.prototype={concat:function(a){if(this.closed||a.closed)throw Error("Paths must not be closed");a=this.points.concat(a.points);return new c.Path2D(a)},appendPoint:function(a){if(this.closed)throw Error("Path must not be closed");a=new c.Vector2D(a);a=this.points.concat([a]);return new c.Path2D(a)},appendPoints:function(a){if(this.closed)throw Error("Path must not be closed");var b=this.points;a.forEach(function(a){b.push(new c.Vector2D(a))});return new c.Path2D(b)},close:function(){return new c.Path2D(this.points,
!0)},rectangularExtrude:function(a,b,c){return this.expandToCAG(a/2,c).extrude({offset:[0,0,b]})},expandToCAG:function(a,b){var c=[],f=this.points.length,k=0;this.closed&&2<f&&(k=-1);for(var e,h=k;h<f;h++){var l=h;0>l&&(l=f-1);l=new m.Vertex(this.points[l]);h>k&&(e=new m.Side(e,l),c.push(e));e=l}return m.fromSides(c).expandedShell(a,b)},innerToCAG:function(){if(!this.closed)throw Error("The path should be closed!");return m.fromPoints(this.points)},transform:function(a){var b=this.points.map(function(b){return b.multiply4x4(a)});
return new c.Path2D(b,this.closed)},appendBezier:function(a,b){2>arguments.length&&(b={});if(this.closed)throw Error("Path must not be closed");if(!(a instanceof Array))throw Error("appendBezier: should pass an array of control points");if(1>a.length)throw Error("appendBezier: need at least 1 control point");if(1>this.points.length)throw Error("appendBezier: path must already contain a point (the endpoint of the path is used as the starting point for the bezier curve)");var d=c.parseOptionAsInt(b,
"resolution",c.defaultResolution2D);4>d&&(d=4);var f=[],e=[];e.push(this.points[this.points.length-1]);for(var g=0;g<a.length;++g){var h=a[g];if(null===h){if(0!=g)throw Error("appendBezier: null can only be passed as the first control point");if(2>a.length)throw Error("appendBezier: null can only be passed if there is at least one more control point");if("lastBezierControlPoint"in this)h=this.lastBezierControlPoint;else{if(2>this.points.length)throw Error("appendBezier: null is passed as a control point but this requires a previous bezier curve or at least two points in the existing path");
h=this.points[this.points.length-2]}h=this.points[this.points.length-1].times(2).minus(h)}else h=new c.Vector2D(h);e.push(h)}for(var m=e.length-1,h=1,g=0;g<=m;++g)0<g&&(h*=g),f.push(h);for(var l=[],g=0;g<=m;++g)l.push(f[m]/(f[g]*f[m-g]));for(var f=function(a){for(var b=1,d=Math.pow(1-a,m),f=1!=a?1/(1-a):1,g=new c.Vector2D(0,0),h=0;h<=m;++h)h==m&&(d=1),g=g.plus(e[h].times(l[h]*b*d)),b*=a,d*=f;return g},h=[],n=[],x=m+1,g=0;g<x;++g){var p=g/(x-1),q=f(p);h.push(q);n.push(p)}g=1;for(d=Math.sin(2*Math.PI/
d);g<h.length-1;)if(x=h[g].minus(h[g-1]).unit(),p=h[g+1].minus(h[g]).unit(),x=x.cross(p),Math.abs(x)>d){var p=n[g-1],q=n[g+1],x=p+1*(q-p)/3,p=p+2*(q-p)/3,q=f(x),F=f(p);h.splice(g,1,q,F);n.splice(g,1,x,p);g--;1>g&&(g=1)}else++g;h=this.points.concat(h.slice(1));f=new c.Path2D(h);f.lastBezierControlPoint=e[e.length-2];return f},appendArc:function(a,b){2>arguments.length&&(b={});if(this.closed)throw Error("Path must not be closed");if(1>this.points.length)throw Error("appendArc: path must already contain a point (the endpoint of the path is used as the starting point for the arc)");
var d=c.parseOptionAsInt(b,"resolution",c.defaultResolution2D);4>d&&(d=4);var f,e;if("xradius"in b||"yradius"in b){if("radius"in b)throw Error("Should either give an xradius and yradius parameter, or a radius parameter");f=c.parseOptionAsFloat(b,"xradius",0);e=c.parseOptionAsFloat(b,"yradius",0)}else e=f=c.parseOptionAsFloat(b,"radius",0);var g=c.parseOptionAsFloat(b,"xaxisrotation",0),h=c.parseOptionAsBool(b,"clockwise",!1),m=c.parseOptionAsBool(b,"large",!1),l=this.points[this.points.length-1];
a=new c.Vector2D(a);var n=!h,h=[];if(0==f||0==e)h.push(a);else{f=Math.abs(f);e=Math.abs(e);var x=g*Math.PI/180,g=Math.cos(x),x=Math.sin(x),p=l.minus(a).times(.5),p=new c.Vector2D(g*p.x+x*p.y,-x*p.x+g*p.y),q=p.x*p.x/(f*f)+p.y*p.y/(e*e);1<q&&(q=Math.sqrt(q),f*=q,e*=q);q=Math.sqrt((f*f*e*e-f*f*p.y*p.y-e*e*p.x*p.x)/(f*f*p.y*p.y+e*e*p.x*p.x));n==m&&(q=-q);m=(new c.Vector2D(f*p.y/e,-e*p.x/f)).times(q);l=(new c.Vector2D(g*m.x-x*m.y,x*m.x+g*m.y)).plus(l.plus(a).times(.5));q=new c.Vector2D((p.x-m.x)/f,(p.y-
m.y)/e);p=new c.Vector2D((-p.x-m.x)/f,(-p.y-m.y)/e);m=q.angleRadians();p=p.angleRadians()-m;p%=2*Math.PI;!n&&0<p?p-=2*Math.PI:n&&0>p&&(p+=2*Math.PI);d=Math.ceil(Math.abs(p)/(2*Math.PI)*d)+1;1>d&&(d=1);for(n=1;n<=d;n++){var F=m+n/d*p,q=Math.cos(F),F=Math.sin(F),q=(new c.Vector2D(g*f*q-x*e*F,x*f*q+g*e*F)).plus(l);h.push(q)}}h=this.points.concat(h);return new c.Path2D(h)}};c.addTransformationMethodsToPrototype=function(a){a.mirrored=function(a){return this.transform(c.Matrix4x4.mirroring(a))};a.mirroredX=
function(){var a=new c.Plane(c.Vector3D.Create(1,0,0),0);return this.mirrored(a)};a.mirroredY=function(){var a=new c.Plane(c.Vector3D.Create(0,1,0),0);return this.mirrored(a)};a.mirroredZ=function(){var a=new c.Plane(c.Vector3D.Create(0,0,1),0);return this.mirrored(a)};a.translate=function(a){return this.transform(c.Matrix4x4.translation(a))};a.scale=function(a){return this.transform(c.Matrix4x4.scaling(a))};a.rotateX=function(a){return this.transform(c.Matrix4x4.rotationX(a))};a.rotateY=function(a){return this.transform(c.Matrix4x4.rotationY(a))};
a.rotateZ=function(a){return this.transform(c.Matrix4x4.rotationZ(a))};a.rotate=function(a,d,f){return this.transform(c.Matrix4x4.rotation(a,d,f))}};c.addCenteringToPrototype=function(a,b){a.center=function(a){a=Array.prototype.map.call(arguments,function(a){return a});a.length||(a=b.slice());var c=this.getBounds();return this.translate(b.map(function(b){return-1<a.indexOf(b)?-(c[0][b]+c[1][b])/2:0}))}};var m=function(){this.sides=[]};m.fromSides=function(a){var b=new m;b.sides=a;return b};m.fromPoints=
function(a){var b=a.length;if(3>b)throw Error("CAG shape needs at least 3 points");var d=[],b=new c.Vector2D(a[b-1]),f=new m.Vertex(b);a.map(function(a){a=new c.Vector2D(a);a=new m.Vertex(a);var b=new m.Side(f,a);d.push(b);f=a});a=m.fromSides(d);if(a.isSelfIntersecting())throw Error("Polygon is self intersecting!");b=a.area();if(1E-5>Math.abs(b))throw Error("Degenerate polygon!");0>b&&(a=a.flipped());return a=a.canonicalized()};m.fromPointsNoCheck=function(a){var b=[],d=new c.Vector2D(a[a.length-
1]),f=new m.Vertex(d);a.map(function(a){a=new c.Vector2D(a);a=new m.Vertex(a);var d=new m.Side(f,a);b.push(d);f=a});return m.fromSides(b)};m.fromFakeCSG=function(a){a=a.polygons.map(function(a){return m.Side._fromFakePolygon(a)}).filter(function(a){return null!==a});return m.fromSides(a)};m.linesIntersect=function(a,b,d,f){if(b.equals(d)||f.equals(a)){if(1E-5>f.minus(d).unit().plus(b.minus(a).unit()).length())return!0}else{b=b.minus(a);f=f.minus(d);if(1E-9>Math.abs(b.cross(f)))return!1;a=c.solve2Linear(-b.x,
f.x,-b.y,f.y,a.x-d.x,a.y-d.y);if(1E-6<a[0]&&.999999>a[0]&&1E-5<a[1]&&.999999>a[1])return!0}return!1};m.circle=function(a){a=a||{};var b=c.parseOptionAs2DVector(a,"center",[0,0]),d=c.parseOptionAsFloat(a,"radius",1);a=c.parseOptionAsInt(a,"resolution",c.defaultResolution2D);var f=[],e;if(0>=d)throw Error("Radius should be positive.");if(5E-4>d)return new m;for(var g=0;g<=a;g++){var h=c.Vector2D.fromAngleRadians(2*Math.PI*g/a).times(d).plus(b),h=new m.Vertex(h);0<g&&f.push(new m.Side(e,h));e=h}return m.fromSides(f)};
m.rectangle=function(a){a=a||{};var b;if("corner1"in a||"corner2"in a){if("center"in a||"radius"in a)throw Error("rectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=c.parseOptionAs2DVector(a,"corner1",[0,0]);corner2=c.parseOptionAs2DVector(a,"corner2",[1,1]);b=corner1.plus(corner2).times(.5);a=corner2.minus(corner1).times(.5)}else b=c.parseOptionAs2DVector(a,"center",[0,0]),a=c.parseOptionAs2DVector(a,"radius",[1,1]);if(0>=a.x||0>=a.y)throw Error("Dimension should be positive.");
if(5E-4>a.x||5E-4>a.y)return console.log("Throwing out a zero-length rectangle."),new m;var d=new c.Vector2D(a.x,-a.y);b=[b.plus(a),b.plus(d),b.minus(a),b.minus(d)];return m.fromPoints(b)};m.roundedRectangle=function(a){a=a||{};var b,d;if("corner1"in a||"corner2"in a){if("center"in a||"radius"in a)throw Error("roundedRectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=c.parseOptionAs2DVector(a,"corner1",[0,0]);corner2=c.parseOptionAs2DVector(a,
"corner2",[1,1]);b=corner1.plus(corner2).times(.5);d=corner2.minus(corner1).times(.5)}else b=c.parseOptionAs2DVector(a,"center",[0,0]),d=c.parseOptionAs2DVector(a,"radius",[1,1]);d=d.abs();var f=c.parseOptionAsFloat(a,"roundradius",.2);a=c.parseOptionAsInt(a,"resolution",c.defaultResolution2D);var e=Math.min(d.x,d.y),f=Math.min(f,e-.1),f=Math.max(0,f);d=new c.Vector2D(d.x-f,d.y-f);b=m.rectangle({center:b,radius:d});0<f&&(b=b.expand(f,a));return b};m.fromCompactBinary=function(a){if("CAG"!=a["class"])throw Error("Not a CAG");
for(var b=[],d=a.vertexData,f=d.length/2,e=0,g=0;g<f;g++){var h=d[e++],l=d[e++],h=new c.Vector2D(h,l),h=new m.Vertex(h);b.push(h)}d=[];f=a.sideVertexIndices.length/2;for(g=e=0;g<f;g++)h=a.sideVertexIndices[e++],l=a.sideVertexIndices[e++],h=new m.Side(b[h],b[l]),d.push(h);a=m.fromSides(d);a.isCanonicalized=!0;return a};m.prototype={toString:function(){var a="CAG ("+this.sides.length+" sides):\n";this.sides.map(function(b){a+="  "+b.toString()+"\n"});return a},_toCSGWall:function(a,b){var d=this.sides.map(function(c){return c.toPolygon3D(a,
b)});return c.fromPolygons(d)},_toVector3DPairs:function(a){var b=this.sides.map(function(a){var b=a.vertex0.pos;a=a.vertex1.pos;return[c.Vector3D.Create(b.x,b.y,0),c.Vector3D.Create(a.x,a.y,0)]});"undefined"!=typeof a&&(b=b.map(function(b){return b.map(function(b){return b.transform(a)})}));return b},_toPlanePolygons:function(a){var b=a.flipped||!1,d=[0,0,0],f=[0,0,1],e=[0,1,0],g=new c.Connector(d,f,e),d=a.translation||d,f=a.axisVector||f,e=a.normalVector||e;a=a.toConnector||new c.Connector(d,f,
e);var h=g.getTransformationTo(a,!1,0);a=this.getBounds();a[0]=a[0].minus(new c.Vector2D(1,1));a[1]=a[1].plus(new c.Vector2D(1,1));g=this._toCSGWall(-1,1);a=c.fromPolygons([new c.Polygon([new c.Vertex(new c.Vector3D(a[0].x,a[0].y,0)),new c.Vertex(new c.Vector3D(a[1].x,a[0].y,0)),new c.Vertex(new c.Vector3D(a[1].x,a[1].y,0)),new c.Vertex(new c.Vector3D(a[0].x,a[1].y,0))])]);b&&(a=a.invert());a=a.intersectSub(g);return a.polygons.filter(function(a){return.99<Math.abs(a.plane.normal.z)}).map(function(a){return a.transform(h)})},
_toWallPolygons:function(a){var b=new c.Connector([0,0,0],[0,0,1],[0,1,0]),d=a.toConnector1,f=a.toConnector2;if(!(d instanceof c.Connector&&f instanceof c.Connector))throw"could not parse CSG.Connector arguments toConnector1 or toConnector2";if(a.cag&&a.cag.sides.length!=this.sides.length)throw"target cag needs same sides count as start cag";a=a.cag||this;var d=b.getTransformationTo(d,!1,0),b=b.getTransformationTo(f,!1,0),f=this._toVector3DPairs(d),e=a._toVector3DPairs(b),g=[];f.forEach(function(a,
b){g.push(new c.Polygon([new c.Vertex(e[b][1]),new c.Vertex(e[b][0]),new c.Vertex(a[0])]));g.push(new c.Polygon([new c.Vertex(e[b][1]),new c.Vertex(a[0]),new c.Vertex(a[1])]))});return g},union:function(a){a=a instanceof Array?a:[a];var b=this._toCSGWall(-1,1),b=b.union(a.map(function(a){return a._toCSGWall(-1,1).reTesselated()}),!1,!1);return m.fromFakeCSG(b).canonicalized()},subtract:function(a){a=a instanceof Array?a:[a];var b=this._toCSGWall(-1,1);a.map(function(a){b=b.subtractSub(a._toCSGWall(-1,
1),!1,!1)});b=b.reTesselated();b=b.canonicalized();b=m.fromFakeCSG(b);return b=b.canonicalized()},intersect:function(a){a=a instanceof Array?a:[a];var b=this._toCSGWall(-1,1);a.map(function(a){b=b.intersectSub(a._toCSGWall(-1,1),!1,!1)});b=b.reTesselated();b=b.canonicalized();b=m.fromFakeCSG(b);return b=b.canonicalized()},transform:function(a){var b=a.isMirroring(),c=this.sides.map(function(b){return b.transform(a)}),c=m.fromSides(c);b&&(c=c.flipped());return c},area:function(){var a=0;this.sides.map(function(b){a+=
b.vertex0.pos.cross(b.vertex1.pos)});return a*=.5},flipped:function(){var a=this.sides.map(function(a){return a.flipped()});a.reverse();return m.fromSides(a)},getBounds:function(){var a,b=a=0===this.sides.length?new c.Vector2D(0,0):this.sides[0].vertex0.pos;this.sides.map(function(c){a=a.min(c.vertex0.pos);a=a.min(c.vertex1.pos);b=b.max(c.vertex0.pos);b=b.max(c.vertex1.pos)});return[a,b]},isSelfIntersecting:function(a){for(var b=this.sides.length,c=0;c<b;c++)for(var f=this.sides[c],e=c+1;e<b;e++){var g=
this.sides[e];if(m.linesIntersect(f.vertex0.pos,f.vertex1.pos,g.vertex0.pos,g.vertex1.pos))return a&&(OpenJsCad.log(f),OpenJsCad.log(g)),!0}return!1},expandedShell:function(a,b){b=b||8;4>b&&(b=4);var d=[],f={};this.canonicalized().sides.map(function(b){var c=b.vertex1.pos.minus(b.vertex0.pos),e=c.length();if(1E-5<e)for(c=c.times(1/e),c=c.normal().times(a),c=[b.vertex1.pos.plus(c),b.vertex1.pos.minus(c),b.vertex0.pos.minus(c),b.vertex0.pos.plus(c)],c=m.fromPoints(c),d.push(c),c=0;2>c;c++){var e=0===
c?b.vertex0.pos:b.vertex1.pos,g=0===c?b.vertex1.pos:b.vertex0.pos,k=e.x+" "+e.y;k in f||(f[k]=[]);f[k].push({p1:e,p2:g})}});for(var e in f){var g=f[e],h,l=g[0].p1;if(2==g.length){h=g[1].p2;g=g[0].p2.minus(l).angleDegrees();h=h.minus(l).angleDegrees();h<g&&(h+=360);h>=g+360&&(h-=360);if(h<g+180){var u=h;h=g+360;g=u}g+=90;h-=90}else g=0,h=360;if(u=h>g+359.999)g=0,h=360;if(h>g+1E-5){var n=[];u||n.push(l);var x=Math.round(b*(h-g)/360);1>x&&(x=1);for(var p=0;p<=x;p++){var q=g+p/x*(h-g);p==x&&(q=h);q=l.plus(c.Vector2D.fromAngleDegrees(q).times(a));
(!u||0<p)&&n.push(q)}l=m.fromPointsNoCheck(n);d.push(l)}}e=new m;return e=e.union(d)},expand:function(a,b){return this.union(this.expandedShell(a,b))},contract:function(a,b){return this.subtract(this.expandedShell(a,b))},extrudeInOrthonormalBasis:function(a,b){if(!(a instanceof c.OrthoNormalBasis))throw Error("extrudeInPlane: the first parameter should be a CSG.OrthoNormalBasis");var d=this.extrude({offset:[0,0,b]}),f=a.getInverseProjectionMatrix();return d=d.transform(f)},extrudeInPlane:function(a,
b,d){return this.extrudeInOrthonormalBasis(c.OrthoNormalBasis.GetCartesian(a,b),d)},extrude:function(a){if(0==this.sides.length)return new c;var b=c.parseOptionAs3DVector(a,"offset",[0,0,1]),d=c.parseOptionAsFloat(a,"twistangle",0);a=c.parseOptionAsInt(a,"twiststeps",c.defaultResolution3D);if(0==b.z)throw"offset cannot be orthogonal to Z axis";if(0==d||1>a)a=1;for(var f=c.Vector3D.Create(0,1,0),e=[],e=e.concat(this._toPlanePolygons({translation:[0,0,0],normalVector:f,flipped:!(0>b.z)})),e=e.concat(this._toPlanePolygons({translation:b,
normalVector:f.rotateZ(d),flipped:0>b.z})),g=0;g<a;g++)var h=new c.Connector(b.times(g/a),[0,0,b.z],f.rotateZ(g*d/a)),m=new c.Connector(b.times((g+1)/a),[0,0,b.z],f.rotateZ((g+1)*d/a)),e=e.concat(this._toWallPolygons({toConnector1:h,toConnector2:m}));return c.fromPolygons(e)},rotateExtrude:function(a){var b=c.parseOptionAsFloat(a,"angle",360),d=c.parseOptionAsInt(a,"resolution",c.defaultResolution3D),b=360<b?b%360:b;a=[0,0,0];var f=c.Vector3D.Create(0,1,0),e=[0,0,1],g=[],h=new c.Connector(a,f,e);
if(0<b&&360>b)var m=new c.Connector(a,f.rotateZ(-b),e),g=g.concat(this._toPlanePolygons({toConnector:h,flipped:!0})),g=g.concat(this._toPlanePolygons({toConnector:m}));for(var l=m=b/d;l<=b+1E-5;l+=m)d=new c.Connector(a,f.rotateZ(-l),e),g=g.concat(this._toWallPolygons({toConnector1:h,toConnector2:d})),h=d;return c.fromPolygons(g).reTesselated()},rotate_extrude:function(a){if(0==this.sides.length)return new c;var b=c.parseOptionAsInt(a,"faces",10),d=c.parseOptionAsInt(a,"twist",0),f=Math.abs(c.parseOptionAsInt(a,
"radius",0));a=c.parseOptionAsInt(a,"tsteps",0);3>b&&(b=3);a=Math.ceil(a/b);1>a&&(a=1);for(var e=m.fromPoints([[-.001,1E5],[2E5,1E5],[2E5,-1E5],[-.001,-1E5]]),g=m.fromPoints([[.001,1E5],[-2E5,1E5],[-2E5,-1E5],[.001,-1E5]]),h=this.translate([f,0,0]),e=h.subtract(e),g=h.subtract(g),g=0!=e.sides.length?e.mirroredX().union(g):g,g=g.translate([-f,0,0]),h=[],e=0;e<b+2;e++)x=new c.Matrix4x4.rotationZ(d/360*e/b*360),h[e]=g.transform(x),h[e]=h[e].translate([f,0,0]),h[e]=h[e].canonicalized();g=g.translate([f,
0,0]);d=[];for(e=0;e<b;e++)for(f=0;f<g.sides.length;f++){var l=[],u=[],n,x;n=new c.Matrix4x4.rotationZ(e/b*360);x=new c.Matrix4x4.rotationZ((e+1)/b*360);l[0]=new c.Vector3D(h[e].sides[f].vertex0.pos.x,0,h[e].sides[f].vertex0.pos.y);l[1]=new c.Vector3D(h[e].sides[f].vertex1.pos.x,0,h[e].sides[f].vertex1.pos.y);l[2]=new c.Vector3D(h[e+1].sides[f].vertex1.pos.x,0,h[e+1].sides[f].vertex1.pos.y);l[3]=new c.Vector3D(h[e+1].sides[f].vertex0.pos.x,0,h[e+1].sides[f].vertex0.pos.y);l[0]=n.rightMultiply1x3Vector(l[0]);
l[1]=n.rightMultiply1x3Vector(l[1]);l[2]=x.rightMultiply1x3Vector(l[2]);l[3]=x.rightMultiply1x3Vector(l[3]);x=(l[3]._x-l[0]._x)/a;n=(l[3]._y-l[0]._y)/a;for(var p=(l[3]._z-l[0]._z)/a,q=(l[2]._x-l[1]._x)/a,F=(l[2]._y-l[1]._y)/a,A=(l[2]._z-l[1]._z)/a,t=0;t<a;t++){u[0]=new c.Vector3D(l[0]._x+t*x,l[0]._y+t*n,l[0]._z+t*p);u[1]=new c.Vector3D(l[1]._x+t*q,l[1]._y+t*F,l[1]._z+t*A);u[2]=new c.Vector3D(l[1]._x+(t+1)*q,l[1]._y+(t+1)*F,l[1]._z+(t+1)*A);u[3]=new c.Vector3D(l[0]._x+(t+1)*x,l[0]._y+(t+1)*n,l[0]._z+
(t+1)*p);var B=new c.Polygon([new c.Vertex(u[0]),new c.Vertex(u[1]),new c.Vertex(u[2])]),C=new c.Polygon([new c.Vertex(u[0]),new c.Vertex(u[2]),new c.Vertex(u[3])]);d.push(B);d.push(C)}}b=c.fromPolygons(d);b=b.reTesselated();return b=b.canonicalized()},hull:function(a){ConvexHullPoint=function(a,b,c){this.index=a;this.angle=b;this.distance=c;this.compare=function(a){return this.angle<a.angle?-1:this.angle>a.angle?1:this.distance<a.distance?-1:this.distance>a.distance?1:0}};ConvexHull=function(){this.indices=
this.points=null;this.getIndices=function(){return this.indices};this.clear=function(){this.points=this.indices=null};this.ccw=function(a,b,c){a=(this.points[b].x-this.points[a].x)*(this.points[c].y-this.points[a].y)-(this.points[b].y-this.points[a].y)*(this.points[c].x-this.points[a].x);return 1E-5>a?0:a};this.angle=function(a,b){return Math.atan2(this.points[b].y-this.points[a].y,this.points[b].x-this.points[a].x)};this.distance=function(a,b){return(this.points[b].x-this.points[a].x)*(this.points[b].x-
this.points[a].x)+(this.points[b].y-this.points[a].y)*(this.points[b].y-this.points[a].y)};this.compute=function(a){this.indices=null;if(!(3>a.length)){this.points=a;var b=0;for(a=1;a<this.points.length;a++)this.points[a].y==this.points[b].y?this.points[a].x<this.points[b].x&&(b=a):this.points[a].y<this.points[b].y&&(b=a);var c=[],d=0,f=0;for(a=0;a<this.points.length;a++)a!=b&&(d=this.angle(b,a),0>d&&(d+=Math.PI),f=this.distance(b,a),c.push(new ConvexHullPoint(a,d,f)));c.sort(function(a,b){return a.compare(b)});
d=Array(this.points.length+1);f=2;for(a=0;a<this.points.length;a++)a!=b&&(d[f]=c[f-2].index,f++);d[0]=d[this.points.length];d[1]=b;c=2;for(a=3;a<=this.points.length;a++){for(;0>=this.ccw(d[c-1],d[c],d[a]);)c--;c++;b=d[a];d[a]=d[c];d[c]=b}this.indices=Array(c);for(a=0;a<c;a++)this.indices[a]=d[a+1]}}};var b=a,c=[];c.push(this);for(var f=0;f<b.length;f++)c.push(b[f]);for(var b=[],e=[],f=0;f<c.length;f++){a=c[f];if(!(a instanceof m))throw"ERROR: don't mix 2D and 3D shapes in hull";for(var g=0;g<a.sides.length;g++){var h=
a.sides[g].vertex0.pos.x,l=a.sides[g].vertex0.pos.y;e[""+h+","+l]||(b.push({x:h,y:l}),e[""+h+","+l]++)}}f=new ConvexHull;f.compute(b);if((c=f.getIndices())&&0<c.length){a=[];for(f=0;f<c.length;f++)a.push(b[c[f]]);return m.fromPoints(a)}},check:function(){var a=[];this.isSelfIntersecting(!0)&&a.push("Self intersects");var b={};this.sides.map(function(a){function c(a){a=a.x+" "+a.y;a in b||(b[a]=0);b[a]++}c(a.vertex0.pos);c(a.vertex1.pos)});for(var c in b){var f=b[c];f&1&&a.push("Uneven number of sides ("+
f+") for point "+c)}c=this.area();c<1E-5*1E-5&&a.push("Area is "+c);if(0<a.length){var e="";a.map(function(a){e+=a+"\n"});throw Error(e);}},canonicalized:function(){if(this.isCanonicalized)return this;var a=(new m.fuzzyCAGFactory).getCAG(this);a.isCanonicalized=!0;return a},toCompactBinary:function(){var a=this.canonicalized(),b={},c=[],f=0,e=new Uint32Array(2*a.sides.length),g=0;a.sides.map(function(a){[a.vertex0,a.vertex1].map(function(a){var h=a.getTag(),l;h in b?l=b[h]:(l=f++,b[h]=l,c.push(a));
e[g++]=l})});var h=new Float64Array(2*f),l=0;c.map(function(a){a=a.pos;h[l++]=a._x;h[l++]=a._y});return{"class":"CAG",sideVertexIndices:e,vertexData:h}},getOutlinePaths:function(){var a={},b={};this.canonicalized().sides.map(function(c){var d=c.getTag();a[d]=c;c=c.vertex0.getTag();c in b||(b[c]=[]);b[c].push(d)});for(var d=[];;){var f=null,e;for(e in b){var g=b[e],f=g[0];g.splice(0,1);0===g.length&&delete b[e];break}if(null===f)break;for(var g=[],h=a[f],f=h.vertex0.getTag();;){g.push(h.vertex0.pos);
var l=h.vertex1.getTag();if(l==f)break;if(!(l in b))throw Error("Area is not closed!");var m=b[l],n=-1;if(1==m.length)n=0;else for(var x=null,h=h.direction().angleDegrees(),p=0;p<m.length;p++){var q=a[m[p]].direction().angleDegrees()-h;-180>q&&(q+=360);180<=q&&(q-=360);if(0>n||q>x)n=p,x=q}x=m[n];m.splice(n,1);0===m.length&&delete b[l];h=a[x]}g=new c.Path2D(g,!0);d.push(g)}return d},overCutInsideCorners:function(a){var b=this.canonicalized(),d={};b.sides.map(function(a){a.vertex0.getTag()in d||(d[a.vertex0.getTag()]=
{pos:a.vertex0.pos,from:[],to:[]});d[a.vertex0.getTag()].to.push(a.vertex1.pos);a.vertex1.getTag()in d||(d[a.vertex1.getTag()]={pos:a.vertex1.pos,from:[],to:[]});d[a.vertex1.getTag()].from.push(a.vertex0.pos)});var f=[],e;for(e in d){var g=d[e];if(1==g.from.length&&1==g.to.length){var h=g.pos,l=g.to[0],g=h.minus(g.from[0]).unit(),l=l.minus(h).unit();if(.001>g.cross(l)){var n=l.angleRadians()-g.angleRadians()+Math.PI;0>n?n+=2*Math.PI:n>=2*Math.PI&&(n-=2*Math.PI);for(var l=l.minus(g).unit(),z=30/180*
Math.PI,g=a/Math.cos(z/2),h=h.plus(l.times(g)),l=n+l.angleRadians(),n=2*(Math.PI-n),z=2*Math.ceil(n/z/2),x=[h],p=0;p<=z;p++){var q=c.Vector2D.fromAngleRadians(l+p/z*n).times(g).plus(h);x.push(q)}f.push(m.fromPoints(x))}}}return b.subtract(f)}};m.Vertex=function(a){this.pos=a};m.Vertex.prototype={toString:function(){return"("+this.pos.x.toFixed(2)+","+this.pos.y.toFixed(2)+")"},getTag:function(){var a=this.tag;a||(this.tag=a=c.getTag());return a}};m.Side=function(a,b){if(!(a instanceof m.Vertex))throw Error("Assertion failed");
if(!(b instanceof m.Vertex))throw Error("Assertion failed");this.vertex0=a;this.vertex1=b};m.Side._fromFakePolygon=function(a){a.vertices.forEach(function(a){if(!(-1.001<=a.pos.z&&-.999>a.pos.z||.999<=a.pos.z&&1.001>a.pos.z))throw"Assertion failed: _fromFakePolygon expects abs z values of 1";});if(4>a.vertices.length)return null;var b=[];a=a.vertices.filter(function(a,c){if(0<a.pos.z)return b.push(c),!0}).map(function(a){return new c.Vector2D(a.pos.x,a.pos.y)});if(2!=a.length)throw"Assertion failed: _fromFakePolygon: not enough points found";
var d=b[1]-b[0];if(1==d||3==d)1==d&&a.reverse();else throw"Assertion failed: _fromFakePolygon: unknown index ordering";return new m.Side(new m.Vertex(a[0]),new m.Vertex(a[1]))};m.Side.prototype={toString:function(){return this.vertex0+" -> "+this.vertex1},toPolygon3D:function(a,b){var d=[new c.Vertex(this.vertex0.pos.toVector3D(a)),new c.Vertex(this.vertex1.pos.toVector3D(a)),new c.Vertex(this.vertex1.pos.toVector3D(b)),new c.Vertex(this.vertex0.pos.toVector3D(b))];return new c.Polygon(d)},transform:function(a){var b=
this.vertex0.pos.transform(a);a=this.vertex1.pos.transform(a);return new m.Side(new m.Vertex(b),new m.Vertex(a))},flipped:function(){return new m.Side(this.vertex1,this.vertex0)},direction:function(){return this.vertex1.pos.minus(this.vertex0.pos)},getTag:function(){var a=this.tag;a||(this.tag=a=c.getTag());return a},lengthSquared:function(){var a=this.vertex1.pos.x-this.vertex0.pos.x,b=this.vertex1.pos.y-this.vertex0.pos.y;return a*a+b*b},length:function(){return Math.sqrt(this.lengthSquared())}};
m.fuzzyCAGFactory=function(){this.vertexfactory=new c.fuzzyFactory(2,1E-5)};m.fuzzyCAGFactory.prototype={getVertex:function(a){return this.vertexfactory.lookupOrCreate([a.pos._x,a.pos._y],function(b){return a})},getSide:function(a){var b=this.getVertex(a.vertex0);a=this.getVertex(a.vertex1);return new m.Side(b,a)},getCAG:function(a){var b=this;a=a.sides.map(function(a){return b.getSide(a)}).filter(function(a){return 1E-5<a.length()});return m.fromSides(a)}};c.addTransformationMethodsToPrototype(c.prototype);
c.addTransformationMethodsToPrototype(c.Vector2D.prototype);c.addTransformationMethodsToPrototype(c.Vector3D.prototype);c.addTransformationMethodsToPrototype(c.Vertex.prototype);c.addTransformationMethodsToPrototype(c.Plane.prototype);c.addTransformationMethodsToPrototype(c.Polygon.prototype);c.addTransformationMethodsToPrototype(c.Line3D.prototype);c.addTransformationMethodsToPrototype(c.Connector.prototype);c.addTransformationMethodsToPrototype(c.Path2D.prototype);c.addTransformationMethodsToPrototype(c.Line2D.prototype);
c.addTransformationMethodsToPrototype(m.prototype);c.addTransformationMethodsToPrototype(m.Side.prototype);c.addTransformationMethodsToPrototype(c.OrthoNormalBasis.prototype);c.addCenteringToPrototype(c.prototype,["x","y","z"]);c.addCenteringToPrototype(m.prototype,["x","y"]);c.Polygon2D=function(a){this.sides=m.fromPoints(a).sides};c.Polygon2D.prototype=m.prototype;e.CSG=c;e.CAG=m})(this);"undefined"!==typeof module&&(CSG=require(lib+"csg.js").CSG,CAG=require(lib+"csg.js").CAG,Blob=require(lib+"Blob.js").Blob);
(function(e){CSG.prototype.toX3D=function(){var e={},l=[],n={};this.polygons.map(function(a){var b=0,c=0,d=1;a.shared&&a.shared.color&&(b=a.shared.color[0],c=a.shared.color[1],d=a.shared.color[2]);for(var f=[],g=a.vertices.length,k,m=0;m<g;m++)k=a.vertices[m],k.getTag()in n||(l.push(k.pos._x.toString()+" "+k.pos._y.toString()+" "+k.pos._z.toString()),n[k.getTag()]=l.length-1),f.push(n[k.getTag()]);a=f.join(" ");b=b.toString()+" "+c.toString()+" "+d.toString();b in e||(e[b]=[]);e[b].push(a)});var c=
document.implementation.createDocumentType("X3D",'ISO//Web3D//DTD X3D 3.1//EN" "http://www.web3d.org/specifications/x3d-3.1.dtd',null),c=document.implementation.createDocument(null,"X3D",c);c.insertBefore(c.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"'),c.doctype);var m=c.getElementsByTagName("X3D")[0];m.setAttribute("profile","Interchange");m.setAttribute("version","3.1");m.setAttribute("xsd:noNamespaceSchemaLocation","http://www.web3d.org/specifications/x3d-3.1.xsd");m.setAttribute("xmlns:xsd",
"http://www.w3.org/2001/XMLSchema-instance");var a=c.createElement("Scene");m.appendChild(a);var m=!1,b;for(b in e){var d=e[b],f=c.createElement("Shape");a.appendChild(f);var k=c.createElement("Appearance");f.appendChild(k);var g=c.createElement("Material");k.appendChild(g);g.setAttribute("diffuseColor",b);g.setAttribute("ambientIntensity","1.0");k=c.createElement("IndexedFaceSet");f.appendChild(k);k.setAttribute("solid","true");k.setAttribute("coordIndex",d.join(" -1 ")+" -1");d=c.createElement("Coordinate");
k.appendChild(d);m?d.setAttribute("USE","coords_mesh"):(d.setAttribute("DEF","coords_mesh"),d.setAttribute("point",l.join(" ")),m=!0)}b=(new XMLSerializer).serializeToString(c);return new Blob([b],{type:"model/x3d+xml"})};CSG.prototype.toStlBinary=function(){var e=new ArrayBuffer(4),l=new Int32Array(e,0,1),e=new Int8Array(e,0,4);l[0]=287454020;if(68!=e[0])throw Error("Binary STL output is currently only supported on little-endian (Intel) processors");var n=0;this.polygons.map(function(a){a=a.vertices.length;
n+=3<=a?a-2:0});l=new Uint8Array(80);for(e=0;80>e;e++)l[e]=65;e=new Uint32Array(1);e[0]=n;var c=new ArrayBuffer(50*n),m=new Int8Array(c),a=new ArrayBuffer(50),b=new Int8Array(a),d=new Float32Array(a,0,12),f=new Uint16Array(a,48,1),k=0;this.polygons.map(function(a){for(var c=a.vertices.length,e=0;e<c-2;e++){var h=a.plane.normal;d[0]=h._x;d[1]=h._y;d[2]=h._z;for(var h=3,l=0;3>l;l++){var n=a.vertices[l+(0<l?e:0)].pos;d[h++]=n._x;d[h++]=n._y;d[h++]=n._z}f[0]=0;m.set(b,k);k+=50}});return new Blob([l.buffer,
e.buffer,c],{type:"application/sla"})};CSG.prototype.toStlString=function(){var e="solid csg.js\n";this.polygons.map(function(l){e+=l.toStlString()});e+="endsolid csg.js\n";return new Blob([e],{type:"application/sla"})};CSG.Vector3D.prototype.toStlString=function(){return this._x+" "+this._y+" "+this._z};CSG.Vertex.prototype.toStlString=function(){return"vertex "+this.pos.toStlString()+"\n"};CSG.Polygon.prototype.toStlString=function(){var e="";if(3<=this.vertices.length)for(var l=this.vertices[0].toStlString(),
n=0;n<this.vertices.length-2;n++)e+="facet normal "+this.plane.normal.toStlString()+"\nouter loop\n",e+=l,e+=this.vertices[n+1].toStlString(),e+=this.vertices[n+2].toStlString(),e+="endloop\nendfacet\n";return e};CAG.PathsToDxf=function(e){var l="999\nDXF generated by OpenJsCad\n",l=l+"  0\nSECTION\n  2\nHEADER\n",l=l+"  0\nENDSEC\n",l=l+"  0\nSECTION\n  2\nTABLES\n",l=l+"  0\nTABLE\n  2\nLTYPE\n  70\n1\n",l=l+"  0\nLTYPE\n  2\nCONTINUOUS\n  3\nSolid Line\n  72\n65\n  73\n0\n  40\n0.0\n",l=l+"  0\nENDTAB\n",
l=l+"  0\nTABLE\n  2\nLAYER\n  70\n1\n",l=l+"  0\nLAYER\n  2\nOpenJsCad\n  62\n7\n  6\ncontinuous\n",l=l+"  0\nENDTAB\n",l=l+"  0\nTABLE\n  2\nSTYLE\n  70\n0\n  0\nENDTAB\n",l=l+"  0\nTABLE\n  2\nVIEW\n  70\n0\n  0\nENDTAB\n",l=l+"  0\nENDSEC\n",l=l+"  0\nSECTION\n  2\nBLOCKS\n",l=l+"  0\nENDSEC\n",l=l+"  0\nSECTION\n  2\nENTITIES\n";e.map(function(e){var c=e.points.length+(e.closed?1:0);l+="  0\nLWPOLYLINE\n  8\nOpenJsCad\n  90\n"+c+"\n  70\n"+(e.closed?1:0)+"\n";for(var h=0;h<c;h++){var a=h;a>=
e.points.length&&(a-=e.points.length);a=e.points[a];l+=" 10\n"+a.x+"\n 20\n"+a.y+"\n 30\n0.0\n"}});l+="  0\nENDSEC\n  0\nEOF\n";return new Blob([l],{type:"application/dxf"})};CAG.prototype.toDxf=function(){var e=this.getOutlinePaths();return CAG.PathsToDxf(e)};CSG.prototype.toAMFString=function(e){var l='<?xml version="1.0" encoding="UTF-8"?>\n<amf'+(e&&e.unit?' unit="+m.unit"':"")+">\n",n;for(n in e)l+='<metadata type="'+n+'">'+e[n]+"</metadata>\n";l+='<object id="0">\n<mesh>\n<vertices>\n';this.polygons.map(function(c){for(var a=
0;a<c.vertices.length;a++)l+=c.vertices[a].toAMFString()});var l=l+"</vertices>\n",c=0;this.polygons.map(function(e){l+="<volume>\n";if(!(3>e.vertices.length)){var a=1,b=.4,d=1,f=1;e.shared&&e.shared.color?(a=e.shared.color[0],b=e.shared.color[1],d=e.shared.color[2],f=e.shared.color[3]):e.color&&(a=e.color[0],b=e.color[1],d=e.color[2],3<e.color.length()&&(f=e.color[3]));l+="<color><r>"+a+"</r><g>"+b+"</g><b>"+d+"</b>"+(void 0!==f?"<a>"+f+"</a>":"")+"</color>";for(a=0;a<e.vertices.length-2;a++)l+=
"<triangle>",l+="<v1>"+c+"</v1>",l+="<v2>"+(c+a+1)+"</v2>",l+="<v3>"+(c+a+2)+"</v3>",l+="</triangle>\n";c+=e.vertices.length;l+="</volume>\n"}});l+="</mesh>\n</object>\n";l+="</amf>\n";return new Blob([l],{type:"application/amf+xml"})};CSG.Vector3D.prototype.toAMFString=function(){return"<x>"+this._x+"</x><y>"+this._y+"</y><z>"+this._z+"</z>"};CSG.Vertex.prototype.toAMFString=function(){return"<vertex><coordinates>"+this.pos.toAMFString()+"</coordinates></vertex>\n"};e.CSG=CSG;e.CAG=CAG})(this);