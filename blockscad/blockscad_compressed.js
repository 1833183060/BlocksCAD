// Do not edit this file; automatically generated by blockscad_build.py.
"use strict";
var Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{};Blockscad.undo=Blockscad.undo||{};Blockscad.Auth.serverURL="https://blocks-and-more-blocks.appspot.com";Blockscad.Auth.sessionTestURL=Blockscad.Auth.serverURL+"/session_test/";Blockscad.Auth.loginURL=Blockscad.Auth.serverURL+"/login/";Blockscad.Auth.registerURL=Blockscad.Auth.serverURL+"/register/";Blockscad.Auth.logoutURL=Blockscad.Auth.serverURL+"/logout/";Blockscad.Auth.usernameCheckURL=Blockscad.Auth.serverURL+"/username_check/";
Blockscad.Auth.saveProjectURL=Blockscad.Auth.serverURL+"/save_project/";Blockscad.Auth.listProjectURL=Blockscad.Auth.serverURL+"/list_project/";Blockscad.Auth.projectDownloadURL=Blockscad.Auth.serverURL+"/fetch_project/";Blockscad.Auth.deleteProjectURL=Blockscad.Auth.serverURL+"/delete_project/";Blockscad.Auth.editPasswordURL=Blockscad.Auth.serverURL+"/edit_password/";Blockscad.Auth.editEmailURL=Blockscad.Auth.serverURL+"/edit_email/";Blockscad.Auth.passwordRecoveryURL=Blockscad.Auth.serverURL+"/recover_password/";
Blockscad.Auth.currentProject="";Blockscad.Auth.currentProjectKey="";Blockscad.Auth.isLoggedIn=0;Blockscad.Auth.currentEmail="";
Blockscad.Auth.init=function(){$.ajaxSetup({crossDomain:!0,xhrFields:{withCredentials:!0}});$("#login-form").submit(function(){$.post(Blockscad.Auth.loginURL,$(this).serialize(),function(a,d){if(a.match(/^SUCCESS/)){var f=a.split(" "),h=$("#login-username").val();Blockscad.Auth.currentEmail=f[1];Blockscad.Auth.loggedIn(h,f[1]);$("#login-user").modal("hide")}else $("#login-error").text(Blockscad.FORM_ERRORS.loginFailed),$("#login-error").addClass("error-message")});$("#login-password").text("");return!1});
$("#login-user").on("shown.bs.modal",function(){$("#login-username").focus()});$("#register-form").submit(function(a){a.preventDefault();a.stopPropagation();Blockscad.Auth.validateRegFields()||Blockscad.Auth.validateUsername(usernameCheckSubmitForm);return!1});$("#register-user").on("shown.bs.modal",function(){$("#register-username").focus()});$("#password-settings-form").submit(function(){Blockscad.Auth.goodPassword=0;Blockscad.Auth.goodPasswordMatch=0;$("#change-pw-new").blur();$("#change-pw-2").blur();
Blockscad.Auth.goodPassword&&Blockscad.Auth.goodPasswordMatch&&$.post(Blockscad.Auth.editPasswordURL,$(this).serialize(),function(a,d){var f=a.match(/^Success/),h=a.match(/^incorrect/);f?($("#change-password-modal").modal("hide"),$("#menuLogout").click(),window.setTimeout(function(){$("#login-button").click()},400)):h?($("#pw-error").text(Blockscad.FORM_ERRORS.badPassword),$("#pw-error").addClass("error-message")):console.log("some unknown error here. Ack!")}).fail(function(a){$("#change-password-modal").modal("hide");
Blockscad.Auth.resetUser()});return!1});$("#change-password-modal").on("shown.bs.modal",function(){$("#change-pw-old").focus()});$("#email-settings-form").submit(function(){Blockscad.Auth.goodEmail=0;$("#new-email").blur();Blockscad.Auth.goodEmail&&$.post(Blockscad.Auth.editEmailURL,$(this).serialize(),function(a,d){var f=a.match(/^Success/),h=a.match(/^incorrect/);f?($("#change-email-modal").modal("hide"),f=a.split(" "),Blockscad.Auth.currentEmail=f[1]):h?($("#email-pw-error").text(Blockscad.FORM_ERRORS.badPassword),
$("#email-pw-error").addClass("error-message")):console.log("some unknown error here. Ack!")}).fail(function(a){$("#change-email-modal").modal("hide");Blockscad.Auth.resetUser()});return!1});$("#change-email-modal").on("show.bs.modal",function(){$("#current-email").html("Current Email is: <b>"+Blockscad.Auth.currentEmail+"</b>");$("#new-email").focus()});$("#pw-recover-form").submit(function(a){a.preventDefault();a.stopPropagation();a=$("#recover-username").val();var d=$("#recover-email").val();$("#un-recover-error").text("");
$("#em-recover-error").text("");if(a.length){if(3>a.length||30<a.length)return $("#un-recover-error").text(Blockscad.FORM_ERRORS.usernameLength),!1;if(!/^[a-zA-Z0-9_-]+$/.test(a))return $("#un-recover-error").text(Blockscad.FORM_ERRORS.usernameCharacters),!1}else if(d.length){if(!/\S+@\S+\.\S+/.test(d))return $("#em-recover-error").text(Blockscad.FORM_ERRORS.emailInvalid),!1}else return!1;$.post(Blockscad.Auth.passwordRecoveryURL,$(this).serialize(),function(a,d){a.match(/^Success/)?($("#pw-recover").modal("hide"),
$("#recover-email-sent").modal("show")):(a.match(/bad username/)&&$("#un-recover-error").text("We can't find this username."),a.match(/bad email/)&&$("#em-recover-error").text("We can't find this email address."))})});$("#pw-recover").on("show.bs.modal",function(){$("#recover-username").focus()});$("#login-area").on("click","#reg-button",function(){clearForm($("#register-form"));Blockscad.Auth.goodUsername=!1;Blockscad.Auth.goodPassword=!1;Blockscad.Auth.goodPasswordMatch=!1;Blockscad.Auth.goodEmail=
!1});$("#login-area").on("click","#login-button",function(){clearForm($("#login-form"))});$("#login-area").on("click","#changePassword",function(){clearForm($("#password-settings-form"))});$("#login-area").on("click","#changeEmail",function(){clearForm($("#email-settings-form"))});$("#forgot-password").on("click",function(){clearForm($("#pw-recover-form"))});$('input[type="password"]').on("keydown",function(a){a.stopPropagation()});$('input[type="email"]').on("keydown",function(a){a.stopPropagation()});
$("#login-area").on("click","#menuLogout",function(){Blockscad.newProject();$.get(Blockscad.Auth.logoutURL,function(a){"SUCCESS"==a&&Blockscad.Auth.notLoggedIn()});return!1});$("#projList").on("click",".proj-to-download",function(){var a=$(this).html(),d=$(this).attr("data-key"),f=$(this).attr("data-id");Blockscad.Auth.currentProjectKey=d;Blockscad.Auth.currentProject=f;$.post(Blockscad.Auth.projectDownloadURL,{key:d},function(a,d){var f=Base64.btou(RawDeflate.inflate(Base64.fromBase64(a)));Blockly.mainWorkspace.clear();
gProcessor.clearViewer();f=Blockly.Xml.textToDom(f);Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),f);for(Blockscad.workspaceChanged();Blockscad.undo.undoStack.length;)Blockscad.undo.undoStack.pop();for(;Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop()}).fail(function(a){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()});$("#project-name").val(a);$("#displayBlocks").click();$("#projView").hide();$("#editView").show()});$("#projList").on("click",".delbtn",function(a){a.preventDefault();
var d=$(this).closest("tr");d.find(".proj-to-download").attr("data-id");var f=d.find(".proj-to-download").attr("data-key");a=d.find(".proj-to-download").html();$("#online-delete-confirm").find(".modal-title").text('Are you sure you want to delete "'+a+'"?');$("#online-delete-confirm").modal().off("click","#toss-it");$("#online-delete-confirm").modal().one("click","#toss-it",function(a){$.post(Blockscad.Auth.deleteProjectURL,{key:f},function(a,f){"success"==f&&d.remove()}).fail(function(a){"Fail. Login Required"==
a.responseText&&$("#projectView").hide();$("#editView").show();Blockscad.Auth.resetUser()})})});$("#file-menu").on("click","#session_test",function(){$.get(Blockscad.Auth.sessionTestURL,function(a){0<a.match(/^SUCCESS/).length&&alert("You are allowed to do SECRET things!!!!")}).fail(function(){alert("You aren't authorized to do SECRET things!!!!")})});$("#register-password").blur(Blockscad.Auth.validatePassword);$("#pass2").blur(Blockscad.Auth.validatePasswordMatch);$("#register-username").blur(function(){Blockscad.Auth.validateUsername(usernameCheckSetErrorMessage)});
$("#register-email").blur(Blockscad.Auth.validateEmail);$("#new-email").blur(Blockscad.Auth.validateEmail);$("#change-pw-new").blur(Blockscad.Auth.validatePassword);$("#change-pw-2").blur(Blockscad.Auth.validatePasswordMatch);$("#file-menu").on("click","#saveLocal",Blockscad.saveBlocksLocal);$("#file-menu").on("click","#saveProject",Blockscad.Auth.saveBlocksToAccount);$("#file-menu").on("click","#saveAsProject",Blockscad.Auth.saveAsCopyToAccount);$("#file-menu").on("click","#projectList",Blockscad.Auth.listProject);
$("#main").on("click",".new-project",Blockscad.newProject);$("#list-more").on("click",Blockscad.Auth.listMoreProject);$("#login-area").on("click","#bigsavebutton",Blockscad.Auth.saveBlocksToAccount);$("#forgot-password").on("click",Blockscad.Auth.forgotPassword)};
Blockscad.Auth.notLoggedIn=function(){Blockscad.Auth.isLoggedIn=0;Blockscad.Auth.currentEmail="";$("#login-area").html("<button type='button' id='reg-button' class='btn-default btn-big' data-toggle='modal' data-target='#register-user' >Register</button>\n<button type='button' id='login-button' class='btn-default btn-big' data-toggle='modal' data-target='#login-user' >Sign in</button>");$("#file-menu").html('<li><a href="#" class="new-project">New</a></li>\n<li class="divider"></li>\n<li><a href="#" id="saveLocal">Save Blocks to your Computer</a></li>\n<li>\n<input type="file" id="loadLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'loadLocal\').click(); return false">Load Blocks from your Computer</a>\n</li>\n<li class="divider"></li>\n<li>\n<input type="file" id="importLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importLocal\').click(); return false">Import Blocks into Current Project</a>\n</li>\n')};
Blockscad.Auth.loggedIn=function(a,d){Blockscad.Auth.isLoggedIn=1;Blockscad.Auth.currentEmail=d;$("#login-area").html('<button type="button" id="bigsavebutton" class="btn-default btn btn-lg" style="margin-top:2px;">Save</button><ul class="nav navbar-nav navbar-right">\n<li class="dropdown">\n<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">'+a+'<span class="caret"></span></a>\n<ul class="dropdown-menu" role="menu">\n <li><a href="#" id="changePassword" data-toggle="modal" data-target="#change-password-modal">Change Password</a></li>\n <li><a href="#" id="changeEmail" data-toggle="modal" data-target="#change-email-modal">Change Email</a></li>\n<li class="divider"></li>\n<li><a href="#" id="menuLogout">Logout</a></li>\n</ul>\n</li>\n</ul>\n');
$("#file-menu").html('<li><a href="#" id="projectList">My Projects</a></li>\n<li><a href="#" class="new-project">New</a></li>\n<li><a href="#" id="saveProject">Save</a></li>\n<li><a href="#" id="saveAsProject">Save As A Copy</a></li>\n<li class="divider"></li>\n<li><a href="#" id="saveLocal">Save Blocks to your Computer</a></li>\n<li>\n<input type="file" id="loadLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'loadLocal\').click(); return false">Load Blocks from your Computer</a>\n</li>\n<li class="divider"></li>\n<li>\n<input type="file" id="importLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importLocal\').click(); return false">Import Blocks into Current Project</a>\n</li>\n')};
Blockscad.Auth.forgotPassword=function(){$("#login-user").modal("hide");$("#pw-recover").modal("show")};Blockscad.Auth.checkForUser=function(){$.get(Blockscad.Auth.sessionTestURL,function(a,d){if(a.match(/^SUCCESS/)){var f=a.split(" ");Blockscad.Auth.loggedIn(f[1],f[2])}}).fail(function(a,d){Blockscad.Auth.notLoggedIn()})};
Blockscad.Auth.listProject=function(){0<Blockscad.undo.undoStack.length&&Blockscad.Auth.saveBlocksToAccount();$.post(Blockscad.Auth.listProjectURL,{more:"false"},function(a,d){var f=a.split("*****",2);$("#projList").html(f[1]);$("#editView").hide();$("#projectView").show();"True"==f[0]?$("#list-more").show():$("#list-more").hide()}).fail(function(a){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()})};
Blockscad.Auth.listMoreProject=function(){$.post(Blockscad.Auth.listProjectURL,{more:"true"},function(a,d){var f=a.split("*****",2);$("#projList").append(f[1]);"True"==f[0]?$("#list-more").show():$("#list-more").hide()}).fail(function(a,d){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()})};Blockscad.Auth.saveBlocksToAccount=function(){var a=$("#project-name").val();""==a&&(a="Untitled");Blockscad.Auth.saveThing(a)};
Blockscad.Auth.saveThing=function(a){var d=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),f=Blockly.Xml.domToText(d),d=Base64.toBase64(RawDeflate.deflate(Base64.utob(f)));console.log("length of uncompressed string is: ",f.length);console.log("length of compressed string is: ",d.length);f=Blockscad.version;""==Blockscad.Auth.currentProject&&(Blockscad.Auth.currentProject=(new Date).getTime());var h=new FormData;h.append("created",Blockscad.Auth.currentProject);h.append("name",a);h.append("version",
f);h.append("shared",0);h.append("key",Blockscad.Auth.currentProjectKey);h.append("content",d);$.ajax({url:Blockscad.Auth.saveProjectURL,type:"POST",data:h,contentType:!1,processData:!1,success:function(a){a=a.split(":",2);a[0]==Blockscad.Auth.currentProject?Blockscad.Auth.currentProjectKey=a[1]:console.log("in save, project id coming back doesn't match current id.  ")},error:function(a){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()}})};
Blockscad.Auth.saveAsCopyToAccount=function(){console.log("save the current project as a copy to the user's account!");var a=$("#project-name").val();""==a&&(a="Untitled");a+=" copy";Blockscad.Auth.currentProject="";Blockscad.Auth.currentProjectKey="";Blockscad.Auth.saveThing(a);$("#project-name").val(a)};
Blockscad.Auth.validateRegFields=function(){$("#register-password").blur();$("#pass2").blur();$("#register-email").blur();Blockscad.Auth.validateUsername(usernameCheckSetErrorMessage);return Blockscad.Auth.goodPassword&&Blockscad.Auth.goodPasswordMatch&&Blockscad.Auth.goodUsername&&Blockscad.Auth.goodEmail?!1:!0};Blockscad.Auth.resetUser=function(){Blockscad.Auth.notLoggedIn();$("#login-button").click()};
Blockscad.Auth.validatePassword=function(a){a=$(this).val();var d=!1,f=$(this).parent().find(".password-error");f.text("");a.length||(f.text(Blockscad.FORM_ERRORS.passwordEmpty),d=!0);a.length&&(Blockscad.Auth.isLoggedIn?$("#login-area").find("a:first").text():$("#register-username").val().toLowerCase(),a.toLowerCase()==$("#register-username").val().toLowerCase()?(f.text(Blockscad.FORM_ERRORS.passwordUsername),d=!0):"password"==a.toLowerCase()?(f.text(Blockscad.FORM_ERRORS.passwordPassword),d=!0):
6>a.length&&(f.text(Blockscad.FORM_ERRORS.passwordLength),d=!0));d?(f.addClass("form-error-message"),Blockscad.Auth.goodPassword=!1):(f.removeClass("form-error-message"),Blockscad.Auth.goodPassword=!0)};
Blockscad.Auth.validatePasswordMatch=function(a){a=$(this).parent().prev().find("input").val();var d=$(this).val(),f=$(this).parent().find(".password-confirm-error");f.text("");a!=d?(f.text(Blockscad.FORM_ERRORS.passwordConfirm),f.addClass("form-error-message"),Blockscad.Auth.goodPasswordMatch=!1):(f.removeClass("form-error-message"),Blockscad.Auth.goodPasswordMatch=!0)};
Blockscad.Auth.validateEmail=function(){var a=!1,d=$(this).val(),f=$(this).next("div").find(".email-error");f.text("");d.length?/\S+@\S+\.\S+/.test(d)||(f.html(Blockscad.FORM_ERRORS.emailInvalid),a=!0):(f.html(Blockscad.FORM_ERRORS.emailEmpty),a=!0);a?(f.addClass("form-error-message"),Blockscad.Auth.goodEmail=!1):(f.removeClass("form-error-message"),Blockscad.Auth.goodEmail=!0)};
Blockscad.Auth.validateUsername=function(a,d){var f=$("#register-username").val(),h=!1,p=$("#username-error");p.text("");f.length||d||(p.text(Blockscad.FORM_ERRORS.usernameEmpty),h=!0);if(f.length&&(3>f.length||30<f.length?(p.text(Blockscad.FORM_ERRORS.usernameLength),h=!0):/^[a-zA-Z0-9_-]+$/.test(f)||(p.text(Blockscad.FORM_ERRORS.usernameCharacters),h=!0),h?(p.addClass("form-error-message"),Blockscad.Auth.goodUsername=!1):(p.removeClass("form-error-message"),Blockscad.Auth.goodUsername=!0),!h))return $.post(Blockscad.Auth.usernameCheckURL,
{name:f},function(d){a(d)}),!1;h?(p.addClass("form-error-message"),Blockscad.Auth.goodUsername=!1):(p.removeClass("form-error-message"),Blockscad.Auth.goodUsername=!0)};function usernameCheckSetErrorMessage(a){"username exists"==a&&($("#username-error").text(Blockscad.FORM_ERRORS.usernameExists),$("#username-error").addClass("form-error-message"))}
function usernameCheckSubmitForm(a){if("username exists"!=a)return $.post(Blockscad.Auth.registerURL,$("#register-form").serialize(),function(a,f){"SUCCESS"==a&&($("#login-username").val($("#register-username").val()),$("#login-password").val($("#register-password").val()),window.setTimeout(function(){$("#login-form").submit()},1E3))}),$("#register-user").modal("hide"),!1}
function clearForm(a){a.find("input:text, input:password").val("");a.find(".password-error, #username-error, .footer-error, .password-confirm-error, .email-error").text("");a.find(".password-error, #username-error, .footer-error,  .password-confirm-error, .email-error").removeClass("form-error-message");a.find(".footer-error").removeClass("error-message")}Blockscad.FORM_ERRORS={};Blockscad.FORM_ERRORS.passwordUsername="Your password cannot match your username!";
Blockscad.FORM_ERRORS.passwordLength="Your password must be at least 6 characters long.";Blockscad.FORM_ERRORS.passwordPassword="Your password cannot be the word 'password'.";Blockscad.FORM_ERRORS.passwordEmpty="Please choose a password at least 6 characters long.";Blockscad.FORM_ERRORS.passwordConfirm="Your second password must match the first password.";Blockscad.FORM_ERRORS.emailInvalid="You must provide a valid email address.";Blockscad.FORM_ERRORS.emailEmpty="Please enter an email address.";
Blockscad.FORM_ERRORS.usernameEmpty="Please choose a username.";Blockscad.FORM_ERRORS.usernameLength="Username must be between 3 and 30 characters.";Blockscad.FORM_ERRORS.usernameCharacters="Your username may only contain letters, numbers, -, and _";Blockscad.FORM_ERRORS.usernameExists="Sorry, that username already exists.";Blockscad.FORM_ERRORS.loginFailed="Incorrect username or password.";Blockscad.FORM_ERRORS.badPassword="Incorrect password - please retype your original password.";var BlocklyStorage=BlocklyStorage||{},Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{};var Blockly=Blockly||{};Blockly.Xml=Blockly.Xml||{};
BlocklyStorage.backupBlocks_=function(){console.log("in backupBlocks");if("localStorage"in window){var a=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),d=window.location.href.split("#")[0],f=d+"proj_name",h=d+"current_project",p=$("#project-name").val(),k=Blockscad.Auth.currentProject;window.localStorage.setItem(d,Blockly.Xml.domToText(a));window.localStorage.setItem(f,p);window.localStorage.setItem(h,k)}};
BlocklyStorage.backupOnUnload=function(){console.log("in backupOnUnload");window.addEventListener("unload",BlocklyStorage.backupBlocks_,!1)};
BlocklyStorage.restoreBlocks=function(){var a=window.location.href.split("#")[0],d=a+"proj_name",f=a+"current_project";"localStorage"in window&&window.localStorage[a]&&(a=Blockly.Xml.textToDom(window.localStorage[a]),Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),a),d=window.localStorage[d],"undefined"!=d?$("#project-name").val(d):$("#project-name").val("Untitled"),f=window.localStorage[f],Blockscad.Auth.currentProject="undefined"!=f?f:"")};var BSUtils=BSUtils||{};BSUtils.LANGUAGE_NAME={en:"English",es:"Espa\u00f1ol"};BSUtils.LANGUAGE_RTL=["ar","fa","he"];BSUtils.LANGUAGES=void 0;BSUtils.getStringParamFromUrl=function(a,d){var f=window.location.search.match(new RegExp("[?&]"+a+"=([^&]+)"));return f?decodeURIComponent(f[1].replace(/\+/g,"%20")):d};BSUtils.getLang=function(){var a=BSUtils.getStringParamFromUrl("lang","");void 0===BSUtils.LANGUAGE_NAME[a]&&(a="en");return a};BSUtils.LANG=BSUtils.getLang();
BSUtils.isRtl=function(){return-1!=BSUtils.LANGUAGE_RTL.indexOf(BSUtils.LANG)};
BSUtils.init=function(){var a=BSUtils.isRtl();document.head.parentElement.setAttribute("dir",a?"rtl":"ltr");document.head.parentElement.setAttribute("lang",BSUtils.LANG);for(var a=[],d=0;d<BSUtils.LANGUAGES.length;d++){var f=BSUtils.LANGUAGES[d];a.push([BSUtils.LANGUAGE_NAME[f],f])}a.sort(function(a,d){return a[0]>d[0]?1:a[0]<d[0]?-1:0});for(var h=document.getElementById("languageMenu"),d=h.options.length=0;d<a.length;d++){var p=a[d],f=p[p.length-1],p=new Option(p[0],f);f==BSUtils.LANG&&(p.selected=
!0);h.options.add(p)}h.addEventListener("change",BSUtils.changeLanguage,!0);document.getElementById("codeButton")&&BSUtils.bindClick("codeButton",BSUtils.showCode);(a=document.querySelector('meta[name="viewport"]'))&&725>screen.availWidth&&a.setAttribute("content","width=725, initial-scale=.35, user-scalable=no")};
BSUtils.initReadonly=function(){Blockly.inject(document.getElementById("blockly"),{path:"./",readOnly:!0,rtl:BSUtils.isRtl(),scrollbars:!1});var a=BSUtils.getStringParamFromUrl("xml",""),a=Blockly.Xml.textToDom("<xml>"+a+"</xml>");Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)};
BSUtils.loadBlocks=function(a){try{var d=window.sessionStorage.loadOnceBlocks}catch(f){d=null}"BlocklyStorage"in window&&1<window.location.hash.length?BlocklyStorage.retrieveXml(window.location.hash.substring(1)):d?(delete window.sessionStorage.loadOnceBlocks,a=Blockly.Xml.textToDom(d),Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)):a?(a=Blockly.Xml.textToDom(a),Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)):"BlocklyStorage"in window&&window.setTimeout(BlocklyStorage.restoreBlocks,0)};
BSUtils.changeLanguage=function(){if("undefined"!=typeof Blockly&&window.sessionStorage){var a=Blockly.Xml.workspaceToDom(Blockly.mainWorkspace),a=Blockly.Xml.domToText(a);window.sessionStorage.loadOnceBlocks=a}var a=document.getElementById("languageMenu"),a=encodeURIComponent(a.options[a.selectedIndex].value),d=window.location.search,d=1>=d.length?"?lang="+a:d.match(/[?&]lang=[^&]*/)?d.replace(/([?&]lang=)[^&]*/,"$1"+a):d.replace(/\?/,"?lang="+a+"&");window.location=window.location.protocol+"//"+
window.location.host+window.location.pathname+d};BSUtils.isDialogVisible_=!1;BSUtils.dialogOrigin_=null;BSUtils.dialogDispose_=null;
BSUtils.showDialog=function(a,d,f,h,p,k){function t(){BSUtils.isDialogVisible_&&(l.style.visibility="visible",l.style.zIndex=1,E.style.visibility="hidden")}BSUtils.isDialogVisible_&&BSUtils.hideDialog(!1);BSUtils.isDialogVisible_=!0;BSUtils.dialogOrigin_=d;BSUtils.dialogDispose_=k;var l=document.getElementById("dialog");k=document.getElementById("dialogShadow");var E=document.getElementById("dialogBorder"),m;for(m in p)l.style[m]=p[m];h&&(k.style.visibility="visible",k.style.opacity=.3,h=document.createElement("div"),
h.id="dialogHeader",l.appendChild(h),BSUtils.dialogMouseDownWrapper_=Blockly.bindEvent_(h,"mousedown",null,BSUtils.dialogMouseDown_));l.appendChild(a);a.className=a.className.replace("dialogHiddenContent","");f&&d?(BSUtils.matchBorder_(d,!1,.2),BSUtils.matchBorder_(l,!0,.8),window.setTimeout(t,175)):t()};BSUtils.dialogStartX_=0;BSUtils.dialogStartY_=0;
BSUtils.dialogMouseDown_=function(a){BSUtils.dialogUnbindDragEvents_();if(!Blockly.isRightButton(a)){var d=document.getElementById("dialog");BSUtils.dialogStartX_=d.offsetLeft-a.clientX;BSUtils.dialogStartY_=d.offsetTop-a.clientY;BSUtils.dialogMouseUpWrapper_=Blockly.bindEvent_(document,"mouseup",null,BSUtils.dialogUnbindDragEvents_);BSUtils.dialogMouseMoveWrapper_=Blockly.bindEvent_(document,"mousemove",null,BSUtils.dialogMouseMove_);a.stopPropagation()}};
BSUtils.dialogMouseMove_=function(a){var d=document.getElementById("dialog"),f=BSUtils.dialogStartX_+a.clientX;a=BSUtils.dialogStartY_+a.clientY;a=Math.max(a,0);a=Math.min(a,window.innerHeight-d.offsetHeight);f=Math.max(f,0);f=Math.min(f,window.innerWidth-d.offsetWidth);d.style.left=f+"px";d.style.top=a+"px"};
BSUtils.dialogUnbindDragEvents_=function(){BSUtils.dialogMouseUpWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseUpWrapper_),BSUtils.dialogMouseUpWrapper_=null);BSUtils.dialogMouseMoveWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseMoveWrapper_),BSUtils.dialogMouseMoveWrapper_=null)};
BSUtils.hideDialog=function(a){function d(){h.style.visibility="hidden";p.style.visibility="hidden"}if(BSUtils.isDialogVisible_){BSUtils.dialogUnbindDragEvents_();BSUtils.dialogMouseDownWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseDownWrapper_),BSUtils.dialogMouseDownWrapper_=null);BSUtils.isDialogVisible_=!1;BSUtils.dialogDispose_&&BSUtils.dialogDispose_();BSUtils.dialogDispose_=null;var f=!1===a?null:BSUtils.dialogOrigin_;a=document.getElementById("dialog");var h=document.getElementById("dialogShadow"),
p=document.getElementById("dialogBorder");h.style.opacity=0;f?(BSUtils.matchBorder_(a,!1,.8),BSUtils.matchBorder_(f,!0,.2),window.setTimeout(d,175)):d();a.style.visibility="hidden";a.style.zIndex=-1;for((f=document.getElementById("dialogHeader"))&&f.parentNode.removeChild(f);a.firstChild;)f=a.firstChild,f.className+=" dialogHiddenContent",document.body.appendChild(f)}};
BSUtils.matchBorder_=function(a,d,f){function h(){p.style.width=k.width+"px";p.style.height=k.height+"px";p.style.left=k.x+"px";p.style.top=k.y+"px";p.style.opacity=f}if(a){var p=document.getElementById("dialogBorder"),k=BSUtils.getBBox_(a);d?(p.className="dialogAnimate",window.setTimeout(h,1)):(p.className="",h());p.style.visibility="visible"}};
BSUtils.getBBox_=function(a){var d=a.offsetHeight,f=a.offsetWidth,h=0,p=0;do h+=a.offsetLeft,p+=a.offsetTop,a=a.offsetParent;while(a);return{height:d,width:f,x:h,y:p}};
BSUtils.storageAlert=function(a){var d=document.getElementById("containerStorage");d.textContent="";a=a.split("\n");for(var f=0;f<a.length;f++){var h=document.createElement("p");h.appendChild(document.createTextNode(a[f]));d.appendChild(h)}d=document.getElementById("dialogStorage");a=document.getElementById("linkButton");BSUtils.showDialog(d,a,!0,!0,{width:"50%",left:"25%",top:"5em"},BSUtils.stopDialogKeyDown());BSUtils.startDialogKeyDown()};
BSUtils.dialogKeyDown_=function(a){!BSUtils.isDialogVisible_||13!=a.keyCode&&27!=a.keyCode&&32!=a.keyCode||(BSUtils.hideDialog(!0),a.stopPropagation(),a.preventDefault())};BSUtils.startDialogKeyDown=function(){document.body.addEventListener("keydown",BSUtils.dialogKeyDown_,!0)};BSUtils.stopDialogKeyDown=function(){document.body.removeEventListener("keydown",BSUtils.dialogKeyDown_,!0)};BSUtils.getMsg=function(a){var d=BSUtils.getMsgOrNull(a);return null===d?"[Unknown message: "+a+"]":d};
BSUtils.getMsgOrNull=function(a){return(a=document.getElementById(a))?(a=a.textContent,a=a.replace(/\\n/g,"\n")):null};BSUtils.addTouchEvents=function(){if("ontouchstart"in document.documentElement)for(var a=document.getElementsByTagName("button"),d=0,f;f=a[d];d++)f.ontouchend||(f.ontouchend=f.onclick)};window.addEventListener("load",BSUtils.addTouchEvents,!1);
BSUtils.bindClick=function(a,d){"string"==typeof a&&(a=document.getElementById(a));a.addEventListener("click",d,!0);a.addEventListener("touchend",d,!0)};Blockscad=Blockscad||{};Blockscad.Toolbox=Blockscad.Toolbox||{};var BlocklyStorage=BlocklyStorage||{},OpenJsCad=OpenJsCad||{},Blockly=Blockly||{},BSUtils=BSUtils||{};Blockscad.version="1.0.0";var gCurrentFile=null,gProcessor=null,editor=null,gCurrentFiles=[],gMemFs=[],gMemFsCount=0,gMemFsTotal=0,gMemFsChanged=0,gRootFs=[],_includePath="./";Blockscad.drawAxes=1;
Blockscad.init=function(){function a(a,d){var f=a.target.files[0];if(f){if(d)var t=f.name.substr(0,f.name.lastIndexOf("("))||f.name,t=t.substr(0,f.name.lastIndexOf("."))||t,t=t.replace(/^\s+|\s+$/g,"");Blockscad.Auth.isLoggedIn&&0<Blockscad.undo.undoStack.length&&Blockscad.Auth.saveBlocksToAccount();d&&(Blockscad.Auth.currentProject="",Blockly.getMainWorkspace().clear());var l={},E=new FileReader;E.onload=function(a){l=a.target.result;a=Blockly.Xml.textToDom(l);Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),
a);Blockly.fireUiEvent(window,"resize")};E.readAsText(f);d&&$("#project-name").val(t);$("#projView").hide();$("#editView").show();$("#displayBlocks").click()}else alert("Failed to load file")}Blockscad.initLanguage();var d=BSUtils.isRtl();Blockscad.missingFields=[];var f=document.getElementById("main");window.addEventListener("resize",function(a){a=BSUtils.getBBox_(f);var d=document.getElementById("blocklyDiv");d.style.top=a.y+"px";d.style.left=a.x+"px";d.style.height=a.height-88+"px";d.style.width=
a.width+"px";gProcessor&&gProcessor.viewer.rendered_resize(gProcessor.viewerdiv.offsetWidth,gProcessor.viewerdiv.offsetHeight);70>$("#main").height()-$(".resizableDiv").height()&&$(".resizableDiv").height($("#main").height()-70);20>$("#main").width()-$(".resizableDiv").width()&&$(".resizableDiv").width($("#main").width()-20);$(".resizableDiv").position({of:$("#main"),my:"right top",at:"right top",offset:"-12 -55"})},!1);Blockscad.workspace=Blockly.inject(document.getElementById("blocklyDiv"),{media:"blockly/media/",
rtl:d,toolbox:Blockscad.Toolbox.other});BSUtils.loadBlocks("");"BlocklyStorage"in window&&BlocklyStorage.backupOnUnload();$(".resizableDiv").resizable({handles:"s,w,sw",resize:function(a,d){var f=$(window).height();gProcessor&&(f=gProcessor.viewerdiv.offsetHeight,gProcessor.viewer.rendered_resize(gProcessor.viewerdiv.offsetWidth,f));20>$("#main").width()-d.size.width&&(d.size.width=$("#main").width()-20);70>$("#main").height()-d.size.height&&(d.size.height=$("#main").height()-70);d.position.left=
$(window).width()-(d.size.width+12);d.position.top=55}});Blockly.fireUiEvent(window,"resize");Blockscad.Auth.init();BSUtils.bindClick("trashButton",function(){Blockscad.discard()});BSUtils.bindClick("renderButton",Blockscad.doRender);BSUtils.bindClick("undoButton",Blockscad.onUndo);BSUtils.bindClick("redoButton",Blockscad.onRedo);$("#axesButton").click(function(){Blockscad.drawAxes=(Blockscad.drawAxes+1)%2;$("#axesButton").toggleClass("btn-pushed");gProcessor.viewer.onDraw()});$("#displayCode").click(function(){var a=
document.getElementById("openScadPre"),d=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace);a.textContent=d;"function"==typeof prettyPrintOne&&(d=a.innerHTML,d=prettyPrintOne(d,"js"),a.innerHTML=d);Blockly.fireUiEvent(window,"resize")});$("#renderButton").prop("disabled",!0);$("#throw-it-away").click(Blockscad.clearProject);$("#target").click(function(){alert("Handler for .click() called.")});$("#file-menu").on("change","#loadLocal",function(d){a(d,!0)});$("#file-menu").on("change","#importLocal",
function(d){a(d,!1)});gProcessor=new OpenJsCad.Processor(document.getElementById("renderDiv"));BSUtils.bindClick("viewReset",Blockscad.resetView);Blockscad.undo={blockList:[],oldBlockList:[],undoStack:[],redoStack:[],current_xml:null,blockCount:0,yesthis:0,fieldChanging:0,blockIds:[],fieldValues:[],parentIds:[],oldBlockIds:[],oldFieldValues:[],oldParentIds:[],just_did_undo:0};Blockscad.workspace.addUndoListener(Blockscad.workspaceChanged);Blockscad.Auth.checkForUser();$("#help-menu").on("click","#about",
function(){$("#about-modal").modal("show")})};document.write('<script src="blockly/msg/js/'+BSUtils.LANG+'.js">\x3c/script>\n');window.addEventListener("load",Blockscad.init);Blockscad.newProject=function(){0<Blockscad.undo.undoStack.length?Blockscad.Auth.isLoggedIn?(Blockscad.Auth.saveBlocksToAccount(),Blockscad.clearProject()):$("#delete-confirm").modal("show"):Blockscad.clearProject();$("#displayBlocks").click()};
Blockscad.clearProject=function(){Blockscad.Auth.currentProject="";Blockscad.Auth.currentProjectKey="";Blockly.mainWorkspace.clear();gProcessor.clearViewer();for(Blockscad.workspaceChanged();Blockscad.undo.undoStack.length;)Blockscad.undo.undoStack.pop();for(;Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop();$("#project-name").val("Untitled");$("#projectView").hide();$("#editView").show()};
Blockscad.discard=function(){var a=Blockly.mainWorkspace.getAllBlocks().length;if(2>a||window.confirm("Delete all "+a+" blocks?"))Blockly.mainWorkspace.clear(),window.location.hash=""};Blockscad.resetView=function(){gProcessor&&gProcessor.viewer&&gProcessor.viewer.viewReset()};
Blockscad.mixes2and3D=function(){for(var a=[],a=Blockly.mainWorkspace.getTopBlocks(),d=0,f=0,h=0,p=0,k=0;k<a.length;k++)if(Blockscad.stackIsShape(a[k])){var p=1,t=a[k].category;"PRIMITIVE_CSG"==t&&d++;"PRIMITIVE_CAG"==t&&f++;if("TRANSFORM"==t||"SET_OP"==t){var l=a[k].getInput("A").connection.check_;1==l.length&&"CSG"==l[0]&&d++;1==l.length&&"CAG"==l[0]&&f++}"LOOP"==t&&(l=a[k].getInput("DO").connection.check_,1==l.length&&"CSG"==l[0]&&d++,1==l.length&&"CAG"==l[0]&&f++);"PROCEDURE"==t&&((l=a[k].myType_)&&
"CSG"==l&&d++,l&&"CAG"==l&&f++);"COLOR"==t&&d++;"EXTRUDE"==t&&d++;"controls_if"==a[k].type&&h++}!p||d+f+h||Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks());return[d&&f,p]};
Blockscad.doRender=function(){$("#error-message").text("");$("#error-message").removeClass("has-error");$("#renderButton").prop("disabled",!0);gProcessor.clearViewer();var a=Blockscad.mixes2and3D();if(0==a[1])$("#error-message").text("Error: Nothing to Render"),$("#error-message").addClass("has-error");else if(a[0])$("#error-message").text("Error: both 2D and 3D objects are present.  There can be only one."),$("#error-message").addClass("has-error");else{Blockscad.missingFields=[];var d=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace);
if(0<Blockscad.missingFields.length){for(a=0;a<Blockscad.missingFields.length;a++){var f=Blockly.mainWorkspace.getBlockById(Blockscad.missingFields[a]);f.unselect();f.backlight();if(f=f.collapsedParents())for(var h=0;h<f.length;h++)f[h].unselect(),f[h].backlight()}$("#error-message").text("ERROR: "+Blockscad.missingFields.length+" blocks have empty fields.");$("#error-message").addClass("has-error")}else{a=!0;try{$("#renderButton").html("working"),window.setTimeout(function(){d=openscadOpenJscadParser.parse(d)},
0)}catch(p){$("#error-message").text(p),$("#error-message").addClass("has-error"),a=!1}a?window.setTimeout(function(){gProcessor.setJsCad(d)},0):$("#renderButton").html("Render")}}};
Blockscad.isRealChange=function(){Blockscad.undo.blockIds=[];Blockscad.undo.parentIds=[];Blockscad.undo.fieldValues=[];Blockscad.undo.isDisabled=[];for(var a=null,a=a=null,d=0;d<Blockscad.undo.blockList.length;d++)Blockscad.undo.fieldValues[d]=Blockscad.undo.blockList[d].getAllFieldValues(),Blockscad.undo.blockIds[d]=Blockscad.undo.blockList[d].id,Blockscad.undo.isDisabled[d]=Blockscad.undo.blockList[d].disabled,Blockscad.undo.blockList[d].getParent()?Blockscad.undo.parentIds[d]=Blockscad.undo.blockList[d].getParent().id:
Blockscad.undo.parentIds[d]=null,Blockscad.undo.blockList[d].category&&"UNKNOWN"==Blockscad.undo.blockList[d].category&&Blockscad.undo.blockList[d].getType();if(Blockscad.undo.blockCount>Blockscad.undo.blockList.length)return Blockscad.undo.fieldChanging=0,0!=Blockscad.undo.blockList.length&&(a=Blockscad.getExtraRootBlock(Blockscad.undo.oldBlockList,Blockscad.undo.blockList),(a=Blockscad.getBlockFromId(Blockscad.undo.oldParentIds[a],Blockscad.undo.blockList))&&Blockscad.assignBlockTypes([a])),!0;
if(Blockscad.undo.blockCount<Blockscad.undo.blockList.length)return Blockscad.undo.fieldChanging=0,0==Blockscad.undo.oldBlockList.length?Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks()):(a=Blockscad.getExtraRootBlock(Blockscad.undo.oldBlockList,Blockscad.undo.blockList),Blockscad.assignBlockTypes([Blockscad.undo.blockList[a]])),!0;for(d=0;d<Blockscad.undo.blockIds.length;d++){for(var f=Blockscad.undo.blockIds[d],h=0,a=0;a<Blockscad.undo.blockIds.length;a++)if(f==Blockscad.undo.oldBlockIds[a]){h=
1;if(Blockscad.undo.parentIds[d]!=Blockscad.undo.oldParentIds[a]){Blockscad.enableMathBlocks(Blockscad.undo.blockList[d]);Blockscad.assignBlockTypes([Blockscad.undo.blockList[d]]);for(d=0;f=Blockscad.undo.blockList[d];d++)if(f.id==Blockscad.undo.oldParentIds[a]){Blockscad.assignBlockTypes([Blockscad.undo.blockList[d]]);Blockscad.enableMathBlocks(Blockscad.undo.blockList[d]);break}return!0}if(Blockscad.undo.fieldValues[d]!=Blockscad.undo.oldFieldValues[a])return $("#renderButton").prop("disabled",
!1),Blockscad.undo.fieldChanging!=f?(Blockscad.undo.fieldChanging=f,!0):!1;if(Blockscad.undo.isDisabled[d]!=Blockscad.undo.oldDisabled[a])return!0}if(!h)return!0}return!1};
Blockscad.workspaceChanged=function(){Blockscad.undo.yesthis=0;Blockscad.undo.blockList=Blockly.mainWorkspace.getAllBlocks();Blockscad.undo.yesthis=Blockscad.isRealChange();Blockscad.undo.blockCount=Blockscad.undo.blockList.length;Blockscad.undo.oldBlockIds=Blockscad.undo.blockIds;Blockscad.undo.oldParentIds=Blockscad.undo.parentIds;Blockscad.undo.oldFieldValues=Blockscad.undo.fieldValues;Blockscad.undo.oldDisabled=Blockscad.undo.isDisabled;Blockscad.checkMathOrphans();if(Blockscad.undo.yesthis&&
($("#renderButton").prop("disabled",!1),Blockscad.undo.just_did_undo&&Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks()),0==Blockscad.undo.just_did_undo)){null!=Blockscad.undo.current_xml&&Blockscad.undo.undoStack.push(Blockscad.undo.current_xml);for(Blockscad.undo.current_xml=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());0<Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop();50<Blockscad.undo.undoStack.length&&Blockscad.undo.undoStack.shift()}Blockscad.undo.current_xml=
Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());Blockscad.undo.oldBlockList=[];for(var a=0;a<Blockscad.undo.blockList.length;a++)Blockscad.undo.oldBlockList.push(Blockly.Xml.blockToDom_(Blockscad.undo.blockList[a]));Blockscad.undo.just_did_undo=0;0<Blockscad.undo.undoStack.length?$("#undoButton").prop("disabled",!1):$("#undoButton").prop("disabled",!0);0<Blockscad.undo.redoStack.length?$("#redoButton").prop("disabled",!1):$("#redoButton").prop("disabled",!0)};
Blockscad.getExtraRootBlock=function(a,d){var f=0;if(a.length>d.length)for(var h=0;h<a.length;h++){for(var p=f=0;p<d.length;p++)if(a[h].getAttribute("id")==d[p].id){f=1;break}if(!f)return h}else for(h=0;h<d.length;h++){for(p=f=0;p<a.length;p++)if(d[h].id==a[p].getAttribute("id")){f=1;break}if(!f)return h}return 0};Blockscad.getBlockFromId=function(a,d){for(var f=0,h;h=d[f];f++)if(h.id==a)return h;return null};
Blockscad.onUndo=function(){0<Blockscad.undo.undoStack.length&&(Blockscad.undo.redoStack.push(Blockscad.undo.current_xml),Blockscad.undo.current_xml=Blockscad.undo.undoStack.pop(),Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),Blockscad.undo.current_xml),Blockly.mainWorkspace.render(),Blockscad.undo.just_did_undo=1)};
Blockscad.onRedo=function(){0<Blockscad.undo.redoStack.length&&(Blockscad.undo.undoStack.push(Blockscad.undo.current_xml),Blockscad.undo.current_xml=Blockscad.undo.redoStack.pop(),Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),Blockscad.undo.current_xml),Blockly.mainWorkspace.render(),Blockscad.undo.just_did_undo=1)};
Blockscad.checkMathOrphans=function(){for(var a=[],a=Blockly.mainWorkspace.getTopBlocks(),d=0;d<a.length;d++)-1==a[d].type.lastIndexOf("math")&&-1==a[d].type.lastIndexOf("variables_get")&&-1==a[d].type.lastIndexOf("logic")||a[d].setDisabled(!0)};
Blockscad.enableMathBlocks=function(a){a=a.getDescendants();for(var d=0;d<a.length;d++)if(a[d].disabled&&(-1!=a[d].type.lastIndexOf("math")||-1!=a[d].type.lastIndexOf("variables_get")||-1!=a[d].type.lastIndexOf("logic"))){var f;if(f=a[d].getParent())f.disabled||a[d].setDisabled(!1)}};Blockscad.aCallerBlock=function(a,d){for(var f=0;f<d.length;f++)if(a==d[f])return!0;return!1};
Blockscad.findBlockType=function(a,d){for(var f=a.getRootBlock().getDescendants(),h=0,p=0,k=0;k<f.length;k++)if(!Blockscad.aCallerBlock(f[k],d)&&f[k].category){var t=f[k].category;if("PRIMITIVE_CSG"==t||"EXTRUDE"==t||"COLOR"==t){h=1;break}"PRIMITIVE_CAG"==t&&(p=1)}return h?Blockscad.hasExtrudeParent(a)?"CAG":"CSG":p?"CAG":"EITHER"};Blockscad.stackIsShape=function(a){a=a.getDescendants();for(var d=0;d<a.length;d++){var f=a[d];if(("PRIMITIVE_CSG"==f.category||"PRIMITIVE_CAG"==f.category)&&!f.hasDisabledParent())return!0}return!1};
Blockscad.assignBlockTypes=function(a){for(var d=0;d<a.length;d++){for(var f=a[d].getRootBlock().getDescendants(),h=0,p=0,k=0;k<f.length;k++)if(f[k].category){var t=f[k].category;if("PRIMITIVE_CSG"==t||"EXTRUDE"==t||"COLOR"==t){h=1;break}"PRIMITIVE_CAG"==t&&(p=1)}for(k=0;k<f.length;k++)!f[k].category||"TRANSFORM"!=f[k].category&&"SET_OP"!=f[k].category&&"PROCEDURE"!=f[k].category&&"LOOP"!=f[k].category||(t=!f[k].collapsedParents(),h?Blockscad.hasExtrudeParent(f[k])?f[k].setType("CAG",t):f[k].setType("CSG",
t):p?f[k].setType("CAG",t):f[k].setType(["CSG","CAG"],t))}};Blockscad.hasExtrudeParent=function(a){do{if("EXTRUDE"==a.category)return!0;a=a.parentBlock_}while(a);return!1};function putSourceInEditor(a,d){editor.setValue(a);editor.clearSelection();editor.navigateFileStart();previousFilename=d;previousScript=a;gPreviousModificationTime=""}
Blockscad.initLanguage=function(){var a=BSUtils.isRtl();document.head.parentElement.setAttribute("dir",a?"rtl":"ltr");document.head.parentElement.setAttribute("lang",BSUtils.LANG);var a=[],d;for(d in BSUtils.LANGUAGE_NAME)a.push([BSUtils.LANGUAGE_NAME[d],d]);a.sort(function(a,d){return a[0]>d[0]?1:a[0]<d[0]?-1:0});for(var f=document.getElementById("languageMenu"),h=f.options.length=0;h<a.length;h++){var p=a[h];d=p[p.length-1];p=new Option(p[0],d);d==BSUtils.LANG&&(p.selected=!0);f.options.add(p)}f.addEventListener("change",
BSUtils.changeLanguage,!0)};Blockscad.saveBlocksLocal=function(){var a=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),a=Blockly.Xml.domToText(a),a=new Blob([a],{type:"text/plain;charset=utf-8"}),d=$("#project-name").val();d?saveAs(a,d+".xml"):alert("SAVE FAILED.  Please give your project a name, then try again.")};var fileSaver={},saveAs=saveAs||"undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){if("undefined"===typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var d=a.document,f=a.URL||a.webkitURL||a,h=d.createElementNS("http://www.w3.org/1999/xhtml","a"),p=!a.externalHost&&"download"in h,k=a.webkitRequestFileSystem,t=a.requestFileSystem||k||a.mozRequestFileSystem,l=function(d){(a.setImmediate||a.setTimeout)(function(){throw d;},0)},
E=0,m=[],N=function(){for(var a=m.length;a--;){var d=m[a];"string"===typeof d?f.revokeObjectURL(d):d.remove()}m.length=0},D=function(a,d,f){d=[].concat(d);for(var k=d.length;k--;){var h=a["on"+d[k]];if("function"===typeof h)try{h.call(a,f||a)}catch(p){l(p)}}},z=function(f,n){var l=this,u=f.type,q=!1,r,e,v=function(){var b=(a.URL||a.webkitURL||a).createObjectURL(f);m.push(b);return b},z=function(){D(l,["writestart","progress","write","writeend"])},H=function(){if(q||!r)r=v(f);e?e.location.href=r:window.open(r,
"_blank");l.readyState=l.DONE;z()},c=function(b){return function(){if(l.readyState!==l.DONE)return b.apply(this,arguments)}},g={create:!0,exclusive:!1},b;l.readyState=l.INIT;n||(n="download");if(p)r=v(f),d=a.document,h=d.createElementNS("http://www.w3.org/1999/xhtml","a"),h.href=r,h.download=n,u=d.createEvent("MouseEvents"),u.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),h.dispatchEvent(u),l.readyState=l.DONE,z();else{a.chrome&&u&&"application/octet-stream"!==u&&(b=f.slice||f.webkitSlice,
f=b.call(f,0,f.size,"application/octet-stream"),q=!0);k&&"download"!==n&&(n+=".download");if("application/octet-stream"===u||k)e=a;t?(E+=f.size,t(a.TEMPORARY,E,c(function(b){b.root.getDirectory("saved",g,c(function(b){var a=function(){b.getFile(n,g,c(function(b){b.createWriter(c(function(c){c.onwriteend=function(c){e.location.href=b.toURL();m.push(b);l.readyState=l.DONE;D(l,"writeend",c)};c.onerror=function(){var b=c.error;b.code!==b.ABORT_ERR&&H()};["writestart","progress","write","abort"].forEach(function(b){c["on"+
b]=l["on"+b]});c.write(f);l.abort=function(){c.abort();l.readyState=l.DONE};l.readyState=l.WRITING}),H)}),H)};b.getFile(n,{create:!1},c(function(b){b.remove();a()}),c(function(b){b.code===b.NOT_FOUND_ERR?a():H()}))}),H)}),H)):H()}},u=z.prototype,n=function(a,d){return new z(a,d)};u.abort=function(){this.readyState=this.DONE;D(this,"abort")};u.readyState=u.INIT=0;u.WRITING=1;u.DONE=2;u.error=u.onwritestart=u.onprogress=u.onwrite=u.onabort=u.onerror=u.onwriteend=null;a.addEventListener("unload",N,!1);
n.unload=function(){N();a.removeEventListener("unload",N,!1)};return n}}("undefined"!==typeof self&&self||"undefined"!==typeof window&&window||this.content);"undefined"!==typeof module&&(module.exports=saveAs);var GL=function(){function a(c,g,b){b=b||{};this.id=e.createTexture();this.width=c;this.height=g;this.format=b.format||e.RGBA;this.type=b.type||e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,this.id);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,b.filter||b.magFilter||e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,b.filter||b.minFilter||e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,b.wrap||b.wrapS||e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,
e.TEXTURE_WRAP_T,b.wrap||b.wrapT||e.CLAMP_TO_EDGE);e.texImage2D(e.TEXTURE_2D,0,this.format,c,g,0,this.format,this.type,null)}function d(){this.unique=[];this.indices=[];this.map={}}function f(c,g){this.buffer=null;this.target=c;this.type=g;this.data=[]}function h(c){c=c||{};this.vertexBuffers={};this.indexBuffers={};this.addVertexBuffer("vertices","gl_Vertex");c.coords&&this.addVertexBuffer("coords","gl_TexCoord");c.normals&&this.addVertexBuffer("normals","gl_Normal");c.colors&&this.addVertexBuffer("colors",
"gl_Color");"triangles"in c&&!c.triangles||this.addIndexBuffer("triangles");c.lines&&this.addIndexBuffer("lines")}function p(c){return new k(2*(c&1)-1,(c&2)-1,(c&4)/2-1)}function k(c,g,b){this.x=c||0;this.y=g||0;this.z=b||0}function t(c,g,b){for(var a;null!==(a=c.exec(g));)b(a)}function l(c,g){function b(b){var c=document.getElementById(b);return c?c.text:b}function a(b,c){var g={},d=/^((\s*\/\/.*\n|\s*#extension.*\n)+)\^*$/.exec(c);c=d?d[1]+b+c.substr(d[1].length):b+c;t(/\bgl_\w+\b/g,b,function(b){b in
g||(c=c.replace(new RegExp("\\b"+b+"\\b","g"),"LIGHTGL"+b),g[b]=!0)});return c}function d(b,c){var g=e.createShader(b);e.shaderSource(g,c);e.compileShader(g);if(!e.getShaderParameter(g,e.COMPILE_STATUS))throw"compile error: "+e.getShaderInfoLog(g);return g}c=b(c);g=b(g);var f=c+g,k={};t(/\b(gl_[^;]*)\b;/g,"uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;",
function(b){b=b[1];if(-1!=f.indexOf(b)){var c=b.replace(/[a-z_]/g,"");k[c]="LIGHTGL"+b}});-1!=f.indexOf("ftransform")&&(k.MVPM="LIGHTGLgl_ModelViewProjectionMatrix");this.usedMatrices=k;c=a("uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;attribute vec4 gl_Vertex;attribute vec4 gl_TexCoord;attribute vec3 gl_Normal;attribute vec4 gl_Color;vec4 ftransform() {  return gl_ModelViewProjectionMatrix * gl_Vertex;}",
c);g=a("precision highp float;uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;",g);this.program=e.createProgram();e.attachShader(this.program,d(e.VERTEX_SHADER,c));e.attachShader(this.program,d(e.FRAGMENT_SHADER,g));e.linkProgram(this.program);if(!e.getProgramParameter(this.program,e.LINK_STATUS))throw"link error: "+
e.getProgramInfoLog(this.program);this.attributes={};this.uniformLocations={};var h={};t(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,c+g,function(b){h[b[2]]=1});this.isSampler=h}function E(){e.MODELVIEW=S|1;e.PROJECTION=S|2;var c=new n,g=new n;e.modelviewMatrix=new n;e.projectionMatrix=new n;var b=[],a=[],d,f;e.matrixMode=function(c){switch(c){case e.MODELVIEW:d="modelviewMatrix";f=b;break;case e.PROJECTION:d="projectionMatrix";f=a;break;default:throw"invalid matrix mode "+c;}};e.loadIdentity=
function(){n.identity(e[d])};e.loadMatrix=function(b){b=b.m;for(var c=e[d].m,g=0;16>g;g++)c[g]=b[g]};e.multMatrix=function(b){e.loadMatrix(n.multiply(e[d],b,g))};e.perspective=function(b,g,a,d){e.multMatrix(n.perspective(b,g,a,d,c))};e.frustum=function(b,g,a,d,w,f){e.multMatrix(n.frustum(b,g,a,d,w,f,c))};e.ortho=function(b,g,a,d,w,f){e.multMatrix(n.ortho(b,g,a,d,w,f,c))};e.scale=function(b,g,a){e.multMatrix(n.scale(b,g,a,c))};e.translate=function(b,g,a){e.multMatrix(n.translate(b,g,a,c))};e.rotate=
function(b,g,a,d){e.multMatrix(n.rotate(b,g,a,d,c))};e.lookAt=function(b,g,a,d,w,f,B,k,h){e.multMatrix(n.lookAt(b,g,a,d,w,f,B,k,h,c))};e.pushMatrix=function(){f.push(Array.prototype.slice.call(e[d].m))};e.popMatrix=function(){var b=f.pop();e[d].m=H?new Float32Array(b):b};e.project=function(b,c,g,a,d,w){a=a||e.modelviewMatrix;d=d||e.projectionMatrix;w=w||e.getParameter(e.VIEWPORT);b=d.transformPoint(a.transformPoint(new k(b,c,g)));return new k(w[0]+w[2]*(.5*b.x+.5),w[1]+w[3]*(.5*b.y+.5),.5*b.z+.5)};
e.unProject=function(b,a,d,w,f,B){w=w||e.modelviewMatrix;f=f||e.projectionMatrix;B=B||e.getParameter(e.VIEWPORT);b=new k((b-B[0])/B[2]*2-1,(a-B[1])/B[3]*2-1,2*d-1);return n.inverse(n.multiply(f,w,c),g).transformPoint(b)};e.matrixMode(e.MODELVIEW)}function m(){var c=new h({coords:!0,colors:!0,triangles:!1}),g=-1,b=[0,0,0,0],a=[1,1,1,1],d=new l("uniform float pointSize;varying vec4 color;varying vec4 coord;void main() {color = gl_Color;coord = gl_TexCoord;gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;gl_PointSize = pointSize;}",
"uniform sampler2D texture;uniform float pointSize;uniform bool useTexture;varying vec4 color;varying vec4 coord;void main() {gl_FragColor = color;if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);}");e.pointSize=function(b){d.uniforms({pointSize:b})};e.begin=function(b){if(-1!=g)throw"mismatched gl.begin() and gl.end() calls";g=b;c.colors=[];c.coords=[];c.vertices=[]};e.color=function(b,c,g,d){a=1==arguments.length?b.toArray().concat(1):[b,c,g,d||1]};e.texCoord=function(c,g){b=1==arguments.length?
c.toArray(2):[c,g]};e.vertex=function(g,d,e){c.colors.push(a);c.coords.push(b);c.vertices.push(1==arguments.length?g.toArray():[g,d,e])};e.end=function(){if(-1==g)throw"mismatched gl.begin() and gl.end() calls";c.compile();d.uniforms({useTexture:!!e.getParameter(e.TEXTURE_BINDING_2D)}).draw(c,g);g=-1}}function N(){function c(){for(var b in F)if(n.call(F,b)&&F[b])return!0;return!1}function g(b){var g={},a;for(a in b)g[a]="function"==typeof b[a]?function(c){return function(){c.apply(b,arguments)}}(b[a]):
b[a];g.original=b;g.x=g.pageX;g.y=g.pageY;for(a=e.canvas;a;a=a.offsetParent)g.x-=a.offsetLeft,g.y-=a.offsetTop;p?(g.deltaX=g.x-l,g.deltaY=g.y-O):(g.deltaX=0,g.deltaY=0,p=!0);l=g.x;O=g.y;g.dragging=c();g.preventDefault=function(){g.original.preventDefault()};g.stopPropagation=function(){g.original.stopPropagation()};return g}function b(b){var c={},g;for(g in b)c[g]="function"==typeof b[g]?function(c){return function(){c.apply(b,arguments)}}(b[g]):b[g];c.original=b;if(0<c.targetTouches.length){g=c.targetTouches[0];
c.x=g.pageX;c.y=g.pageY;for(g=e.canvas;g;g=g.offsetParent)c.x-=g.offsetLeft,c.y-=g.offsetTop;p?(c.deltaX=c.x-l,c.deltaY=c.y-O):(c.deltaX=0,c.deltaY=0,p=!0);l=c.x;O=c.y;c.dragging=!0}c.preventDefault=function(){c.original.preventDefault()};c.stopPropagation=function(){c.original.stopPropagation()};return c}function a(b){e=A;b=g(b);if(e.onmousemove)e.onmousemove(b);b.preventDefault()}function d(b){e=A;F[b.which]=!1;c()||(document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",
d),e.canvas.addEventListener("mousemove",a),e.canvas.addEventListener("mouseup",d));b=g(b);if(e.onmouseup)e.onmouseup(b);b.preventDefault()}function f(b){e=A;b=g(b);if(e.onmousewheel)e.onmousewheel(b);b.preventDefault()}function k(c){e=A;0===c.targetTouches.length&&h(c);c=b(c);if(e.ontouchmove)e.ontouchmove(c);c.preventDefault()}function h(c){document.removeEventListener("touchmove",k);document.removeEventListener("touchend",h);e.canvas.addEventListener("touchmove",k);e.canvas.addEventListener("touchend",
h);e=A;c=b(c);if(e.ontouchend)e.ontouchend(c);c.preventDefault()}function q(){p=!1}function I(){F={};p=!1}var A=e,l=0,O=0,F={},p=!1,n=Object.prototype.hasOwnProperty;e.canvas.addEventListener("mousedown",function(b){e=A;c()||(document.addEventListener("mousemove",a),document.addEventListener("mouseup",d),e.canvas.removeEventListener("mousemove",a),e.canvas.removeEventListener("mouseup",d));F[b.which]=!0;b=g(b);if(e.onmousedown)e.onmousedown(b);b.preventDefault()});e.canvas.addEventListener("mousemove",
a);e.canvas.addEventListener("mouseup",d);e.canvas.addEventListener("mousewheel",f);e.canvas.addEventListener("DOMMouseScroll",f);e.canvas.addEventListener("mouseover",q);e.canvas.addEventListener("mouseout",q);e.canvas.addEventListener("touchstart",function(c){I();document.addEventListener("touchmove",k);document.addEventListener("touchend",h);e.canvas.removeEventListener("touchmove",k);e.canvas.removeEventListener("touchend",h);e=A;c=b(c);if(e.ontouchstart)e.ontouchstart(c);c.preventDefault()});
e.canvas.addEventListener("touchmove",k);e.canvas.addEventListener("touchend",h);document.addEventListener("contextmenu",I)}function D(c){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[c]||(65<=c&&90>=c?String.fromCharCode(c):null)}function z(c,g,b){c.addEventListener(g,b)}function u(){(function(c){e.makeCurrent=function(){e=c}})(e);e.animate=function(){function c(){e=a;var d=(new Date).getTime();if(e.onupdate)e.onupdate((d-b)/1E3);
if(e.ondraw)e.ondraw();g(c);b=d}var g=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(b){setTimeout(b,1E3/60)},b=(new Date).getTime(),a=e;c()};e.fullscreen=function(c){function g(){e.canvas.width=window.innerWidth-a-d;e.canvas.height=window.innerHeight-b-f;e.viewport(0,0,e.canvas.width,e.canvas.height);!c.camera&&"camera"in c||(e.matrixMode(e.PROJECTION),e.loadIdentity(),e.perspective(c.fov||45,e.canvas.width/e.canvas.height,c.near||.1,c.far||
1E3),e.matrixMode(e.MODELVIEW));if(e.onresize)e.onresize();if(e.ondraw)e.ondraw()}c=c||{};var b=c.paddingTop||0,a=c.paddingLeft||0,d=c.paddingRight||0,f=c.paddingBottom||0;if(!document.body)throw"document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)";document.body.appendChild(e.canvas);document.body.style.overflow="hidden";e.canvas.style.position="absolute";e.canvas.style.left=a+"px";e.canvas.style.top=b+"px";window.addEventListener("resize",g);
g()}}function n(){var c=Array.prototype.concat.apply([],arguments);c.length||(c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.m=H?new Float32Array(c):c}function y(c,g,b){this.t=arguments.length?c:Number.MAX_VALUE;this.hit=g;this.normal=b}function G(){var c=e.getParameter(e.VIEWPORT),g=e.modelviewMatrix.m,b=new k(g[0],g[4],g[8]),a=new k(g[1],g[5],g[9]),d=new k(g[2],g[6],g[10]),g=new k(g[3],g[7],g[11]);this.eye=new k(-g.dot(b),-g.dot(a),-g.dot(d));b=c[0];a=b+c[2];d=c[1];g=d+c[3];this.ray00=e.unProject(b,
d,1).subtract(this.eye);this.ray10=e.unProject(a,d,1).subtract(this.eye);this.ray01=e.unProject(b,g,1).subtract(this.eye);this.ray11=e.unProject(a,g,1).subtract(this.eye);this.viewport=c}var J,P,q;a.prototype={bind:function(c){e.activeTexture(e.TEXTURE0+(c||0));e.bindTexture(e.TEXTURE_2D,this.id)},unbind:function(c){e.activeTexture(e.TEXTURE0+(c||0));e.bindTexture(e.TEXTURE_2D,null)},drawTo:function(c,g){g=g||{};var b=e.getParameter(e.VIEWPORT);e.viewport(0,0,this.width,this.height);J=J||e.createFramebuffer();
e.bindFramebuffer(e.FRAMEBUFFER,J);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.id,0);if(!1!==g.depth){P=P||e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,P);if(this.width!=P.width||this.height!=P.height)P.width=this.width,P.height=this.height,e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,P)}c();e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,
null);e.viewport(b[0],b[1],b[2],b[3])},swapWith:function(c){var g;g=c.id;c.id=this.id;this.id=g;g=c.width;c.width=this.width;this.width=g;g=c.height;c.height=this.height;this.height=g}};a.fromImage=function(c,g){g=g||{};var b=new a(c.width,c.height,g);try{e.texImage2D(e.TEXTURE_2D,0,b.format,b.format,b.type,c)}catch(d){if("file:"==window.location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}g.minFilter&&g.minFilter!=e.NEAREST&&g.minFilter!=e.LINEAR&&e.generateMipmap(e.TEXTURE_2D);return b};a.fromURL=function(c,g){q=q||function(){var b=document.createElement("canvas").getContext("2d");b.canvas.width=b.canvas.height=128;for(var c=0;c<b.canvas.height;c+=16)for(var g=0;g<b.canvas.width;g+=16)b.fillStyle=(g^c)&16?"#FFF":"#DDD",b.fillRect(g,c,16,16);return b.canvas}();var b=a.fromImage(q,g),d=new Image,f=e;d.onload=function(){f.makeCurrent();a.fromImage(d,g).swapWith(b)};d.src=c;return b};
d.prototype={add:function(c){var g=JSON.stringify(c);g in this.map||(this.map[g]=this.unique.length,this.unique.push(c));return this.map[g]}};f.prototype={compile:function(c){for(var g=[],b=0;b<this.data.length;b+=1E4)g=Array.prototype.concat.apply(g,this.data.slice(b,b+1E4));b=this.data.length?g.length/this.data.length:0;if(b!=Math.round(b))throw"buffer elements not of consistent size, average size is "+b;this.buffer=this.buffer||e.createBuffer();this.buffer.length=g.length;this.buffer.spacing=b;
e.bindBuffer(this.target,this.buffer);e.bufferData(this.target,new this.type(g),c||e.STATIC_DRAW)}};h.prototype={addVertexBuffer:function(c,g){(this.vertexBuffers[g]=new f(e.ARRAY_BUFFER,Float32Array)).name=c;this[c]=[]},addIndexBuffer:function(c){this.indexBuffers[c]=new f(e.ELEMENT_ARRAY_BUFFER,Uint16Array);this[c]=[]},compile:function(){for(var c in this.vertexBuffers){var g=this.vertexBuffers[c];g.data=this[g.name];g.compile()}for(var b in this.indexBuffers)g=this.indexBuffers[b],g.data=this[b],
g.compile()},transform:function(c){this.vertices=this.vertices.map(function(b){return c.transformPoint(k.fromArray(b)).toArray()});if(this.normals){var g=c.inverse().transpose();this.normals=this.normals.map(function(b){return g.transformVector(k.fromArray(b)).unit().toArray()})}this.compile();return this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var c=0;c<this.vertices.length;c++)this.normals[c]=new k;for(c=0;c<this.triangles.length;c++){var g=this.triangles[c],
b=k.fromArray(this.vertices[g[0]]),a=k.fromArray(this.vertices[g[1]]),d=k.fromArray(this.vertices[g[2]]),b=a.subtract(b).cross(d.subtract(b)).unit();this.normals[g[0]]=this.normals[g[0]].add(b);this.normals[g[1]]=this.normals[g[1]].add(b);this.normals[g[2]]=this.normals[g[2]].add(b)}for(c=0;c<this.vertices.length;c++)this.normals[c]=this.normals[c].unit().toArray();this.compile();return this},computeWireframe:function(){for(var c=new d,g=0;g<this.triangles.length;g++)for(var b=this.triangles[g],a=
0;a<b.length;a++){var e=b[a],f=b[(a+1)%b.length];c.add([Math.min(e,f),Math.max(e,f)])}this.lines||this.addIndexBuffer("lines");this.lines=c.unique;this.compile();return this},getAABB:function(){var c={min:new k(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};c.max=c.min.negative();for(var g=0;g<this.vertices.length;g++){var b=k.fromArray(this.vertices[g]);c.min=k.min(c.min,b);c.max=k.max(c.max,b)}return c},getBoundingSphere:function(){for(var c=this.getAABB(),c={center:c.min.add(c.max).divide(2),
radius:0},g=0;g<this.vertices.length;g++)c.radius=Math.max(c.radius,k.fromArray(this.vertices[g]).subtract(c.center).length());return c}};h.plane=function(c){c=c||{};var g=new h(c),b=c.detailX||c.detail||1;c=c.detailY||c.detail||1;for(var a=0;a<=c;a++)for(var d=a/c,e=0;e<=b;e++){var f=e/b;g.vertices.push([2*f-1,2*d-1,0]);g.coords&&g.coords.push([f,d]);g.normals&&g.normals.push([0,0,1]);e<b&&a<c&&(f=e+a*(b+1),g.triangles.push([f,f+1,f+b+1]),g.triangles.push([f+b+1,f+1,f+b+2]))}g.compile();return g};
var r=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];h.cube=function(c){c=new h(c);for(var g=0;g<r.length;g++){for(var b=r[g],a=4*g,d=0;4>d;d++)c.vertices.push(p(b[d]).toArray()),c.coords&&c.coords.push([d&1,(d&2)/2]),c.normals&&c.normals.push(b.slice(4,7));c.triangles.push([a,a+1,a+2]);c.triangles.push([a+2,a+1,a+3])}c.compile();return c};h.sphere=function(c){function g(b,c,g){return q?[b,g,c]:[b,c,g]}c=c||{};var b=new h(c),a=new d;c=c.detail||
6;for(var e=0;8>e;e++)for(var f=p(e),q=0<f.x*f.y*f.z,l=[],n=0;n<=c;n++){for(var I=0;n+I<=c;I++){var A=n/c,m=I/c,O=(c-n-I)/c,m={vertex:(new k(A+(A-A*A)/2,m+(m-m*m)/2,O+(O-O*O)/2)).unit().multiply(f).toArray()};b.coords&&(m.coord=0<f.y?[1-A,O]:[O,1-A]);l.push(a.add(m))}if(0<n)for(I=0;n+I<=c;I++)A=(n-1)*(c+1)+(n-1-(n-1)*(n-1))/2+I,m=n*(c+1)+(n-n*n)/2+I,b.triangles.push(g(l[A],l[A+1],l[m])),n+I<c&&b.triangles.push(g(l[m],l[A+1],l[m+1]))}b.vertices=a.unique.map(function(b){return b.vertex});b.coords&&
(b.coords=a.unique.map(function(b){return b.coord}));b.normals&&(b.normals=b.vertices);b.compile();return b};h.load=function(c,g){g=g||{};"coords"in g||(g.coords=!!c.coords);"normals"in g||(g.normals=!!c.normals);"colors"in g||(g.colors=!!c.colors);"triangles"in g||(g.triangles=!!c.triangles);"lines"in g||(g.lines=!!c.lines);var b=new h(g);b.vertices=c.vertices;b.coords&&(b.coords=c.coords);b.normals&&(b.normals=c.normals);b.colors&&(b.colors=c.colors);b.triangles&&(b.triangles=c.triangles);b.lines&&
(b.lines=c.lines);b.compile();return b};k.prototype={negative:function(){return new k(-this.x,-this.y,-this.z)},add:function(c){return c instanceof k?new k(this.x+c.x,this.y+c.y,this.z+c.z):new k(this.x+c,this.y+c,this.z+c)},subtract:function(c){return c instanceof k?new k(this.x-c.x,this.y-c.y,this.z-c.z):new k(this.x-c,this.y-c,this.z-c)},multiply:function(c){return c instanceof k?new k(this.x*c.x,this.y*c.y,this.z*c.z):new k(this.x*c,this.y*c,this.z*c)},divide:function(c){return c instanceof k?
new k(this.x/c.x,this.y/c.y,this.z/c.z):new k(this.x/c,this.y/c,this.z/c)},equals:function(c){return this.x==c.x&&this.y==c.y&&this.z==c.z},dot:function(c){return this.x*c.x+this.y*c.y+this.z*c.z},cross:function(c){return new k(this.y*c.z-this.z*c.y,this.z*c.x-this.x*c.z,this.x*c.y-this.y*c.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,
this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(c){return[this.x,this.y,this.z].slice(0,c||3)},clone:function(){return new k(this.x,this.y,this.z)},init:function(c,g,b){this.x=c;this.y=g;this.z=b;return this}};k.negative=function(c,g){g.x=-c.x;g.y=-c.y;g.z=-c.z;return g};k.add=function(c,g,b){g instanceof k?(b.x=c.x+g.x,b.y=c.y+g.y,b.z=c.z+g.z):(b.x=c.x+g,b.y=c.y+g,b.z=c.z+g);return b};k.subtract=function(c,g,b){g instanceof
k?(b.x=c.x-g.x,b.y=c.y-g.y,b.z=c.z-g.z):(b.x=c.x-g,b.y=c.y-g,b.z=c.z-g);return b};k.multiply=function(c,g,b){g instanceof k?(b.x=c.x*g.x,b.y=c.y*g.y,b.z=c.z*g.z):(b.x=c.x*g,b.y=c.y*g,b.z=c.z*g);return b};k.divide=function(c,g,b){g instanceof k?(b.x=c.x/g.x,b.y=c.y/g.y,b.z=c.z/g.z):(b.x=c.x/g,b.y=c.y/g,b.z=c.z/g);return b};k.cross=function(c,g,b){b.x=c.y*g.z-c.z*g.y;b.y=c.z*g.x-c.x*g.z;b.z=c.x*g.y-c.y*g.x;return b};k.unit=function(c,g){var b=c.length();g.x=c.x/b;g.y=c.y/b;g.z=c.z/b;return g};k.fromAngles=
function(c,g){return new k(Math.cos(c)*Math.cos(g),Math.sin(g),Math.sin(c)*Math.cos(g))};k.randomDirection=function(){return k.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))};k.min=function(c,g){return new k(Math.min(c.x,g.x),Math.min(c.y,g.y),Math.min(c.z,g.z))};k.max=function(c,g){return new k(Math.max(c.x,g.x),Math.max(c.y,g.y),Math.max(c.z,g.z))};k.lerp=function(c,g,b){return g.subtract(c).multiply(b).add(c)};k.fromArray=function(c){return new k(c[0],c[1],c[2])};l.prototype=
{uniforms:function(c){e.useProgram(this.program);for(var g in c){var b=this.uniformLocations[g]||e.getUniformLocation(this.program,g);if(b){this.uniformLocations[g]=b;var a=c[g];a instanceof k?a=[a.x,a.y,a.z]:a instanceof n&&(a=a.m);var d=Object.prototype.toString.call(a);if("[object Array]"==d||"[object Float32Array]"==d)switch(a.length){case 1:e.uniform1fv(b,new Float32Array(a));break;case 2:e.uniform2fv(b,new Float32Array(a));break;case 3:e.uniform3fv(b,new Float32Array(a));break;case 4:e.uniform4fv(b,
new Float32Array(a));break;case 9:e.uniformMatrix3fv(b,!1,new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]));break;case 16:e.uniformMatrix4fv(b,!1,new Float32Array([a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]));break;default:throw"don't know how to load uniform \""+g+'" of length '+a.length;}else if(d=Object.prototype.toString.call(a),"[object Number]"==d||"[object Boolean]"==d)(this.isSampler[g]?e.uniform1i:e.uniform1f).call(e,b,a);else throw'attempted to set uniform "'+
g+'" to invalid value '+a;}}return this},draw:function(c,a){this.drawBuffers(c.vertexBuffers,c.indexBuffers[a==e.LINES?"lines":"triangles"],2>arguments.length?e.TRIANGLES:a)},drawBuffers:function(c,a,b){var d=this.usedMatrices,f=e.modelviewMatrix,k=e.projectionMatrix,h=d.MVMI||d.NM?f.inverse():null,q=d.PMI?k.inverse():null,n=d.MVPM||d.MVPMI?k.multiply(f):null,l={};d.MVM&&(l[d.MVM]=f);d.MVMI&&(l[d.MVMI]=h);d.PM&&(l[d.PM]=k);d.PMI&&(l[d.PMI]=q);d.MVPM&&(l[d.MVPM]=n);d.MVPMI&&(l[d.MVPMI]=n.inverse());
d.NM&&(f=h.m,l[d.NM]=[f[0],f[4],f[8],f[1],f[5],f[9],f[2],f[6],f[10]]);this.uniforms(l);var d=0,p;for(p in c)l=c[p],f=this.attributes[p]||e.getAttribLocation(this.program,p.replace(/^(gl_.*)$/,"LIGHTGL$1")),-1!=f&&l.buffer&&(this.attributes[p]=f,e.bindBuffer(e.ARRAY_BUFFER,l.buffer),e.enableVertexAttribArray(f),e.vertexAttribPointer(f,l.buffer.spacing,e.FLOAT,!1,0,0),d=l.buffer.length/l.buffer.spacing);for(p in this.attributes)p in c||e.disableVertexAttribArray(this.attributes[p]);!d||a&&!a.buffer||
(a?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.buffer),e.drawElements(b,a.buffer.length,e.UNSIGNED_SHORT,0)):e.drawArrays(b,0,d));return this}};l.fromURL=function(c,a){var b=function(b){var c=new XMLHttpRequest;c.open("GET",b,!1);c.send(null);if(200!==c.status)throw"could not load "+b;return c.responseText},d=b(c),b=b(a);return new l(d,b)};l.from=function(c,a){try{return new l(c,a)}catch(b){return l.fromURL(c,a)}};var e,v={create:function(c){c=c||{};var a=c.canvas;a||(a=document.createElement("canvas"),
a.width=c.width||800,a.height=c.height||600);"alpha"in c||(c.alpha=!1);try{e=a.getContext("webgl",c)}catch(b){}try{e=e||a.getContext("experimental-webgl",c)}catch(d){}if(!e)throw"WebGL not supported";E();m();N();u();return e},keys:{},Matrix:n,Indexer:d,Buffer:f,Mesh:h,HitTest:y,Raytracer:G,Shader:l,Texture:a,Vector:k};z(document,"keydown",function(c){if(!c.altKey&&!c.ctrlKey&&!c.metaKey){var a=D(c.keyCode);a&&(v.keys[a]=!0);v.keys[c.keyCode]=!0}});z(document,"keyup",function(c){if(!c.altKey&&!c.ctrlKey&&
!c.metaKey){var a=D(c.keyCode);a&&(v.keys[a]=!1);v.keys[c.keyCode]=!1}});var S=305397760,H="undefined"!=typeof Float32Array;n.prototype={inverse:function(){return n.inverse(this,new n)},transpose:function(){return n.transpose(this,new n)},multiply:function(c){return n.multiply(this,c,new n)},transformPoint:function(c){var a=this.m;return(new k(a[0]*c.x+a[1]*c.y+a[2]*c.z+a[3],a[4]*c.x+a[5]*c.y+a[6]*c.z+a[7],a[8]*c.x+a[9]*c.y+a[10]*c.z+a[11])).divide(a[12]*c.x+a[13]*c.y+a[14]*c.z+a[15])},transformVector:function(c){var a=
this.m;return new k(a[0]*c.x+a[1]*c.y+a[2]*c.z,a[4]*c.x+a[5]*c.y+a[6]*c.z,a[8]*c.x+a[9]*c.y+a[10]*c.z)}};n.inverse=function(c,a){a=a||new n;var b=c.m,d=a.m;d[0]=b[5]*b[10]*b[15]-b[5]*b[14]*b[11]-b[6]*b[9]*b[15]+b[6]*b[13]*b[11]+b[7]*b[9]*b[14]-b[7]*b[13]*b[10];d[1]=-b[1]*b[10]*b[15]+b[1]*b[14]*b[11]+b[2]*b[9]*b[15]-b[2]*b[13]*b[11]-b[3]*b[9]*b[14]+b[3]*b[13]*b[10];d[2]=b[1]*b[6]*b[15]-b[1]*b[14]*b[7]-b[2]*b[5]*b[15]+b[2]*b[13]*b[7]+b[3]*b[5]*b[14]-b[3]*b[13]*b[6];d[3]=-b[1]*b[6]*b[11]+b[1]*b[10]*
b[7]+b[2]*b[5]*b[11]-b[2]*b[9]*b[7]-b[3]*b[5]*b[10]+b[3]*b[9]*b[6];d[4]=-b[4]*b[10]*b[15]+b[4]*b[14]*b[11]+b[6]*b[8]*b[15]-b[6]*b[12]*b[11]-b[7]*b[8]*b[14]+b[7]*b[12]*b[10];d[5]=b[0]*b[10]*b[15]-b[0]*b[14]*b[11]-b[2]*b[8]*b[15]+b[2]*b[12]*b[11]+b[3]*b[8]*b[14]-b[3]*b[12]*b[10];d[6]=-b[0]*b[6]*b[15]+b[0]*b[14]*b[7]+b[2]*b[4]*b[15]-b[2]*b[12]*b[7]-b[3]*b[4]*b[14]+b[3]*b[12]*b[6];d[7]=b[0]*b[6]*b[11]-b[0]*b[10]*b[7]-b[2]*b[4]*b[11]+b[2]*b[8]*b[7]+b[3]*b[4]*b[10]-b[3]*b[8]*b[6];d[8]=b[4]*b[9]*b[15]-b[4]*
b[13]*b[11]-b[5]*b[8]*b[15]+b[5]*b[12]*b[11]+b[7]*b[8]*b[13]-b[7]*b[12]*b[9];d[9]=-b[0]*b[9]*b[15]+b[0]*b[13]*b[11]+b[1]*b[8]*b[15]-b[1]*b[12]*b[11]-b[3]*b[8]*b[13]+b[3]*b[12]*b[9];d[10]=b[0]*b[5]*b[15]-b[0]*b[13]*b[7]-b[1]*b[4]*b[15]+b[1]*b[12]*b[7]+b[3]*b[4]*b[13]-b[3]*b[12]*b[5];d[11]=-b[0]*b[5]*b[11]+b[0]*b[9]*b[7]+b[1]*b[4]*b[11]-b[1]*b[8]*b[7]-b[3]*b[4]*b[9]+b[3]*b[8]*b[5];d[12]=-b[4]*b[9]*b[14]+b[4]*b[13]*b[10]+b[5]*b[8]*b[14]-b[5]*b[12]*b[10]-b[6]*b[8]*b[13]+b[6]*b[12]*b[9];d[13]=b[0]*b[9]*
b[14]-b[0]*b[13]*b[10]-b[1]*b[8]*b[14]+b[1]*b[12]*b[10]+b[2]*b[8]*b[13]-b[2]*b[12]*b[9];d[14]=-b[0]*b[5]*b[14]+b[0]*b[13]*b[6]+b[1]*b[4]*b[14]-b[1]*b[12]*b[6]-b[2]*b[4]*b[13]+b[2]*b[12]*b[5];d[15]=b[0]*b[5]*b[10]-b[0]*b[9]*b[6]-b[1]*b[4]*b[10]+b[1]*b[8]*b[6]+b[2]*b[4]*b[9]-b[2]*b[8]*b[5];for(var b=b[0]*d[0]+b[1]*d[4]+b[2]*d[8]+b[3]*d[12],f=0;16>f;f++)d[f]/=b;return a};n.transpose=function(c,a){a=a||new n;var b=c.m,d=a.m;d[0]=b[0];d[1]=b[4];d[2]=b[8];d[3]=b[12];d[4]=b[1];d[5]=b[5];d[6]=b[9];d[7]=b[13];
d[8]=b[2];d[9]=b[6];d[10]=b[10];d[11]=b[14];d[12]=b[3];d[13]=b[7];d[14]=b[11];d[15]=b[15];return a};n.multiply=function(c,a,b){b=b||new n;c=c.m;a=a.m;var d=b.m;d[0]=c[0]*a[0]+c[1]*a[4]+c[2]*a[8]+c[3]*a[12];d[1]=c[0]*a[1]+c[1]*a[5]+c[2]*a[9]+c[3]*a[13];d[2]=c[0]*a[2]+c[1]*a[6]+c[2]*a[10]+c[3]*a[14];d[3]=c[0]*a[3]+c[1]*a[7]+c[2]*a[11]+c[3]*a[15];d[4]=c[4]*a[0]+c[5]*a[4]+c[6]*a[8]+c[7]*a[12];d[5]=c[4]*a[1]+c[5]*a[5]+c[6]*a[9]+c[7]*a[13];d[6]=c[4]*a[2]+c[5]*a[6]+c[6]*a[10]+c[7]*a[14];d[7]=c[4]*a[3]+c[5]*
a[7]+c[6]*a[11]+c[7]*a[15];d[8]=c[8]*a[0]+c[9]*a[4]+c[10]*a[8]+c[11]*a[12];d[9]=c[8]*a[1]+c[9]*a[5]+c[10]*a[9]+c[11]*a[13];d[10]=c[8]*a[2]+c[9]*a[6]+c[10]*a[10]+c[11]*a[14];d[11]=c[8]*a[3]+c[9]*a[7]+c[10]*a[11]+c[11]*a[15];d[12]=c[12]*a[0]+c[13]*a[4]+c[14]*a[8]+c[15]*a[12];d[13]=c[12]*a[1]+c[13]*a[5]+c[14]*a[9]+c[15]*a[13];d[14]=c[12]*a[2]+c[13]*a[6]+c[14]*a[10]+c[15]*a[14];d[15]=c[12]*a[3]+c[13]*a[7]+c[14]*a[11]+c[15]*a[15];return b};n.identity=function(a){a=a||new n;var d=a.m;d[0]=d[5]=d[10]=d[15]=
1;d[1]=d[2]=d[3]=d[4]=d[6]=d[7]=d[8]=d[9]=d[11]=d[12]=d[13]=d[14]=0;return a};n.perspective=function(a,d,b,f,e){a=Math.tan(a*Math.PI/360)*b;d*=a;return n.frustum(-d,d,-a,a,b,f,e)};n.frustum=function(a,d,b,f,e,k,h){h=h||new n;var l=h.m;l[0]=2*e/(d-a);l[1]=0;l[2]=(d+a)/(d-a);l[3]=0;l[4]=0;l[5]=2*e/(f-b);l[6]=(f+b)/(f-b);l[7]=0;l[8]=0;l[9]=0;l[10]=-(k+e)/(k-e);l[11]=-2*k*e/(k-e);l[12]=0;l[13]=0;l[14]=-1;l[15]=0;return h};n.ortho=function(a,d,b,f,e,k,h){h=h||new n;var l=h.m;l[0]=2/(d-a);l[1]=0;l[2]=0;
l[3]=-(d+a)/(d-a);l[4]=0;l[5]=2/(f-b);l[6]=0;l[7]=-(f+b)/(f-b);l[8]=0;l[9]=0;l[10]=-2/(k-e);l[11]=-(k+e)/(k-e);l[12]=0;l[13]=0;l[14]=0;l[15]=1;return h};n.scale=function(a,d,b,f){f=f||new n;var e=f.m;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=d;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=b;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return f};n.translate=function(a,d,b,f){f=f||new n;var e=f.m;e[0]=1;e[1]=0;e[2]=0;e[3]=a;e[4]=0;e[5]=1;e[6]=0;e[7]=d;e[8]=0;e[9]=0;e[10]=1;e[11]=b;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return f};
n.rotate=function(a,d,b,e,f){if(!a||!d&&!b&&!e)return n.identity(f);f=f||new n;var k=f.m,h=Math.sqrt(d*d+b*b+e*e);a*=Math.PI/180;d/=h;b/=h;e/=h;h=Math.cos(a);a=Math.sin(a);var l=1-h;k[0]=d*d*l+h;k[1]=d*b*l-e*a;k[2]=d*e*l+b*a;k[3]=0;k[4]=b*d*l+e*a;k[5]=b*b*l+h;k[6]=b*e*l-d*a;k[7]=0;k[8]=e*d*l-b*a;k[9]=e*b*l+d*a;k[10]=e*e*l+h;k[11]=0;k[12]=0;k[13]=0;k[14]=0;k[15]=1;return f};n.lookAt=function(a,d,b,e,f,h,l,q,p,m){m=m||new n;var A=m.m;a=new k(a,d,b);e=new k(e,f,h);q=new k(l,q,p);l=a.subtract(e).unit();
q=q.cross(l).unit();p=l.cross(q).unit();A[0]=q.x;A[1]=q.y;A[2]=q.z;A[3]=-q.dot(a);A[4]=p.x;A[5]=p.y;A[6]=p.z;A[7]=-p.dot(a);A[8]=l.x;A[9]=l.y;A[10]=l.z;A[11]=-l.dot(a);A[12]=0;A[13]=0;A[14]=0;A[15]=1;return m};y.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};G.prototype={getRayForPixel:function(a,d){a=(a-this.viewport[0])/this.viewport[2];d=1-(d-this.viewport[1])/this.viewport[3];var b=k.lerp(this.ray00,this.ray10,a),e=k.lerp(this.ray01,this.ray11,
a);return k.lerp(b,e,d).unit()}};G.hitTestBox=function(a,d,b,e){var f=b.subtract(a).divide(d),h=e.subtract(a).divide(d),l=k.min(f,h),f=k.max(f,h),l=l.max(),f=f.min();return 0<l&&l<f?(a=a.add(d.multiply(l)),b=b.add(1E-6),e=e.subtract(1E-6),new y(l,a,new k((a.x>e.x)-(a.x<b.x),(a.y>e.y)-(a.y<b.y),(a.z>e.z)-(a.z<b.z)))):null};G.hitTestSphere=function(a,d,b,e){var f=a.subtract(b),k=d.dot(d),l=2*d.dot(f),f=f.dot(f)-e*e,f=l*l-4*k*f;return 0<f?(k=(-l-Math.sqrt(f))/(2*k),a=a.add(d.multiply(k)),new y(k,a,a.subtract(b).divide(e))):
null};G.hitTestTriangle=function(a,d,b,e,f){var k=e.subtract(b),l=f.subtract(b);f=k.cross(l).unit();e=f.dot(b.subtract(a))/f.dot(d);if(0<e){a=a.add(d.multiply(e));var h=a.subtract(b);b=l.dot(l);d=l.dot(k);var l=l.dot(h),q=k.dot(k),k=k.dot(h),h=b*q-d*d,q=(q*l-d*k)/h,k=(b*k-d*l)/h;if(0<=q&&0<=k&&1>=q+k)return new y(e,a,f)}return null};return v}();Blockscad=Blockscad||{};Blockscad.Toolbox={};Blockscad.Toolbox.cat_3D='<category name="3D Shapes"><block type="sphere"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cylinder"><value name="RAD1"><block type="math_number"><field name="NUM">10</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">10</field></block></value><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cube"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">10</field></block></value></block></category>';
Blockscad.Toolbox.cat2D='<category name="2D Shapes"><block type="circle"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="square"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value></block></category>';Blockscad.Toolbox.catTransform='<category name="Transforms"><block type="translate"><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="simplerotate"><value name="XVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_angle"><field name="NUM">0</field></block></value></block><block type="simplemirror_new"></block><block type="scale"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="color"><value name="COLOR"><block type="colour_picker"><field name="COLOUR">#ffcc00</field></block></value></block><block type="$fn"><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value></block><block type="linearextrude"><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value><value name="TWIST"><block type="math_angle"><field name="NUM">0</field></block></value></block><block type="rotateextrude"><value name="FACES"><block type="math_number"><field name="NUM">5</field></block></value></block></category>';
Blockscad.Toolbox.catSetOps='<category name="Set Ops"><block type="union"></block><block type="difference"></block><block type="intersection"></block><block type="hull"></block></category>';Blockscad.Toolbox.catMathLogic='<category name="Math"><block type="math_number"></block><block type="math_angle"></block><block type="math_arithmetic"></block><block type="math_single"></block><block type="math_trig"></block><block type="math_constant_bs"></block><block type="math_number_property"></block><block type="math_round"></block><block type="math_modulo"></block><block type="math_constrain"><value name="LOW"><block type="math_number"><field name="NUM">1</field></block></value><value name="HIGH"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="math_random_int"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block></value><value name="TO"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="math_random_float"></block></category><category name="Logic"><block type="controls_if"></block><block type="logic_compare"></block><block type="logic_operation"></block><block type="logic_negate"></block><block type="logic_boolean"></block><block type="logic_ternary"></block></category>';
Blockscad.Toolbox.catLoops='<category name="Loops"><block type="controls_for"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block> </value><value name="TO"><block type="math_number"><field name="NUM">10</field></block></value><value name="BY"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="controls_for_chainhull"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block> </value><value name="TO"><block type="math_number"><field name="NUM">10</field></block></value><value name="BY"><block type="math_number"><field name="NUM">1</field></block></value></block></category>';
Blockscad.Toolbox.catOther='<category name="Advanced"><block type="torus"><value name="RAD1"><block type="math_number"><field name="NUM">4</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">1</field></block></value><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value><value name="FACES"><block type="math_number"><field name="NUM">3</field></block></value></block><block type="rotateextrudetwist"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value><value name="FACES"><block type="math_number"><field name="NUM">5</field></block></value><value name="TWIST"><block type="math_number"><field name="NUM">360</field></block></value><value name="TSTEPS"><block type="math_number"><field name="NUM">180</field></block></value></block><block type="fancyrotate"><value name="AVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="fancymirror"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block></category><category name="Variables" custom="VARIABLE"></category><category name="Modules" custom="PROCEDURE"></category></xml>';
Blockscad.Toolbox.other='<xml id="toolbox" style="display: none">';Blockscad.Toolbox.other+=Blockscad.Toolbox.cat_3D;Blockscad.Toolbox.other+=Blockscad.Toolbox.cat2D;Blockscad.Toolbox.other+=Blockscad.Toolbox.catTransform;Blockscad.Toolbox.other+=Blockscad.Toolbox.catSetOps;Blockscad.Toolbox.other+=Blockscad.Toolbox.catMathLogic;Blockscad.Toolbox.other+=Blockscad.Toolbox.catLoops;Blockscad.Toolbox.other+=Blockscad.Toolbox.catOther;(function(a){var d,f,h=null,p,k,t,l,E,m,N,D,z,u,n,y,G,J,P,q=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],e=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],v=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],H=[16,17,18,0,8,7,9,6,
10,5,11,4,12,3,13,2,14,1,15],c=function(){this.list=this.next=null},g=function(){this.n=this.b=this.e=0;this.t=null},b=function(a,b,d,e,f,k){this.BMAX=16;this.N_MAX=288;this.status=0;this.root=null;this.m=0;var l=Array(this.BMAX+1),h,q,p,n,m,r,t,v=Array(this.BMAX+1),w,u,y,x=new g,B=Array(this.BMAX);n=Array(this.N_MAX);var z,D=Array(this.BMAX+1),E,G,H;H=this.root=null;for(m=0;m<l.length;m++)l[m]=0;for(m=0;m<v.length;m++)v[m]=0;for(m=0;m<B.length;m++)B[m]=null;for(m=0;m<n.length;m++)n[m]=0;for(m=0;m<
D.length;m++)D[m]=0;h=256<b?a[256]:this.BMAX;w=a;u=0;m=b;do l[w[u]]++,u++;while(0<--m);if(l[0]==b)this.root=null,this.status=this.m=0;else{for(r=1;r<=this.BMAX&&0==l[r];r++);t=r;k<r&&(k=r);for(m=this.BMAX;0!=m&&0==l[m];m--);p=m;k>m&&(k=m);for(E=1<<r;r<m;r++,E<<=1)if(0>(E-=l[r])){this.status=2;this.m=k;return}if(0>(E-=l[m]))this.status=2,this.m=k;else{l[m]+=E;D[1]=r=0;w=l;u=1;for(y=2;0<--m;)D[y++]=r+=w[u++];w=a;m=u=0;do 0!=(r=w[u++])&&(n[D[r]++]=m);while(++m<b);b=D[p];D[0]=m=0;w=n;u=0;n=-1;z=v[0]=
0;y=null;for(G=0;t<=p;t++)for(a=l[t];0<a--;){for(;t>z+v[1+n];){z+=v[1+n];n++;G=(G=p-z)>k?k:G;if((q=1<<(r=t-z))>a+1)for(q-=a+1,y=t;++r<G&&!((q<<=1)<=l[++y]);)q-=l[y];z+r>h&&z<h&&(r=h-z);G=1<<r;v[1+n]=r;y=Array(G);for(q=0;q<G;q++)y[q]=new g;H=null==H?this.root=new c:H.next=new c;H.next=null;H.list=y;B[n]=y;0<n&&(D[n]=m,x.b=v[n],x.e=16+r,x.t=y,r=(m&(1<<z)-1)>>z-v[n],B[n-1][r].e=x.e,B[n-1][r].b=x.b,B[n-1][r].n=x.n,B[n-1][r].t=x.t)}x.b=t-z;u>=b?x.e=99:w[u]<d?(x.e=256>w[u]?16:15,x.n=w[u++]):(x.e=f[w[u]-
d],x.n=e[w[u++]-d]);q=1<<t-z;for(r=m>>z;r<G;r+=q)y[r].e=x.e,y[r].b=x.b,y[r].n=x.n,y[r].t=x.t;for(r=1<<t-1;0!=(m&r);r>>=1)m^=r;for(m^=r;(m&(1<<z)-1)!=D[n];)z-=v[n],n--}this.m=v[1];this.status=0!=E&&1!=p?1:0}}},w=function(a){for(;E<a;){var b=l,c;c=J.length==P?-1:J.charCodeAt(P++)&255;l=b|c<<E;E+=8}},B=function(a){return l&q[a]},x=function(a){l>>=a;E-=a},Q=function(a,b,c){var e,g,k;if(0==c)return 0;for(k=0;;){w(y);g=u.list[B(y)];for(e=g.e;16<e;){if(99==e)return-1;x(g.b);e-=16;w(e);g=g.t[B(e)];e=g.e}x(g.b);
if(16==e)f&=32767,a[b+k++]=d[f++]=g.n;else{if(15==e)break;w(e);D=g.n+B(e);x(e);w(G);g=n.list[B(G)];for(e=g.e;16<e;){if(99==e)return-1;x(g.b);e-=16;w(e);g=g.t[B(e)];e=g.e}x(g.b);w(e);z=f-g.n-B(e);for(x(e);0<D&&k<c;)D--,z&=32767,f&=32767,a[b+k++]=d[f++]=d[z++]}if(k==c)return c}m=-1;return k},T=function(a,c,d){var f,g,k,l,h,m,q,p=Array(316);for(f=0;f<p.length;f++)p[f]=0;w(5);m=257+B(5);x(5);w(5);q=1+B(5);x(5);w(4);f=4+B(4);x(4);if(286<m||30<q)return-1;for(g=0;g<f;g++)w(3),p[H[g]]=B(3),x(3);for(;19>g;g++)p[H[g]]=
0;y=7;g=new b(p,19,19,null,null,y);if(0!=g.status)return-1;u=g.root;y=g.m;l=m+q;for(f=k=0;f<l;)if(w(y),h=u.list[B(y)],g=h.b,x(g),g=h.n,16>g)p[f++]=k=g;else if(16==g){w(2);g=3+B(2);x(2);if(f+g>l)return-1;for(;0<g--;)p[f++]=k}else{17==g?(w(3),g=3+B(3),x(3)):(w(7),g=11+B(7),x(7));if(f+g>l)return-1;for(;0<g--;)p[f++]=0;k=0}y=9;g=new b(p,m,257,r,e,y);0==y&&(g.status=1);if(0!=g.status&&1==g.status)return-1;u=g.root;y=g.m;for(f=0;f<q;f++)p[f]=p[f+m];G=6;g=new b(p,q,0,v,S,G);n=g.root;G=g.m;return 0==G&&257<
m||0!=g.status?-1:Q(a,c,d)},X=function(a,c,g){var q,F;for(q=0;q<g&&(!N||-1!=m);){if(0<D){if(0!=m)for(;0<D&&q<g;)D--,z&=32767,f&=32767,a[c+q++]=d[f++]=d[z++];else{for(;0<D&&q<g;)D--,f&=32767,w(8),a[c+q++]=d[f++]=B(8),x(8);0==D&&(m=-1)}if(q==g)break}if(-1==m){if(N)break;w(1);0!=B(1)&&(N=!0);x(1);w(2);m=B(2);x(2);u=null;D=0}switch(m){case 0:F=a;var H=c+q,J=g-q,K=void 0,K=E&7;x(K);w(16);K=B(16);x(16);w(16);if(K!=(~l&65535))F=-1;else{x(16);D=K;for(K=0;0<D&&K<J;)D--,f&=32767,w(8),F[H+K++]=d[f++]=B(8),x(8);
0==D&&(m=-1);F=K}break;case 1:if(null!=u)F=Q(a,c+q,g-q);else a:{F=a;H=c+q;J=g-q;if(null==h){for(var C=void 0,K=Array(288),C=void 0,C=0;144>C;C++)K[C]=8;for(;256>C;C++)K[C]=9;for(;280>C;C++)K[C]=7;for(;288>C;C++)K[C]=8;k=7;C=new b(K,288,257,r,e,k);if(0!=C.status){alert("HufBuild error: "+C.status);F=-1;break a}h=C.root;k=C.m;for(C=0;30>C;C++)K[C]=5;t=5;C=new b(K,30,0,v,S,t);if(1<C.status){h=null;alert("HufBuild error: "+C.status);F=-1;break a}p=C.root;t=C.m}u=h;n=p;y=k;G=t;F=Q(F,H,J)}break;case 2:F=
null!=u?Q(a,c+q,g-q):T(a,c+q,g-q);break;default:F=-1}if(-1==F)return N?0:-1;q+=F}return q};a.RawDeflate||(a.RawDeflate={});a.RawDeflate.inflate=function(a){var b;null==d&&(d=Array(65536));E=l=f=0;m=-1;N=!1;D=z=0;u=null;J=a;P=0;for(var c=Array(1024),e=[];0<(a=X(c,0,c.length));){var g=Array(a);for(b=0;b<a;b++)g[b]=String.fromCharCode(c[b]);e[e.length]=g.join("")}J=null;return e.join("")}})(this);
(function(a){var d,f,h,p,k=null,t,l,E,m,N,D,z,u,n,y,G,J,P,q,r,e,v,S,H,c,g,b,w,B,x,Q,T,X,I,A,U,O,F,M,Y,K,C,fa,ca,sa,ka,la,Z,ma,ta,da,ga,aa,ea,na,ua,ha=function(){this.dl=this.fc=0},va=function(){this.extra_bits=this.static_tree=this.dyn_tree=null;this.max_code=this.max_length=this.elems=this.extra_base=0},W=function(a,b,c,d){this.good_length=a;this.max_lazy=b;this.nice_length=c;this.max_chain=d},Na=function(){this.next=null;this.len=0;this.ptr=Array(8192);this.off=0},wa=[0,0,0,0,0,0,0,0,1,1,1,1,2,
2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ia=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Oa=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Ba=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],xa=[new W(0,0,0,0),new W(4,4,8,4),new W(4,5,16,8),new W(4,6,32,32),new W(4,4,16,16),new W(8,16,32,32),new W(8,16,128,128),new W(8,32,128,256),new W(32,128,258,1024),new W(32,258,258,4096)],oa=function(a){k[l+t++]=a;if(8192==l+t&&0!=t){var b;null!=d?(a=d,d=d.next):a=new Na;a.next=null;a.len=a.off=0;null==
f?f=h=a:h=h.next=a;a.len=t-l;for(b=0;b<a.len;b++)a.ptr[b]=k[l+b];t=l=0}},pa=function(a){a&=65535;8190>l+t?(k[l+t++]=a&255,k[l+t++]=a>>>8):(oa(a&255),oa(a>>>8))},qa=function(){G=(G<<5^m[v+3-1]&255)&8191;J=z[32768+G];z[v&32767]=J;z[32768+G]=v},ba=function(a,b){R(b[a].fc,b[a].dl)},Ca=function(a,b,c){return a[b].fc<a[c].fc||a[b].fc==a[c].fc&&C[b]<=C[c]},Da=function(a,b,c){var d;for(d=0;d<c&&ua<na.length;d++)a[b+d]=na.charCodeAt(ua++)&255;return d},Ea=function(a){var b=g,c=v,d,f=e,k=32506<v?v-32506:0,
l=v+258,h=m[c+f-1],q=m[c+f];e>=B&&(b>>=2);do if(d=a,m[d+f]==q&&m[d+f-1]==h&&m[d]==m[c]&&m[++d]==m[c+1]){c+=2;for(d++;m[++c]==m[++d]&&m[++c]==m[++d]&&m[++c]==m[++d]&&m[++c]==m[++d]&&m[++c]==m[++d]&&m[++c]==m[++d]&&m[++c]==m[++d]&&m[++c]==m[++d]&&c<l;);d=258-(l-c);c=l-258;if(d>f){S=a;f=d;if(258<=d)break;h=m[c+f-1];q=m[c+f]}}while((a=z[a&32767])>k&&0!=--b);return f},ya=function(){var a,b,d=65536-c-v;if(-1==d)d--;else if(65274<=v){for(a=0;32768>a;a++)m[a]=m[a+32768];S-=32768;v-=32768;y-=32768;for(a=0;8192>
a;a++)b=z[32768+a],z[32768+a]=32768<=b?b-32768:0;for(a=0;32768>a;a++)b=z[a],z[a]=32768<=b?b-32768:0;d+=32768}H||(a=Da(m,v+c,d),0>=a?H=!0:c+=a)},Pa=function(a,d,k){var h;if(!p){if(!H){n=u=0;var V,L;if(0==X[0].dl){A.dyn_tree=x;A.static_tree=T;A.extra_bits=wa;A.extra_base=257;A.elems=286;A.max_length=15;A.max_code=0;U.dyn_tree=Q;U.static_tree=X;U.extra_bits=ia;U.extra_base=0;U.elems=30;U.max_length=15;U.max_code=0;O.dyn_tree=I;O.static_tree=null;O.extra_bits=Oa;O.extra_base=0;O.elems=19;O.max_length=
7;for(L=V=O.max_code=0;28>L;L++)for(sa[L]=V,h=0;h<1<<wa[L];h++)fa[V++]=L;fa[V-1]=L;for(L=V=0;16>L;L++)for(ka[L]=V,h=0;h<1<<ia[L];h++)ca[V++]=L;for(V>>=7;30>L;L++)for(ka[L]=V<<7,h=0;h<1<<ia[L]-7;h++)ca[256+V++]=L;for(h=0;15>=h;h++)F[h]=0;for(h=0;143>=h;)T[h++].dl=8,F[8]++;for(;255>=h;)T[h++].dl=9,F[9]++;for(;279>=h;)T[h++].dl=7,F[7]++;for(;287>=h;)T[h++].dl=8,F[8]++;Fa(T,287);for(h=0;30>h;h++)X[h].dl=5,X[h].fc=Ga(h,5);Ha()}for(h=0;8192>h;h++)z[32768+h]=0;b=xa[w].max_lazy;B=xa[w].good_length;g=xa[w].max_chain;
y=v=0;c=Da(m,0,65536);if(0>=c)H=!0,c=0;else{for(H=!1;262>c&&!H;)ya();for(h=G=0;2>h;h++)G=(G<<5^m[h]&255)&8191}f=null;q=l=t=0;3>=w?(e=2,r=0):(r=2,q=q=0);E=!1}p=!0;if(0==c)return E=!0,0}if((h=Ia(a,d,k))==k)return k;if(E)return h;if(3>=w)for(;0!=c&&null==f;){qa();0!=J&&32506>=v-J&&(r=Ea(J),r>c&&(r=c));if(3<=r)if(L=ja(v-S,r-3),c-=r,r<=b){r--;do v++,qa();while(0!=--r);v++}else v+=r,r=0,G=m[v]&255,G=(G<<5^m[v+1]&255)&8191;else L=ja(0,m[v]&255),c--,v++;L&&(ra(0),y=v);for(;262>c&&!H;)ya()}else for(;0!=c&&
null==f;){qa();e=r;P=S;r=2;0!=J&&e<b&&32506>=v-J&&(r=Ea(J),r>c&&(r=c),3==r&&4096<v-S&&r--);if(3<=e&&r<=e){L=ja(v-1-P,e-3);c-=e-1;e-=2;do v++,qa();while(0!=--e);q=0;r=2;v++;L&&(ra(0),y=v)}else 0!=q?ja(0,m[v-1]&255)&&(ra(0),y=v):q=1,v++,c--;for(;262>c&&!H;)ya()}0==c&&(0!=q&&ja(0,m[v-1]&255),ra(1),E=!0);return h+Ia(a,h+d,k-h)},Ia=function(a,b,c){var e,g,h;for(e=0;null!=f&&e<c;){g=c-e;g>f.len&&(g=f.len);for(h=0;h<g;h++)a[b+e+h]=f.ptr[f.off+h];f.off+=g;f.len-=g;e+=g;0==f.len&&(g=f,f=f.next,g.next=d,d=
g)}if(e==c)return e;if(l<t){g=c-e;g>t-l&&(g=t-l);for(h=0;h<g;h++)a[b+e+h]=k[l+h];l+=g;e+=g;t==l&&(t=l=0)}return e},Ha=function(){var a;for(a=0;286>a;a++)x[a].fc=0;for(a=0;30>a;a++)Q[a].fc=0;for(a=0;19>a;a++)I[a].fc=0;x[256].fc=1;da=Z=ma=ta=aa=ea=0;ga=1},za=function(a,b){for(var c=M[b],d=b<<1;d<=Y;){d<Y&&Ca(a,M[d+1],M[d])&&d++;if(Ca(a,c,M[d]))break;M[b]=M[d];b=d;d<<=1}M[b]=c},Fa=function(a,b){var c=Array(16),d=0,e;for(e=1;15>=e;e++)d=d+F[e-1]<<1,c[e]=d;for(d=0;d<=b;d++)e=a[d].dl,0!=e&&(a[d].fc=Ga(c[e]++,
e))},Aa=function(a){var b=a.dyn_tree,c=a.static_tree,d=a.elems,e,g=-1,f=d;Y=0;K=573;for(e=0;e<d;e++)0!=b[e].fc?(M[++Y]=g=e,C[e]=0):b[e].dl=0;for(;2>Y;)e=M[++Y]=2>g?++g:0,b[e].fc=1,C[e]=0,aa--,null!=c&&(ea-=c[e].dl);a.max_code=g;for(e=Y>>1;1<=e;e--)za(b,e);do e=M[1],M[1]=M[Y--],za(b,1),c=M[1],M[--K]=e,M[--K]=c,b[f].fc=b[e].fc+b[c].fc,C[f]=C[e]>C[c]+1?C[e]:C[c]+1,b[e].dl=b[c].dl=f,M[1]=f++,za(b,1);while(2<=Y);M[--K]=M[1];f=a.dyn_tree;e=a.extra_bits;var d=a.extra_base,c=a.max_code,h=a.max_length,k=a.static_tree,
l,q,m,n,p=0;for(q=0;15>=q;q++)F[q]=0;f[M[K]].dl=0;for(a=K+1;573>a;a++)l=M[a],q=f[f[l].dl].dl+1,q>h&&(q=h,p++),f[l].dl=q,l>c||(F[q]++,m=0,l>=d&&(m=e[l-d]),n=f[l].fc,aa+=n*(q+m),null!=k&&(ea+=n*(k[l].dl+m)));if(0!=p){do{for(q=h-1;0==F[q];)q--;F[q]--;F[q+1]+=2;F[h]--;p-=2}while(0<p);for(q=h;0!=q;q--)for(l=F[q];0!=l;)e=M[--a],e>c||(f[e].dl!=q&&(aa+=(q-f[e].dl)*f[e].fc,f[e].fc=q),l--)}Fa(b,g)},Ja=function(a,b){var c,d=-1,e,f=a[0].dl,g=0,h=7,k=4;0==f&&(h=138,k=3);a[b+1].dl=65535;for(c=0;c<=b;c++)e=f,f=
a[c+1].dl,++g<h&&e==f||(g<k?I[e].fc+=g:0!=e?(e!=d&&I[e].fc++,I[16].fc++):10>=g?I[17].fc++:I[18].fc++,g=0,d=e,0==f?(h=138,k=3):e==f?(h=6,k=3):(h=7,k=4))},Ka=function(a,b){var c,d=-1,e,f=a[0].dl,g=0,h=7,k=4;0==f&&(h=138,k=3);for(c=0;c<=b;c++)if(e=f,f=a[c+1].dl,!(++g<h&&e==f)){if(g<k){do ba(e,I);while(0!=--g)}else 0!=e?(e!=d&&(ba(e,I),g--),ba(16,I),R(g-3,2)):10>=g?(ba(17,I),R(g-3,3)):(ba(18,I),R(g-11,7));g=0;d=e;0==f?(h=138,k=3):e==f?(h=6,k=3):(h=7,k=4)}},ra=function(a){var b,c,d,e;e=v-y;la[ta]=da;Aa(A);
Aa(U);Ja(x,A.max_code);Ja(Q,U.max_code);Aa(O);for(d=18;3<=d&&0==I[Ba[d]].dl;d--);aa+=3*(d+1)+14;b=aa+3+7>>3;c=ea+3+7>>3;c<=b&&(b=c);if(e+4<=b&&0<=y)for(R(0+a,3),La(),pa(e),pa(~e),d=0;d<e;d++)oa(m[y+d]);else if(c==b)R(2+a,3),Ma(T,X);else{R(4+a,3);e=A.max_code+1;b=U.max_code+1;d+=1;R(e-257,5);R(b-1,5);R(d-4,4);for(c=0;c<d;c++)R(I[Ba[c]].dl,3);Ka(x,e-1);Ka(Q,b-1);Ma(x,Q)}Ha();0!=a&&La()},ja=function(a,b){D[Z++]=b;0==a?x[b].fc++:(a--,x[fa[b]+256+1].fc++,Q[(256>a?ca[a]:ca[256+(a>>7)])&255].fc++,N[ma++]=
a,da|=ga);ga<<=1;0==(Z&7)&&(la[ta++]=da,da=0,ga=1);if(2<w&&0==(Z&4095)){var c=8*Z,d=v-y,e;for(e=0;30>e;e++)c+=Q[e].fc*(5+ia[e]);c>>=3;if(ma<parseInt(Z/2)&&c<parseInt(d/2))return!0}return 8191==Z||8192==ma},Ma=function(a,b){var c,d=0,e=0,g=0,f=0,h,k;if(0!=Z){do 0==(d&7)&&(f=la[g++]),c=D[d++]&255,0==(f&1)?ba(c,a):(h=fa[c],ba(h+256+1,a),k=wa[h],0!=k&&(c-=sa[h],R(c,k)),c=N[e++],h=(256>c?ca[c]:ca[256+(c>>7)])&255,ba(h,b),k=ia[h],0!=k&&(c-=ka[h],R(c,k))),f>>=1;while(d<Z)}ba(256,a)},R=function(a,b){n>16-
b?(u|=a<<n,pa(u),u=a>>16-n,n+=b-16):(u|=a<<n,n+=b)},Ga=function(a,b){var c=0;do c|=a&1,a>>=1,c<<=1;while(0<--b);return c>>1},La=function(){8<n?pa(u):0<n&&oa(u);n=u=0};a.RawDeflate||(a.RawDeflate={});a.RawDeflate.deflate=function(a,b){var c,e;na=a;ua=0;"undefined"==typeof b&&(b=6);(c=b)?1>c?c=1:9<c&&(c=9):c=6;w=c;H=p=!1;if(null==k){d=f=h=null;k=Array(8192);m=Array(65536);N=Array(8192);D=Array(32832);z=Array(65536);x=Array(573);for(c=0;573>c;c++)x[c]=new ha;Q=Array(61);for(c=0;61>c;c++)Q[c]=new ha;
T=Array(288);for(c=0;288>c;c++)T[c]=new ha;X=Array(30);for(c=0;30>c;c++)X[c]=new ha;I=Array(39);for(c=0;39>c;c++)I[c]=new ha;A=new va;U=new va;O=new va;F=Array(16);M=Array(573);C=Array(573);fa=Array(256);ca=Array(512);sa=Array(29);ka=Array(30);la=Array(1024)}for(var g=Array(1024),l=[];0<(c=Pa(g,0,g.length));){var q=Array(c);for(e=0;e<c;e++)q[e]=String.fromCharCode(g[e]);l[l.length]=q.join("")}na=null;return l.join("")}})(this);
(function(a){if(!a.Base64){var d;"undefined"!==typeof module&&module.exports&&(d=require("buffer").Buffer);var f=function(a){for(var d={},e=0,f=a.length;e<f;e++)d[a.charAt(e)]=e;return d}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),h=String.fromCharCode,p=function(a){if(2>a.length){var d=a.charCodeAt(0);return 128>d?a:2048>d?h(192|d>>>6)+h(128|d&63):h(224|d>>>12&15)+h(128|d>>>6&63)+h(128|d&63)}d=65536+1024*(a.charCodeAt(0)-55296)+(a.charCodeAt(1)-56320);return h(240|d>>>18&
7)+h(128|d>>>12&63)+h(128|d>>>6&63)+h(128|d&63)},k=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,t=function(a){return a.replace(k,p)},l=function(a){var d=[0,2,1][a.length%3];a=a.charCodeAt(0)<<16|(1<a.length?a.charCodeAt(1):0)<<8|(2<a.length?a.charCodeAt(2):0);return["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>12&63),2<=d?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>
6&63),1<=d?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a&63)].join("")},E=a.btoa||function(a){return a.replace(/[\s\S]{1,3}/g,l)},m=d?function(a){return(new d(a)).toString("base64")}:function(a){return E(t(a))},N=function(a,d){return d?m(a).replace(/[+\/]/g,function(a){return"+"==a?"-":"_"}).replace(/=/g,""):m(a)},D=/[\u00c0-\u00df][\u0080-\u00bf]|[\u00e0-\u00ef][\u0080-\u00bf]{2}|[\u00f0-\u00f7][\u0080-\u00bf]{3}/g,z=function(a){switch(a.length){case 4:return a=
((7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3))-65536,h((a>>>10)+55296)+h((a&1023)+56320);case 3:return h((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return h((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1))}},u=function(a){return a.replace(D,z)},n=function(a){var d=a.length,e=d%4;a=(0<d?f[a.charAt(0)]<<18:0)|(1<d?f[a.charAt(1)]<<12:0)|(2<d?f[a.charAt(2)]<<6:0)|(3<d?f[a.charAt(3)]:0);a=[h(a>>>16),h(a>>>8&255),h(a&255)];a.length-=
[0,0,2,1][e];return a.join("")},y=a.atob||function(a){return a.replace(/[\s\S]{1,4}/g,n)},G=d?function(a){return(new d(a,"base64")).toString()}:function(a){return u(y(a))},J=function(a){return G(a.replace(/[-_]/g,function(a){return"-"==a?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};a.Base64={VERSION:"2.1.1",atob:y,btoa:E,fromBase64:J,toBase64:N,utob:t,encode:N,encodeURI:function(a){return N(a,!0)},btou:u,decode:J};if("function"===typeof Object.defineProperty){var P=function(a){return{value:a,enumerable:!1,
writable:!0,configurable:!0}};a.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",P(function(){return J(this)}));Object.defineProperty(String.prototype,"toBase64",P(function(a){return N(this,a)}));Object.defineProperty(String.prototype,"toBase64URI",P(function(){return N(this,!0)}))}}}})(this);