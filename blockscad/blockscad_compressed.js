// Do not edit this file; automatically generated by blockscad_build.py.
"use strict";
var Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{};Blockscad.undo=Blockscad.undo||{};Blockscad.Auth.serverURL="https://blocks-and-more-blocks.appspot.com";Blockscad.Auth.sessionTestURL=Blockscad.Auth.serverURL+"/session_test/";Blockscad.Auth.loginURL=Blockscad.Auth.serverURL+"/login/";Blockscad.Auth.registerURL=Blockscad.Auth.serverURL+"/register/";Blockscad.Auth.logoutURL=Blockscad.Auth.serverURL+"/logout/";Blockscad.Auth.usernameCheckURL=Blockscad.Auth.serverURL+"/username_check/";
Blockscad.Auth.saveProjectURL=Blockscad.Auth.serverURL+"/save_project/";Blockscad.Auth.listProjectURL=Blockscad.Auth.serverURL+"/list_project/";Blockscad.Auth.projectDownloadURL=Blockscad.Auth.serverURL+"/fetch_project/";Blockscad.Auth.deleteProjectURL=Blockscad.Auth.serverURL+"/delete_project/";Blockscad.Auth.editPasswordURL=Blockscad.Auth.serverURL+"/edit_password/";Blockscad.Auth.editEmailURL=Blockscad.Auth.serverURL+"/edit_email/";Blockscad.Auth.passwordRecoveryURL=Blockscad.Auth.serverURL+"/recover_password/";
Blockscad.Auth.deleteAccountURL=Blockscad.Auth.serverURL+"/schedule_deletion/";Blockscad.Auth.currentProject="";Blockscad.Auth.currentProjectKey="";Blockscad.Auth.isLoggedIn=0;Blockscad.Auth.currentEmail="";
Blockscad.Auth.init=function(){$.ajaxSetup({crossDomain:!0,xhrFields:{withCredentials:!0}});$("#login-form").submit(function(){$.post(Blockscad.Auth.loginURL,$(this).serialize(),function(a,b){if(a.match(/^SUCCESS/)){var d=a.split(" "),f=$("#login-username").val();Blockscad.Auth.currentEmail=d[1];Blockscad.Auth.loggedIn(f,d[1]);$("#login-user").modal("hide");"REACTIVATE"==d[2]&&$("#delete-reactivate").modal("show")}else $("#login-error").text(Blockscad.FORM_ERRORS.loginFailed),$("#login-error").addClass("error-message")});
$("#login-password").text("");return!1});$("#login-user").on("shown.bs.modal",function(){$("#login-username").focus()});$("#register-form").submit(function(a){a.preventDefault();a.stopPropagation();Blockscad.Auth.validateRegFields()||Blockscad.Auth.validateUsername(usernameCheckSubmitForm);return!1});$("#register-user").on("shown.bs.modal",function(){$("#register-username").focus()});$("#password-settings-form").submit(function(){Blockscad.Auth.goodPassword=0;Blockscad.Auth.goodPasswordMatch=0;$("#change-pw-new").blur();
$("#change-pw-2").blur();Blockscad.Auth.goodPassword&&Blockscad.Auth.goodPasswordMatch&&$.post(Blockscad.Auth.editPasswordURL,$(this).serialize(),function(a,b){var d=a.match(/^Success/),f=a.match(/^incorrect/);d?($("#change-password-modal").modal("hide"),$("#menuLogout").click(),window.setTimeout(function(){$("#login-button").click()},600)):f?($("#pw-error").text(Blockscad.FORM_ERRORS.badPassword),$("#pw-error").addClass("error-message")):console.log("some unknown error here. Ack!")}).fail(function(a){$("#change-password-modal").modal("hide");
Blockscad.Auth.resetUser()});return!1});$("#change-password-modal").on("shown.bs.modal",function(){$("#change-pw-old").focus()});$("#delete-account-yes").on("click",function(){$("#delete-account-modal").modal("show");clearForm($("#delete-account-form"))});$("#delete-account-form").submit(function(){$.post(Blockscad.Auth.deleteAccountURL,$(this).serialize(),function(a,b){var d=a.match(/^Success/),f=a.match(/^incorrect/);d?($("#delete-account-modal").modal("hide"),$("#menuLogout").click()):f?($("#da-pw-error").text(Blockscad.FORM_ERRORS.badPassword),
$("#da-pw-error").addClass("error-message")):console.log("some unknown error here. Ack!")}).fail(function(a){$("#delete-account-modal").modal("hide");Blockscad.Auth.resetUser()});return!1});$("#delete-account-modal").on("shown.bs.modal",function(){$("#del-acct-pw").focus()});$("#email-settings-form").submit(function(){Blockscad.Auth.goodEmail=0;$("#new-email").blur();Blockscad.Auth.goodEmail&&$.post(Blockscad.Auth.editEmailURL,$(this).serialize(),function(a,b){var d=a.match(/^Success/),f=a.match(/^incorrect/);
d?($("#change-email-modal").modal("hide"),d=a.split(" "),Blockscad.Auth.currentEmail=d[1]):f?($("#email-pw-error").text(Blockscad.FORM_ERRORS.badPassword),$("#email-pw-error").addClass("error-message")):console.log("some unknown error here. Ack!")}).fail(function(a){$("#change-email-modal").modal("hide");Blockscad.Auth.resetUser()});return!1});$("#change-email-modal").on("show.bs.modal",function(){$("#current-email").html("Current Email is: <b>"+Blockscad.Auth.currentEmail+"</b>");$("#new-email").focus()});
$("#pw-recover-form").submit(function(a){a.preventDefault();a.stopPropagation();a=$("#recover-username").val();var b=$("#recover-email").val();$("#un-recover-error").text("");$("#em-recover-error").text("");if(a.length){if(3>a.length||30<a.length)return $("#un-recover-error").text(Blockscad.FORM_ERRORS.usernameLength),!1;if(!/^[a-zA-Z0-9_-]+$/.test(a))return $("#un-recover-error").text(Blockscad.FORM_ERRORS.usernameCharacters),!1}else if(b.length){if(!/\S+@\S+\.\S+/.test(b))return $("#em-recover-error").text(Blockscad.FORM_ERRORS.emailInvalid),
!1}else return!1;$.post(Blockscad.Auth.passwordRecoveryURL,$(this).serialize(),function(a,b){a.match(/^Success/)?($("#pw-recover").modal("hide"),$("#recover-email-sent").modal("show")):(a.match(/bad username/)&&$("#un-recover-error").text("We can't find this username."),a.match(/bad email/)&&$("#em-recover-error").text("We can't find this email address."))})});$("#pw-recover").on("show.bs.modal",function(){$("#recover-username").focus()});$("#login-area").on("click","#reg-button",function(){clearForm($("#register-form"));
Blockscad.Auth.goodUsername=!1;Blockscad.Auth.goodPassword=!1;Blockscad.Auth.goodPasswordMatch=!1;Blockscad.Auth.goodEmail=!1});$("#login-area").on("click","#login-button",function(){clearForm($("#login-form"))});$("#login-area").on("click","#changePassword",function(){clearForm($("#password-settings-form"))});$("#login-area").on("click","#changeEmail",function(){clearForm($("#email-settings-form"))});$("#forgot-password").on("click",function(){clearForm($("#pw-recover-form"))});$('input[type="password"]').on("keydown",
function(a){a.stopPropagation()});$('input[type="email"]').on("keydown",function(a){a.stopPropagation()});$("#login-area").on("click","#menuLogout",function(){Blockscad.newProject();$.get(Blockscad.Auth.logoutURL,function(a){"SUCCESS"==a&&Blockscad.Auth.notLoggedIn()});return!1});$("#projList").on("click",".proj-to-download",function(){var a=$(this).html(),b=$(this).attr("data-key"),d=$(this).attr("data-id");Blockscad.Auth.currentProjectKey!=b&&Blockscad.Auth.currentProject!=d&&(Blockscad.Auth.currentProjectKey=
b,Blockscad.Auth.currentProject=d,$.post(Blockscad.Auth.projectDownloadURL,{key:b},function(a,b){var d=Base64.btou(RawDeflate.inflate(Base64.fromBase64(a)));Blockly.mainWorkspace.clear();gProcessor.clearViewer();d=Blockly.Xml.textToDom(d);Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),d);Blockscad.clearStlBlocks();for(Blockscad.workspaceChanged();Blockscad.undo.undoStack.length;)Blockscad.undo.undoStack.pop();for(;Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop()}).fail(function(a){"Fail. Login Required"==
a.responseText&&Blockscad.Auth.resetUser()}),$("#project-name").val(a));$("#displayBlocks").click();$("#projView").hide();$("#editView").show()});$("#projList").on("click",".delbtn",function(a){a.preventDefault();var b=$(this).closest("tr");b.find(".proj-to-download").attr("data-id");var d=b.find(".proj-to-download").attr("data-key");a=b.find(".proj-to-download").html();$("#online-delete-confirm").find(".modal-title").text('Are you sure you want to delete "'+a+'"?');$("#online-delete-confirm").modal().off("click",
"#toss-it");$("#online-delete-confirm").modal().one("click","#toss-it",function(a){$.post(Blockscad.Auth.deleteProjectURL,{key:d},function(a,d){"success"==d&&b.remove()}).fail(function(a){"Fail. Login Required"==a.responseText&&$("#projectView").hide();$("#editView").show();Blockscad.Auth.resetUser()})})});$("#file-menu").on("click","#session_test",function(){$.get(Blockscad.Auth.sessionTestURL,function(a){0<a.match(/^SUCCESS/).length&&alert("You are allowed to do SECRET things!!!!")}).fail(function(){alert("You aren't authorized to do SECRET things!!!!")})});
$("#register-password").blur(Blockscad.Auth.validatePassword);$("#pass2").blur(Blockscad.Auth.validatePasswordMatch);$("#register-username").blur(function(){Blockscad.Auth.validateUsername(usernameCheckSetErrorMessage)});$("#register-email").blur(Blockscad.Auth.validateEmail);$("#new-email").blur(Blockscad.Auth.validateEmail);$("#change-pw-new").blur(Blockscad.Auth.validatePassword);$("#change-pw-2").blur(Blockscad.Auth.validatePasswordMatch);$("#file-menu").on("click","#saveProject",Blockscad.Auth.saveBlocksToAccount);
$("#file-menu").on("click","#saveAsProject",Blockscad.Auth.saveAsCopyToAccount);$("#file-menu").on("click","#projectList",Blockscad.Auth.listProject);$("#main").on("click",".new-project",Blockscad.newProject);$("#list-more").on("click",Blockscad.Auth.listMoreProject);$("#login-area").on("click","#bigsavebutton",Blockscad.Auth.saveBlocksToAccount);$("#forgot-password").on("click",Blockscad.Auth.forgotPassword)};
Blockscad.Auth.notLoggedIn=function(){Blockscad.Auth.isLoggedIn=0;Blockscad.Auth.currentEmail="";$("#login-area").html("<button type='button' id='reg-button' class='btn-default btn-big' data-toggle='modal' data-target='#register-user' >Register</button>\n<button type='button' id='login-button' class='btn-default btn-big' data-toggle='modal' data-target='#login-user' >Sign in</button>");$("#file-menu").html('<li><a href="#" class="new-project">New</a></li>\n<li class="divider"></li>\n<li><a href="#" id="saveLocal">Save Blocks to your Computer</a></li>\n<li>\n<input type="file" accept=".xml" id="loadLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'loadLocal\').click(); return false">Load Blocks from your Computer</a>\n</li>\n<li class="divider"></li>\n<li>\n<input type="file" accept=".xml" id="importLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importLocal\').click(); return false">Import Blocks into Current Project</a>\n</li>\n<li>\n<input type="file" accept=".stl" id="importStl" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importStl\').click(); return false">Import STL into Current Project</a>\n</li>\n')};
Blockscad.Auth.loggedIn=function(a,b){Blockscad.Auth.isLoggedIn=1;Blockscad.Auth.currentEmail=b;$("#login-area").html('<button type="button" id="bigsavebutton" class="btn-default btn btn-lg" style="margin-top:2px;">Save</button><ul class="nav navbar-nav navbar-right">\n<li class="dropdown">\n<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">'+a+'<span class="caret"></span></a>\n<ul class="dropdown-menu" role="menu">\n <li><a href="#" id="changePassword" data-toggle="modal" data-target="#change-password-modal">Change Password</a></li>\n <li><a href="#" id="changeEmail" data-toggle="modal" data-target="#change-email-modal">Change Email</a></li>\n <li><a href="#" id="deleteAccount" data-toggle="modal" data-target="#delete-account-confirm">Delete My Account</a></li>\n<li class="divider"></li>\n<li><a href="#" id="menuLogout">Logout</a></li>\n</ul>\n</li>\n</ul>\n');
$("#file-menu").html('<li><a href="#" id="projectList">My Projects</a></li>\n<li><a href="#" class="new-project">New</a></li>\n<li><a href="#" id="saveProject">Save</a></li>\n<li><a href="#" id="saveAsProject">Save As A Copy</a></li>\n<li class="divider"></li>\n<li><a href="#" id="saveLocal">Save Blocks to your Computer</a></li>\n<li>\n<input type="file" accept=".xml" id="loadLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'loadLocal\').click(); return false">Load Blocks from your Computer</a>\n</li>\n<li class="divider"></li>\n<li>\n<input type="file" accept=".xml" id="importLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importLocal\').click(); return false">Import Blocks into Current Project</a>\n</li>\n<li>\n<input type="file" accept=".stl" id="importStl" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importStl\').click(); return false">Import STL into Current Project</a>\n</li>\n')};
Blockscad.Auth.forgotPassword=function(){$("#login-user").modal("hide");$("#pw-recover").modal("show")};Blockscad.Auth.checkForUser=function(){$.get(Blockscad.Auth.sessionTestURL,function(a,b){if(a.match(/^SUCCESS/)){var d=a.split(" ");Blockscad.Auth.loggedIn(d[1],d[2])}}).fail(function(a,b){Blockscad.Auth.notLoggedIn()})};
Blockscad.Auth.listProject=function(){0<Blockscad.undo.undoStack.length&&Blockscad.Auth.saveBlocksToAccount();$.post(Blockscad.Auth.listProjectURL,{more:"false"},function(a,b){var d=a.split("*****",2);$("#projList").html(d[1]);$("#editView").hide();$("#projectView").show();"True"==d[0]?$("#list-more").show():$("#list-more").hide()}).fail(function(a){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()})};
Blockscad.Auth.listMoreProject=function(){$.post(Blockscad.Auth.listProjectURL,{more:"true"},function(a,b){var d=a.split("*****",2);$("#projList").append(d[1]);"True"==d[0]?$("#list-more").show():$("#list-more").hide()}).fail(function(a,b){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()})};Blockscad.Auth.saveBlocksToAccount=function(){var a=$("#project-name").val();""==a&&(a="Untitled");Blockscad.Auth.saveThing(a)};
Blockscad.Auth.saveThing=function(a){var b=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),b=Blockly.Xml.domToText(b),b=Base64.toBase64(RawDeflate.deflate(Base64.utob(b))),d=Blockscad.version;""==Blockscad.Auth.currentProject&&(Blockscad.Auth.currentProject=(new Date).getTime());var f=new FormData;f.append("created",Blockscad.Auth.currentProject);f.append("name",a);f.append("version",d);f.append("shared",0);f.append("key",Blockscad.Auth.currentProjectKey);f.append("content",b);$.ajax({url:Blockscad.Auth.saveProjectURL,
type:"POST",data:f,contentType:!1,processData:!1,success:function(a){a=a.split(":",2);a[0]==Blockscad.Auth.currentProject?Blockscad.Auth.currentProjectKey=a[1]:console.log("in save, project id coming back doesn't match current id.  ")},error:function(a){"Fail. Login Required"==a.responseText&&Blockscad.Auth.resetUser()}})};
Blockscad.Auth.saveAsCopyToAccount=function(){var a=$("#project-name").val();""==a&&(a="Untitled");a+=" copy";Blockscad.Auth.currentProject="";Blockscad.Auth.currentProjectKey="";Blockscad.Auth.saveThing(a);$("#project-name").val(a)};
Blockscad.Auth.validateRegFields=function(){$("#register-password").blur();$("#pass2").blur();$("#register-email").blur();Blockscad.Auth.validateUsername(usernameCheckSetErrorMessage);return Blockscad.Auth.goodPassword&&Blockscad.Auth.goodPasswordMatch&&Blockscad.Auth.goodUsername&&Blockscad.Auth.goodEmail?!1:!0};Blockscad.Auth.resetUser=function(){Blockscad.Auth.notLoggedIn();$("#login-button").click()};
Blockscad.Auth.validatePassword=function(a){a=$(this).val();var b=!1,d=$(this).parent().find(".password-error");d.text("");a.length||(d.text(Blockscad.FORM_ERRORS.passwordEmpty),b=!0);a.length&&(Blockscad.Auth.isLoggedIn?$("#login-area").find("a:first").text():$("#register-username").val().toLowerCase(),a.toLowerCase()==$("#register-username").val().toLowerCase()?(d.text(Blockscad.FORM_ERRORS.passwordUsername),b=!0):"password"==a.toLowerCase()?(d.text(Blockscad.FORM_ERRORS.passwordPassword),b=!0):
6>a.length&&(d.text(Blockscad.FORM_ERRORS.passwordLength),b=!0));b?(d.addClass("form-error-message"),Blockscad.Auth.goodPassword=!1):(d.removeClass("form-error-message"),Blockscad.Auth.goodPassword=!0)};
Blockscad.Auth.validatePasswordMatch=function(a){a=$(this).parent().prev().find("input").val();var b=$(this).val(),d=$(this).parent().find(".password-confirm-error");d.text("");a!=b?(d.text(Blockscad.FORM_ERRORS.passwordConfirm),d.addClass("form-error-message"),Blockscad.Auth.goodPasswordMatch=!1):(d.removeClass("form-error-message"),Blockscad.Auth.goodPasswordMatch=!0)};
Blockscad.Auth.validateEmail=function(){var a=!1,b=$(this).val(),d=$(this).next("div").find(".email-error");d.text("");b.length?/\S+@\S+\.\S+/.test(b)||(d.html(Blockscad.FORM_ERRORS.emailInvalid),a=!0):(d.html(Blockscad.FORM_ERRORS.emailEmpty),a=!0);a?(d.addClass("form-error-message"),Blockscad.Auth.goodEmail=!1):(d.removeClass("form-error-message"),Blockscad.Auth.goodEmail=!0)};
Blockscad.Auth.validateUsername=function(a,b){var d=$("#register-username").val(),f=!1,k=$("#username-error");k.text("");d.length||b||(k.text(Blockscad.FORM_ERRORS.usernameEmpty),f=!0);if(d.length&&(3>d.length||30<d.length?(k.text(Blockscad.FORM_ERRORS.usernameLength),f=!0):/^[a-zA-Z0-9_-]+$/.test(d)||(k.text(Blockscad.FORM_ERRORS.usernameCharacters),f=!0),f?(k.addClass("form-error-message"),Blockscad.Auth.goodUsername=!1):(k.removeClass("form-error-message"),Blockscad.Auth.goodUsername=!0),!f))return $.post(Blockscad.Auth.usernameCheckURL,
{name:d},function(b){a(b)}),!1;f?(k.addClass("form-error-message"),Blockscad.Auth.goodUsername=!1):(k.removeClass("form-error-message"),Blockscad.Auth.goodUsername=!0)};function usernameCheckSetErrorMessage(a){"username exists"==a&&($("#username-error").text(Blockscad.FORM_ERRORS.usernameExists),$("#username-error").addClass("form-error-message"))}
function usernameCheckSubmitForm(a){if("username exists"!=a)return $.post(Blockscad.Auth.registerURL,$("#register-form").serialize(),function(a,d){"SUCCESS"==a&&($("#login-username").val($("#register-username").val()),$("#login-password").val($("#register-password").val()),window.setTimeout(function(){$("#login-form").submit()},1E3))}),$("#register-user").modal("hide"),!1}
function clearForm(a){a.find("input:text, input:password").val("");a.find(".password-error, #username-error, .footer-error, .password-confirm-error, .email-error").text("");a.find(".password-error, #username-error, .footer-error,  .password-confirm-error, .email-error").removeClass("form-error-message");a.find(".footer-error").removeClass("error-message")}Blockscad.FORM_ERRORS={};Blockscad.FORM_ERRORS.passwordUsername="Your password cannot match your username!";
Blockscad.FORM_ERRORS.passwordLength="Your password must be at least 6 characters long.";Blockscad.FORM_ERRORS.passwordPassword="Your password cannot be the word 'password'.";Blockscad.FORM_ERRORS.passwordEmpty="Please choose a password at least 6 characters long.";Blockscad.FORM_ERRORS.passwordConfirm="Your second password must match the first password.";Blockscad.FORM_ERRORS.emailInvalid="You must provide a valid email address.";Blockscad.FORM_ERRORS.emailEmpty="Please enter an email address.";
Blockscad.FORM_ERRORS.usernameEmpty="Please choose a username.";Blockscad.FORM_ERRORS.usernameLength="Username must be between 3 and 30 characters.";Blockscad.FORM_ERRORS.usernameCharacters="Your username may only contain letters, numbers, -, and _";Blockscad.FORM_ERRORS.usernameExists="Sorry, that username already exists.";Blockscad.FORM_ERRORS.loginFailed="Incorrect username or password.";Blockscad.FORM_ERRORS.badPassword="Incorrect password - please retype your original password.";var BlocklyStorage=BlocklyStorage||{},Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{};var Blockly=Blockly||{};Blockly.Xml=Blockly.Xml||{};
BlocklyStorage.backupBlocks_=function(){console.log("in backupBlocks");if("localStorage"in window){localStorage.clear();for(var a=Blockly.Xml.workspaceToDom(Blockscad.workspace),b=window.location.href.split("#")[0],d=b+"proj_name",f=b+"current_project",k=Blockscad.workspace.getAllBlocks(),h=0;h<k.length;h++)if("stl_import"==k[h].type){var n=k[h].getField("STL_CONTENTS").getText();if(0<n.length){var l=b+n,t=b+n+"center";if(3E6>Blockscad.csg_commands[n].length){var m=Base64.toBase64(RawDeflate.deflate(Base64.utob(Blockscad.csg_commands[n])));
window.localStorage.setItem(l,m);window.localStorage.setItem(t,Blockscad.csg_center[n])}}}window.localStorage.setItem(b,Blockly.Xml.domToText(a));window.localStorage.setItem(d,$("#project-name").val());window.localStorage.setItem(f,Blockscad.Auth.current_project)}};BlocklyStorage.backupOnUnload=function(){window.addEventListener("unload",BlocklyStorage.backupBlocks_,!1)};
BlocklyStorage.restoreBlocks=function(){var a=window.location.href.split("#")[0],b=a+"proj_name",d=a+"current_project";console.log(window.localStorage);if("localStorage"in window&&window.localStorage[a]){var f=Blockly.Xml.textToDom(window.localStorage[a]);Blockly.Xml.domToWorkspace(Blockscad.workspace,f);for(var f=Blockscad.workspace.getAllBlocks(),k=0;k<f.length;k++)if("stl_import"==f[k].type){var h=f[k].getField("STL_CONTENTS").getText(),n=f[k].getField("STL_FILENAME").getText(),l=f[k].getField("STL_BUTTON");
if(0<h.length){var t=window.localStorage[a+h],m=window.localStorage[a+h+"center"];if(t&&0<t.length)l.setVisible(!1),console.log("csg contents compressed length is:",t.length),l=Base64.btou(RawDeflate.inflate(Base64.fromBase64(t))),console.log("decompressed lengeth is:",l.length),Blockscad.csg_commands[h]=l,Blockscad.csg_filename[h]=n+":::",Blockscad.csg_center[h]=m;else{console.log("couldn't find the stuff in localStorage");f[k].getField("STL_CONTENTS").setText("");f[k].getField("STL_FILENAME").setText("");
h=f[k].getCommentText();h="RELOAD: "+h;f[k].setCommentText(h);l.setText("Reload");f[k].backlight();if(h=f[k].collapsedParents())for(n=0;n<h.length;n++)h[n].backlight();f[k].isCollapsed()||l.setVisible(!0);l=f[k];for(h=null;l;)l.isCollapsed()&&(h=l),l=l.getSurroundParent();h&&h.setCollapsed(!0,!0)}f[k].render()}}a=window.localStorage[b];"undefined"!=a?$("#project-name").val(a):$("#project-name").val("Untitled");d=window.localStorage[d];Blockscad.Auth.currentProject="undefined"!=d?d:""}};var BSUtils=BSUtils||{};BSUtils.LANGUAGE_NAME={en:"English",es:"Espa\u00f1ol"};BSUtils.LANGUAGE_RTL=["ar","fa","he"];BSUtils.LANGUAGES=void 0;BSUtils.getStringParamFromUrl=function(a,b){var d=window.location.search.match(new RegExp("[?&]"+a+"=([^&]+)"));return d?decodeURIComponent(d[1].replace(/\+/g,"%20")):b};BSUtils.getLang=function(){var a=BSUtils.getStringParamFromUrl("lang","");void 0===BSUtils.LANGUAGE_NAME[a]&&(a="en");return a};BSUtils.LANG=BSUtils.getLang();
BSUtils.isRtl=function(){return-1!=BSUtils.LANGUAGE_RTL.indexOf(BSUtils.LANG)};
BSUtils.init=function(){var a=BSUtils.isRtl();document.head.parentElement.setAttribute("dir",a?"rtl":"ltr");document.head.parentElement.setAttribute("lang",BSUtils.LANG);for(var a=[],b=0;b<BSUtils.LANGUAGES.length;b++){var d=BSUtils.LANGUAGES[b];a.push([BSUtils.LANGUAGE_NAME[d],d])}a.sort(function(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:0});for(var f=document.getElementById("languageMenu"),b=f.options.length=0;b<a.length;b++){var k=a[b],d=k[k.length-1],k=new Option(k[0],d);d==BSUtils.LANG&&(k.selected=
!0);f.options.add(k)}f.addEventListener("change",BSUtils.changeLanguage,!0);document.getElementById("codeButton")&&BSUtils.bindClick("codeButton",BSUtils.showCode);(a=document.querySelector('meta[name="viewport"]'))&&725>screen.availWidth&&a.setAttribute("content","width=725, initial-scale=.35, user-scalable=no")};
BSUtils.initReadonly=function(){Blockly.inject(document.getElementById("blockly"),{path:"./",readOnly:!0,rtl:BSUtils.isRtl(),scrollbars:!1});var a=BSUtils.getStringParamFromUrl("xml",""),a=Blockly.Xml.textToDom("<xml>"+a+"</xml>");Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)};
BSUtils.loadBlocks=function(a){try{var b=window.sessionStorage.loadOnceBlocks}catch(d){b=null}"BlocklyStorage"in window&&1<window.location.hash.length?BlocklyStorage.retrieveXml(window.location.hash.substring(1)):b?(delete window.sessionStorage.loadOnceBlocks,a=Blockly.Xml.textToDom(b),Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)):a?(a=Blockly.Xml.textToDom(a),Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)):"BlocklyStorage"in window&&window.setTimeout(BlocklyStorage.restoreBlocks,0)};
BSUtils.changeLanguage=function(){if("undefined"!=typeof Blockly&&window.sessionStorage){var a=Blockly.Xml.workspaceToDom(Blockly.mainWorkspace),a=Blockly.Xml.domToText(a);window.sessionStorage.loadOnceBlocks=a}var a=document.getElementById("languageMenu"),a=encodeURIComponent(a.options[a.selectedIndex].value),b=window.location.search,b=1>=b.length?"?lang="+a:b.match(/[?&]lang=[^&]*/)?b.replace(/([?&]lang=)[^&]*/,"$1"+a):b.replace(/\?/,"?lang="+a+"&");window.location=window.location.protocol+"//"+
window.location.host+window.location.pathname+b};BSUtils.isDialogVisible_=!1;BSUtils.dialogOrigin_=null;BSUtils.dialogDispose_=null;
BSUtils.showDialog=function(a,b,d,f,k,h){function n(){BSUtils.isDialogVisible_&&(l.style.visibility="visible",l.style.zIndex=1,t.style.visibility="hidden")}BSUtils.isDialogVisible_&&BSUtils.hideDialog(!1);BSUtils.isDialogVisible_=!0;BSUtils.dialogOrigin_=b;BSUtils.dialogDispose_=h;var l=document.getElementById("dialog");h=document.getElementById("dialogShadow");var t=document.getElementById("dialogBorder"),m;for(m in k)l.style[m]=k[m];f&&(h.style.visibility="visible",h.style.opacity=.3,f=document.createElement("div"),
f.id="dialogHeader",l.appendChild(f),BSUtils.dialogMouseDownWrapper_=Blockly.bindEvent_(f,"mousedown",null,BSUtils.dialogMouseDown_));l.appendChild(a);a.className=a.className.replace("dialogHiddenContent","");d&&b?(BSUtils.matchBorder_(b,!1,.2),BSUtils.matchBorder_(l,!0,.8),window.setTimeout(n,175)):n()};BSUtils.dialogStartX_=0;BSUtils.dialogStartY_=0;
BSUtils.dialogMouseDown_=function(a){BSUtils.dialogUnbindDragEvents_();if(!Blockly.isRightButton(a)){var b=document.getElementById("dialog");BSUtils.dialogStartX_=b.offsetLeft-a.clientX;BSUtils.dialogStartY_=b.offsetTop-a.clientY;BSUtils.dialogMouseUpWrapper_=Blockly.bindEvent_(document,"mouseup",null,BSUtils.dialogUnbindDragEvents_);BSUtils.dialogMouseMoveWrapper_=Blockly.bindEvent_(document,"mousemove",null,BSUtils.dialogMouseMove_);a.stopPropagation()}};
BSUtils.dialogMouseMove_=function(a){var b=document.getElementById("dialog"),d=BSUtils.dialogStartX_+a.clientX;a=BSUtils.dialogStartY_+a.clientY;a=Math.max(a,0);a=Math.min(a,window.innerHeight-b.offsetHeight);d=Math.max(d,0);d=Math.min(d,window.innerWidth-b.offsetWidth);b.style.left=d+"px";b.style.top=a+"px"};
BSUtils.dialogUnbindDragEvents_=function(){BSUtils.dialogMouseUpWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseUpWrapper_),BSUtils.dialogMouseUpWrapper_=null);BSUtils.dialogMouseMoveWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseMoveWrapper_),BSUtils.dialogMouseMoveWrapper_=null)};
BSUtils.hideDialog=function(a){function b(){f.style.visibility="hidden";k.style.visibility="hidden"}if(BSUtils.isDialogVisible_){BSUtils.dialogUnbindDragEvents_();BSUtils.dialogMouseDownWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseDownWrapper_),BSUtils.dialogMouseDownWrapper_=null);BSUtils.isDialogVisible_=!1;BSUtils.dialogDispose_&&BSUtils.dialogDispose_();BSUtils.dialogDispose_=null;var d=!1===a?null:BSUtils.dialogOrigin_;a=document.getElementById("dialog");var f=document.getElementById("dialogShadow"),
k=document.getElementById("dialogBorder");f.style.opacity=0;d?(BSUtils.matchBorder_(a,!1,.8),BSUtils.matchBorder_(d,!0,.2),window.setTimeout(b,175)):b();a.style.visibility="hidden";a.style.zIndex=-1;for((d=document.getElementById("dialogHeader"))&&d.parentNode.removeChild(d);a.firstChild;)d=a.firstChild,d.className+=" dialogHiddenContent",document.body.appendChild(d)}};
BSUtils.matchBorder_=function(a,b,d){function f(){k.style.width=h.width+"px";k.style.height=h.height+"px";k.style.left=h.x+"px";k.style.top=h.y+"px";k.style.opacity=d}if(a){var k=document.getElementById("dialogBorder"),h=BSUtils.getBBox_(a);b?(k.className="dialogAnimate",window.setTimeout(f,1)):(k.className="",f());k.style.visibility="visible"}};
BSUtils.getBBox_=function(a){var b=a.offsetHeight,d=a.offsetWidth,f=0,k=0;do f+=a.offsetLeft,k+=a.offsetTop,a=a.offsetParent;while(a);return{height:b,width:d,x:f,y:k}};
BSUtils.storageAlert=function(a){var b=document.getElementById("containerStorage");b.textContent="";a=a.split("\n");for(var d=0;d<a.length;d++){var f=document.createElement("p");f.appendChild(document.createTextNode(a[d]));b.appendChild(f)}b=document.getElementById("dialogStorage");a=document.getElementById("linkButton");BSUtils.showDialog(b,a,!0,!0,{width:"50%",left:"25%",top:"5em"},BSUtils.stopDialogKeyDown());BSUtils.startDialogKeyDown()};
BSUtils.dialogKeyDown_=function(a){!BSUtils.isDialogVisible_||13!=a.keyCode&&27!=a.keyCode&&32!=a.keyCode||(BSUtils.hideDialog(!0),a.stopPropagation(),a.preventDefault())};BSUtils.startDialogKeyDown=function(){document.body.addEventListener("keydown",BSUtils.dialogKeyDown_,!0)};BSUtils.stopDialogKeyDown=function(){document.body.removeEventListener("keydown",BSUtils.dialogKeyDown_,!0)};BSUtils.getMsg=function(a){var b=BSUtils.getMsgOrNull(a);return null===b?"[Unknown message: "+a+"]":b};
BSUtils.getMsgOrNull=function(a){return(a=document.getElementById(a))?(a=a.textContent,a=a.replace(/\\n/g,"\n")):null};BSUtils.addTouchEvents=function(){if("ontouchstart"in document.documentElement)for(var a=document.getElementsByTagName("button"),b=0,d;d=a[b];b++)d.ontouchend||(d.ontouchend=d.onclick)};window.addEventListener("load",BSUtils.addTouchEvents,!1);
BSUtils.bindClick=function(a,b){"string"==typeof a&&(a=document.getElementById(a));a.addEventListener("click",b,!0);a.addEventListener("touchend",b,!0)};Blockscad=Blockscad||{};Blockscad.Toolbox=Blockscad.Toolbox||{};BlocklyStorage=BlocklyStorage||{};Blockly=Blockly||{};BSUtils=BSUtils||{};Blockscad.version="1.0.0";Blockscad.offline=!1;var gCurrentFile=null,gProcessor=null,editor=null,gCurrentFiles=[],gMemFs=[],gMemFsCount=0,gMemFsTotal=0,gMemFsChanged=0,gRootFs=[],_includePath="./";Blockscad.drawAxes=1;
Blockscad.init=function(){function a(a,b){var d=a.target.files[0];if(d){if(b)var n=d.name.substr(0,d.name.lastIndexOf("("))||d.name,n=n.substr(0,d.name.lastIndexOf("."))||n,n=n.replace(/^\s+|\s+$/g,"");!Blockscad.offline&&b&&(Blockscad.Auth.isLoggedIn&&0<Blockscad.undo.undoStack.length&&(console.log("autosaving!"),Blockscad.Auth.saveBlocksToAccount()),Blockscad.Auth.currentProject="");b&&Blockly.getMainWorkspace().clear();var l={},t=new FileReader;t.onload=function(a){l=a.target.result;a=Blockly.Xml.textToDom(l);
Blockly.Xml.domToWorkspace(Blockscad.workspace,a);Blockly.fireUiEvent(window,"resize");Blockscad.clearStlBlocks()};t.readAsText(d);$("#importLocal")[0].value="";$("#loadLocal")[0].value="";b&&$("#project-name").val(n);$("#projView").hide();$("#editView").show();$("#displayBlocks").click()}else alert("Failed to load file")}Blockscad.initLanguage();var b=BSUtils.isRtl();Blockscad.missingFields=[];Blockscad.csg_commands={};Blockscad.csg_filename={};Blockscad.csg_center=[0,0,0];var d=document.getElementById("main");
window.addEventListener("resize",function(a){a=BSUtils.getBBox_(d);var b=document.getElementById("blocklyDiv");b.style.top=a.y+"px";b.style.left=a.x+"px";b.style.height=a.height-88+"px";b.style.width=a.width+"px";gProcessor&&gProcessor.viewer.rendered_resize(gProcessor.viewerdiv.offsetWidth,gProcessor.viewerdiv.offsetHeight);70>$("#main").height()-$(".resizableDiv").height()&&$(".resizableDiv").height($("#main").height()-70);20>$("#main").width()-$(".resizableDiv").width()&&$(".resizableDiv").width($("#main").width()-
20);$(".resizableDiv").position({of:$("#main"),my:"right top",at:"right top",offset:"-12 -55"})},!1);Blockscad.workspace=Blockly.inject(document.getElementById("blocklyDiv"),{media:"blockly/media/",rtl:b,toolbox:Blockscad.Toolbox.other});BSUtils.loadBlocks("");"BlocklyStorage"in window&&BlocklyStorage.backupOnUnload();$(".resizableDiv").resizable({handles:"s,w,sw",resize:function(a,b){var d=$(window).height();gProcessor&&(d=gProcessor.viewerdiv.offsetHeight,gProcessor.viewer.rendered_resize(gProcessor.viewerdiv.offsetWidth,
d));20>$("#main").width()-b.size.width&&(b.size.width=$("#main").width()-20);70>$("#main").height()-b.size.height&&(b.size.height=$("#main").height()-70);b.position.left=$(window).width()-(b.size.width+12);b.position.top=55}});Blockly.fireUiEvent(window,"resize");Blockscad.offline||Blockscad.Auth.init();BSUtils.bindClick("trashButton",function(){Blockscad.discard()});BSUtils.bindClick("renderButton",Blockscad.doRender);BSUtils.bindClick("undoButton",Blockscad.onUndo);BSUtils.bindClick("redoButton",
Blockscad.onRedo);$("#axesButton").click(function(){Blockscad.drawAxes=(Blockscad.drawAxes+1)%2;$("#axesButton").toggleClass("btn-pushed");gProcessor.viewer.onDraw()});$("#displayCode").click(function(){var a=document.getElementById("openScadPre"),b=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace);a.textContent=b;"function"==typeof prettyPrintOne&&(b=a.innerHTML,b=prettyPrintOne(b,"js"),a.innerHTML=b);Blockly.fireUiEvent(window,"resize")});$("#renderButton").prop("disabled",!0);$("#throw-it-away").click(Blockscad.clearProject);
$("#target").click(function(){alert("Handler for .click() called.")});Blockscad.readStlFile=function(a){var b=a.target.files[0];b?(a=new FileReader,a.onload=function(a){a=importSTL(a.target.result);var d=a[0];(a=a[1])||(a="blah");for(var f=b.name.substr(0,b.name.lastIndexOf("("))||b.name,f=f.substr(0,b.name.lastIndexOf("."))||f,t=f=f.replace(/^\s+|\s+$/g,""),m=1,w=0;Blockscad.csg_commands[t]&&!w;)d!=Blockscad.csg_commands[t]?(t=f+"_"+m,m++):w=1;Blockscad.csg_commands[t]=d;Blockscad.csg_filename[t]=
w?Blockscad.csg_filename[t]+(b.name+":::"):b.name+":::";Blockscad.csg_center[t]=a;Blockscad.currentInterestingBlock?(f=Blockscad.currentInterestingBlock.getField("STL_FILENAME"),d=Blockscad.currentInterestingBlock.getField("STL_BUTTON"),m=Blockscad.currentInterestingBlock.getField("STL_CONTENTS"),f.setText(b.name),f.setVisible(!0),d.setVisible(!1),m.setText(t),Blockscad.currentInterestingBlock.setCommentText(b.name+"\ncenter:("+a+")"),Blockscad.currentInterestingBlock=null):(t=Blockly.Xml.textToDom('<xml xmlns="http://www.w3.org/1999/xhtml"><block type="stl_import" id="1" x="10" y="10"><field name="STL_FILENAME">'+
b.name+'</field><field name="STL_BUTTON">Browse</field><field name="STL_CONTENTS">'+t+"</field></block></xml>"),t=Blockly.Xml.domToBlock(Blockscad.workspace,t.firstChild),d=t.getField("STL_BUTTON"),d.setVisible(!1),t.setCommentText(b.name+"\ncenter:("+a+")"),t.render())},a.readAsBinaryString(b),$("#importStl")[0].value="",$("#displayBlocks").click(),$("#renderButton").prop("disabled",!1)):alert("Failed to load file")};$("#file-menu").on("change","#loadLocal",function(b){a(b,!0)});$("#file-menu").on("change",
"#importLocal",function(b){a(b,!1)});$("#file-menu").on("change","#importStl",function(a){Blockscad.readStlFile(a)});gProcessor=new Blockscad.Processor(document.getElementById("renderDiv"));BSUtils.bindClick("viewReset",Blockscad.resetView);Blockscad.undo={blockList:[],oldBlockList:[],undoStack:[],redoStack:[],current_xml:null,blockCount:0,yesthis:0,fieldChanging:0,blockIds:[],fieldValues:[],parentIds:[],oldBlockIds:[],oldFieldValues:[],oldParentIds:[],just_did_undo:0};Blockscad.workspace.addUndoListener(Blockscad.workspaceChanged);
Blockscad.offline||Blockscad.Auth.checkForUser();$("#help-menu").on("click","#about",function(){$("#about-modal").modal("show")});$("#file-menu").on("click","#saveLocal",Blockscad.saveBlocksLocal)};document.write('<script src="blockly/msg/js/'+BSUtils.LANG+'.js">\x3c/script>\n');window.addEventListener("load",Blockscad.init);
Blockscad.clearStlBlocks=function(){for(var a=Blockscad.workspace.getAllBlocks(),b=0;b<a.length;b++)if("stl_import"==a[b].type){var d=a[b].getField("STL_BUTTON");a[b].getField("STL_CONTENTS").setText("");a[b].getField("STL_FILENAME").setText("");var f=a[b].getCommentText(),f="RELOAD: "+f;a[b].setCommentText(f);d.setText("Reload");a[b].backlight();if(f=a[b].collapsedParents())for(var k=0;k<f.length;k++)f[k].backlight();a[b].isCollapsed()||d.setVisible(!0);d=a[b];for(f=null;d;)d.isCollapsed()&&(f=d),
d=d.getSurroundParent();f&&f.setCollapsed(!0,!0);a[b].render()}};Blockscad.newProject=function(){0<Blockscad.undo.undoStack.length?!Blockscad.offline&&Blockscad.Auth.isLoggedIn?(console.log("autosaving"),Blockscad.Auth.saveBlocksToAccount(),Blockscad.clearProject()):$("#delete-confirm").modal("show"):Blockscad.clearProject();$("#displayBlocks").click()};
Blockscad.clearProject=function(){Blockscad.offline||(Blockscad.Auth.currentProject="",Blockscad.Auth.currentProjectKey="");Blockly.mainWorkspace.clear();gProcessor.clearViewer();for(Blockscad.workspaceChanged();Blockscad.undo.undoStack.length;)Blockscad.undo.undoStack.pop();for(;Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop();$("#project-name").val("Untitled");$("#projectView").hide();$("#editView").show()};
Blockscad.discard=function(){var a=Blockly.mainWorkspace.getAllBlocks().length;if(2>a||window.confirm("Delete all "+a+" blocks?"))Blockly.mainWorkspace.clear(),window.location.hash=""};Blockscad.resetView=function(){gProcessor&&gProcessor.viewer&&gProcessor.viewer.viewReset()};
Blockscad.mixes2and3D=function(){for(var a=[],a=Blockly.mainWorkspace.getTopBlocks(),b=0,d=0,f=0,k=0,h=0;h<a.length;h++)if(Blockscad.stackIsShape(a[h])){var k=1,n=a[h].category;"PRIMITIVE_CSG"==n&&b++;"PRIMITIVE_CAG"==n&&d++;if("TRANSFORM"==n||"SET_OP"==n){var l=a[h].getInput("A").connection.check_;1==l.length&&"CSG"==l[0]&&b++;1==l.length&&"CAG"==l[0]&&d++}"LOOP"==n&&(l=a[h].getInput("DO").connection.check_,1==l.length&&"CSG"==l[0]&&b++,1==l.length&&"CAG"==l[0]&&d++);"PROCEDURE"==n&&((l=a[h].myType_)&&
"CSG"==l&&b++,l&&"CAG"==l&&d++);"COLOR"==n&&b++;"EXTRUDE"==n&&b++;"controls_if"==a[h].type&&f++}!k||b+d+f||Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks());return[b&&d,k]};
Blockscad.doRender=function(){$("#error-message").text("");$("#error-message").removeClass("has-error");$("#renderButton").prop("disabled",!0);gProcessor.clearViewer();var a=Blockscad.mixes2and3D();if(0==a[1])$("#error-message").text("Error: Nothing to Render"),$("#error-message").addClass("has-error");else if(a[0])$("#error-message").text("Error: both 2D and 3D objects are present.  There can be only one."),$("#error-message").addClass("has-error");else{Blockscad.missingFields=[];var b=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace);
if(0<Blockscad.missingFields.length){for(a=0;a<Blockscad.missingFields.length;a++){var d=Blockly.mainWorkspace.getBlockById(Blockscad.missingFields[a]);d.unselect();d.backlight();if(d=d.collapsedParents())for(var f=0;f<d.length;f++)d[f].unselect(),d[f].backlight()}$("#error-message").text("ERROR: "+Blockscad.missingFields.length+" blocks have empty fields.");$("#error-message").addClass("has-error")}else{a=!0;try{$("#renderButton").html("working"),window.setTimeout(function(){b=openscadOpenJscadParser.parse(b)},
0)}catch(k){$("#error-message").text(k),$("#error-message").addClass("has-error"),a=!1}a?window.setTimeout(function(){gProcessor.setBlockscad(b)},0):$("#renderButton").html("Render")}}};
Blockscad.isRealChange=function(){Blockscad.undo.blockIds=[];Blockscad.undo.parentIds=[];Blockscad.undo.fieldValues=[];Blockscad.undo.isDisabled=[];for(var a=null,a=a=null,b=0;b<Blockscad.undo.blockList.length;b++)Blockscad.undo.fieldValues[b]=Blockscad.undo.blockList[b].getAllFieldValues(),Blockscad.undo.blockIds[b]=Blockscad.undo.blockList[b].id,Blockscad.undo.isDisabled[b]=Blockscad.undo.blockList[b].disabled,Blockscad.undo.blockList[b].getParent()?Blockscad.undo.parentIds[b]=Blockscad.undo.blockList[b].getParent().id:
Blockscad.undo.parentIds[b]=null,Blockscad.undo.blockList[b].category&&"UNKNOWN"==Blockscad.undo.blockList[b].category&&Blockscad.undo.blockList[b].getType();if(Blockscad.undo.blockCount>Blockscad.undo.blockList.length)return Blockscad.undo.fieldChanging=0,0!=Blockscad.undo.blockList.length&&(a=Blockscad.getExtraRootBlock(Blockscad.undo.oldBlockList,Blockscad.undo.blockList),(a=Blockscad.getBlockFromId(Blockscad.undo.oldParentIds[a],Blockscad.undo.blockList))&&Blockscad.assignBlockTypes([a])),!0;
if(Blockscad.undo.blockCount<Blockscad.undo.blockList.length)return Blockscad.undo.fieldChanging=0,0==Blockscad.undo.oldBlockList.length?Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks()):(a=Blockscad.getExtraRootBlock(Blockscad.undo.oldBlockList,Blockscad.undo.blockList),Blockscad.assignBlockTypes([Blockscad.undo.blockList[a]])),!0;for(b=0;b<Blockscad.undo.blockIds.length;b++){for(var d=Blockscad.undo.blockIds[b],f=0,a=0;a<Blockscad.undo.blockIds.length;a++)if(d==Blockscad.undo.oldBlockIds[a]){f=
1;if(Blockscad.undo.parentIds[b]!=Blockscad.undo.oldParentIds[a]){Blockscad.enableMathBlocks(Blockscad.undo.blockList[b]);Blockscad.assignBlockTypes([Blockscad.undo.blockList[b]]);for(b=0;d=Blockscad.undo.blockList[b];b++)if(d.id==Blockscad.undo.oldParentIds[a]){Blockscad.assignBlockTypes([Blockscad.undo.blockList[b]]);Blockscad.enableMathBlocks(Blockscad.undo.blockList[b]);break}return!0}if(Blockscad.undo.fieldValues[b]!=Blockscad.undo.oldFieldValues[a])return $("#renderButton").prop("disabled",
!1),Blockscad.undo.fieldChanging!=d?(Blockscad.undo.fieldChanging=d,!0):!1;if(Blockscad.undo.isDisabled[b]!=Blockscad.undo.oldDisabled[a])return!0}if(!f)return!0}return!1};
Blockscad.workspaceChanged=function(){Blockscad.undo.yesthis=0;Blockscad.undo.blockList=Blockly.mainWorkspace.getAllBlocks();Blockscad.undo.yesthis=Blockscad.isRealChange();Blockscad.undo.blockCount=Blockscad.undo.blockList.length;Blockscad.undo.oldBlockIds=Blockscad.undo.blockIds;Blockscad.undo.oldParentIds=Blockscad.undo.parentIds;Blockscad.undo.oldFieldValues=Blockscad.undo.fieldValues;Blockscad.undo.oldDisabled=Blockscad.undo.isDisabled;Blockscad.checkMathOrphans();if(Blockscad.undo.yesthis&&
($("#renderButton").prop("disabled",!1),Blockscad.undo.just_did_undo&&Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks()),0==Blockscad.undo.just_did_undo)){null!=Blockscad.undo.current_xml&&Blockscad.undo.undoStack.push(Blockscad.undo.current_xml);for(Blockscad.undo.current_xml=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());0<Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop();50<Blockscad.undo.undoStack.length&&Blockscad.undo.undoStack.shift()}Blockscad.undo.current_xml=
Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());Blockscad.undo.oldBlockList=[];for(var a=0;a<Blockscad.undo.blockList.length;a++)Blockscad.undo.oldBlockList.push(Blockly.Xml.blockToDom_(Blockscad.undo.blockList[a]));Blockscad.undo.just_did_undo=0;0<Blockscad.undo.undoStack.length?$("#undoButton").prop("disabled",!1):$("#undoButton").prop("disabled",!0);0<Blockscad.undo.redoStack.length?$("#redoButton").prop("disabled",!1):$("#redoButton").prop("disabled",!0)};
Blockscad.getExtraRootBlock=function(a,b){var d=0;if(a.length>b.length)for(var f=0;f<a.length;f++){for(var k=d=0;k<b.length;k++)if(a[f].getAttribute("id")==b[k].id){d=1;break}if(!d)return f}else for(f=0;f<b.length;f++){for(k=d=0;k<a.length;k++)if(b[f].id==a[k].getAttribute("id")){d=1;break}if(!d)return f}return 0};Blockscad.getBlockFromId=function(a,b){for(var d=0,f;f=b[d];d++)if(f.id==a)return f;return null};
Blockscad.onUndo=function(){0<Blockscad.undo.undoStack.length&&(Blockscad.undo.redoStack.push(Blockscad.undo.current_xml),Blockscad.undo.current_xml=Blockscad.undo.undoStack.pop(),Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),Blockscad.undo.current_xml),Blockly.mainWorkspace.render(),Blockscad.undo.just_did_undo=1)};
Blockscad.onRedo=function(){0<Blockscad.undo.redoStack.length&&(Blockscad.undo.undoStack.push(Blockscad.undo.current_xml),Blockscad.undo.current_xml=Blockscad.undo.redoStack.pop(),Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(Blockly.getMainWorkspace(),Blockscad.undo.current_xml),Blockly.mainWorkspace.render(),Blockscad.undo.just_did_undo=1)};
Blockscad.checkMathOrphans=function(){for(var a=[],a=Blockly.mainWorkspace.getTopBlocks(),b=0;b<a.length;b++)-1==a[b].type.lastIndexOf("math")&&-1==a[b].type.lastIndexOf("variables_get")&&-1==a[b].type.lastIndexOf("logic")||a[b].setDisabled(!0)};
Blockscad.enableMathBlocks=function(a){a=a.getDescendants();for(var b=0;b<a.length;b++)if(a[b].disabled&&(-1!=a[b].type.lastIndexOf("math")||-1!=a[b].type.lastIndexOf("variables_get")||-1!=a[b].type.lastIndexOf("logic"))){var d;if(d=a[b].getParent())d.disabled||a[b].setDisabled(!1)}};Blockscad.aCallerBlock=function(a,b){for(var d=0;d<b.length;d++)if(a==b[d])return!0;return!1};
Blockscad.findBlockType=function(a,b){for(var d=a.getRootBlock().getDescendants(),f=0,k=0,h=0;h<d.length;h++)if(!Blockscad.aCallerBlock(d[h],b)&&d[h].category){var n=d[h].category;if("PRIMITIVE_CSG"==n||"EXTRUDE"==n||"COLOR"==n){f=1;break}"PRIMITIVE_CAG"==n&&(k=1)}return f?Blockscad.hasExtrudeParent(a)?"CAG":"CSG":k?"CAG":"EITHER"};Blockscad.stackIsShape=function(a){a=a.getDescendants();for(var b=0;b<a.length;b++){var d=a[b];if(("PRIMITIVE_CSG"==d.category||"PRIMITIVE_CAG"==d.category)&&!d.hasDisabledParent())return!0}return!1};
Blockscad.assignBlockTypes=function(a){for(var b=0;b<a.length;b++){for(var d=a[b].getRootBlock().getDescendants(),f=0,k=0,h=0;h<d.length;h++)if(d[h].category){var n=d[h].category;if("PRIMITIVE_CSG"==n||"EXTRUDE"==n||"COLOR"==n){f=1;break}"PRIMITIVE_CAG"==n&&(k=1)}for(h=0;h<d.length;h++)!d[h].category||"TRANSFORM"!=d[h].category&&"SET_OP"!=d[h].category&&"PROCEDURE"!=d[h].category&&"LOOP"!=d[h].category||(n=!d[h].collapsedParents(),f?Blockscad.hasExtrudeParent(d[h])?d[h].setType("CAG",n):d[h].setType("CSG",
n):k?d[h].setType("CAG",n):d[h].setType(["CSG","CAG"],n))}};Blockscad.hasExtrudeParent=function(a){do{if("EXTRUDE"==a.category)return!0;a=a.parentBlock_}while(a);return!1};function putSourceInEditor(a,b){editor.setValue(a);editor.clearSelection();editor.navigateFileStart();previousFilename=b;previousScript=a;gPreviousModificationTime=""}
Blockscad.initLanguage=function(){var a=BSUtils.isRtl();document.head.parentElement.setAttribute("dir",a?"rtl":"ltr");document.head.parentElement.setAttribute("lang",BSUtils.LANG);var a=[],b;for(b in BSUtils.LANGUAGE_NAME)a.push([BSUtils.LANGUAGE_NAME[b],b]);a.sort(function(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:0});for(var d=document.getElementById("languageMenu"),f=d.options.length=0;f<a.length;f++){var k=a[f];b=k[k.length-1];k=new Option(k[0],b);b==BSUtils.LANG&&(k.selected=!0);d.options.add(k)}d.addEventListener("change",
BSUtils.changeLanguage,!0)};Blockscad.saveBlocksLocal=function(){var a=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),a=Blockly.Xml.domToText(a),a=new Blob([a],{type:"text/plain;charset=utf-8"}),b=$("#project-name").val();b?saveAs(a,b+".xml"):alert("SAVE FAILED.  Please give your project a name, then try again.")};var fileSaver={},saveAs=saveAs||"undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){if("undefined"===typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var b=a.document,d=a.URL||a.webkitURL||a,f=b.createElementNS("http://www.w3.org/1999/xhtml","a"),k=!a.externalHost&&"download"in f,h=a.webkitRequestFileSystem,n=a.requestFileSystem||h||a.mozRequestFileSystem,l=function(b){(a.setImmediate||a.setTimeout)(function(){throw b;},0)},
t=0,m=[],w=function(){for(var a=m.length;a--;){var b=m[a];"string"===typeof b?d.revokeObjectURL(b):b.remove()}m.length=0},q=function(a,b,d){b=[].concat(b);for(var f=b.length;f--;){var h=a["on"+b[f]];if("function"===typeof h)try{h.call(a,d||a)}catch(k){l(k)}}},v=function(d,l){var p=this,v=d.type,r=!1,A,e,w=function(){var c=(a.URL||a.webkitURL||a).createObjectURL(d);m.push(c);return c},z=function(){q(p,["writestart","progress","write","writeend"])},H=function(){if(r||!A)A=w(d);e?e.location.href=A:window.open(A,
"_blank");p.readyState=p.DONE;z()},g=function(c){return function(){if(p.readyState!==p.DONE)return c.apply(this,arguments)}},u={create:!0,exclusive:!1},c;p.readyState=p.INIT;l||(l="download");if(k)A=w(d),b=a.document,f=b.createElementNS("http://www.w3.org/1999/xhtml","a"),f.href=A,f.download=l,v=b.createEvent("MouseEvents"),v.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),f.dispatchEvent(v),p.readyState=p.DONE,z();else{a.chrome&&v&&"application/octet-stream"!==v&&(c=d.slice||d.webkitSlice,
d=c.call(d,0,d.size,"application/octet-stream"),r=!0);h&&"download"!==l&&(l+=".download");if("application/octet-stream"===v||h)e=a;n?(t+=d.size,n(a.TEMPORARY,t,g(function(c){c.root.getDirectory("saved",u,g(function(c){var a=function(){c.getFile(l,u,g(function(c){c.createWriter(g(function(g){g.onwriteend=function(g){e.location.href=c.toURL();m.push(c);p.readyState=p.DONE;q(p,"writeend",g)};g.onerror=function(){var c=g.error;c.code!==c.ABORT_ERR&&H()};["writestart","progress","write","abort"].forEach(function(c){g["on"+
c]=p["on"+c]});g.write(d);p.abort=function(){g.abort();p.readyState=p.DONE};p.readyState=p.WRITING}),H)}),H)};c.getFile(l,{create:!1},g(function(c){c.remove();a()}),g(function(c){c.code===c.NOT_FOUND_ERR?a():H()}))}),H)}),H)):H()}},z=v.prototype,p=function(a,b){return new v(a,b)};z.abort=function(){this.readyState=this.DONE;q(this,"abort")};z.readyState=z.INIT=0;z.WRITING=1;z.DONE=2;z.error=z.onwritestart=z.onprogress=z.onwrite=z.onabort=z.onerror=z.onwriteend=null;a.addEventListener("unload",w,!1);
p.unload=function(){w();a.removeEventListener("unload",w,!1)};return p}}("undefined"!==typeof self&&self||"undefined"!==typeof window&&window||this.content);"undefined"!==typeof module&&(module.exports=saveAs);var GL=function(){function a(g,a,c){c=c||{};this.id=e.createTexture();this.width=g;this.height=a;this.format=c.format||e.RGBA;this.type=c.type||e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,this.id);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,c.filter||c.magFilter||e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,c.filter||c.minFilter||e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,c.wrap||c.wrapS||e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,
e.TEXTURE_WRAP_T,c.wrap||c.wrapT||e.CLAMP_TO_EDGE);e.texImage2D(e.TEXTURE_2D,0,this.format,g,a,0,this.format,this.type,null)}function b(){this.unique=[];this.indices=[];this.map={}}function d(g,a){this.buffer=null;this.target=g;this.type=a;this.data=[]}function f(g){g=g||{};this.vertexBuffers={};this.indexBuffers={};this.addVertexBuffer("vertices","gl_Vertex");g.coords&&this.addVertexBuffer("coords","gl_TexCoord");g.normals&&this.addVertexBuffer("normals","gl_Normal");g.colors&&this.addVertexBuffer("colors",
"gl_Color");"triangles"in g&&!g.triangles||this.addIndexBuffer("triangles");g.lines&&this.addIndexBuffer("lines")}function k(g){return new h(2*(g&1)-1,(g&2)-1,(g&4)/2-1)}function h(g,a,c){this.x=g||0;this.y=a||0;this.z=c||0}function n(g,a,c){for(var b;null!==(b=g.exec(a));)c(b)}function l(g,a){function c(c){var g=document.getElementById(c);return g?g.text:c}function b(c,g){var a={},u=/^((\s*\/\/.*\n|\s*#extension.*\n)+)\^*$/.exec(g);g=u?u[1]+c+g.substr(u[1].length):c+g;n(/\bgl_\w+\b/g,c,function(c){c in
a||(g=g.replace(new RegExp("\\b"+c+"\\b","g"),"LIGHTGL"+c),a[c]=!0)});return g}function d(c,g){var a=e.createShader(c);e.shaderSource(a,g);e.compileShader(a);if(!e.getShaderParameter(a,e.COMPILE_STATUS))throw"compile error: "+e.getShaderInfoLog(a);return a}g=c(g);a=c(a);var f=g+a,h={};n(/\b(gl_[^;]*)\b;/g,"uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;",
function(c){c=c[1];if(-1!=f.indexOf(c)){var g=c.replace(/[a-z_]/g,"");h[g]="LIGHTGL"+c}});-1!=f.indexOf("ftransform")&&(h.MVPM="LIGHTGLgl_ModelViewProjectionMatrix");this.usedMatrices=h;g=b("uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;attribute vec4 gl_Vertex;attribute vec4 gl_TexCoord;attribute vec3 gl_Normal;attribute vec4 gl_Color;vec4 ftransform() {  return gl_ModelViewProjectionMatrix * gl_Vertex;}",
g);a=b("precision highp float;uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;",a);this.program=e.createProgram();e.attachShader(this.program,d(e.VERTEX_SHADER,g));e.attachShader(this.program,d(e.FRAGMENT_SHADER,a));e.linkProgram(this.program);if(!e.getProgramParameter(this.program,e.LINK_STATUS))throw"link error: "+
e.getProgramInfoLog(this.program);this.attributes={};this.uniformLocations={};var Q={};n(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,g+a,function(c){Q[c[2]]=1});this.isSampler=Q}function t(){e.MODELVIEW=S|1;e.PROJECTION=S|2;var g=new p,a=new p;e.modelviewMatrix=new p;e.projectionMatrix=new p;var c=[],b=[],d,f;e.matrixMode=function(g){switch(g){case e.MODELVIEW:d="modelviewMatrix";f=c;break;case e.PROJECTION:d="projectionMatrix";f=b;break;default:throw"invalid matrix mode "+g;}};e.loadIdentity=
function(){p.identity(e[d])};e.loadMatrix=function(c){c=c.m;for(var g=e[d].m,a=0;16>a;a++)g[a]=c[a]};e.multMatrix=function(c){e.loadMatrix(p.multiply(e[d],c,a))};e.perspective=function(c,a,u,b){e.multMatrix(p.perspective(c,a,u,b,g))};e.frustum=function(c,a,u,b,d,y){e.multMatrix(p.frustum(c,a,u,b,d,y,g))};e.ortho=function(c,a,u,b,d,y){e.multMatrix(p.ortho(c,a,u,b,d,y,g))};e.scale=function(c,a,u){e.multMatrix(p.scale(c,a,u,g))};e.translate=function(c,a,u){e.multMatrix(p.translate(c,a,u,g))};e.rotate=
function(c,a,u,b){e.multMatrix(p.rotate(c,a,u,b,g))};e.lookAt=function(c,a,u,b,d,y,f,h,B){e.multMatrix(p.lookAt(c,a,u,b,d,y,f,h,B,g))};e.pushMatrix=function(){f.push(Array.prototype.slice.call(e[d].m))};e.popMatrix=function(){var c=f.pop();e[d].m=H?new Float32Array(c):c};e.project=function(c,g,a,u,b,d){u=u||e.modelviewMatrix;b=b||e.projectionMatrix;d=d||e.getParameter(e.VIEWPORT);c=b.transformPoint(u.transformPoint(new h(c,g,a)));return new h(d[0]+d[2]*(.5*c.x+.5),d[1]+d[3]*(.5*c.y+.5),.5*c.z+.5)};
e.unProject=function(c,b,d,y,f,B){y=y||e.modelviewMatrix;f=f||e.projectionMatrix;B=B||e.getParameter(e.VIEWPORT);c=new h((c-B[0])/B[2]*2-1,(b-B[1])/B[3]*2-1,2*d-1);return p.inverse(p.multiply(f,y,g),a).transformPoint(c)};e.matrixMode(e.MODELVIEW)}function m(){var g=new f({coords:!0,colors:!0,triangles:!1}),a=-1,c=[0,0,0,0],b=[1,1,1,1],d=new l("uniform float pointSize;varying vec4 color;varying vec4 coord;void main() {color = gl_Color;coord = gl_TexCoord;gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;gl_PointSize = pointSize;}",
"uniform sampler2D texture;uniform float pointSize;uniform bool useTexture;varying vec4 color;varying vec4 coord;void main() {gl_FragColor = color;if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);}");e.pointSize=function(c){d.uniforms({pointSize:c})};e.begin=function(c){if(-1!=a)throw"mismatched gl.begin() and gl.end() calls";a=c;g.colors=[];g.coords=[];g.vertices=[]};e.color=function(c,g,a,u){b=1==arguments.length?c.toArray().concat(1):[c,g,a,u||1]};e.texCoord=function(g,a){c=1==arguments.length?
g.toArray(2):[g,a]};e.vertex=function(a,u,d){g.colors.push(b);g.coords.push(c);g.vertices.push(1==arguments.length?a.toArray():[a,u,d])};e.end=function(){if(-1==a)throw"mismatched gl.begin() and gl.end() calls";g.compile();d.uniforms({useTexture:!!e.getParameter(e.TEXTURE_BINDING_2D)}).draw(g,a);a=-1}}function w(){function g(){for(var c in F)if(t.call(F,c)&&F[c])return!0;return!1}function a(c){var u={},b;for(b in c)u[b]="function"==typeof c[b]?function(g){return function(){g.apply(c,arguments)}}(c[b]):
c[b];u.original=c;u.x=u.pageX;u.y=u.pageY;for(b=e.canvas;b;b=b.offsetParent)u.x-=b.offsetLeft,u.y-=b.offsetTop;p?(u.deltaX=u.x-r,u.deltaY=u.y-M):(u.deltaX=0,u.deltaY=0,p=!0);r=u.x;M=u.y;u.dragging=g();u.preventDefault=function(){u.original.preventDefault()};u.stopPropagation=function(){u.original.stopPropagation()};return u}function c(c){var g={},a;for(a in c)g[a]="function"==typeof c[a]?function(g){return function(){g.apply(c,arguments)}}(c[a]):c[a];g.original=c;if(0<g.targetTouches.length){a=g.targetTouches[0];
g.x=a.pageX;g.y=a.pageY;for(a=e.canvas;a;a=a.offsetParent)g.x-=a.offsetLeft,g.y-=a.offsetTop;p?(g.deltaX=g.x-r,g.deltaY=g.y-M):(g.deltaX=0,g.deltaY=0,p=!0);r=g.x;M=g.y;g.dragging=!0}g.preventDefault=function(){g.original.preventDefault()};g.stopPropagation=function(){g.original.stopPropagation()};return g}function b(c){e=m;c=a(c);if(e.onmousemove)e.onmousemove(c);c.preventDefault()}function d(c){e=m;F[c.which]=!1;g()||(document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",
d),e.canvas.addEventListener("mousemove",b),e.canvas.addEventListener("mouseup",d));c=a(c);if(e.onmouseup)e.onmouseup(c);c.preventDefault()}function f(c){e=m;c=a(c);if(e.onmousewheel)e.onmousewheel(c);c.preventDefault()}function h(g){e=m;0===g.targetTouches.length&&k(g);g=c(g);if(e.ontouchmove)e.ontouchmove(g);g.preventDefault()}function k(g){document.removeEventListener("touchmove",h);document.removeEventListener("touchend",k);e.canvas.addEventListener("touchmove",h);e.canvas.addEventListener("touchend",
k);e=m;g=c(g);if(e.ontouchend)e.ontouchend(g);g.preventDefault()}function n(){p=!1}function l(){F={};p=!1}var m=e,r=0,M=0,F={},p=!1,t=Object.prototype.hasOwnProperty;e.canvas.addEventListener("mousedown",function(c){e=m;g()||(document.addEventListener("mousemove",b),document.addEventListener("mouseup",d),e.canvas.removeEventListener("mousemove",b),e.canvas.removeEventListener("mouseup",d));F[c.which]=!0;c=a(c);if(e.onmousedown)e.onmousedown(c);c.preventDefault()});e.canvas.addEventListener("mousemove",
b);e.canvas.addEventListener("mouseup",d);e.canvas.addEventListener("mousewheel",f);e.canvas.addEventListener("DOMMouseScroll",f);e.canvas.addEventListener("mouseover",n);e.canvas.addEventListener("mouseout",n);e.canvas.addEventListener("touchstart",function(g){l();document.addEventListener("touchmove",h);document.addEventListener("touchend",k);e.canvas.removeEventListener("touchmove",h);e.canvas.removeEventListener("touchend",k);e=m;g=c(g);if(e.ontouchstart)e.ontouchstart(g);g.preventDefault()});
e.canvas.addEventListener("touchmove",h);e.canvas.addEventListener("touchend",k);document.addEventListener("contextmenu",l)}function q(g){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[g]||(65<=g&&90>=g?String.fromCharCode(g):null)}function v(g,a,c){g.addEventListener(a,c)}function z(){(function(g){e.makeCurrent=function(){e=g}})(e);e.animate=function(){function g(){e=b;var d=(new Date).getTime();if(e.onupdate)e.onupdate((d-c)/1E3);
if(e.ondraw)e.ondraw();a(g);c=d}var a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(c){setTimeout(c,1E3/60)},c=(new Date).getTime(),b=e;g()};e.fullscreen=function(g){function a(){e.canvas.width=window.innerWidth-b-d;e.canvas.height=window.innerHeight-c-f;e.viewport(0,0,e.canvas.width,e.canvas.height);!g.camera&&"camera"in g||(e.matrixMode(e.PROJECTION),e.loadIdentity(),e.perspective(g.fov||45,e.canvas.width/e.canvas.height,g.near||.1,g.far||
1E3),e.matrixMode(e.MODELVIEW));if(e.onresize)e.onresize();if(e.ondraw)e.ondraw()}g=g||{};var c=g.paddingTop||0,b=g.paddingLeft||0,d=g.paddingRight||0,f=g.paddingBottom||0;if(!document.body)throw"document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)";document.body.appendChild(e.canvas);document.body.style.overflow="hidden";e.canvas.style.position="absolute";e.canvas.style.left=b+"px";e.canvas.style.top=c+"px";window.addEventListener("resize",a);
a()}}function p(){var g=Array.prototype.concat.apply([],arguments);g.length||(g=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.m=H?new Float32Array(g):g}function C(g,a,c){this.t=arguments.length?g:Number.MAX_VALUE;this.hit=a;this.normal=c}function G(){var g=e.getParameter(e.VIEWPORT),a=e.modelviewMatrix.m,c=new h(a[0],a[4],a[8]),b=new h(a[1],a[5],a[9]),d=new h(a[2],a[6],a[10]),a=new h(a[3],a[7],a[11]);this.eye=new h(-a.dot(c),-a.dot(b),-a.dot(d));c=g[0];b=c+g[2];d=g[1];a=d+g[3];this.ray00=e.unProject(c,
d,1).subtract(this.eye);this.ray10=e.unProject(b,d,1).subtract(this.eye);this.ray01=e.unProject(c,a,1).subtract(this.eye);this.ray11=e.unProject(b,a,1).subtract(this.eye);this.viewport=g}var L,N,r;a.prototype={bind:function(g){e.activeTexture(e.TEXTURE0+(g||0));e.bindTexture(e.TEXTURE_2D,this.id)},unbind:function(g){e.activeTexture(e.TEXTURE0+(g||0));e.bindTexture(e.TEXTURE_2D,null)},drawTo:function(g,a){a=a||{};var c=e.getParameter(e.VIEWPORT);e.viewport(0,0,this.width,this.height);L=L||e.createFramebuffer();
e.bindFramebuffer(e.FRAMEBUFFER,L);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.id,0);if(!1!==a.depth){N=N||e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,N);if(this.width!=N.width||this.height!=N.height)N.width=this.width,N.height=this.height,e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,N)}g();e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,
null);e.viewport(c[0],c[1],c[2],c[3])},swapWith:function(g){var a;a=g.id;g.id=this.id;this.id=a;a=g.width;g.width=this.width;this.width=a;a=g.height;g.height=this.height;this.height=a}};a.fromImage=function(g,u){u=u||{};var c=new a(g.width,g.height,u);try{e.texImage2D(e.TEXTURE_2D,0,c.format,c.format,c.type,g)}catch(b){if("file:"==window.location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}u.minFilter&&u.minFilter!=e.NEAREST&&u.minFilter!=e.LINEAR&&e.generateMipmap(e.TEXTURE_2D);return c};a.fromURL=function(g,u){r=r||function(){var c=document.createElement("canvas").getContext("2d");c.canvas.width=c.canvas.height=128;for(var g=0;g<c.canvas.height;g+=16)for(var a=0;a<c.canvas.width;a+=16)c.fillStyle=(a^g)&16?"#FFF":"#DDD",c.fillRect(a,g,16,16);return c.canvas}();var c=a.fromImage(r,u),b=new Image,d=e;b.onload=function(){d.makeCurrent();a.fromImage(b,u).swapWith(c)};b.src=g;return c};
b.prototype={add:function(g){var a=JSON.stringify(g);a in this.map||(this.map[a]=this.unique.length,this.unique.push(g));return this.map[a]}};d.prototype={compile:function(g){for(var a=[],c=0;c<this.data.length;c+=1E4)a=Array.prototype.concat.apply(a,this.data.slice(c,c+1E4));c=this.data.length?a.length/this.data.length:0;if(c!=Math.round(c))throw"buffer elements not of consistent size, average size is "+c;this.buffer=this.buffer||e.createBuffer();this.buffer.length=a.length;this.buffer.spacing=c;
e.bindBuffer(this.target,this.buffer);e.bufferData(this.target,new this.type(a),g||e.STATIC_DRAW)}};f.prototype={addVertexBuffer:function(g,a){(this.vertexBuffers[a]=new d(e.ARRAY_BUFFER,Float32Array)).name=g;this[g]=[]},addIndexBuffer:function(g){this.indexBuffers[g]=new d(e.ELEMENT_ARRAY_BUFFER,Uint16Array);this[g]=[]},compile:function(){for(var g in this.vertexBuffers){var a=this.vertexBuffers[g];a.data=this[a.name];a.compile()}for(var c in this.indexBuffers)a=this.indexBuffers[c],a.data=this[c],
a.compile()},transform:function(g){this.vertices=this.vertices.map(function(c){return g.transformPoint(h.fromArray(c)).toArray()});if(this.normals){var a=g.inverse().transpose();this.normals=this.normals.map(function(c){return a.transformVector(h.fromArray(c)).unit().toArray()})}this.compile();return this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var g=0;g<this.vertices.length;g++)this.normals[g]=new h;for(g=0;g<this.triangles.length;g++){var a=this.triangles[g],
c=h.fromArray(this.vertices[a[0]]),b=h.fromArray(this.vertices[a[1]]),d=h.fromArray(this.vertices[a[2]]),c=b.subtract(c).cross(d.subtract(c)).unit();this.normals[a[0]]=this.normals[a[0]].add(c);this.normals[a[1]]=this.normals[a[1]].add(c);this.normals[a[2]]=this.normals[a[2]].add(c)}for(g=0;g<this.vertices.length;g++)this.normals[g]=this.normals[g].unit().toArray();this.compile();return this},computeWireframe:function(){for(var a=new b,u=0;u<this.triangles.length;u++)for(var c=this.triangles[u],d=
0;d<c.length;d++){var e=c[d],f=c[(d+1)%c.length];a.add([Math.min(e,f),Math.max(e,f)])}this.lines||this.addIndexBuffer("lines");this.lines=a.unique;this.compile();return this},getAABB:function(){var a={min:new h(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};a.max=a.min.negative();for(var b=0;b<this.vertices.length;b++){var c=h.fromArray(this.vertices[b]);a.min=h.min(a.min,c);a.max=h.max(a.max,c)}return a},getBoundingSphere:function(){for(var a=this.getAABB(),a={center:a.min.add(a.max).divide(2),
radius:0},b=0;b<this.vertices.length;b++)a.radius=Math.max(a.radius,h.fromArray(this.vertices[b]).subtract(a.center).length());return a}};f.plane=function(a){a=a||{};var b=new f(a),c=a.detailX||a.detail||1;a=a.detailY||a.detail||1;for(var d=0;d<=a;d++)for(var e=d/a,h=0;h<=c;h++){var k=h/c;b.vertices.push([2*k-1,2*e-1,0]);b.coords&&b.coords.push([k,e]);b.normals&&b.normals.push([0,0,1]);h<c&&d<a&&(k=h+d*(c+1),b.triangles.push([k,k+1,k+c+1]),b.triangles.push([k+c+1,k+1,k+c+2]))}b.compile();return b};
var A=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];f.cube=function(a){a=new f(a);for(var b=0;b<A.length;b++){for(var c=A[b],d=4*b,e=0;4>e;e++)a.vertices.push(k(c[e]).toArray()),a.coords&&a.coords.push([e&1,(e&2)/2]),a.normals&&a.normals.push(c.slice(4,7));a.triangles.push([d,d+1,d+2]);a.triangles.push([d+2,d+1,d+3])}a.compile();return a};f.sphere=function(a){function d(a,c,g){return l?[a,g,c]:[a,c,g]}a=a||{};var c=new f(a),e=new b;a=a.detail||
6;for(var B=0;8>B;B++)for(var n=k(B),l=0<n.x*n.y*n.z,m=[],r=0;r<=a;r++){for(var p=0;r+p<=a;p++){var K=r/a,t=p/a,M=(a-r-p)/a,t={vertex:(new h(K+(K-K*K)/2,t+(t-t*t)/2,M+(M-M*M)/2)).unit().multiply(n).toArray()};c.coords&&(t.coord=0<n.y?[1-K,M]:[M,1-K]);m.push(e.add(t))}if(0<r)for(p=0;r+p<=a;p++)K=(r-1)*(a+1)+(r-1-(r-1)*(r-1))/2+p,t=r*(a+1)+(r-r*r)/2+p,c.triangles.push(d(m[K],m[K+1],m[t])),r+p<a&&c.triangles.push(d(m[t],m[K+1],m[t+1]))}c.vertices=e.unique.map(function(a){return a.vertex});c.coords&&
(c.coords=e.unique.map(function(a){return a.coord}));c.normals&&(c.normals=c.vertices);c.compile();return c};f.load=function(a,b){b=b||{};"coords"in b||(b.coords=!!a.coords);"normals"in b||(b.normals=!!a.normals);"colors"in b||(b.colors=!!a.colors);"triangles"in b||(b.triangles=!!a.triangles);"lines"in b||(b.lines=!!a.lines);var c=new f(b);c.vertices=a.vertices;c.coords&&(c.coords=a.coords);c.normals&&(c.normals=a.normals);c.colors&&(c.colors=a.colors);c.triangles&&(c.triangles=a.triangles);c.lines&&
(c.lines=a.lines);c.compile();return c};h.prototype={negative:function(){return new h(-this.x,-this.y,-this.z)},add:function(a){return a instanceof h?new h(this.x+a.x,this.y+a.y,this.z+a.z):new h(this.x+a,this.y+a,this.z+a)},subtract:function(a){return a instanceof h?new h(this.x-a.x,this.y-a.y,this.z-a.z):new h(this.x-a,this.y-a,this.z-a)},multiply:function(a){return a instanceof h?new h(this.x*a.x,this.y*a.y,this.z*a.z):new h(this.x*a,this.y*a,this.z*a)},divide:function(a){return a instanceof h?
new h(this.x/a.x,this.y/a.y,this.z/a.z):new h(this.x/a,this.y/a,this.z/a)},equals:function(a){return this.x==a.x&&this.y==a.y&&this.z==a.z},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a){return new h(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,
this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(a){return[this.x,this.y,this.z].slice(0,a||3)},clone:function(){return new h(this.x,this.y,this.z)},init:function(a,b,c){this.x=a;this.y=b;this.z=c;return this}};h.negative=function(a,b){b.x=-a.x;b.y=-a.y;b.z=-a.z;return b};h.add=function(a,b,c){b instanceof h?(c.x=a.x+b.x,c.y=a.y+b.y,c.z=a.z+b.z):(c.x=a.x+b,c.y=a.y+b,c.z=a.z+b);return c};h.subtract=function(a,b,c){b instanceof
h?(c.x=a.x-b.x,c.y=a.y-b.y,c.z=a.z-b.z):(c.x=a.x-b,c.y=a.y-b,c.z=a.z-b);return c};h.multiply=function(a,b,c){b instanceof h?(c.x=a.x*b.x,c.y=a.y*b.y,c.z=a.z*b.z):(c.x=a.x*b,c.y=a.y*b,c.z=a.z*b);return c};h.divide=function(a,b,c){b instanceof h?(c.x=a.x/b.x,c.y=a.y/b.y,c.z=a.z/b.z):(c.x=a.x/b,c.y=a.y/b,c.z=a.z/b);return c};h.cross=function(a,b,c){c.x=a.y*b.z-a.z*b.y;c.y=a.z*b.x-a.x*b.z;c.z=a.x*b.y-a.y*b.x;return c};h.unit=function(a,b){var c=a.length();b.x=a.x/c;b.y=a.y/c;b.z=a.z/c;return b};h.fromAngles=
function(a,b){return new h(Math.cos(a)*Math.cos(b),Math.sin(b),Math.sin(a)*Math.cos(b))};h.randomDirection=function(){return h.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))};h.min=function(a,b){return new h(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.min(a.z,b.z))};h.max=function(a,b){return new h(Math.max(a.x,b.x),Math.max(a.y,b.y),Math.max(a.z,b.z))};h.lerp=function(a,b,c){return b.subtract(a).multiply(c).add(a)};h.fromArray=function(a){return new h(a[0],a[1],a[2])};l.prototype=
{uniforms:function(a){e.useProgram(this.program);for(var b in a){var c=this.uniformLocations[b]||e.getUniformLocation(this.program,b);if(c){this.uniformLocations[b]=c;var d=a[b];d instanceof h?d=[d.x,d.y,d.z]:d instanceof p&&(d=d.m);var f=Object.prototype.toString.call(d);if("[object Array]"==f||"[object Float32Array]"==f)switch(d.length){case 1:e.uniform1fv(c,new Float32Array(d));break;case 2:e.uniform2fv(c,new Float32Array(d));break;case 3:e.uniform3fv(c,new Float32Array(d));break;case 4:e.uniform4fv(c,
new Float32Array(d));break;case 9:e.uniformMatrix3fv(c,!1,new Float32Array([d[0],d[3],d[6],d[1],d[4],d[7],d[2],d[5],d[8]]));break;case 16:e.uniformMatrix4fv(c,!1,new Float32Array([d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15]]));break;default:throw"don't know how to load uniform \""+b+'" of length '+d.length;}else if(f=Object.prototype.toString.call(d),"[object Number]"==f||"[object Boolean]"==f)(this.isSampler[b]?e.uniform1i:e.uniform1f).call(e,c,d);else throw'attempted to set uniform "'+
b+'" to invalid value '+d;}}return this},draw:function(a,b){this.drawBuffers(a.vertexBuffers,a.indexBuffers[b==e.LINES?"lines":"triangles"],2>arguments.length?e.TRIANGLES:b)},drawBuffers:function(a,b,c){var d=this.usedMatrices,f=e.modelviewMatrix,h=e.projectionMatrix,k=d.MVMI||d.NM?f.inverse():null,n=d.PMI?h.inverse():null,r=d.MVPM||d.MVPMI?h.multiply(f):null,l={};d.MVM&&(l[d.MVM]=f);d.MVMI&&(l[d.MVMI]=k);d.PM&&(l[d.PM]=h);d.PMI&&(l[d.PMI]=n);d.MVPM&&(l[d.MVPM]=r);d.MVPMI&&(l[d.MVPMI]=r.inverse());
d.NM&&(f=k.m,l[d.NM]=[f[0],f[4],f[8],f[1],f[5],f[9],f[2],f[6],f[10]]);this.uniforms(l);var d=0,m;for(m in a)l=a[m],f=this.attributes[m]||e.getAttribLocation(this.program,m.replace(/^(gl_.*)$/,"LIGHTGL$1")),-1!=f&&l.buffer&&(this.attributes[m]=f,e.bindBuffer(e.ARRAY_BUFFER,l.buffer),e.enableVertexAttribArray(f),e.vertexAttribPointer(f,l.buffer.spacing,e.FLOAT,!1,0,0),d=l.buffer.length/l.buffer.spacing);for(m in this.attributes)m in a||e.disableVertexAttribArray(this.attributes[m]);!d||b&&!b.buffer||
(b?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,b.buffer),e.drawElements(c,b.buffer.length,e.UNSIGNED_SHORT,0)):e.drawArrays(c,0,d));return this}};l.fromURL=function(a,b){var c=function(a){var c=new XMLHttpRequest;c.open("GET",a,!1);c.send(null);if(200!==c.status)throw"could not load "+a;return c.responseText},d=c(a),c=c(b);return new l(d,c)};l.from=function(a,b){try{return new l(a,b)}catch(c){return l.fromURL(a,b)}};var e,x={create:function(a){a=a||{};var b=a.canvas;b||(b=document.createElement("canvas"),
b.width=a.width||800,b.height=a.height||600);"alpha"in a||(a.alpha=!1);try{e=b.getContext("webgl",a)}catch(c){}try{e=e||b.getContext("experimental-webgl",a)}catch(d){}if(!e)throw"WebGL not supported";t();m();w();z();return e},keys:{},Matrix:p,Indexer:b,Buffer:d,Mesh:f,HitTest:C,Raytracer:G,Shader:l,Texture:a,Vector:h};v(document,"keydown",function(a){if(!a.altKey&&!a.ctrlKey&&!a.metaKey){var b=q(a.keyCode);b&&(x.keys[b]=!0);x.keys[a.keyCode]=!0}});v(document,"keyup",function(a){if(!a.altKey&&!a.ctrlKey&&
!a.metaKey){var b=q(a.keyCode);b&&(x.keys[b]=!1);x.keys[a.keyCode]=!1}});var S=305397760,H="undefined"!=typeof Float32Array;p.prototype={inverse:function(){return p.inverse(this,new p)},transpose:function(){return p.transpose(this,new p)},multiply:function(a){return p.multiply(this,a,new p)},transformPoint:function(a){var b=this.m;return(new h(b[0]*a.x+b[1]*a.y+b[2]*a.z+b[3],b[4]*a.x+b[5]*a.y+b[6]*a.z+b[7],b[8]*a.x+b[9]*a.y+b[10]*a.z+b[11])).divide(b[12]*a.x+b[13]*a.y+b[14]*a.z+b[15])},transformVector:function(a){var b=
this.m;return new h(b[0]*a.x+b[1]*a.y+b[2]*a.z,b[4]*a.x+b[5]*a.y+b[6]*a.z,b[8]*a.x+b[9]*a.y+b[10]*a.z)}};p.inverse=function(a,b){b=b||new p;var c=a.m,d=b.m;d[0]=c[5]*c[10]*c[15]-c[5]*c[14]*c[11]-c[6]*c[9]*c[15]+c[6]*c[13]*c[11]+c[7]*c[9]*c[14]-c[7]*c[13]*c[10];d[1]=-c[1]*c[10]*c[15]+c[1]*c[14]*c[11]+c[2]*c[9]*c[15]-c[2]*c[13]*c[11]-c[3]*c[9]*c[14]+c[3]*c[13]*c[10];d[2]=c[1]*c[6]*c[15]-c[1]*c[14]*c[7]-c[2]*c[5]*c[15]+c[2]*c[13]*c[7]+c[3]*c[5]*c[14]-c[3]*c[13]*c[6];d[3]=-c[1]*c[6]*c[11]+c[1]*c[10]*
c[7]+c[2]*c[5]*c[11]-c[2]*c[9]*c[7]-c[3]*c[5]*c[10]+c[3]*c[9]*c[6];d[4]=-c[4]*c[10]*c[15]+c[4]*c[14]*c[11]+c[6]*c[8]*c[15]-c[6]*c[12]*c[11]-c[7]*c[8]*c[14]+c[7]*c[12]*c[10];d[5]=c[0]*c[10]*c[15]-c[0]*c[14]*c[11]-c[2]*c[8]*c[15]+c[2]*c[12]*c[11]+c[3]*c[8]*c[14]-c[3]*c[12]*c[10];d[6]=-c[0]*c[6]*c[15]+c[0]*c[14]*c[7]+c[2]*c[4]*c[15]-c[2]*c[12]*c[7]-c[3]*c[4]*c[14]+c[3]*c[12]*c[6];d[7]=c[0]*c[6]*c[11]-c[0]*c[10]*c[7]-c[2]*c[4]*c[11]+c[2]*c[8]*c[7]+c[3]*c[4]*c[10]-c[3]*c[8]*c[6];d[8]=c[4]*c[9]*c[15]-c[4]*
c[13]*c[11]-c[5]*c[8]*c[15]+c[5]*c[12]*c[11]+c[7]*c[8]*c[13]-c[7]*c[12]*c[9];d[9]=-c[0]*c[9]*c[15]+c[0]*c[13]*c[11]+c[1]*c[8]*c[15]-c[1]*c[12]*c[11]-c[3]*c[8]*c[13]+c[3]*c[12]*c[9];d[10]=c[0]*c[5]*c[15]-c[0]*c[13]*c[7]-c[1]*c[4]*c[15]+c[1]*c[12]*c[7]+c[3]*c[4]*c[13]-c[3]*c[12]*c[5];d[11]=-c[0]*c[5]*c[11]+c[0]*c[9]*c[7]+c[1]*c[4]*c[11]-c[1]*c[8]*c[7]-c[3]*c[4]*c[9]+c[3]*c[8]*c[5];d[12]=-c[4]*c[9]*c[14]+c[4]*c[13]*c[10]+c[5]*c[8]*c[14]-c[5]*c[12]*c[10]-c[6]*c[8]*c[13]+c[6]*c[12]*c[9];d[13]=c[0]*c[9]*
c[14]-c[0]*c[13]*c[10]-c[1]*c[8]*c[14]+c[1]*c[12]*c[10]+c[2]*c[8]*c[13]-c[2]*c[12]*c[9];d[14]=-c[0]*c[5]*c[14]+c[0]*c[13]*c[6]+c[1]*c[4]*c[14]-c[1]*c[12]*c[6]-c[2]*c[4]*c[13]+c[2]*c[12]*c[5];d[15]=c[0]*c[5]*c[10]-c[0]*c[9]*c[6]-c[1]*c[4]*c[10]+c[1]*c[8]*c[6]+c[2]*c[4]*c[9]-c[2]*c[8]*c[5];for(var c=c[0]*d[0]+c[1]*d[4]+c[2]*d[8]+c[3]*d[12],e=0;16>e;e++)d[e]/=c;return b};p.transpose=function(a,b){b=b||new p;var c=a.m,d=b.m;d[0]=c[0];d[1]=c[4];d[2]=c[8];d[3]=c[12];d[4]=c[1];d[5]=c[5];d[6]=c[9];d[7]=c[13];
d[8]=c[2];d[9]=c[6];d[10]=c[10];d[11]=c[14];d[12]=c[3];d[13]=c[7];d[14]=c[11];d[15]=c[15];return b};p.multiply=function(a,b,c){c=c||new p;a=a.m;b=b.m;var d=c.m;d[0]=a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12];d[1]=a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13];d[2]=a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14];d[3]=a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15];d[4]=a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12];d[5]=a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13];d[6]=a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14];d[7]=a[4]*b[3]+a[5]*
b[7]+a[6]*b[11]+a[7]*b[15];d[8]=a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12];d[9]=a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13];d[10]=a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14];d[11]=a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15];d[12]=a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12];d[13]=a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13];d[14]=a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14];d[15]=a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15];return c};p.identity=function(a){a=a||new p;var b=a.m;b[0]=b[5]=b[10]=b[15]=
1;b[1]=b[2]=b[3]=b[4]=b[6]=b[7]=b[8]=b[9]=b[11]=b[12]=b[13]=b[14]=0;return a};p.perspective=function(a,b,c,d,e){a=Math.tan(a*Math.PI/360)*c;b*=a;return p.frustum(-b,b,-a,a,c,d,e)};p.frustum=function(a,b,c,d,e,f,h){h=h||new p;var k=h.m;k[0]=2*e/(b-a);k[1]=0;k[2]=(b+a)/(b-a);k[3]=0;k[4]=0;k[5]=2*e/(d-c);k[6]=(d+c)/(d-c);k[7]=0;k[8]=0;k[9]=0;k[10]=-(f+e)/(f-e);k[11]=-2*f*e/(f-e);k[12]=0;k[13]=0;k[14]=-1;k[15]=0;return h};p.ortho=function(a,b,c,d,e,f,h){h=h||new p;var k=h.m;k[0]=2/(b-a);k[1]=0;k[2]=0;
k[3]=-(b+a)/(b-a);k[4]=0;k[5]=2/(d-c);k[6]=0;k[7]=-(d+c)/(d-c);k[8]=0;k[9]=0;k[10]=-2/(f-e);k[11]=-(f+e)/(f-e);k[12]=0;k[13]=0;k[14]=0;k[15]=1;return h};p.scale=function(a,b,c,d){d=d||new p;var e=d.m;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=c;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return d};p.translate=function(a,b,c,d){d=d||new p;var e=d.m;e[0]=1;e[1]=0;e[2]=0;e[3]=a;e[4]=0;e[5]=1;e[6]=0;e[7]=b;e[8]=0;e[9]=0;e[10]=1;e[11]=c;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return d};
p.rotate=function(a,b,c,d,e){if(!a||!b&&!c&&!d)return p.identity(e);e=e||new p;var f=e.m,h=Math.sqrt(b*b+c*c+d*d);a*=Math.PI/180;b/=h;c/=h;d/=h;h=Math.cos(a);a=Math.sin(a);var k=1-h;f[0]=b*b*k+h;f[1]=b*c*k-d*a;f[2]=b*d*k+c*a;f[3]=0;f[4]=c*b*k+d*a;f[5]=c*c*k+h;f[6]=c*d*k-b*a;f[7]=0;f[8]=d*b*k-c*a;f[9]=d*c*k+b*a;f[10]=d*d*k+h;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return e};p.lookAt=function(a,b,c,d,e,f,k,l,n,m){m=m||new p;var r=m.m;a=new h(a,b,c);d=new h(d,e,f);l=new h(k,l,n);k=a.subtract(d).unit();
l=l.cross(k).unit();n=k.cross(l).unit();r[0]=l.x;r[1]=l.y;r[2]=l.z;r[3]=-l.dot(a);r[4]=n.x;r[5]=n.y;r[6]=n.z;r[7]=-n.dot(a);r[8]=k.x;r[9]=k.y;r[10]=k.z;r[11]=-k.dot(a);r[12]=0;r[13]=0;r[14]=0;r[15]=1;return m};C.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};G.prototype={getRayForPixel:function(a,b){a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];var c=h.lerp(this.ray00,this.ray10,a),d=h.lerp(this.ray01,this.ray11,
a);return h.lerp(c,d,b).unit()}};G.hitTestBox=function(a,b,c,d){var e=c.subtract(a).divide(b),f=d.subtract(a).divide(b),k=h.min(e,f),e=h.max(e,f),k=k.max(),e=e.min();return 0<k&&k<e?(a=a.add(b.multiply(k)),c=c.add(1E-6),d=d.subtract(1E-6),new C(k,a,new h((a.x>d.x)-(a.x<c.x),(a.y>d.y)-(a.y<c.y),(a.z>d.z)-(a.z<c.z)))):null};G.hitTestSphere=function(a,b,c,d){var e=a.subtract(c),f=b.dot(b),h=2*b.dot(e),e=e.dot(e)-d*d,e=h*h-4*f*e;return 0<e?(f=(-h-Math.sqrt(e))/(2*f),a=a.add(b.multiply(f)),new C(f,a,a.subtract(c).divide(d))):
null};G.hitTestTriangle=function(a,b,c,d,e){var f=d.subtract(c),h=e.subtract(c);e=f.cross(h).unit();d=e.dot(c.subtract(a))/e.dot(b);if(0<d){a=a.add(b.multiply(d));var k=a.subtract(c);c=h.dot(h);b=h.dot(f);var h=h.dot(k),l=f.dot(f),f=f.dot(k),k=c*l-b*b,l=(l*h-b*f)/k,f=(c*f-b*h)/k;if(0<=l&&0<=f&&1>=l+f)return new C(d,a,e)}return null};return x}();Blockscad=Blockscad||{};Blockscad.Toolbox={};Blockscad.Toolbox.cat_3D='<category name="3D Shapes"><block type="sphere"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cylinder"><value name="RAD1"><block type="math_number"><field name="NUM">10</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">10</field></block></value><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cube"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">10</field></block></value></block></category>';
Blockscad.Toolbox.cat2D='<category name="2D Shapes"><block type="circle"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="square"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value></block></category>';Blockscad.Toolbox.catTransform='<category name="Transforms"><block type="translate"><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="simplerotate"><value name="XVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_angle"><field name="NUM">0</field></block></value></block><block type="simplemirror_new"></block><block type="scale"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="color"><value name="COLOR"><block type="colour_picker"><field name="COLOUR">#ffcc00</field></block></value></block><block type="$fn"><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value></block><block type="linearextrude"><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value><value name="TWIST"><block type="math_angle"><field name="NUM">0</field></block></value></block><block type="rotateextrude"><value name="FACES"><block type="math_number"><field name="NUM">5</field></block></value></block></category>';
Blockscad.Toolbox.catSetOps='<category name="Set Ops"><block type="union"></block><block type="difference"></block><block type="intersection"></block><block type="hull"></block></category>';Blockscad.Toolbox.catMathLogic='<category name="Math"><block type="math_number"></block><block type="math_angle"></block><block type="math_arithmetic"></block><block type="math_single"></block><block type="math_trig"></block><block type="math_constant_bs"></block><block type="math_number_property"></block><block type="math_round"></block><block type="math_modulo"></block><block type="math_constrain"><value name="LOW"><block type="math_number"><field name="NUM">1</field></block></value><value name="HIGH"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="math_random_int"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block></value><value name="TO"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="math_random_float"></block></category><category name="Logic"><block type="controls_if"></block><block type="logic_compare"></block><block type="logic_operation"></block><block type="logic_negate"></block><block type="logic_boolean"></block><block type="logic_ternary"></block></category>';
Blockscad.Toolbox.catLoops='<category name="Loops"><block type="controls_for"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block> </value><value name="TO"><block type="math_number"><field name="NUM">10</field></block></value><value name="BY"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="controls_for_chainhull"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block> </value><value name="TO"><block type="math_number"><field name="NUM">10</field></block></value><value name="BY"><block type="math_number"><field name="NUM">1</field></block></value></block></category>';
Blockscad.Toolbox.catOther='<category name="Advanced"><block type="torus"><value name="RAD1"><block type="math_number"><field name="NUM">4</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">1</field></block></value><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value><value name="FACES"><block type="math_number"><field name="NUM">3</field></block></value></block><block type="rotateextrudetwist"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value><value name="FACES"><block type="math_number"><field name="NUM">5</field></block></value><value name="TWIST"><block type="math_number"><field name="NUM">360</field></block></value><value name="TSTEPS"><block type="math_number"><field name="NUM">180</field></block></value></block><block type="fancyrotate"><value name="AVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="fancymirror"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="stl_import"></block></category><category name="Variables" custom="VARIABLE"></category><category name="Modules" custom="PROCEDURE"></category></xml>';
Blockscad.Toolbox.other='<xml id="toolbox" style="display: none">';Blockscad.Toolbox.other+=Blockscad.Toolbox.cat_3D;Blockscad.Toolbox.other+=Blockscad.Toolbox.cat2D;Blockscad.Toolbox.other+=Blockscad.Toolbox.catTransform;Blockscad.Toolbox.other+=Blockscad.Toolbox.catSetOps;Blockscad.Toolbox.other+=Blockscad.Toolbox.catMathLogic;Blockscad.Toolbox.other+=Blockscad.Toolbox.catLoops;Blockscad.Toolbox.other+=Blockscad.Toolbox.catOther;(function(a){var b,d,f=null,k,h,n,l,t,m,w,q,v,z,p,C,G,L,N,r=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],A=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],e=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],x=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],H=[16,17,18,0,8,7,9,6,
10,5,11,4,12,3,13,2,14,1,15],g=function(){this.list=this.next=null},u=function(){this.n=this.b=this.e=0;this.t=null},c=function(a,b,c,d,e,f){this.BMAX=16;this.N_MAX=288;this.status=0;this.root=null;this.m=0;var h=Array(this.BMAX+1),k,l,r,n,m,p,t,q=Array(this.BMAX+1),A,v,w,x=new u,z=Array(this.BMAX);n=Array(this.N_MAX);var y,B=Array(this.BMAX+1),C,D,G;G=this.root=null;for(m=0;m<h.length;m++)h[m]=0;for(m=0;m<q.length;m++)q[m]=0;for(m=0;m<z.length;m++)z[m]=null;for(m=0;m<n.length;m++)n[m]=0;for(m=0;m<
B.length;m++)B[m]=0;k=256<b?a[256]:this.BMAX;A=a;v=0;m=b;do h[A[v]]++,v++;while(0<--m);if(h[0]==b)this.root=null,this.status=this.m=0;else{for(p=1;p<=this.BMAX&&0==h[p];p++);t=p;f<p&&(f=p);for(m=this.BMAX;0!=m&&0==h[m];m--);r=m;f>m&&(f=m);for(C=1<<p;p<m;p++,C<<=1)if(0>(C-=h[p])){this.status=2;this.m=f;return}if(0>(C-=h[m]))this.status=2,this.m=f;else{h[m]+=C;B[1]=p=0;A=h;v=1;for(w=2;0<--m;)B[w++]=p+=A[v++];A=a;m=v=0;do 0!=(p=A[v++])&&(n[B[p]++]=m);while(++m<b);b=B[r];B[0]=m=0;A=n;v=0;n=-1;y=q[0]=
0;w=null;for(D=0;t<=r;t++)for(a=h[t];0<a--;){for(;t>y+q[1+n];){y+=q[1+n];n++;D=(D=r-y)>f?f:D;if((l=1<<(p=t-y))>a+1)for(l-=a+1,w=t;++p<D&&!((l<<=1)<=h[++w]);)l-=h[w];y+p>k&&y<k&&(p=k-y);D=1<<p;q[1+n]=p;w=Array(D);for(l=0;l<D;l++)w[l]=new u;G=null==G?this.root=new g:G.next=new g;G.next=null;G.list=w;z[n]=w;0<n&&(B[n]=m,x.b=q[n],x.e=16+p,x.t=w,p=(m&(1<<y)-1)>>y-q[n],z[n-1][p].e=x.e,z[n-1][p].b=x.b,z[n-1][p].n=x.n,z[n-1][p].t=x.t)}x.b=t-y;v>=b?x.e=99:A[v]<c?(x.e=256>A[v]?16:15,x.n=A[v++]):(x.e=e[A[v]-
c],x.n=d[A[v++]-c]);l=1<<t-y;for(p=m>>y;p<D;p+=l)w[p].e=x.e,w[p].b=x.b,w[p].n=x.n,w[p].t=x.t;for(p=1<<t-1;0!=(m&p);p>>=1)m^=p;for(m^=p;(m&(1<<y)-1)!=B[n];)y-=q[n],n--}this.m=q[1];this.status=0!=C&&1!=r?1:0}}},y=function(a){for(;t<a;){var b=l,c;c=L.length==N?-1:L.charCodeAt(N++)&255;l=b|c<<t;t+=8}},B=function(a){return l&r[a]},D=function(a){l>>=a;t-=a},P=function(a,c,e){var f,g,h;if(0==e)return 0;for(h=0;;){y(C);g=z.list[B(C)];for(f=g.e;16<f;){if(99==f)return-1;D(g.b);f-=16;y(f);g=g.t[B(f)];f=g.e}D(g.b);
if(16==f)d&=32767,a[c+h++]=b[d++]=g.n;else{if(15==f)break;y(f);q=g.n+B(f);D(f);y(G);g=p.list[B(G)];for(f=g.e;16<f;){if(99==f)return-1;D(g.b);f-=16;y(f);g=g.t[B(f)];f=g.e}D(g.b);y(f);v=d-g.n-B(f);for(D(f);0<q&&h<e;)q--,v&=32767,d&=32767,a[c+h++]=b[d++]=b[v++]}if(h==e)return e}m=-1;return h},Q=function(a,b,d){var f,g,h,k,m,l,n,r=Array(316);for(f=0;f<r.length;f++)r[f]=0;y(5);l=257+B(5);D(5);y(5);n=1+B(5);D(5);y(4);f=4+B(4);D(4);if(286<l||30<n)return-1;for(g=0;g<f;g++)y(3),r[H[g]]=B(3),D(3);for(;19>g;g++)r[H[g]]=
0;C=7;g=new c(r,19,19,null,null,C);if(0!=g.status)return-1;z=g.root;C=g.m;k=l+n;for(f=h=0;f<k;)if(y(C),m=z.list[B(C)],g=m.b,D(g),g=m.n,16>g)r[f++]=h=g;else if(16==g){y(2);g=3+B(2);D(2);if(f+g>k)return-1;for(;0<g--;)r[f++]=h}else{17==g?(y(3),g=3+B(3),D(3)):(y(7),g=11+B(7),D(7));if(f+g>k)return-1;for(;0<g--;)r[f++]=0;h=0}C=9;g=new c(r,l,257,A,e,C);0==C&&(g.status=1);if(0!=g.status&&1==g.status)return-1;z=g.root;C=g.m;for(f=0;f<n;f++)r[f]=r[f+l];G=6;g=new c(r,n,0,x,S,G);p=g.root;G=g.m;return 0==G&&257<
l||0!=g.status?-1:P(a,b,d)},W=function(a,g,r){var u,F;for(u=0;u<r&&(!w||-1!=m);){if(0<q){if(0!=m)for(;0<q&&u<r;)q--,v&=32767,d&=32767,a[g+u++]=b[d++]=b[v++];else{for(;0<q&&u<r;)q--,d&=32767,y(8),a[g+u++]=b[d++]=B(8),D(8);0==q&&(m=-1)}if(u==r)break}if(-1==m){if(w)break;y(1);0!=B(1)&&(w=!0);D(1);y(2);m=B(2);D(2);z=null;q=0}switch(m){case 0:F=a;var I=g+u,H=r-u,J=void 0,J=t&7;D(J);y(16);J=B(16);D(16);y(16);if(J!=(~l&65535))F=-1;else{D(16);q=J;for(J=0;0<q&&J<H;)q--,d&=32767,y(8),F[I+J++]=b[d++]=B(8),D(8);
0==q&&(m=-1);F=J}break;case 1:if(null!=z)F=P(a,g+u,r-u);else a:{F=a;I=g+u;H=r-u;if(null==f){for(var E=void 0,J=Array(288),E=void 0,E=0;144>E;E++)J[E]=8;for(;256>E;E++)J[E]=9;for(;280>E;E++)J[E]=7;for(;288>E;E++)J[E]=8;h=7;E=new c(J,288,257,A,e,h);if(0!=E.status){alert("HufBuild error: "+E.status);F=-1;break a}f=E.root;h=E.m;for(E=0;30>E;E++)J[E]=5;n=5;E=new c(J,30,0,x,S,n);if(1<E.status){f=null;alert("HufBuild error: "+E.status);F=-1;break a}k=E.root;n=E.m}z=f;p=k;C=h;G=n;F=P(F,I,H)}break;case 2:F=
null!=z?P(a,g+u,r-u):Q(a,g+u,r-u);break;default:F=-1}if(-1==F)return w?0:-1;u+=F}return u};a.RawDeflate||(a.RawDeflate={});a.RawDeflate.inflate=function(a){var c;null==b&&(b=Array(65536));t=l=d=0;m=-1;w=!1;q=v=0;z=null;L=a;N=0;for(var e=Array(1024),f=[];0<(a=W(e,0,e.length));){var g=Array(a);for(c=0;c<a;c++)g[c]=String.fromCharCode(e[c]);f[f.length]=g.join("")}L=null;return f.join("")}})(this);
(function(a){var b,d,f,k,h=null,n,l,t,m,w,q,v,z,p,C,G,L,N,r,A,e,x,S,H,g,u,c,y,B,D,P,Q,W,O,K,T,M,F,I,X,J,E,ea,ba,ra,ja,ka,Y,la,sa,ca,fa,Z,da,ma,ta,ga=function(){this.dl=this.fc=0},ua=function(){this.extra_bits=this.static_tree=this.dyn_tree=null;this.max_code=this.max_length=this.elems=this.extra_base=0},V=function(a,b,c,d){this.good_length=a;this.max_lazy=b;this.nice_length=c;this.max_chain=d},Ma=function(){this.next=null;this.len=0;this.ptr=Array(8192);this.off=0},va=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,
2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ha=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Na=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Aa=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],wa=[new V(0,0,0,0),new V(4,4,8,4),new V(4,5,16,8),new V(4,6,32,32),new V(4,4,16,16),new V(8,16,32,32),new V(8,16,128,128),new V(8,32,128,256),new V(32,128,258,1024),new V(32,258,258,4096)],na=function(a){h[l+n++]=a;if(8192==l+n&&0!=n){var c;null!=b?(a=b,b=b.next):a=new Ma;a.next=null;a.len=a.off=0;null==
d?d=f=a:f=f.next=a;a.len=n-l;for(c=0;c<a.len;c++)a.ptr[c]=h[l+c];n=l=0}},oa=function(a){a&=65535;8190>l+n?(h[l+n++]=a&255,h[l+n++]=a>>>8):(na(a&255),na(a>>>8))},pa=function(){G=(G<<5^m[x+3-1]&255)&8191;L=v[32768+G];v[x&32767]=L;v[32768+G]=x},aa=function(a,c){R(c[a].fc,c[a].dl)},Ba=function(a,c,b){return a[c].fc<a[b].fc||a[c].fc==a[b].fc&&E[c]<=E[b]},Ca=function(a,c,b){var d;for(d=0;d<b&&ta<ma.length;d++)a[c+d]=ma.charCodeAt(ta++)&255;return d},Da=function(a){var c=u,b=x,d,f=e,g=32506<x?x-32506:0,
h=x+258,k=m[b+f-1],l=m[b+f];e>=B&&(c>>=2);do if(d=a,m[d+f]==l&&m[d+f-1]==k&&m[d]==m[b]&&m[++d]==m[b+1]){b+=2;for(d++;m[++b]==m[++d]&&m[++b]==m[++d]&&m[++b]==m[++d]&&m[++b]==m[++d]&&m[++b]==m[++d]&&m[++b]==m[++d]&&m[++b]==m[++d]&&m[++b]==m[++d]&&b<h;);d=258-(h-b);b=h-258;if(d>f){S=a;f=d;if(258<=d)break;k=m[b+f-1];l=m[b+f]}}while((a=v[a&32767])>g&&0!=--c);return f},xa=function(){var a,b,c=65536-g-x;if(-1==c)c--;else if(65274<=x){for(a=0;32768>a;a++)m[a]=m[a+32768];S-=32768;x-=32768;C-=32768;for(a=0;8192>
a;a++)b=v[32768+a],v[32768+a]=32768<=b?b-32768:0;for(a=0;32768>a;a++)b=v[a],v[a]=32768<=b?b-32768:0;c+=32768}H||(a=Ca(m,x+g,c),0>=a?H=!0:g+=a)},Oa=function(a,b,f){var h;if(!k){if(!H){p=z=0;var U,q;if(0==W[0].dl){K.dyn_tree=D;K.static_tree=Q;K.extra_bits=va;K.extra_base=257;K.elems=286;K.max_length=15;K.max_code=0;T.dyn_tree=P;T.static_tree=W;T.extra_bits=ha;T.extra_base=0;T.elems=30;T.max_length=15;T.max_code=0;M.dyn_tree=O;M.static_tree=null;M.extra_bits=Na;M.extra_base=0;M.elems=19;M.max_length=
7;for(q=U=M.max_code=0;28>q;q++)for(ra[q]=U,h=0;h<1<<va[q];h++)ea[U++]=q;ea[U-1]=q;for(q=U=0;16>q;q++)for(ja[q]=U,h=0;h<1<<ha[q];h++)ba[U++]=q;for(U>>=7;30>q;q++)for(ja[q]=U<<7,h=0;h<1<<ha[q]-7;h++)ba[256+U++]=q;for(h=0;15>=h;h++)F[h]=0;for(h=0;143>=h;)Q[h++].dl=8,F[8]++;for(;255>=h;)Q[h++].dl=9,F[9]++;for(;279>=h;)Q[h++].dl=7,F[7]++;for(;287>=h;)Q[h++].dl=8,F[8]++;Ea(Q,287);for(h=0;30>h;h++)W[h].dl=5,W[h].fc=Fa(h,5);Ga()}for(h=0;8192>h;h++)v[32768+h]=0;c=wa[y].max_lazy;B=wa[y].good_length;u=wa[y].max_chain;
C=x=0;g=Ca(m,0,65536);if(0>=g)H=!0,g=0;else{for(H=!1;262>g&&!H;)xa();for(h=G=0;2>h;h++)G=(G<<5^m[h]&255)&8191}d=null;r=l=n=0;3>=y?(e=2,A=0):(A=2,r=r=0);t=!1}k=!0;if(0==g)return t=!0,0}if((h=Ha(a,b,f))==f)return f;if(t)return h;if(3>=y)for(;0!=g&&null==d;){pa();0!=L&&32506>=x-L&&(A=Da(L),A>g&&(A=g));if(3<=A)if(q=ia(x-S,A-3),g-=A,A<=c){A--;do x++,pa();while(0!=--A);x++}else x+=A,A=0,G=m[x]&255,G=(G<<5^m[x+1]&255)&8191;else q=ia(0,m[x]&255),g--,x++;q&&(qa(0),C=x);for(;262>g&&!H;)xa()}else for(;0!=g&&
null==d;){pa();e=A;N=S;A=2;0!=L&&e<c&&32506>=x-L&&(A=Da(L),A>g&&(A=g),3==A&&4096<x-S&&A--);if(3<=e&&A<=e){q=ia(x-1-N,e-3);g-=e-1;e-=2;do x++,pa();while(0!=--e);r=0;A=2;x++;q&&(qa(0),C=x)}else 0!=r?ia(0,m[x-1]&255)&&(qa(0),C=x):r=1,x++,g--;for(;262>g&&!H;)xa()}0==g&&(0!=r&&ia(0,m[x-1]&255),qa(1),t=!0);return h+Ha(a,h+b,f-h)},Ha=function(a,c,e){var f,g,k;for(f=0;null!=d&&f<e;){g=e-f;g>d.len&&(g=d.len);for(k=0;k<g;k++)a[c+f+k]=d.ptr[d.off+k];d.off+=g;d.len-=g;f+=g;0==d.len&&(g=d,d=d.next,g.next=b,b=
g)}if(f==e)return f;if(l<n){g=e-f;g>n-l&&(g=n-l);for(k=0;k<g;k++)a[c+f+k]=h[l+k];l+=g;f+=g;n==l&&(n=l=0)}return f},Ga=function(){var a;for(a=0;286>a;a++)D[a].fc=0;for(a=0;30>a;a++)P[a].fc=0;for(a=0;19>a;a++)O[a].fc=0;D[256].fc=1;ca=Y=la=sa=Z=da=0;fa=1},ya=function(a,b){for(var c=I[b],d=b<<1;d<=X;){d<X&&Ba(a,I[d+1],I[d])&&d++;if(Ba(a,c,I[d]))break;I[b]=I[d];b=d;d<<=1}I[b]=c},Ea=function(a,b){var c=Array(16),d=0,e;for(e=1;15>=e;e++)d=d+F[e-1]<<1,c[e]=d;for(d=0;d<=b;d++)e=a[d].dl,0!=e&&(a[d].fc=Fa(c[e]++,
e))},za=function(a){var b=a.dyn_tree,c=a.static_tree,d=a.elems,e,f=-1,g=d;X=0;J=573;for(e=0;e<d;e++)0!=b[e].fc?(I[++X]=f=e,E[e]=0):b[e].dl=0;for(;2>X;)e=I[++X]=2>f?++f:0,b[e].fc=1,E[e]=0,Z--,null!=c&&(da-=c[e].dl);a.max_code=f;for(e=X>>1;1<=e;e--)ya(b,e);do e=I[1],I[1]=I[X--],ya(b,1),c=I[1],I[--J]=e,I[--J]=c,b[g].fc=b[e].fc+b[c].fc,E[g]=E[e]>E[c]+1?E[e]:E[c]+1,b[e].dl=b[c].dl=g,I[1]=g++,ya(b,1);while(2<=X);I[--J]=I[1];g=a.dyn_tree;e=a.extra_bits;var d=a.extra_base,c=a.max_code,h=a.max_length,k=a.static_tree,
m,l,r,n,p=0;for(l=0;15>=l;l++)F[l]=0;g[I[J]].dl=0;for(a=J+1;573>a;a++)m=I[a],l=g[g[m].dl].dl+1,l>h&&(l=h,p++),g[m].dl=l,m>c||(F[l]++,r=0,m>=d&&(r=e[m-d]),n=g[m].fc,Z+=n*(l+r),null!=k&&(da+=n*(k[m].dl+r)));if(0!=p){do{for(l=h-1;0==F[l];)l--;F[l]--;F[l+1]+=2;F[h]--;p-=2}while(0<p);for(l=h;0!=l;l--)for(m=F[l];0!=m;)e=I[--a],e>c||(g[e].dl!=l&&(Z+=(l-g[e].dl)*g[e].fc,g[e].fc=l),m--)}Ea(b,f)},Ia=function(a,b){var c,d=-1,e,f=a[0].dl,g=0,h=7,k=4;0==f&&(h=138,k=3);a[b+1].dl=65535;for(c=0;c<=b;c++)e=f,f=a[c+
1].dl,++g<h&&e==f||(g<k?O[e].fc+=g:0!=e?(e!=d&&O[e].fc++,O[16].fc++):10>=g?O[17].fc++:O[18].fc++,g=0,d=e,0==f?(h=138,k=3):e==f?(h=6,k=3):(h=7,k=4))},Ja=function(a,b){var c,d=-1,e,f=a[0].dl,g=0,h=7,k=4;0==f&&(h=138,k=3);for(c=0;c<=b;c++)if(e=f,f=a[c+1].dl,!(++g<h&&e==f)){if(g<k){do aa(e,O);while(0!=--g)}else 0!=e?(e!=d&&(aa(e,O),g--),aa(16,O),R(g-3,2)):10>=g?(aa(17,O),R(g-3,3)):(aa(18,O),R(g-11,7));g=0;d=e;0==f?(h=138,k=3):e==f?(h=6,k=3):(h=7,k=4)}},qa=function(a){var b,c,d,e;e=x-C;ka[sa]=ca;za(K);
za(T);Ia(D,K.max_code);Ia(P,T.max_code);za(M);for(d=18;3<=d&&0==O[Aa[d]].dl;d--);Z+=3*(d+1)+14;b=Z+3+7>>3;c=da+3+7>>3;c<=b&&(b=c);if(e+4<=b&&0<=C)for(R(0+a,3),Ka(),oa(e),oa(~e),d=0;d<e;d++)na(m[C+d]);else if(c==b)R(2+a,3),La(Q,W);else{R(4+a,3);e=K.max_code+1;b=T.max_code+1;d+=1;R(e-257,5);R(b-1,5);R(d-4,4);for(c=0;c<d;c++)R(O[Aa[c]].dl,3);Ja(D,e-1);Ja(P,b-1);La(D,P)}Ga();0!=a&&Ka()},ia=function(a,b){q[Y++]=b;0==a?D[b].fc++:(a--,D[ea[b]+256+1].fc++,P[(256>a?ba[a]:ba[256+(a>>7)])&255].fc++,w[la++]=
a,ca|=fa);fa<<=1;0==(Y&7)&&(ka[sa++]=ca,ca=0,fa=1);if(2<y&&0==(Y&4095)){var c=8*Y,d=x-C,e;for(e=0;30>e;e++)c+=P[e].fc*(5+ha[e]);c>>=3;if(la<parseInt(Y/2)&&c<parseInt(d/2))return!0}return 8191==Y||8192==la},La=function(a,b){var c,d=0,e=0,f=0,g=0,h,k;if(0!=Y){do 0==(d&7)&&(g=ka[f++]),c=q[d++]&255,0==(g&1)?aa(c,a):(h=ea[c],aa(h+256+1,a),k=va[h],0!=k&&(c-=ra[h],R(c,k)),c=w[e++],h=(256>c?ba[c]:ba[256+(c>>7)])&255,aa(h,b),k=ha[h],0!=k&&(c-=ja[h],R(c,k))),g>>=1;while(d<Y)}aa(256,a)},R=function(a,c){p>16-
c?(z|=a<<p,oa(z),z=a>>16-p,p+=c-16):(z|=a<<p,p+=c)},Fa=function(a,c){var b=0;do b|=a&1,a>>=1,b<<=1;while(0<--c);return b>>1},Ka=function(){8<p?oa(z):0<p&&na(z);p=z=0};a.RawDeflate||(a.RawDeflate={});a.RawDeflate.deflate=function(a,c){var e,g;ma=a;ta=0;"undefined"==typeof c&&(c=6);(e=c)?1>e?e=1:9<e&&(e=9):e=6;y=e;H=k=!1;if(null==h){b=d=f=null;h=Array(8192);m=Array(65536);w=Array(8192);q=Array(32832);v=Array(65536);D=Array(573);for(e=0;573>e;e++)D[e]=new ga;P=Array(61);for(e=0;61>e;e++)P[e]=new ga;
Q=Array(288);for(e=0;288>e;e++)Q[e]=new ga;W=Array(30);for(e=0;30>e;e++)W[e]=new ga;O=Array(39);for(e=0;39>e;e++)O[e]=new ga;K=new ua;T=new ua;M=new ua;F=Array(16);I=Array(573);E=Array(573);ea=Array(256);ba=Array(512);ra=Array(29);ja=Array(30);ka=Array(1024)}for(var l=Array(1024),r=[];0<(e=Oa(l,0,l.length));){var n=Array(e);for(g=0;g<e;g++)n[g]=String.fromCharCode(l[g]);r[r.length]=n.join("")}ma=null;return r.join("")}})(this);
(function(a){if(!a.Base64){var b;"undefined"!==typeof module&&module.exports&&(b=require("buffer").Buffer);var d=function(a){for(var b={},d=0,f=a.length;d<f;d++)b[a.charAt(d)]=d;return b}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),f=String.fromCharCode,k=function(a){if(2>a.length){var b=a.charCodeAt(0);return 128>b?a:2048>b?f(192|b>>>6)+f(128|b&63):f(224|b>>>12&15)+f(128|b>>>6&63)+f(128|b&63)}b=65536+1024*(a.charCodeAt(0)-55296)+(a.charCodeAt(1)-56320);return f(240|b>>>18&
7)+f(128|b>>>12&63)+f(128|b>>>6&63)+f(128|b&63)},h=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,n=function(a){return a.replace(h,k)},l=function(a){var b=[0,2,1][a.length%3];a=a.charCodeAt(0)<<16|(1<a.length?a.charCodeAt(1):0)<<8|(2<a.length?a.charCodeAt(2):0);return["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>12&63),2<=b?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>
6&63),1<=b?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a&63)].join("")},t=a.btoa||function(a){return a.replace(/[\s\S]{1,3}/g,l)},m=b?function(a){return(new b(a)).toString("base64")}:function(a){return t(n(a))},w=function(a,b){return b?m(a).replace(/[+\/]/g,function(a){return"+"==a?"-":"_"}).replace(/=/g,""):m(a)},q=/[\u00c0-\u00df][\u0080-\u00bf]|[\u00e0-\u00ef][\u0080-\u00bf]{2}|[\u00f0-\u00f7][\u0080-\u00bf]{3}/g,v=function(a){switch(a.length){case 4:return a=
((7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3))-65536,f((a>>>10)+55296)+f((a&1023)+56320);case 3:return f((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return f((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1))}},z=function(a){return a.replace(q,v)},p=function(a){var b=a.length,e=b%4;a=(0<b?d[a.charAt(0)]<<18:0)|(1<b?d[a.charAt(1)]<<12:0)|(2<b?d[a.charAt(2)]<<6:0)|(3<b?d[a.charAt(3)]:0);a=[f(a>>>16),f(a>>>8&255),f(a&255)];a.length-=
[0,0,2,1][e];return a.join("")},C=a.atob||function(a){return a.replace(/[\s\S]{1,4}/g,p)},G=b?function(a){return(new b(a,"base64")).toString()}:function(a){return z(C(a))},L=function(a){return G(a.replace(/[-_]/g,function(a){return"-"==a?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};a.Base64={VERSION:"2.1.1",atob:C,btoa:t,fromBase64:L,toBase64:w,utob:n,encode:w,encodeURI:function(a){return w(a,!0)},btou:z,decode:L};if("function"===typeof Object.defineProperty){var N=function(a){return{value:a,enumerable:!1,
writable:!0,configurable:!0}};a.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",N(function(){return L(this)}));Object.defineProperty(String.prototype,"toBase64",N(function(a){return w(this,a)}));Object.defineProperty(String.prototype,"toBase64URI",N(function(){return w(this,!0)}))}}}})(this);function importSTL(a,b){for(var d=!0,f=0;f<a.length;f++)if(0==a[f].charCodeAt(0)){d=!1;break}console.log("STL file is ascii: ",d);return d?importAsciiSTL(a,b):importBinarySTL(a,b)}
function importBinarySTL(a,b){var d=[],f=new BinaryReader(a);f.seek(80);for(var k=f.readUInt32(),h=[1E4,1E4,1E4],n=[-1E4,-1E4,-1E4],l=0;l<k;l++){f.readFloat();f.readFloat();f.readFloat();var t=[];t.push(f.readFloat());t.push(f.readFloat());t.push(f.readFloat());var m=[];m.push(f.readFloat());m.push(f.readFloat());m.push(f.readFloat());var w=[];w.push(f.readFloat());w.push(f.readFloat());w.push(f.readFloat());for(var q=0,v=0;3>v;v++)isNaN(t[v])&&q++,isNaN(m[v])&&q++,isNaN(w[v])&&q++;0<q&&console.log("this many bad vertices: ",
q);f.readUInt16();if(!q)for(d.push(t),d.push(m),d.push(w),v=0;3>v;v++)h[v]=Math.min(h[v],t[v]),h[v]=Math.min(h[v],m[v]),h[v]=Math.min(h[v],w[v]),n[v]=Math.max(n[v],t[v]),n[v]=Math.max(n[v],m[v]),n[v]=Math.max(n[v],w[v])}q&&console.log("WARNING: import errors: expect some missing or bad triangles\n");f=[Math.round(n[0]-(n[0]-h[0])/2),Math.round(n[1]-(n[1]-h[1])/2),Math.round(n[2]-(n[2]-h[2])/2)];return[vt2csg(d),f]}
function importAsciiSTL(a,b){for(var d="",f=[],k=0,h=0,n=[1E4,1E4,1E4],l=[-1E4,-1E4,-1E4],t=a.split("\n"),m=0;m<t.length;m++)if(!t[m].match(/facet/)&&!t[m].match(/endloop/))if(t[m].match(/outer/))var k=h=0,w=[[],[],[]];else if(t[m].match(/vertex/)){t[m]=t[m].replace(/^\s+|\s+$/g,"");var q=t[m].split(" ");w[h].push(parseFloat(q[1]));w[h].push(parseFloat(q[2]));w[h].push(parseFloat(q[3]));isNaN(w[h][0])&&k++;isNaN(w[h][1])&&k++;isNaN(w[h][2])&&k++;0<k&&(console.log("this many bad vertices: ",k),console.log("things are:",
q));if(!k&&3==++h)for(f.push(w[0]),f.push(w[1]),f.push(w[2]),q=0;3>q;q++)n[q]=Math.min(n[q],w[0][q]),n[q]=Math.min(n[q],w[1][q]),n[q]=Math.min(n[q],w[2][q]),l[q]=Math.max(l[q],w[0][q]),l[q]=Math.max(l[q],w[1][q]),l[q]=Math.max(l[q],w[2][q])}k=[Math.round(l[0]-(l[0]-n[0])/2),Math.round(l[1]-(l[1]-n[1])/2),Math.round(l[2]-(l[2]-n[2])/2)];d+=vt2csg(f);return[d,k]}
function vt2csg(a){var b;b="CSG.fromPolygons([";for(var d=0;d<a.length/3;d++){b+="new CSG.Polygon([";for(var f=0;3>f;f++)b+="new CSG.Vertex(new CSG.Vector3D([",b+=a[3*d+f]+"]))",2>f&&(b+=",");b+="])";d<a.length/3-1&&(b+=",")}return b+"])"}var BinaryReader=function(a){this._buffer=a;this._pos=0};
BinaryReader.prototype={readInt8:function(){return this._decodeInt(8,!0)},readUInt8:function(){return this._decodeInt(8,!1)},readInt16:function(){return this._decodeInt(16,!0)},readUInt16:function(){return this._decodeInt(16,!1)},readInt32:function(){return this._decodeInt(32,!0)},readUInt32:function(){return this._decodeInt(32,!1)},readFloat:function(){return this._decodeFloat(23,8)},readDouble:function(){return this._decodeFloat(52,11)},readChar:function(){return this.readString(1)},readString:function(a){this._checkSize(8*
a);var b=this._buffer.substr(this._pos,a);this._pos+=a;return b},seek:function(a){this._pos=a;this._checkSize(0)},getPosition:function(){return this._pos},getSize:function(){return this._buffer.length},_decodeFloat:function(a,b){var d=a+b+1,f=d>>3;this._checkSize(d);var d=Math.pow(2,b-1)-1,k=this._readBits(a+b,1,f),h=this._readBits(a,b,f),n=0,l=2,t=0;do for(var m=this._readByte(++t,f),w=a%8||8,q=1<<w;q>>=1;)m&q&&(n+=1/l),l*=2;while(a-=w);this._pos+=f;return h==(d<<1)+1?n?NaN:k?-Infinity:Infinity:
(1+-2*k)*(h||n?h?Math.pow(2,h-d)*(1+n):Math.pow(2,-d+1)*n:0)},_decodeInt:function(a,b){var d=this._readBits(0,a,a/8),f=Math.pow(2,a);this._pos+=a/8;return b&&d>=f/2?d-f:d},_shl:function(a,b){for(++b;--b;a=1073741824==((a%=2147483648)&1073741824)?2*a:2*(a-1073741824)+2147483648);return a},_readByte:function(a,b){return this._buffer.charCodeAt(this._pos+b-a-1)&255},_readBits:function(a,b,d){var f=(a+b)%8,k=a%8,h=d-(a>>3)-1;a=d+(-(a+b)>>3);var n=h-a;b=this._readByte(h,d)>>k&(1<<(n?8-k:b))-1;for(n&&f&&
(b+=(this._readByte(a++,d)&(1<<f)-1)<<(n--<<3)-k);n;)b+=this._shl(this._readByte(a++,d),(n--<<3)-k);return b},_checkSize:function(a){Math.ceil(a/8)}};