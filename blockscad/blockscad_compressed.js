// Do not edit this file; automatically generated by blockscad_build.py.
"use strict";
var BlocklyStorage=BlocklyStorage||{},Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{};var Blockly=Blockly||{};Blockly.Xml=Blockly.Xml||{};
BlocklyStorage.backupBlocks_=function(){if("localStorage"in window){localStorage.clear();for(var a=Blockly.Xml.workspaceToDom(Blockscad.workspace),b=window.location.href.split("#")[0],b=b.split("?lang")[0],d=b+"proj_name",f=b+"current_project",p=b+"current_project_key",g=b+"needToSave",k=Blockscad.workspace.getAllBlocks(),m=0;m<k.length;m++)if("stl_import"==k[m].type){var v=k[m].getField("STL_CONTENTS").getText();if(0<v.length){var q=b+v,t=b+v+"center";if(3E6>Blockscad.csg_commands[v].length){var l=
Base64.toBase64(RawDeflate.deflate(Base64.utob(Blockscad.csg_commands[v])));window.localStorage.setItem(q,l);window.localStorage.setItem(t,Blockscad.csg_center[v])}}}window.localStorage.setItem(b,Blockly.Xml.domToText(a));window.localStorage.setItem(d,$("#project-name").val());window.localStorage.setItem(f,Blockscad.Auth.currentProject);window.localStorage.setItem(p,Blockscad.Auth.currentProjectKey);window.localStorage.setItem(g,Blockscad.undo.needToSave)}};
BlocklyStorage.autosaveBlocks=function(a){"localStorage"in window&&(localStorage.xml=a,localStorage.proj_name=$("#project-name").val())};BlocklyStorage.standaloneRestoreBlocks=function(){if(localStorage.xml){var a=Blockly.Xml.textToDom(localStorage.xml);Blockly.Xml.domToWorkspace(Blockscad.workspace,a);a=localStorage.proj_name;"undefined"!=a?$("#project-name").val(a):$("#project-name").val("Untitled")}};
BlocklyStorage.backupOnUnload=function(){window.addEventListener("unload",BlocklyStorage.backupBlocks_,!1)};
BlocklyStorage.restoreBlocks=function(){var a=window.location.href.split("#")[0],a=a.split("?lang")[0],b=a+"proj_name",d=a+"current_project",f=a+"current_project_key",p=a+"needToSave";console.log(window.localStorage);if("localStorage"in window&&window.localStorage[a]){var g=Blockly.Xml.textToDom(window.localStorage[a]);Blockly.Xml.domToWorkspace(Blockscad.workspace,g);for(var g=Blockscad.workspace.getAllBlocks(),k=0;k<g.length;k++)if("stl_import"==g[k].type){var m=g[k].getField("STL_CONTENTS").getText(),
v=g[k].getField("STL_FILENAME").getText(),q=g[k].getField("STL_BUTTON");if(0<m.length){var t=window.localStorage[a+m],l=window.localStorage[a+m+"center"];if(t&&0<t.length)q.setVisible(!1),console.log("csg contents compressed length is:",t.length),q=Base64.btou(RawDeflate.inflate(Base64.fromBase64(t))),console.log("decompressed lengeth is:",q.length),Blockscad.csg_commands[m]=q,Blockscad.csg_filename[m]=v+":::",Blockscad.csg_center[m]=l;else{console.log("couldn't find the stl in localStorage");$("#error-message").html("Warning: Re-load your .STL files");
g[k].getField("STL_CONTENTS").setText("");g[k].getField("STL_FILENAME").setText("");m=g[k].getCommentText();m.match(/^RELOAD/)||(m="RELOAD: "+m);g[k].setCommentText(m);q.setText("Reload");g[k].backlight();if(m=g[k].collapsedParents())for(v=0;v<m.length;v++)m[v].backlight();g[k].isCollapsed()||q.setVisible(!0);q=g[k];for(m=null;q;)q.isCollapsed()&&(m=q),q=q.getSurroundParent();m&&m.setCollapsed(!0,!0)}g[k].render()}}a=window.localStorage[b];"undefined"!=a?$("#project-name").val(a):$("#project-name").val("Untitled");
d=window.localStorage[d];Blockscad.Auth.currentProject="undefined"!=d?d:"";f=window.localStorage[f];"undefined"!=f&&(Blockscad.Auth.currentProjectKey=f);var r=Number(window.localStorage[p]);"undefined"==r||1!=r&&0!=r||setTimeout(function(){Blockscad.undo.needToSave=r},300)}};var BSUtils=BSUtils||{};BSUtils.LANGUAGE_NAME={en:"English",de:"Deutsch",fr:"Fran\u00e7ais"};BSUtils.LANGUAGE_RTL=["ar","fa","he"];BSUtils.LANGUAGES=void 0;BSUtils.getStringParamFromUrl=function(a,b){var d=window.location.search.match(new RegExp("[?&]"+a+"=([^&]+)"));return d?decodeURIComponent(d[1].replace(/\+/g,"%20")):b};BSUtils.getLang=function(){var a=BSUtils.getStringParamFromUrl("lang","");void 0===BSUtils.LANGUAGE_NAME[a]&&(a="en");return a};BSUtils.LANG=BSUtils.getLang();
BSUtils.isRtl=function(){return-1!=BSUtils.LANGUAGE_RTL.indexOf(BSUtils.LANG)};BSUtils.initReadonly=function(){Blockly.inject(document.getElementById("blockly"),{path:"./",readOnly:!0,rtl:BSUtils.isRtl(),scrollbars:!1});var a=BSUtils.getStringParamFromUrl("xml",""),a=Blockly.Xml.textToDom("<xml>"+a+"</xml>");Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)};
BSUtils.loadBlocks=function(a){a?(a=Blockly.Xml.textToDom(a),Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,a)):"BlocklyStorage"in window&&window.setTimeout(BlocklyStorage.restoreBlocks,0)};
BSUtils.changeLanguage=function(){console.log("in changeLanguage");BlocklyStorage.backupBlocks_();var a=encodeURIComponent($(this).data("lang"));console.log("newLang is:",a);var b=window.location.search,b=1>=b.length?"?lang="+a:b.match(/[?&]lang=[^&]*/)?b.replace(/([?&]lang=)[^&]*/,"$1"+a):b.replace(/\?/,"?lang="+a+"&");window.location=window.location.protocol+"//"+window.location.host+window.location.pathname+b};BSUtils.isDialogVisible_=!1;BSUtils.dialogOrigin_=null;BSUtils.dialogDispose_=null;
BSUtils.showDialog=function(a,b,d,f,p,g){function k(){BSUtils.isDialogVisible_&&(m.style.visibility="visible",m.style.zIndex=1,v.style.visibility="hidden")}BSUtils.isDialogVisible_&&BSUtils.hideDialog(!1);BSUtils.isDialogVisible_=!0;BSUtils.dialogOrigin_=b;BSUtils.dialogDispose_=g;var m=document.getElementById("dialog");g=document.getElementById("dialogShadow");var v=document.getElementById("dialogBorder"),q;for(q in p)m.style[q]=p[q];f&&(g.style.visibility="visible",g.style.opacity=.3,f=document.createElement("div"),
f.id="dialogHeader",m.appendChild(f),BSUtils.dialogMouseDownWrapper_=Blockly.bindEvent_(f,"mousedown",null,BSUtils.dialogMouseDown_));m.appendChild(a);a.className=a.className.replace("dialogHiddenContent","");d&&b?(BSUtils.matchBorder_(b,!1,.2),BSUtils.matchBorder_(m,!0,.8),window.setTimeout(k,175)):k()};BSUtils.dialogStartX_=0;BSUtils.dialogStartY_=0;
BSUtils.dialogMouseDown_=function(a){BSUtils.dialogUnbindDragEvents_();if(!Blockly.isRightButton(a)){var b=document.getElementById("dialog");BSUtils.dialogStartX_=b.offsetLeft-a.clientX;BSUtils.dialogStartY_=b.offsetTop-a.clientY;BSUtils.dialogMouseUpWrapper_=Blockly.bindEvent_(document,"mouseup",null,BSUtils.dialogUnbindDragEvents_);BSUtils.dialogMouseMoveWrapper_=Blockly.bindEvent_(document,"mousemove",null,BSUtils.dialogMouseMove_);a.stopPropagation()}};
BSUtils.dialogMouseMove_=function(a){var b=document.getElementById("dialog"),d=BSUtils.dialogStartX_+a.clientX;a=BSUtils.dialogStartY_+a.clientY;a=Math.max(a,0);a=Math.min(a,window.innerHeight-b.offsetHeight);d=Math.max(d,0);d=Math.min(d,window.innerWidth-b.offsetWidth);b.style.left=d+"px";b.style.top=a+"px"};
BSUtils.dialogUnbindDragEvents_=function(){BSUtils.dialogMouseUpWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseUpWrapper_),BSUtils.dialogMouseUpWrapper_=null);BSUtils.dialogMouseMoveWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseMoveWrapper_),BSUtils.dialogMouseMoveWrapper_=null)};
BSUtils.hideDialog=function(a){function b(){f.style.visibility="hidden";p.style.visibility="hidden"}if(BSUtils.isDialogVisible_){BSUtils.dialogUnbindDragEvents_();BSUtils.dialogMouseDownWrapper_&&(Blockly.unbindEvent_(BSUtils.dialogMouseDownWrapper_),BSUtils.dialogMouseDownWrapper_=null);BSUtils.isDialogVisible_=!1;BSUtils.dialogDispose_&&BSUtils.dialogDispose_();BSUtils.dialogDispose_=null;var d=!1===a?null:BSUtils.dialogOrigin_;a=document.getElementById("dialog");var f=document.getElementById("dialogShadow"),
p=document.getElementById("dialogBorder");f.style.opacity=0;d?(BSUtils.matchBorder_(a,!1,.8),BSUtils.matchBorder_(d,!0,.2),window.setTimeout(b,175)):b();a.style.visibility="hidden";a.style.zIndex=-1;for((d=document.getElementById("dialogHeader"))&&d.parentNode.removeChild(d);a.firstChild;)d=a.firstChild,d.className+=" dialogHiddenContent",document.body.appendChild(d)}};
BSUtils.matchBorder_=function(a,b,d){function f(){p.style.width=g.width+"px";p.style.height=g.height+"px";p.style.left=g.x+"px";p.style.top=g.y+"px";p.style.opacity=d}if(a){var p=document.getElementById("dialogBorder"),g=BSUtils.getBBox_(a);b?(p.className="dialogAnimate",window.setTimeout(f,1)):(p.className="",f());p.style.visibility="visible"}};
BSUtils.getBBox_=function(a){var b=a.offsetHeight,d=a.offsetWidth,f=0,p=0;do f+=a.offsetLeft,p+=a.offsetTop,a=a.offsetParent;while(a);return{height:b,width:d,x:f,y:p}};
BSUtils.storageAlert=function(a){var b=document.getElementById("containerStorage");b.textContent="";a=a.split("\n");for(var d=0;d<a.length;d++){var f=document.createElement("p");f.appendChild(document.createTextNode(a[d]));b.appendChild(f)}b=document.getElementById("dialogStorage");a=document.getElementById("linkButton");BSUtils.showDialog(b,a,!0,!0,{width:"50%",left:"25%",top:"5em"},BSUtils.stopDialogKeyDown());BSUtils.startDialogKeyDown()};
BSUtils.dialogKeyDown_=function(a){!BSUtils.isDialogVisible_||13!=a.keyCode&&27!=a.keyCode&&32!=a.keyCode||(BSUtils.hideDialog(!0),a.stopPropagation(),a.preventDefault())};BSUtils.startDialogKeyDown=function(){document.body.addEventListener("keydown",BSUtils.dialogKeyDown_,!0)};BSUtils.stopDialogKeyDown=function(){document.body.removeEventListener("keydown",BSUtils.dialogKeyDown_,!0)};BSUtils.getMsg=function(a){var b=BSUtils.getMsgOrNull(a);return null===b?"[Unknown message: "+a+"]":b};
BSUtils.getMsgOrNull=function(a){return(a=document.getElementById(a))?(a=a.textContent,a=a.replace(/\\n/g,"\n")):null};BSUtils.addTouchEvents=function(){if("ontouchstart"in document.documentElement)for(var a=document.getElementsByTagName("button"),b=0,d;d=a[b];b++)d.ontouchend||(d.ontouchend=d.onclick)};window.addEventListener("load",BSUtils.addTouchEvents,!1);
BSUtils.bindClick=function(a,b){"string"==typeof a&&(a=document.getElementById(a));a.addEventListener("click",b,!0);a.addEventListener("touchend",b,!0)};Blockscad=Blockscad||{};Blockscad.Toolbox=Blockscad.Toolbox||{};Blockscad.Auth=Blockscad.Auth||{};BlocklyStorage=BlocklyStorage||{};Blockly=Blockly||{};BSUtils=BSUtils||{};Blockscad.version="1.4.2";Blockscad.releaseDate="2016/06/17";Blockscad.offline=!0;Blockscad.gProcessor=null;var _includePath="./";Blockscad.drawAxes=1;
Blockscad.init=function(){Blockscad.initLanguage();Blockscad.inputVersion=Blockscad.version;BSUtils.isRtl();Blockscad.missingFields=[];Blockscad.csg_commands={};Blockscad.csg_filename={};Blockscad.csg_center=[0,0,0];var a=document.getElementById("main");window.addEventListener("resize",function(b){b=BSUtils.getBBox_(a);var d=document.getElementById("blocklyDiv");d.style.top=b.y+"px";d.style.left=b.x+"px";d.style.height=b.height-88+"px";d.style.width=b.width+"px";null!=Blockscad.gProcessor&&Blockscad.gProcessor.viewer&&
Blockscad.gProcessor.viewer.rendered_resize(Blockscad.gProcessor.viewerdiv.offsetWidth,Blockscad.gProcessor.viewerdiv.offsetHeight);70>$("#main").height()-$(".resizableDiv").height()&&$(".resizableDiv").height($("#main").height()-70);20>$("#main").width()-$(".resizableDiv").width()&&$(".resizableDiv").width($("#main").width()-20);$(".resizableDiv").position({of:$("#main"),my:"right top",at:"right top",offset:"-12 -55"})},!1);Blockscad.workspace=Blockly.inject(document.getElementById("blocklyDiv"),
{media:"blockly/media/",zoom:{enabled:!0,scaleSpeed:1.1,controls:!0},trashcan:!1,toolbox:Blockscad.Toolbox.adv});Blockscad.Toolbox.setColorScheme(Blockscad.Toolbox.colorScheme.one);Blockscad.Toolbox.setCatColors();$("#advancedToolbox").hide();console.log("trying to restore blocks");BlocklyStorage.standaloneRestoreBlocks();"BlocklyStorage"in window&&BlocklyStorage.backupOnUnload();$(".resizableDiv").resizable({handles:"s,w,sw",resize:function(a,d){var f;$(window).height();null!=Blockscad.gProcessor&&
(f=Blockscad.gProcessor.viewerdiv.offsetHeight,Blockscad.gProcessor.viewer.rendered_resize(Blockscad.gProcessor.viewerdiv.offsetWidth,f));20>$("#main").width()-d.size.width&&(d.size.width=$("#main").width()-20);70>$("#main").height()-d.size.height&&(d.size.height=$("#main").height()-70);d.position.left=$(window).width()-(d.size.width+12);d.position.top=55}});Blockly.fireUiEvent(window,"resize");Blockscad.offline||Blockscad.Auth.init();BSUtils.bindClick("trashButton",function(){Blockscad.discard()});
BSUtils.bindClick("renderButton",Blockscad.doRender);BSUtils.bindClick("undoButton",Blockscad.onUndo);BSUtils.bindClick("redoButton",Blockscad.onRedo);$("#redrawBlocksButton").click(function(){Blockly.fireUiEvent(window,"resize")});$("#axesButton").click(function(){Blockscad.drawAxes=(Blockscad.drawAxes+1)%2;$("#axesButton").toggleClass("btn-pushed");Blockscad.gProcessor.viewer.onDraw()});$("#displayCode").click(function(){var a=document.getElementById("openScadPre"),d=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace);
a.textContent=d;"function"==typeof prettyPrintOne&&(d=a.innerHTML,d=prettyPrintOne(d,"js"),a.innerHTML=d);Blockly.fireUiEvent(window,"resize")});$("#main").on("click",".new-project",Blockscad.newProject);$("#file-menu").on("change","#loadLocal",function(a){Blockscad.loadLocalBlocks(a)});$("#file-menu").on("change","#importLocal",function(a){readSingleFile(a,!1)});$("#file-menu").on("change","#importStl",function(a){Blockscad.readStlFile(a)});Blockscad.picSize=[120,120];Blockscad.picQuality=.85;$("#picButton").click(Blockscad.takePic);
$("#rPicButton").click(Blockscad.takeRPic);Blockscad.gProcessor=new Blockscad.Processor(document.getElementById("renderDiv"));BSUtils.bindClick("viewReset",Blockscad.resetView);Blockscad.undo={blockList:[],oldBlockList:[],undoStack:[],redoStack:[],current_xml:null,blockCount:0,yesthis:0,fieldChanging:0,blockIds:[],fieldValues:[],parentIds:[],oldBlockIds:[],oldFieldValues:[],oldParentIds:[],just_did_undo:0,oldProjectName:Blockscad.Msg.PROJECT_NAME_DEFAULT};Blockscad.setNoSaveNeeded();Blockscad.workspace.addUndoListener(Blockscad.workspaceChanged);
Blockscad.offline||Blockscad.Auth.checkForUser();$("#help-menu").on("click","#about",function(){$("#about-modal").modal("show")});$("#file-menu").on("click","#saveLocal",Blockscad.saveBlocksLocal);$("#file-menu").on("click","#saveOpenscad",Blockscad.saveOpenscadLocal);$("#simpleToolbox").on("click",function(){$("#simpleToolbox").hide();$("#advancedToolbox").show();Blockscad.workspace&&(Blockscad.Toolbox.catIDs=[],Blockscad.workspace.updateToolbox(Blockscad.Toolbox.sim),Blockscad.Toolbox.setCatColors())});
$("#advancedToolbox").on("click",function(){$("#advancedToolbox").hide();$("#simpleToolbox").show();Blockscad.workspace&&(Blockscad.Toolbox.catIDs=[],Blockscad.workspace.updateToolbox(Blockscad.Toolbox.adv),Blockscad.Toolbox.setCatColors())});$("#colors_one").on("click",function(){Blockscad.workspace&&(Blockscad.Toolbox.setColorScheme(Blockscad.Toolbox.colorScheme.one),Blockscad.Toolbox.setCatColors(),Blockscad.workspace.clear(),Blockly.Xml.domToWorkspace(Blockscad.workspace,Blockscad.undo.current_xml))});
$("#colors_two").on("click",function(){Blockscad.workspace&&(Blockscad.Toolbox.setColorScheme(Blockscad.Toolbox.colorScheme.two),Blockscad.Toolbox.setCatColors(),Blockscad.workspace.clear(),Blockly.Xml.domToWorkspace(Blockscad.workspace,Blockscad.undo.current_xml))});Blockscad.setColor=function(a,d,f){null!=Blockscad.gProcessor&&Blockscad.gProcessor.viewer&&(Blockscad.gProcessor.viewer.defaultColor=[a/255,d/255,f/255,1],Blockscad.gProcessor.picviewer.defaultColor=[a/255,d/255,f/255,1],Blockscad.gProcessor.hasSolid()&&
(Blockscad.gProcessor.viewer.setCsg(Blockscad.gProcessor.currentObject),Blockscad.gProcessor.picviewer.setCsg(Blockscad.gProcessor.currentObject),Blockscad.gProcessor.thumbnail=Blockscad.gProcessor.picviewer.takePic(Blockscad.picQuality,0)),Blockscad.defaultColor=Math.round(a)+","+Math.round(d)+","+Math.round(f),$("#defColor").spectrum("set","rgb("+Blockscad.defaultColor+")"))};$("#defColor").spectrum({color:"rgb(255,128,255)",showPalette:!0,className:"defaultColor",appendTo:"#renderDiv",hideAfterPaletteSelect:!0,
showPaletteOnly:!0,change:function(a){Blockscad.setColor(a._r,a._g,a._b)},palette:[["rgb(255,128,255);","rgb(153,153,153);","rgb(238,0,0);","rgb(255,102,0);"],["rgb(255,204,0);","rgb(0,153,0);","rgb(51,102,255);","rgb(204,51,204);"]]});$("#examples_torus").click({msg:"torus.xml"},Blockscad.showExample);$("#examples_box").click({msg:"box.xml"},Blockscad.showExample);$("#examples_linear_extrude").click({msg:"linear_extrude.xml"},Blockscad.showExample);$("#examples_rotate_extrude").click({msg:"rotate_extrude.xml"},
Blockscad.showExample);$("#examples_cube_with_cutouts").click({msg:"cube_with_cutouts.xml"},Blockscad.showExample);$("#examples_anthias_fish").click({msg:"anthias_fish.xml"},Blockscad.showExample);$("#examples_hulled_loop_sun").click({msg:"hulled_loop_sun.xml"},Blockscad.showExample);$("#examples_sine_function_with_loop").click({msg:"sine_function_with_loop.xml"},Blockscad.showExample);$("#examples_trefoil_knot_param_eq").click({msg:"trefoil_knot_param_eq.xml"},Blockscad.showExample);$(function(){$(".dropdown-menu > li > a.trigger").on("click",
function(a){var d=$(this).next(),f=$(this).parent().parent();($(this).hasClass("left-caret")||$(this).hasClass("right-caret"))&&$(this).toggleClass("right-caret left-caret");f.find(".left-caret").not(this).toggleClass("right-caret left-caret");f.find(".sub-menu:visible").not(d).hide();d.toggle();a.stopPropagation()});$(".dropdown-menu > li > a:not(.trigger)").on("click",function(){var a=$(this).closest(".dropdown");a.find(".left-caret").toggleClass("right-caret left-caret");a.find(".sub-menu:visible").hide()})});
$("#stl_buttons").hide()};Blockscad.takeRPic=function(){if(null!=Blockscad.gProcessor){var a=Blockscad.gProcessor.takeRotatingPic(1,13);gifshot.createGIF({images:a,interval:.4,gifWidth:Blockscad.picSize[0],gifHeight:Blockscad.picSize[1],sampleInterval:1},function(a){a.error||Blockscad.savePic(a.image,$("#project-name").val()+".gif")})}};
Blockscad.savePic=function(a,b){if(a){var d=atob(a.split(",")[1]);a.split(",")[0].split(":")[1].split(";");for(var f=new ArrayBuffer(d.length),p=new Uint8Array(f),g=0;g<d.length;g++)p[g]=d.charCodeAt(g);d=new Blob([f],{type:"img/jpeg"});saveAs(d,b)}};Blockscad.takePic=function(){if(Blockscad.gProcessor.picviewer){var a=Blockscad.gProcessor.picviewer.takePic(Blockscad.picQuality,0);a&&Blockscad.savePic(a,$("#project-name").val()+".jpg")}};
Blockscad.loadLocalBlocks=function(a){a.target.files.length&&(Blockscad.undo.needToSave?promptForSave().then(function(b){"cancel"!=b&&("nosave"==b?Blockscad.setNoSaveNeeded():"save"==b&&Blockscad.saveBlocks(),Blockscad.createNewProject(),readSingleFile(a,!0))})["catch"](function(a){console.log("caught an error in new project.  result is:"+a)}):(Blockscad.createNewProject(),readSingleFile(a,!0)))};
function readSingleFile(a,b){var d=a.target.files[0];if(d){var f;b&&(f=d.name.substr(0,d.name.lastIndexOf("("))||d.name,f=f.substr(0,d.name.lastIndexOf("."))||f,f=f.replace(/^\s+|\s+$/g,""));b&&(Blockscad.Auth.currentProject="");b&&Blockly.getMainWorkspace().clear();var p={},g=new FileReader;g.onload=function(a){p=a.target.result;a=Blockly.Xml.textToDom(p);Blockly.Xml.domToWorkspace(Blockscad.workspace,a);Blockly.fireUiEvent(window,"resize");Blockscad.clearStlBlocks()};g.readAsText(d);$("#importLocal")[0].value=
"";$("#loadLocal")[0].value="";b&&$("#project-name").val(f);$("#projView").hide();$("#editView").show();Blockscad.offline||$("#bigsavebutton").show();$("#displayBlocks").click();Blockscad.gProcessor.clearViewer()}}
Blockscad.readStlFile=function(a){var b=a.target.files[0];b?(a=new FileReader,a.onload=function(a){a=importSTL(a.target.result);var f=a[0];(a=a[1])||(a="blah");for(var p=b.name.substr(0,b.name.lastIndexOf("("))||b.name,p=p.substr(0,b.name.lastIndexOf("."))||p,g=p=p.replace(/^\s+|\s+$/g,""),k=1,m=0;Blockscad.csg_commands[g]&&!m;)f!=Blockscad.csg_commands[g]?(g=p+"_"+k,k++):m=1;Blockscad.csg_commands[g]=f;Blockscad.csg_filename[g]=m?Blockscad.csg_filename[g]+(b.name+":::"):b.name+":::";Blockscad.csg_center[g]=
a;Blockscad.currentInterestingBlock?(p=Blockscad.currentInterestingBlock.getField("STL_FILENAME"),f=Blockscad.currentInterestingBlock.getField("STL_BUTTON"),k=Blockscad.currentInterestingBlock.getField("STL_CONTENTS"),p.setText(b.name),p.setVisible(!0),f.setVisible(!1),k.setText(g),Blockscad.currentInterestingBlock.setCommentText(b.name+"\ncenter:("+a+")"),Blockscad.currentInterestingBlock=null):(g=Blockly.Xml.textToDom('<xml xmlns="http://blockscad.einsteinsworkshop.com"><block type="stl_import" id="1" x="10" y="10"><field name="STL_FILENAME">'+
b.name+'</field><field name="STL_BUTTON">'+Blockscad.Msg.BROWSE+'</field><field name="STL_CONTENTS">'+g+"</field></block></xml>"),g=Blockly.Xml.domToBlock(Blockscad.workspace,g.firstChild),f=g.getField("STL_BUTTON"),f.setVisible(!1),g.setCommentText(b.name+"\ncenter:("+a+")"),g.render())},a.readAsBinaryString(b),$("#importStl")[0].value="",$("#displayBlocks").click()):alert("Failed to load file")};document.write('<script src="blockly/msg/js/'+BSUtils.LANG+'.js">\x3c/script>\n');
document.write('<script src="blockscad/msg/js/'+BSUtils.LANG+'.js">\x3c/script>\n');window.addEventListener("load",Blockscad.init);
Blockscad.clearStlBlocks=function(){for(var a=Blockscad.workspace.getAllBlocks(),b=0;b<a.length;b++)if("stl_import"==a[b].type){var d=a[b].getField("STL_BUTTON");a[b].getField("STL_CONTENTS").setText("");a[b].getField("STL_FILENAME").setText("");var f=a[b].getCommentText();f.match(/^RELOAD/)||(f="RELOAD: "+f);a[b].setCommentText(f);d.setText("Reload");a[b].backlight();if(f=a[b].collapsedParents())for(var p=0;p<f.length;p++)f[p].backlight();a[b].isCollapsed()||d.setVisible(!0);d=a[b];for(f=null;d;)d.isCollapsed()&&
(f=d),d=d.getSurroundParent();f&&f.setCollapsed(!0,!0);a[b].render();$("#error-message").html(Blockscad.Msg.WARNING_RELOAD_STL)}};Blockscad.newProject=function(){$("#displayBlocks").click();Blockscad.undo.needToSave?promptForSave().then(function(a){"cancel"!=a&&("nosave"==a?Blockscad.setNoSaveNeeded():"save"==a&&Blockscad.saveBlocks(),Blockscad.createNewProject())})["catch"](function(a){console.log("caught an error in new project.  result is:"+a)}):Blockscad.createNewProject()};
Blockscad.createNewProject=function(){Blockscad.clearProject();Blockscad.workspaceChanged();Blockscad.clearUndo();setTimeout(Blockscad.setNoSaveNeeded,300);$("#displayBlocks").click();Blockscad.offline||$("#bigsavebutton").show()};
function promptForSave(){var a="<h4>"+Blockscad.Msg.SAVE_PROMPT+"</h4>";return new Promise(function(b,d){bootbox.dialog({message:a,backdrop:!0,size:"small",buttons:{save:{label:Blockscad.Msg.SAVE_PROMPT_YES,className:"btn-default btn-lg primary pull-right giant-yes",callback:function(a){b("save")}},dont_save:{label:Blockscad.Msg.SAVE_PROMPT_NO,className:"btn-default btn-lg primary pull-left giant-yes",callback:function(a){b("nosave")}}},onEscape:function(){b("cancel")}})})}
Blockscad.saveBlocks=function(){!Blockscad.offline&&Blockscad.Auth.isLoggedIn?Blockscad.Auth.saveBlocksToAccount():Blockscad.saveBlocksLocal()};
Blockscad.showExample=function(a){var b="examples/"+a.data.msg,d=a.data.msg.split(".")[0],f="example_"+d;Blockscad.undo.needToSave?promptForSave().then(function(a){"cancel"!=a&&("nosave"==a?Blockscad.setNoSaveNeeded():"save"==a&&Blockscad.saveBlocks(),Blockscad.getExample(b,d,f))})["catch"](function(a){console.log("caught an error in show example 1.  result is:"+a)}):Blockscad.getExample(b,d,f)};
Blockscad.getExample=function(a,b,d){$.get(a,function(a){Blockscad.clearProject();Blockscad.workspaceChanged();a=Blockly.Xml.textToDom(Blockscad[d]);Blockly.Xml.domToWorkspace(Blockscad.workspace,a);Blockly.fireUiEvent(window,"resize");$("#project-name").val(b+" example");setTimeout(Blockscad.setNoSaveNeeded,300)})};Blockscad.setNoSaveNeeded=function(){Blockscad.undo.needToSave=0};
Blockscad.clearProject=function(){Blockscad.offline||(Blockscad.Auth.currentProject="",Blockscad.Auth.currentProjectKey="");Blockscad.workspace.clear();Blockscad.gProcessor.clearViewer();$("#project-name").val(Blockscad.Msg.PROJECT_NAME_DEFAULT);$("#projectView").hide();$("#editView").show();$("#bigsavebutton").show()};Blockscad.clearUndo=function(){for(;Blockscad.undo.undoStack.length;)Blockscad.undo.undoStack.pop();for(;Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop()};
Blockscad.discard=function(){var a=Blockly.mainWorkspace.getAllBlocks().length;2>a?(Blockly.mainWorkspace.clear(),window.location.hash=""):(a=Blockscad.Msg.DISCARD_ALL.replace("%1",a),bootbox.confirm({size:"small",message:a,buttons:{confirm:{label:Blockscad.Msg.CONFIRM_DIALOG_YES,className:"btn-default confirm-yes"},cancel:{label:Blockscad.Msg.CONFIRM_DIALOG_NO,className:"btn-default confirm-yes"}},callback:function(a){a&&(Blockly.mainWorkspace.clear(),window.location.hash="")}}))};
Blockscad.resetView=function(){null!=Blockscad.gProcessor&&(Blockscad.gProcessor.viewer&&Blockscad.gProcessor.viewer.viewReset(),Blockscad.gProcessor.picviewer&&Blockscad.gProcessor.picviewer.viewReset())};
Blockscad.mixes2and3D=function(){var a;a=Blockly.mainWorkspace.getTopBlocks();for(var b=0,d=0,f=0,p=0,g=0;g<a.length;g++)if(Blockscad.stackIsShape(a[g])){var p=1,k=a[g].category,m;"PRIMITIVE_CSG"==k&&b++;"PRIMITIVE_CAG"==k&&d++;if("TRANSFORM"==k||"SET_OP"==k)m=a[g].getInput("A").connection.check_,1==m.length&&"CSG"==m[0]&&b++,1==m.length&&"CAG"==m[0]&&d++;"LOOP"==k&&(m=a[g].getInput("DO").connection.check_,1==m.length&&"CSG"==m[0]&&b++,1==m.length&&"CAG"==m[0]&&d++);"COLOR"==k&&b++;"EXTRUDE"==k&&
b++;"controls_if"==a[g].type&&f++}!p||b+d+f||Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks());return[b&&d,p]};
Blockscad.doRender=function(){$("#error-message").html("");$("#error-message").removeClass("has-error");$("#renderButton").prop("disabled",!0);Blockscad.gProcessor.clearViewer();var a=Blockscad.mixes2and3D();if(0===a[1])$("#error-message").html(Blockscad.Msg.ERROR_MESSAGE+": "+Blockscad.Msg.RENDER_ERROR_EMPTY),$("#error-message").addClass("has-error"),$("#renderButton").prop("disabled",!1);else if(a[0])$("#error-message").html(Blockscad.Msg.ERROR_MESSAGE+": "+Blockscad.Msg.RENDER_ERROR_MIXED),$("#error-message").addClass("has-error"),
$("#renderButton").prop("disabled",!1);else{Blockscad.missingFields=[];Blockscad.illegalValue=[];var a=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace),b=!1;if(0<Blockscad.missingFields.length)for(var d=0;d<Blockscad.missingFields.length;d++){b=Blockly.mainWorkspace.getBlockById(Blockscad.missingFields[d]);b.unselect();b.backlight();if(b=b.collapsedParents())for(var f=0;f<b.length;f++)b[f].unselect(),b[f].backlight();b=!0}if(0<Blockscad.illegalValue.length){for(d=0;d<Blockscad.illegalValue.length;d++)if(b=
Blockly.mainWorkspace.getBlockById(Blockscad.illegalValue[d]),b.unselect(),b.backlight(),b=b.collapsedParents())for(f=0;f<b.length;f++)b[f].unselect(),b[f].backlight();b=!0}if(b)a="",Blockscad.missingFields.length&&(d=Blockscad.Msg.ERROR_MESSAGE+": "+Blockscad.Msg.PARSING_ERROR_MISSING_FIELDS,a=d.replace("%1",Blockscad.missingFields.length+" ")),Blockscad.missingFields.length&&Blockscad.illegalValue.length&&(a+="<br>"),Blockscad.illegalValue.length&&(d=Blockscad.Msg.ERROR_MESSAGE+": "+Blockscad.Msg.PARSING_ERROR_ILLEGAL_VALUE,
a+=d.replace("%1",Blockscad.illegalValue.length+" ")),$("#error-message").html(a),$("#error-message").addClass("has-error"),$("#renderButton").prop("disabled",!1);else if(Blockscad.loadTheseFonts=Blockscad.whichFonts(a),$("#renderButton").html("working"),0<Blockscad.loadTheseFonts.length)for(d=Blockscad.numloaded=0;d<Blockscad.loadTheseFonts.length;d++)Blockscad.loadFontThenRender(d,a);else Blockscad.renderCode(a)}};
Blockscad.renderCode=function(a){var b="",d=!0;try{window.setTimeout(function(){b=openscadOpenJscadParser.parse(a)},0)}catch(f){$("#error-message").html(f),$("#error-message").addClass("has-error"),d=!1}d?window.setTimeout(function(){Blockscad.gProcessor.setBlockscad(b)},0):$("#renderButton").html(Blockscad.Msg.RENDER_BUTTON)};
Blockscad.isRealChange=function(){Blockscad.undo.blockIds=[];Blockscad.undo.parentIds=[];Blockscad.undo.fieldValues=[];Blockscad.undo.isDisabled=[];Blockscad.undo.varNames=[];Blockscad.undo.comment=[];Blockscad.undo.projectName=$("#project-name").val();Blockscad.undo.triggerRender=!1;var a,b,d=!1;Blockscad.undo.projectName!=Blockscad.undo.oldProjectName&&(Blockscad.undo.needToSave=1);for(b=0;b<Blockscad.undo.blockList.length;b++)Blockscad.undo.fieldValues[b]=Blockscad.undo.blockList[b].getAllFieldValues(),
Blockscad.undo.blockIds[b]=Blockscad.undo.blockList[b].id,Blockscad.undo.isDisabled[b]=Blockscad.undo.blockList[b].disabled,Blockscad.undo.comment[b]=Blockscad.undo.blockList[b].getCommentText(),Blockscad.undo.varNames[b]="variables_set"==Blockscad.undo.blockList[b].type||"variables_get"==Blockscad.undo.blockList[b].type?Blockscad.undo.blockList[b].getFieldValue("VAR"):null,Blockscad.undo.blockList[b].getParent()?Blockscad.undo.parentIds[b]=Blockscad.undo.blockList[b].getParent().id:Blockscad.undo.parentIds[b]=
null,Blockscad.undo.blockList[b].category&&"UNKNOWN"==Blockscad.undo.blockList[b].category&&Blockscad.undo.blockList[b].getType();if(Blockscad.undo.blockCount>Blockscad.undo.blockList.length){Blockscad.undo.fieldChanging=0;if(0!==Blockscad.undo.blockList.length){a=Blockscad.getExtraRootBlock(Blockscad.undo.oldBlockList,Blockscad.undo.blockList);if(b=Blockscad.getBlockFromId(Blockscad.undo.oldParentIds[a],Blockscad.undo.blockList))Blockscad.assignBlockTypes([b]),"variables_set"==b.type&&Blockscad.assignVarTypes(b);
if(null!=Blockscad.undo.oldVarNames[a])for(a=Blockly.Variables.getInstances(Blockscad.undo.oldVarNames[a],Blockscad.workspace),b=0;a&&b<a.length;b++)"variables_get"==a[b].type&&Blockscad.assignVarTypes(a[b])}Blockscad.undo.needToSave=1;return Blockscad.undo.triggerRender=!0}if(Blockscad.undo.blockCount<Blockscad.undo.blockList.length){Blockscad.undo.fieldChanging=0;if(0===Blockscad.undo.oldBlockList.length)for(Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks()),a=Blockly.mainWorkspace.getAllBlocks(),
b=0;b<a.length;b++)"variables_set"==a[b].type&&Blockscad.assignVarTypes(a[b]);else a=Blockscad.getExtraRootBlock(Blockscad.undo.oldBlockList,Blockscad.undo.blockList),Blockscad.assignBlockTypes([Blockscad.undo.blockList[a]]),(b=Blockscad.undo.blockList[a].getParent())&&"variables_set"==b.type&&Blockscad.assignVarTypes(b),"variables_set"==Blockscad.undo.blockList[a].type&&Blockscad.assignVarTypes(Blockscad.undo.blockList[a]);Blockscad.undo.needToSave=1;return Blockscad.undo.triggerRender=!0}for(b=
0;b<Blockscad.undo.blockIds.length;b++){var f=Blockscad.undo.blockIds[b],p=0;for(a=0;a<Blockscad.undo.blockIds.length;a++)if(f==Blockscad.undo.oldBlockIds[a]){p=1;if(Blockscad.undo.parentIds[b]!=Blockscad.undo.oldParentIds[a]){Blockscad.undo.needToSave=1;Blockscad.undo.triggerRender=!0;Blockscad.assignBlockTypes([Blockscad.undo.blockList[b]]);(b=Blockscad.undo.blockList[b].getParent())&&"variables_set"==b.type&&Blockscad.assignVarTypes(b);for(b=0;d=Blockscad.undo.blockList[b];b++)if(d.id==Blockscad.undo.oldParentIds[a]){Blockscad.assignBlockTypes([Blockscad.undo.blockList[b]]);
"variables_set"==Blockscad.undo.blockList[b].type&&Blockscad.assignVarTypes(Blockscad.undo.blockList[b]);break}return!0}Blockscad.undo.varNames[b]!=Blockscad.undo.oldVarNames[a]&&(Blockscad.undo.fieldChanging=0,Blockscad.assignVarTypes(Blockscad.undo.blockList[b]),Blockscad.undo.needToSave=1,Blockscad.undo.triggerRender=!0);Blockscad.undo.fieldValues[b]!=Blockscad.undo.oldFieldValues[a]&&($("#renderButton").prop("disabled",!1),Blockscad.undo.fieldChanging=1,Blockscad.undo.needToSave=1);if(Blockscad.undo.fieldChanging&&
Blockscad.undo.editorClosed)return Blockscad.undo.fieldChanging=0,Blockscad.undo.triggerRender=!0;Blockscad.undo.isDisabled[b]!=Blockscad.undo.oldDisabled[a]&&(d=!0,Blockscad.undo.triggerRender=!0);Blockscad.undo.comment[b]!=Blockscad.undo.oldComment[a]&&(Blockscad.undo.needToSave=1)}if(!p)return!0}return d?(Blockscad.undo.needToSave=1,!0):!1};
Blockscad.workspaceChanged=function(){Blockscad.undo.yesthis=0;Blockscad.undo.blockList=Blockly.mainWorkspace.getAllBlocks();Blockscad.undo.yesthis=Blockscad.isRealChange();Blockscad.undo.blockCount=Blockscad.undo.blockList.length;Blockscad.undo.oldBlockIds=Blockscad.undo.blockIds;Blockscad.undo.oldParentIds=Blockscad.undo.parentIds;Blockscad.undo.oldFieldValues=Blockscad.undo.fieldValues;Blockscad.undo.oldDisabled=Blockscad.undo.isDisabled;Blockscad.undo.oldComment=Blockscad.undo.comment;Blockscad.undo.oldProjectName=
Blockscad.undo.projectName;Blockscad.undo.oldVarNames=Blockscad.undo.varNames;if(Blockscad.undo.yesthis){Blockscad.undo.needToSave&&0==Blockscad.undo.blockCount&&Blockscad.setNoSaveNeeded();$("#renderButton").prop("disabled",!1);Blockscad.undo.just_did_undo&&Blockscad.assignBlockTypes(Blockly.mainWorkspace.getTopBlocks());if(0===Blockscad.undo.just_did_undo){null!==Blockscad.undo.current_xml&&Blockscad.undo.undoStack.push(Blockscad.undo.current_xml);for(Blockscad.undo.current_xml=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());0<
Blockscad.undo.redoStack.length;)Blockscad.undo.redoStack.pop();50<Blockscad.undo.undoStack.length&&Blockscad.undo.undoStack.shift()}Blockly.Xml.domToText(Blockscad.undo.current_xml);BlocklyStorage.autosaveBlocks(Blockly.Xml.domToText(Blockscad.undo.current_xml))}Blockscad.undo.current_xml=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace());Blockscad.undo.oldBlockList=[];for(var a=0;a<Blockscad.undo.blockList.length;a++)Blockscad.undo.oldBlockList.push(Blockly.Xml.blockToDom_(Blockscad.undo.blockList[a]));
Blockscad.undo.just_did_undo=0;0<Blockscad.undo.undoStack.length?$("#undoButton").prop("disabled",!1):$("#undoButton").prop("disabled",!0);0<Blockscad.undo.redoStack.length?$("#redoButton").prop("disabled",!1):$("#redoButton").prop("disabled",!0)};
Blockscad.getExtraRootBlock=function(a,b){var d;if(a.length>b.length)for(var f=0;f<a.length;f++){for(var p=d=0;p<b.length;p++)if(a[f].getAttribute("id")==b[p].id){d=1;break}if(!d)return f}else for(f=0;f<b.length;f++){for(p=d=0;p<a.length;p++)if(b[f].id==a[p].getAttribute("id")){d=1;break}if(!d)return f}return 0};Blockscad.getBlockFromId=function(a,b){for(var d=0,f;f=b[d];d++)if(f.id==a)return f;return null};
Blockscad.onUndo=function(){0<Blockscad.undo.undoStack.length&&(Blockscad.undo.redoStack.push(Blockscad.undo.current_xml),Blockscad.undo.current_xml=Blockscad.undo.undoStack.pop(),Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(Blockscad.workspace,Blockscad.undo.current_xml),Blockly.mainWorkspace.render(),Blockscad.undo.just_did_undo=1)};
Blockscad.onRedo=function(){0<Blockscad.undo.redoStack.length&&(Blockscad.undo.undoStack.push(Blockscad.undo.current_xml),Blockscad.undo.current_xml=Blockscad.undo.redoStack.pop(),Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(Blockscad.workspace,Blockscad.undo.current_xml),Blockly.mainWorkspace.render(),Blockscad.undo.just_did_undo=1)};Blockscad.aCallerBlock=function(a,b){for(var d=0;d<b.length;d++)if(a==b[d])return!0;return!1};
Blockscad.findBlockType=function(a,b){for(var d=a.getRootBlock().getDescendants(),f=0,p=0,g=0;g<d.length;g++)if(!Blockscad.aCallerBlock(d[g],b)&&d[g].category){var k=d[g].category;if("PRIMITIVE_CSG"==k||"EXTRUDE"==k||"COLOR"==k){f=1;break}"PRIMITIVE_CAG"==k&&(p=1)}return f?Blockscad.hasExtrudeParent(a)?"CAG":"CSG":p?"CAG":"EITHER"};Blockscad.stackIsShape=function(a){a=a.getDescendants();for(var b=0;b<a.length;b++){var d=a[b];if(("PRIMITIVE_CSG"==d.category||"PRIMITIVE_CAG"==d.category)&&!d.hasDisabledParent())return!0}return!1};
Blockscad.assignVarTypes=function(a){if("variables_get"==a.type){for(var b=Blockly.Variables.getInstances(a.getFieldValue("VAR"),this.workspace),d=0,f=0;f<b.length;f++){if("variables_set"==b[f].type){a.outputConnection.setCheck(b[f].myType_);d=1;break}if("controls_for"==b[f].type||"controls_for_chainhull"==b[f].type){a.outputConnection.setCheck(null);d=1;break}}d||a.outputConnection.setCheck(null);(a=a.getParent())&&"variables_set"==a.type&&Blockscad.assignVarTypes(a)}else if("variables_set"==a.type)if(b=
a.getChildren(),0==b.length)a.setType(null);else{for(f=d=0;f<b.length;f++)b[f].outputConnection&&(a.setType(b[f].outputConnection.check_),d=1);0==d&&a.setType(null)}};
Blockscad.assignBlockTypes=function(a){for(var b=0;b<a.length;b++){for(var d=a[b].getRootBlock().getDescendants(),f=0,p=0,g=0;g<d.length;g++)if(d[g].category){var k=d[g].category;if("PRIMITIVE_CSG"==k||"EXTRUDE"==k||"COLOR"==k){f=1;break}"PRIMITIVE_CAG"==k&&(p=1)}for(g=0;g<d.length;g++)!d[g].category||"TRANSFORM"!=d[g].category&&"SET_OP"!=d[g].category&&"PROCEDURE"!=d[g].category&&"LOOP"!=d[g].category||(k=!d[g].collapsedParents(),f?Blockscad.hasExtrudeParent(d[g])?d[g].setType("CAG",k):d[g].setType("CSG",
k):p?d[g].setType("CAG",k):d[g].setType(["CSG","CAG"],k))}};Blockscad.hasExtrudeParent=function(a){do{if("EXTRUDE"==a.category)return!0;a=a.parentBlock_}while(a);return!1};
Blockscad.initLanguage=function(){var a=BSUtils.isRtl();document.head.parentElement.setAttribute("dir",a?"rtl":"ltr");document.head.parentElement.setAttribute("lang",BSUtils.LANG);var a=[],b;for(b in BSUtils.LANGUAGE_NAME)a.push([BSUtils.LANGUAGE_NAME[b],b]);a.sort(function(a,b){return a[0]>b[0]?1:a[0]<b[0]?-1:0});b=[];for(var d=0;d<a.length;d++)b.push('<li><a href="#" class="lang-option" data-lang="'+a[d][1]+'"</a>'+a[d][0]+"</li>");$("#languageMenu").append(b.join(""));$(".lang-option").on("click",
BSUtils.changeLanguage)};Blockscad.saveBlocksLocal=function(){var a=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),a=Blockly.Xml.domToText(a),a=new Blob([a],{type:"text/plain;charset=utf-8"}),b=$("#project-name").val();b?(saveAs(a,b+".xml"),Blockscad.setNoSaveNeeded()):alert(Blockscad.Msg.SAVE_FAILED+"!\n"+Blockscad.Msg.SAVE_FAILED_PROJECT_NAME)};Blockscad.savePicLocal=function(a){a=new Blob([a],{type:"img/jpeg"});saveAs(a,"tryThis.jpg")};
Blockscad.saveOpenscadLocal=function(){var a=Blockly.OpenSCAD.workspaceToCode(Blockscad.workspace),a=new Blob([a],{type:"text/plain;charset=utf-8"}),b=$("#project-name").val();b?saveAs(a,b+".scad"):alert("SAVE FAILED.  Please give your project a name, then try again.")};var saveAs=saveAs||function(a){if(!("undefined"===typeof a||"undefined"!==typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document.createElementNS("http://www.w3.org/1999/xhtml","a"),d="download"in b,f=/constructor/i.test(a.HTMLElement),p=function(b){(a.setImmediate||a.setTimeout)(function(){throw b;},0)},g=function(b){setTimeout(function(){"string"===typeof b?(a.URL||a.webkitURL||a).revokeObjectURL(b):b.remove()},4E4)},k=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?
new Blob([String.fromCharCode(65279),a],{type:a.type}):a},m=function(q,m,l){l||(q=k(q));var r=this,v="application/octet-stream"===q.type,n,y=function(){for(var a=["writestart","progress","write","writeend"],a=[].concat(a),b=a.length;b--;){var d=r["on"+a[b]];if("function"===typeof d)try{d.call(r,r)}catch(g){p(g)}}};l=function(){if(v&&f&&a.FileReader){var b=new FileReader;b.onloadend=function(){var d=b.result;a.location.href="data:attachment/file"+d.slice(d.search(/[,;]/));r.readyState=r.DONE;y()};
b.readAsDataURL(q);r.readyState=r.INIT}else n||(n=(a.URL||a.webkitURL||a).createObjectURL(q)),v?a.location.href=n:a.open(n,"_blank")||(a.location.href=n),r.readyState=r.DONE,y(),g(n)};r.readyState=r.INIT;d?(n=(a.URL||a.webkitURL||a).createObjectURL(q),setTimeout(function(){b.href=n;b.download=m;var a=new MouseEvent("click");b.dispatchEvent(a);y();g(n);r.readyState=r.DONE})):l()},v=m.prototype;if("undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob)return function(a,b,d){b=b||a.name||"download";
d||(a=k(a));return navigator.msSaveOrOpenBlob(a,b)};v.abort=function(){};v.readyState=v.INIT=0;v.WRITING=1;v.DONE=2;v.error=v.onwritestart=v.onprogress=v.onwrite=v.onabort=v.onerror=v.onwriteend=null;return function(a,b,d){return new m(a,b||a.name||"download",d)}}}("undefined"!==typeof self&&self||"undefined"!==typeof window&&window||this.content);"undefined"!==typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!==typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs});Blockscad=Blockscad||{};Blockscad.fonts={};Blockscad.fontList="/fonts/Roboto/Roboto-Bold.ttf /fonts/liberation/LiberationSerif-Bold.ttf /fonts/nimbus/nimbus-sans-l_bold.ttf /fonts/AverageMono/AverageMonoSimp.ttf /fonts/Open_Sans/OpenSans-ExtraBold.ttf /fonts/stardos-stencil/StardosStencil-Bold.ttf /fonts/Chewy/Chewy.ttf /fonts/bangers/Bangers.ttf".split(" ");Blockscad.fontName="Roboto;Liberation Serif;Nimbus Sans;Average Mono;Open Sans;Stardos Stencil;Chewy;Bangers".split(";");
Blockscad.loadFonts=function(){for(var a=0;a<Blockscad.fontList.length;a++)Blockscad.loadFont(a)};Blockscad.loadFont=function(a){opentype.load(Blockscad.fontList[a],function(b,d){if(b)console.log("Could not load font: ",d+":"+b);else return Blockscad.fonts[Blockscad.fontName[a]]=d})};
Blockscad.loadFontThenRender=function(a,b){try{var d=Blockscad.fontName[Blockscad.loadTheseFonts[a]];opentype.load(Blockscad.fontList[Blockscad.loadTheseFonts[a]],function(f,p){f?(console.log("Could not load font: ",p+":"+f),$("#error-message").html("Error: Failed to load font: "+d),$("#error-message").addClass("has-error"),$("#renderButton").html("Render"),$("#renderButton").prop("disabled",!1)):(Blockscad.fonts[Blockscad.fontName[Blockscad.loadTheseFonts[a]]]=p,Blockscad.numloaded++,Blockscad.numloaded==
Blockscad.loadTheseFonts.length&&Blockscad.renderCode(b))})}catch(f){console.log("network error loading font")}};
Blockscad.pathToPoints=function(a,b){var d=[],f=[],p=[],g=2,k,m,v,q,t,l;2<b&&(g=b);10<g&&(g=10);if(a&&a.commands&&0<a.commands.length)for(var r=0,D=[],n=0;n<a.commands.length;n++)switch(a.commands[n].type){case "M":2<p.length&&f.push(p);p=[];d.push([a.commands[n].x,-1*a.commands[n].y]);p.push(r++);D=[a.commands[n].x,-1*a.commands[n].y];break;case "L":d.push([a.commands[n].x,-1*a.commands[n].y]);p.push(r++);D=[a.commands[n].x,-1*a.commands[n].y];break;case "C":k=[a.commands[n].x,-1*a.commands[n].y];
m=[a.commands[n].x1,-1*a.commands[n].y1];v=[a.commands[n].x2,-1*a.commands[n].y2];for(var y=1;y<=g;y++)l=y/g,q=D[1]*Math.pow(1-l,3)+3*m[1]*Math.pow(1-l,2)*l+3*v[1]*Math.pow(1-l,1)*l*l+k[1]*Math.pow(l,3),d.push([q,t]),p.push(r++);D=k;break;case "Q":k=[a.commands[n].x,-1*a.commands[n].y];m=[a.commands[n].x1,-1*a.commands[n].y1];for(y=1;y<=g;y++)l=y/g,q=D[0]*Math.pow(1-l,2)+2*m[0]*Math.pow(1-l,1)*l+k[0]*Math.pow(l,2),t=D[1]*Math.pow(1-l,2)+2*m[1]*Math.pow(1-l,1)*l+k[1]*Math.pow(l,2),d.push([q,t]),p.push(r++);
D=k;break;case "Z":2<p.length&&(f.push(p),p=[])}3>d.length&&(d=[]);return[d,f]};Blockscad.whichFonts=function(a){for(var b=[],d=0;d<Blockscad.fontList.length;d++)-1<a.indexOf(Blockscad.fontName[d])&&(Blockscad.fonts[Blockscad.fontName[d]]||b.push(d));return b};var GL=function(){function a(h,a,c){c=c||{};this.id=e.createTexture();this.width=h;this.height=a;this.format=c.format||e.RGBA;this.type=c.type||e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,this.id);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,c.filter||c.magFilter||e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,c.filter||c.minFilter||e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,c.wrap||c.wrapS||e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,
e.TEXTURE_WRAP_T,c.wrap||c.wrapT||e.CLAMP_TO_EDGE);e.texImage2D(e.TEXTURE_2D,0,this.format,h,a,0,this.format,this.type,null)}function b(){this.unique=[];this.indices=[];this.map={}}function d(h,a){this.buffer=null;this.target=h;this.type=a;this.data=[]}function f(h){h=h||{};this.vertexBuffers={};this.indexBuffers={};this.addVertexBuffer("vertices","gl_Vertex");h.coords&&this.addVertexBuffer("coords","gl_TexCoord");h.normals&&this.addVertexBuffer("normals","gl_Normal");h.colors&&this.addVertexBuffer("colors",
"gl_Color");"triangles"in h&&!h.triangles||this.addIndexBuffer("triangles");h.lines&&this.addIndexBuffer("lines")}function p(h){return new g(2*(h&1)-1,(h&2)-1,(h&4)/2-1)}function g(h,a,c){this.x=h||0;this.y=a||0;this.z=c||0}function k(h,a,c){for(var b;null!==(b=h.exec(a));)c(b)}function m(h,a){function c(c){var h=document.getElementById(c);return h?h.text:c}function b(c,h){var a={},u=/^((\s*\/\/.*\n|\s*#extension.*\n)+)\^*$/.exec(h);h=u?u[1]+c+h.substr(u[1].length):c+h;k(/\bgl_\w+\b/g,c,function(c){c in
a||(h=h.replace(new RegExp("\\b"+c+"\\b","g"),"LIGHTGL"+c),a[c]=!0)});return h}function d(c,h){var a=e.createShader(c);e.shaderSource(a,h);e.compileShader(a);if(!e.getShaderParameter(a,e.COMPILE_STATUS))throw"compile error: "+e.getShaderInfoLog(a);return a}h=c(h);a=c(a);var g=h+a,f={};k(/\b(gl_[^;]*)\b;/g,"uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;",
function(c){c=c[1];if(-1!=g.indexOf(c)){var h=c.replace(/[a-z_]/g,"");f[h]="LIGHTGL"+c}});-1!=g.indexOf("ftransform")&&(f.MVPM="LIGHTGLgl_ModelViewProjectionMatrix");this.usedMatrices=f;h=b("uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;attribute vec4 gl_Vertex;attribute vec4 gl_TexCoord;attribute vec3 gl_Normal;attribute vec4 gl_Color;vec4 ftransform() {  return gl_ModelViewProjectionMatrix * gl_Vertex;}",
h);a=b("precision highp float;uniform mat3 gl_NormalMatrix;uniform mat4 gl_ModelViewMatrix;uniform mat4 gl_ProjectionMatrix;uniform mat4 gl_ModelViewProjectionMatrix;uniform mat4 gl_ModelViewMatrixInverse;uniform mat4 gl_ProjectionMatrixInverse;uniform mat4 gl_ModelViewProjectionMatrixInverse;",a);this.program=e.createProgram();e.attachShader(this.program,d(e.VERTEX_SHADER,h));e.attachShader(this.program,d(e.FRAGMENT_SHADER,a));e.linkProgram(this.program);if(!e.getProgramParameter(this.program,e.LINK_STATUS))throw"link error: "+
e.getProgramInfoLog(this.program);this.attributes={};this.uniformLocations={};var P={};k(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,h+a,function(c){P[c[2]]=1});this.isSampler=P}function v(){e.MODELVIEW=T|1;e.PROJECTION=T|2;var h=new n,a=new n;e.modelviewMatrix=new n;e.projectionMatrix=new n;var c=[],b=[],d,f;e.matrixMode=function(h){switch(h){case e.MODELVIEW:d="modelviewMatrix";f=c;break;case e.PROJECTION:d="projectionMatrix";f=b;break;default:throw"invalid matrix mode "+h;}};e.loadIdentity=
function(){n.identity(e[d])};e.loadMatrix=function(c){c=c.m;for(var h=e[d].m,a=0;16>a;a++)h[a]=c[a]};e.multMatrix=function(c){e.loadMatrix(n.multiply(e[d],c,a))};e.perspective=function(c,a,u,b){e.multMatrix(n.perspective(c,a,u,b,h))};e.frustum=function(c,a,u,b,d,x){e.multMatrix(n.frustum(c,a,u,b,d,x,h))};e.ortho=function(c,a,u,b,d,x){e.multMatrix(n.ortho(c,a,u,b,d,x,h))};e.scale=function(c,a,u){e.multMatrix(n.scale(c,a,u,h))};e.translate=function(c,a,u){e.multMatrix(n.translate(c,a,u,h))};e.rotate=
function(c,a,u,b){e.multMatrix(n.rotate(c,a,u,b,h))};e.lookAt=function(c,a,u,b,d,x,f,g,C){e.multMatrix(n.lookAt(c,a,u,b,d,x,f,g,C,h))};e.pushMatrix=function(){f.push(Array.prototype.slice.call(e[d].m))};e.popMatrix=function(){var c=f.pop();e[d].m=N?new Float32Array(c):c};e.project=function(c,h,a,u,b,d){u=u||e.modelviewMatrix;b=b||e.projectionMatrix;d=d||e.getParameter(e.VIEWPORT);c=b.transformPoint(u.transformPoint(new g(c,h,a)));return new g(d[0]+d[2]*(.5*c.x+.5),d[1]+d[3]*(.5*c.y+.5),.5*c.z+.5)};
e.unProject=function(c,b,d,x,f,C){x=x||e.modelviewMatrix;f=f||e.projectionMatrix;C=C||e.getParameter(e.VIEWPORT);c=new g((c-C[0])/C[2]*2-1,(b-C[1])/C[3]*2-1,2*d-1);return n.inverse(n.multiply(f,x,h),a).transformPoint(c)};e.matrixMode(e.MODELVIEW)}function q(){var h=new f({coords:!0,colors:!0,triangles:!1}),a=-1,c=[0,0,0,0],b=[1,1,1,1],d=new m("uniform float pointSize;varying vec4 color;varying vec4 coord;void main() {color = gl_Color;coord = gl_TexCoord;gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;gl_PointSize = pointSize;}",
"uniform sampler2D texture;uniform float pointSize;uniform bool useTexture;varying vec4 color;varying vec4 coord;void main() {gl_FragColor = color;if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);}");e.pointSize=function(c){d.uniforms({pointSize:c})};e.begin=function(c){if(-1!=a)throw"mismatched gl.begin() and gl.end() calls";a=c;h.colors=[];h.coords=[];h.vertices=[]};e.color=function(c,h,a,u){b=1==arguments.length?c.toArray().concat(1):[c,h,a,u||1]};e.texCoord=function(h,a){c=1==arguments.length?
h.toArray(2):[h,a]};e.vertex=function(a,u,d){h.colors.push(b);h.coords.push(c);h.vertices.push(1==arguments.length?a.toArray():[a,u,d])};e.end=function(){if(-1==a)throw"mismatched gl.begin() and gl.end() calls";h.compile();d.uniforms({useTexture:!!e.getParameter(e.TEXTURE_BINDING_2D)}).draw(h,a);a=-1}}function t(){function h(){for(var c in F)if(r.call(F,c)&&F[c])return!0;return!1}function a(c){var u={},b;for(b in c)u[b]="function"==typeof c[b]?function(h){return function(){h.apply(c,arguments)}}(c[b]):
c[b];u.original=c;u.x=u.pageX;u.y=u.pageY;for(b=e.canvas;b;b=b.offsetParent)u.x-=b.offsetLeft,u.y-=b.offsetTop;l?(u.deltaX=u.x-n,u.deltaY=u.y-z):(u.deltaX=0,u.deltaY=0,l=!0);n=u.x;z=u.y;u.dragging=h();u.preventDefault=function(){u.original.preventDefault()};u.stopPropagation=function(){u.original.stopPropagation()};return u}function c(c){var h={},a;for(a in c)h[a]="function"==typeof c[a]?function(h){return function(){h.apply(c,arguments)}}(c[a]):c[a];h.original=c;if(0<h.targetTouches.length){a=h.targetTouches[0];
h.x=a.pageX;h.y=a.pageY;for(a=e.canvas;a;a=a.offsetParent)h.x-=a.offsetLeft,h.y-=a.offsetTop;l?(h.deltaX=h.x-n,h.deltaY=h.y-z):(h.deltaX=0,h.deltaY=0,l=!0);n=h.x;z=h.y;h.dragging=!0}h.preventDefault=function(){h.original.preventDefault()};h.stopPropagation=function(){h.original.stopPropagation()};return h}function b(c){e=q;c=a(c);if(e.onmousemove)e.onmousemove(c);c.preventDefault()}function d(c){e=q;F[c.which]=!1;h()||(document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",
d),e.canvas.addEventListener("mousemove",b),e.canvas.addEventListener("mouseup",d));c=a(c);if(e.onmouseup)e.onmouseup(c);c.preventDefault()}function f(c){e=q;c=a(c);if(e.onmousewheel)e.onmousewheel(c);c.preventDefault()}function g(h){e=q;0===h.targetTouches.length&&k(h);h=c(h);if(e.ontouchmove)e.ontouchmove(h);h.preventDefault()}function k(h){document.removeEventListener("touchmove",g);document.removeEventListener("touchend",k);e.canvas.addEventListener("touchmove",g);e.canvas.addEventListener("touchend",
k);e=q;h=c(h);if(e.ontouchend)e.ontouchend(h);h.preventDefault()}function m(){l=!1}function p(){F={};l=!1}var q=e,n=0,z=0,F={},l=!1,r=Object.prototype.hasOwnProperty;e.canvas.addEventListener("mousedown",function(c){e=q;h()||(document.addEventListener("mousemove",b),document.addEventListener("mouseup",d),e.canvas.removeEventListener("mousemove",b),e.canvas.removeEventListener("mouseup",d));F[c.which]=!0;c=a(c);if(e.onmousedown)e.onmousedown(c);c.preventDefault()});e.canvas.addEventListener("mousemove",
b);e.canvas.addEventListener("mouseup",d);e.canvas.addEventListener("mousewheel",f);e.canvas.addEventListener("DOMMouseScroll",f);e.canvas.addEventListener("mouseover",m);e.canvas.addEventListener("mouseout",m);e.canvas.addEventListener("touchstart",function(h){p();document.addEventListener("touchmove",g);document.addEventListener("touchend",k);e.canvas.removeEventListener("touchmove",g);e.canvas.removeEventListener("touchend",k);e=q;h=c(h);if(e.ontouchstart)e.ontouchstart(h);h.preventDefault()});
e.canvas.addEventListener("touchmove",g);e.canvas.addEventListener("touchend",k);document.addEventListener("contextmenu",p)}function l(h){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[h]||(65<=h&&90>=h?String.fromCharCode(h):null)}function r(h,a,c){h.addEventListener(a,c)}function D(){(function(h){e.makeCurrent=function(){e=h}})(e);e.animate=function(){function h(){e=b;var d=(new Date).getTime();if(e.onupdate)e.onupdate((d-c)/1E3);
if(e.ondraw)e.ondraw();a(h);c=d}var a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(c){setTimeout(c,1E3/60)},c=(new Date).getTime(),b=e;h()};e.fullscreen=function(h){function a(){e.canvas.width=window.innerWidth-b-d;e.canvas.height=window.innerHeight-c-f;e.viewport(0,0,e.canvas.width,e.canvas.height);!h.camera&&"camera"in h||(e.matrixMode(e.PROJECTION),e.loadIdentity(),e.perspective(h.fov||45,e.canvas.width/e.canvas.height,h.near||.1,h.far||
1E3),e.matrixMode(e.MODELVIEW));if(e.onresize)e.onresize();if(e.ondraw)e.ondraw()}h=h||{};var c=h.paddingTop||0,b=h.paddingLeft||0,d=h.paddingRight||0,f=h.paddingBottom||0;if(!document.body)throw"document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)";document.body.appendChild(e.canvas);document.body.style.overflow="hidden";e.canvas.style.position="absolute";e.canvas.style.left=b+"px";e.canvas.style.top=c+"px";window.addEventListener("resize",a);
a()}}function n(){var h=Array.prototype.concat.apply([],arguments);h.length||(h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.m=N?new Float32Array(h):h}function y(h,a,c){this.t=arguments.length?h:Number.MAX_VALUE;this.hit=a;this.normal=c}function G(){var h=e.getParameter(e.VIEWPORT),a=e.modelviewMatrix.m,c=new g(a[0],a[4],a[8]),b=new g(a[1],a[5],a[9]),d=new g(a[2],a[6],a[10]),a=new g(a[3],a[7],a[11]);this.eye=new g(-a.dot(c),-a.dot(b),-a.dot(d));c=h[0];b=c+h[2];d=h[1];a=d+h[3];this.ray00=e.unProject(c,
d,1).subtract(this.eye);this.ray10=e.unProject(b,d,1).subtract(this.eye);this.ray01=e.unProject(c,a,1).subtract(this.eye);this.ray11=e.unProject(b,a,1).subtract(this.eye);this.viewport=h}var I,K,z;a.prototype={bind:function(h){e.activeTexture(e.TEXTURE0+(h||0));e.bindTexture(e.TEXTURE_2D,this.id)},unbind:function(h){e.activeTexture(e.TEXTURE0+(h||0));e.bindTexture(e.TEXTURE_2D,null)},drawTo:function(h,a){a=a||{};var c=e.getParameter(e.VIEWPORT);e.viewport(0,0,this.width,this.height);I=I||e.createFramebuffer();
e.bindFramebuffer(e.FRAMEBUFFER,I);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.id,0);if(!1!==a.depth){K=K||e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,K);if(this.width!=K.width||this.height!=K.height)K.width=this.width,K.height=this.height,e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,K)}h();e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,
null);e.viewport(c[0],c[1],c[2],c[3])},swapWith:function(h){var a;a=h.id;h.id=this.id;this.id=a;a=h.width;h.width=this.width;this.width=a;a=h.height;h.height=this.height;this.height=a}};a.fromImage=function(h,u){u=u||{};var c=new a(h.width,h.height,u);try{e.texImage2D(e.TEXTURE_2D,0,c.format,c.format,c.type,h)}catch(b){if("file:"==window.location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}u.minFilter&&u.minFilter!=e.NEAREST&&u.minFilter!=e.LINEAR&&e.generateMipmap(e.TEXTURE_2D);return c};a.fromURL=function(h,u){z=z||function(){var c=document.createElement("canvas").getContext("2d");c.canvas.width=c.canvas.height=128;for(var h=0;h<c.canvas.height;h+=16)for(var a=0;a<c.canvas.width;a+=16)c.fillStyle=(a^h)&16?"#FFF":"#DDD",c.fillRect(a,h,16,16);return c.canvas}();var c=a.fromImage(z,u),b=new Image,d=e;b.onload=function(){d.makeCurrent();a.fromImage(b,u).swapWith(c)};b.src=h;return c};
b.prototype={add:function(h){var a=JSON.stringify(h);a in this.map||(this.map[a]=this.unique.length,this.unique.push(h));return this.map[a]}};d.prototype={compile:function(a){for(var b=[],c=0;c<this.data.length;c+=1E4)b=Array.prototype.concat.apply(b,this.data.slice(c,c+1E4));c=this.data.length?b.length/this.data.length:0;if(c!=Math.round(c))throw"buffer elements not of consistent size, average size is "+c;this.buffer=this.buffer||e.createBuffer();this.buffer.length=b.length;this.buffer.spacing=c;
e.bindBuffer(this.target,this.buffer);e.bufferData(this.target,new this.type(b),a||e.STATIC_DRAW)}};f.prototype={addVertexBuffer:function(a,b){(this.vertexBuffers[b]=new d(e.ARRAY_BUFFER,Float32Array)).name=a;this[a]=[]},addIndexBuffer:function(a){this.indexBuffers[a]=new d(e.ELEMENT_ARRAY_BUFFER,Uint16Array);this[a]=[]},compile:function(){for(var a in this.vertexBuffers){var b=this.vertexBuffers[a];b.data=this[b.name];b.compile()}for(var c in this.indexBuffers)b=this.indexBuffers[c],b.data=this[c],
b.compile()},transform:function(a){this.vertices=this.vertices.map(function(c){return a.transformPoint(g.fromArray(c)).toArray()});if(this.normals){var b=a.inverse().transpose();this.normals=this.normals.map(function(c){return b.transformVector(g.fromArray(c)).unit().toArray()})}this.compile();return this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var a=0;a<this.vertices.length;a++)this.normals[a]=new g;for(a=0;a<this.triangles.length;a++){var b=this.triangles[a],
c=g.fromArray(this.vertices[b[0]]),d=g.fromArray(this.vertices[b[1]]),e=g.fromArray(this.vertices[b[2]]),c=d.subtract(c).cross(e.subtract(c)).unit();this.normals[b[0]]=this.normals[b[0]].add(c);this.normals[b[1]]=this.normals[b[1]].add(c);this.normals[b[2]]=this.normals[b[2]].add(c)}for(a=0;a<this.vertices.length;a++)this.normals[a]=this.normals[a].unit().toArray();this.compile();return this},computeWireframe:function(){for(var a=new b,u=0;u<this.triangles.length;u++)for(var c=this.triangles[u],d=
0;d<c.length;d++){var e=c[d],f=c[(d+1)%c.length];a.add([Math.min(e,f),Math.max(e,f)])}this.lines||this.addIndexBuffer("lines");this.lines=a.unique;this.compile();return this},getAABB:function(){var a={min:new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};a.max=a.min.negative();for(var b=0;b<this.vertices.length;b++){var c=g.fromArray(this.vertices[b]);a.min=g.min(a.min,c);a.max=g.max(a.max,c)}return a},getBoundingSphere:function(){for(var a=this.getAABB(),a={center:a.min.add(a.max).divide(2),
radius:0},b=0;b<this.vertices.length;b++)a.radius=Math.max(a.radius,g.fromArray(this.vertices[b]).subtract(a.center).length());return a}};f.plane=function(a){a=a||{};var b=new f(a),c=a.detailX||a.detail||1;a=a.detailY||a.detail||1;for(var d=0;d<=a;d++)for(var e=d/a,g=0;g<=c;g++){var k=g/c;b.vertices.push([2*k-1,2*e-1,0]);b.coords&&b.coords.push([k,e]);b.normals&&b.normals.push([0,0,1]);g<c&&d<a&&(k=g+d*(c+1),b.triangles.push([k,k+1,k+c+1]),b.triangles.push([k+c+1,k+1,k+c+2]))}b.compile();return b};
var A=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];f.cube=function(a){a=new f(a);for(var b=0;b<A.length;b++){for(var c=A[b],d=4*b,e=0;4>e;e++)a.vertices.push(p(c[e]).toArray()),a.coords&&a.coords.push([e&1,(e&2)/2]),a.normals&&a.normals.push(c.slice(4,7));a.triangles.push([d,d+1,d+2]);a.triangles.push([d+2,d+1,d+3])}a.compile();return a};f.sphere=function(a){function u(a,c,h){return m?[a,h,c]:[a,c,h]}a=a||{};var c=new f(a),d=new b;a=a.detail||
6;for(var e=0;8>e;e++)for(var k=p(e),m=0<k.x*k.y*k.z,q=[],n=0;n<=a;n++){for(var l=0;n+l<=a;l++){var z=n/a,r=l/a,M=(a-n-l)/a,r={vertex:(new g(z+(z-z*z)/2,r+(r-r*r)/2,M+(M-M*M)/2)).unit().multiply(k).toArray()};c.coords&&(r.coord=0<k.y?[1-z,M]:[M,1-z]);q.push(d.add(r))}if(0<n)for(l=0;n+l<=a;l++)z=(n-1)*(a+1)+(n-1-(n-1)*(n-1))/2+l,r=n*(a+1)+(n-n*n)/2+l,c.triangles.push(u(q[z],q[z+1],q[r])),n+l<a&&c.triangles.push(u(q[r],q[z+1],q[r+1]))}c.vertices=d.unique.map(function(a){return a.vertex});c.coords&&
(c.coords=d.unique.map(function(a){return a.coord}));c.normals&&(c.normals=c.vertices);c.compile();return c};f.load=function(a,b){b=b||{};"coords"in b||(b.coords=!!a.coords);"normals"in b||(b.normals=!!a.normals);"colors"in b||(b.colors=!!a.colors);"triangles"in b||(b.triangles=!!a.triangles);"lines"in b||(b.lines=!!a.lines);var c=new f(b);c.vertices=a.vertices;c.coords&&(c.coords=a.coords);c.normals&&(c.normals=a.normals);c.colors&&(c.colors=a.colors);c.triangles&&(c.triangles=a.triangles);c.lines&&
(c.lines=a.lines);c.compile();return c};g.prototype={negative:function(){return new g(-this.x,-this.y,-this.z)},add:function(a){return a instanceof g?new g(this.x+a.x,this.y+a.y,this.z+a.z):new g(this.x+a,this.y+a,this.z+a)},subtract:function(a){return a instanceof g?new g(this.x-a.x,this.y-a.y,this.z-a.z):new g(this.x-a,this.y-a,this.z-a)},multiply:function(a){return a instanceof g?new g(this.x*a.x,this.y*a.y,this.z*a.z):new g(this.x*a,this.y*a,this.z*a)},divide:function(a){return a instanceof g?
new g(this.x/a.x,this.y/a.y,this.z/a.z):new g(this.x/a,this.y/a,this.z/a)},equals:function(a){return this.x==a.x&&this.y==a.y&&this.z==a.z},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a){return new g(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,
this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(a){return[this.x,this.y,this.z].slice(0,a||3)},clone:function(){return new g(this.x,this.y,this.z)},init:function(a,b,c){this.x=a;this.y=b;this.z=c;return this}};g.negative=function(a,b){b.x=-a.x;b.y=-a.y;b.z=-a.z;return b};g.add=function(a,b,c){b instanceof g?(c.x=a.x+b.x,c.y=a.y+b.y,c.z=a.z+b.z):(c.x=a.x+b,c.y=a.y+b,c.z=a.z+b);return c};g.subtract=function(a,b,c){b instanceof
g?(c.x=a.x-b.x,c.y=a.y-b.y,c.z=a.z-b.z):(c.x=a.x-b,c.y=a.y-b,c.z=a.z-b);return c};g.multiply=function(a,b,c){b instanceof g?(c.x=a.x*b.x,c.y=a.y*b.y,c.z=a.z*b.z):(c.x=a.x*b,c.y=a.y*b,c.z=a.z*b);return c};g.divide=function(a,b,c){b instanceof g?(c.x=a.x/b.x,c.y=a.y/b.y,c.z=a.z/b.z):(c.x=a.x/b,c.y=a.y/b,c.z=a.z/b);return c};g.cross=function(a,b,c){c.x=a.y*b.z-a.z*b.y;c.y=a.z*b.x-a.x*b.z;c.z=a.x*b.y-a.y*b.x;return c};g.unit=function(a,b){var c=a.length();b.x=a.x/c;b.y=a.y/c;b.z=a.z/c;return b};g.fromAngles=
function(a,b){return new g(Math.cos(a)*Math.cos(b),Math.sin(b),Math.sin(a)*Math.cos(b))};g.randomDirection=function(){return g.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))};g.min=function(a,b){return new g(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.min(a.z,b.z))};g.max=function(a,b){return new g(Math.max(a.x,b.x),Math.max(a.y,b.y),Math.max(a.z,b.z))};g.lerp=function(a,b,c){return b.subtract(a).multiply(c).add(a)};g.fromArray=function(a){return new g(a[0],a[1],a[2])};m.prototype=
{uniforms:function(a){e.useProgram(this.program);for(var b in a){var c=this.uniformLocations[b]||e.getUniformLocation(this.program,b);if(c){this.uniformLocations[b]=c;var d=a[b];d instanceof g?d=[d.x,d.y,d.z]:d instanceof n&&(d=d.m);var f=Object.prototype.toString.call(d);if("[object Array]"==f||"[object Float32Array]"==f)switch(d.length){case 1:e.uniform1fv(c,new Float32Array(d));break;case 2:e.uniform2fv(c,new Float32Array(d));break;case 3:e.uniform3fv(c,new Float32Array(d));break;case 4:e.uniform4fv(c,
new Float32Array(d));break;case 9:e.uniformMatrix3fv(c,!1,new Float32Array([d[0],d[3],d[6],d[1],d[4],d[7],d[2],d[5],d[8]]));break;case 16:e.uniformMatrix4fv(c,!1,new Float32Array([d[0],d[4],d[8],d[12],d[1],d[5],d[9],d[13],d[2],d[6],d[10],d[14],d[3],d[7],d[11],d[15]]));break;default:throw"don't know how to load uniform \""+b+'" of length '+d.length;}else if(f=Object.prototype.toString.call(d),"[object Number]"==f||"[object Boolean]"==f)(this.isSampler[b]?e.uniform1i:e.uniform1f).call(e,c,d);else throw'attempted to set uniform "'+
b+'" to invalid value '+d;}}return this},draw:function(a,b){this.drawBuffers(a.vertexBuffers,a.indexBuffers[b==e.LINES?"lines":"triangles"],2>arguments.length?e.TRIANGLES:b)},drawBuffers:function(a,b,c){var d=this.usedMatrices,f=e.modelviewMatrix,g=e.projectionMatrix,k=d.MVMI||d.NM?f.inverse():null,q=d.PMI?g.inverse():null,n=d.MVPM||d.MVPMI?g.multiply(f):null,m={};d.MVM&&(m[d.MVM]=f);d.MVMI&&(m[d.MVMI]=k);d.PM&&(m[d.PM]=g);d.PMI&&(m[d.PMI]=q);d.MVPM&&(m[d.MVPM]=n);d.MVPMI&&(m[d.MVPMI]=n.inverse());
d.NM&&(f=k.m,m[d.NM]=[f[0],f[4],f[8],f[1],f[5],f[9],f[2],f[6],f[10]]);this.uniforms(m);var d=0,p;for(p in a)m=a[p],f=this.attributes[p]||e.getAttribLocation(this.program,p.replace(/^(gl_.*)$/,"LIGHTGL$1")),-1!=f&&m.buffer&&(this.attributes[p]=f,e.bindBuffer(e.ARRAY_BUFFER,m.buffer),e.enableVertexAttribArray(f),e.vertexAttribPointer(f,m.buffer.spacing,e.FLOAT,!1,0,0),d=m.buffer.length/m.buffer.spacing);for(p in this.attributes)p in a||e.disableVertexAttribArray(this.attributes[p]);!d||b&&!b.buffer||
(b?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,b.buffer),e.drawElements(c,b.buffer.length,e.UNSIGNED_SHORT,0)):e.drawArrays(c,0,d));return this}};m.fromURL=function(a,b){var c=function(a){var c=new XMLHttpRequest;c.open("GET",a,!1);c.send(null);if(200!==c.status)throw"could not load "+a;return c.responseText},d=c(a),c=c(b);return new m(d,c)};m.from=function(a,b){try{return new m(a,b)}catch(c){return m.fromURL(a,b)}};var e,w={create:function(a){a=a||{};var b=a.canvas;b||(b=document.createElement("canvas"),
b.width=a.width||800,b.height=a.height||600);"alpha"in a||(a.alpha=!1);try{e=b.getContext("webgl",a)}catch(c){}try{e=e||b.getContext("experimental-webgl",a)}catch(c){}if(!e)throw"WebGL not supported";v();q();t();D();return e},keys:{},Matrix:n,Indexer:b,Buffer:d,Mesh:f,HitTest:y,Raytracer:G,Shader:m,Texture:a,Vector:g};r(document,"keydown",function(a){if(!a.altKey&&!a.ctrlKey&&!a.metaKey){var b=l(a.keyCode);b&&(w.keys[b]=!0);w.keys[a.keyCode]=!0}});r(document,"keyup",function(a){if(!a.altKey&&!a.ctrlKey&&
!a.metaKey){var b=l(a.keyCode);b&&(w.keys[b]=!1);w.keys[a.keyCode]=!1}});var T=305397760,N="undefined"!=typeof Float32Array;n.prototype={inverse:function(){return n.inverse(this,new n)},transpose:function(){return n.transpose(this,new n)},multiply:function(a){return n.multiply(this,a,new n)},transformPoint:function(a){var b=this.m;return(new g(b[0]*a.x+b[1]*a.y+b[2]*a.z+b[3],b[4]*a.x+b[5]*a.y+b[6]*a.z+b[7],b[8]*a.x+b[9]*a.y+b[10]*a.z+b[11])).divide(b[12]*a.x+b[13]*a.y+b[14]*a.z+b[15])},transformVector:function(a){var b=
this.m;return new g(b[0]*a.x+b[1]*a.y+b[2]*a.z,b[4]*a.x+b[5]*a.y+b[6]*a.z,b[8]*a.x+b[9]*a.y+b[10]*a.z)}};n.inverse=function(a,b){b=b||new n;var c=a.m,d=b.m;d[0]=c[5]*c[10]*c[15]-c[5]*c[14]*c[11]-c[6]*c[9]*c[15]+c[6]*c[13]*c[11]+c[7]*c[9]*c[14]-c[7]*c[13]*c[10];d[1]=-c[1]*c[10]*c[15]+c[1]*c[14]*c[11]+c[2]*c[9]*c[15]-c[2]*c[13]*c[11]-c[3]*c[9]*c[14]+c[3]*c[13]*c[10];d[2]=c[1]*c[6]*c[15]-c[1]*c[14]*c[7]-c[2]*c[5]*c[15]+c[2]*c[13]*c[7]+c[3]*c[5]*c[14]-c[3]*c[13]*c[6];d[3]=-c[1]*c[6]*c[11]+c[1]*c[10]*
c[7]+c[2]*c[5]*c[11]-c[2]*c[9]*c[7]-c[3]*c[5]*c[10]+c[3]*c[9]*c[6];d[4]=-c[4]*c[10]*c[15]+c[4]*c[14]*c[11]+c[6]*c[8]*c[15]-c[6]*c[12]*c[11]-c[7]*c[8]*c[14]+c[7]*c[12]*c[10];d[5]=c[0]*c[10]*c[15]-c[0]*c[14]*c[11]-c[2]*c[8]*c[15]+c[2]*c[12]*c[11]+c[3]*c[8]*c[14]-c[3]*c[12]*c[10];d[6]=-c[0]*c[6]*c[15]+c[0]*c[14]*c[7]+c[2]*c[4]*c[15]-c[2]*c[12]*c[7]-c[3]*c[4]*c[14]+c[3]*c[12]*c[6];d[7]=c[0]*c[6]*c[11]-c[0]*c[10]*c[7]-c[2]*c[4]*c[11]+c[2]*c[8]*c[7]+c[3]*c[4]*c[10]-c[3]*c[8]*c[6];d[8]=c[4]*c[9]*c[15]-c[4]*
c[13]*c[11]-c[5]*c[8]*c[15]+c[5]*c[12]*c[11]+c[7]*c[8]*c[13]-c[7]*c[12]*c[9];d[9]=-c[0]*c[9]*c[15]+c[0]*c[13]*c[11]+c[1]*c[8]*c[15]-c[1]*c[12]*c[11]-c[3]*c[8]*c[13]+c[3]*c[12]*c[9];d[10]=c[0]*c[5]*c[15]-c[0]*c[13]*c[7]-c[1]*c[4]*c[15]+c[1]*c[12]*c[7]+c[3]*c[4]*c[13]-c[3]*c[12]*c[5];d[11]=-c[0]*c[5]*c[11]+c[0]*c[9]*c[7]+c[1]*c[4]*c[11]-c[1]*c[8]*c[7]-c[3]*c[4]*c[9]+c[3]*c[8]*c[5];d[12]=-c[4]*c[9]*c[14]+c[4]*c[13]*c[10]+c[5]*c[8]*c[14]-c[5]*c[12]*c[10]-c[6]*c[8]*c[13]+c[6]*c[12]*c[9];d[13]=c[0]*c[9]*
c[14]-c[0]*c[13]*c[10]-c[1]*c[8]*c[14]+c[1]*c[12]*c[10]+c[2]*c[8]*c[13]-c[2]*c[12]*c[9];d[14]=-c[0]*c[5]*c[14]+c[0]*c[13]*c[6]+c[1]*c[4]*c[14]-c[1]*c[12]*c[6]-c[2]*c[4]*c[13]+c[2]*c[12]*c[5];d[15]=c[0]*c[5]*c[10]-c[0]*c[9]*c[6]-c[1]*c[4]*c[10]+c[1]*c[8]*c[6]+c[2]*c[4]*c[9]-c[2]*c[8]*c[5];for(var c=c[0]*d[0]+c[1]*d[4]+c[2]*d[8]+c[3]*d[12],e=0;16>e;e++)d[e]/=c;return b};n.transpose=function(a,b){b=b||new n;var c=a.m,d=b.m;d[0]=c[0];d[1]=c[4];d[2]=c[8];d[3]=c[12];d[4]=c[1];d[5]=c[5];d[6]=c[9];d[7]=c[13];
d[8]=c[2];d[9]=c[6];d[10]=c[10];d[11]=c[14];d[12]=c[3];d[13]=c[7];d[14]=c[11];d[15]=c[15];return b};n.multiply=function(a,b,c){c=c||new n;a=a.m;b=b.m;var d=c.m;d[0]=a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12];d[1]=a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13];d[2]=a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14];d[3]=a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15];d[4]=a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12];d[5]=a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13];d[6]=a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14];d[7]=a[4]*b[3]+a[5]*
b[7]+a[6]*b[11]+a[7]*b[15];d[8]=a[8]*b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12];d[9]=a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13];d[10]=a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14];d[11]=a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15];d[12]=a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12];d[13]=a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13];d[14]=a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14];d[15]=a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15];return c};n.identity=function(a){a=a||new n;var b=a.m;b[0]=b[5]=b[10]=b[15]=
1;b[1]=b[2]=b[3]=b[4]=b[6]=b[7]=b[8]=b[9]=b[11]=b[12]=b[13]=b[14]=0;return a};n.perspective=function(a,b,c,d,e){a=Math.tan(a*Math.PI/360)*c;b*=a;return n.frustum(-b,b,-a,a,c,d,e)};n.frustum=function(a,b,c,d,e,f,g){g=g||new n;var k=g.m;k[0]=2*e/(b-a);k[1]=0;k[2]=(b+a)/(b-a);k[3]=0;k[4]=0;k[5]=2*e/(d-c);k[6]=(d+c)/(d-c);k[7]=0;k[8]=0;k[9]=0;k[10]=-(f+e)/(f-e);k[11]=-2*f*e/(f-e);k[12]=0;k[13]=0;k[14]=-1;k[15]=0;return g};n.ortho=function(a,b,c,d,e,f,g){g=g||new n;var k=g.m;k[0]=2/(b-a);k[1]=0;k[2]=0;
k[3]=-(b+a)/(b-a);k[4]=0;k[5]=2/(d-c);k[6]=0;k[7]=-(d+c)/(d-c);k[8]=0;k[9]=0;k[10]=-2/(f-e);k[11]=-(f+e)/(f-e);k[12]=0;k[13]=0;k[14]=0;k[15]=1;return g};n.scale=function(a,b,c,d){d=d||new n;var e=d.m;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=c;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return d};n.translate=function(a,b,c,d){d=d||new n;var e=d.m;e[0]=1;e[1]=0;e[2]=0;e[3]=a;e[4]=0;e[5]=1;e[6]=0;e[7]=b;e[8]=0;e[9]=0;e[10]=1;e[11]=c;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return d};
n.rotate=function(a,b,c,d,e){if(!a||!b&&!c&&!d)return n.identity(e);e=e||new n;var f=e.m,g=Math.sqrt(b*b+c*c+d*d);a*=Math.PI/180;b/=g;c/=g;d/=g;g=Math.cos(a);a=Math.sin(a);var k=1-g;f[0]=b*b*k+g;f[1]=b*c*k-d*a;f[2]=b*d*k+c*a;f[3]=0;f[4]=c*b*k+d*a;f[5]=c*c*k+g;f[6]=c*d*k-b*a;f[7]=0;f[8]=d*b*k-c*a;f[9]=d*c*k+b*a;f[10]=d*d*k+g;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return e};n.lookAt=function(a,b,c,d,e,f,k,m,q,p){p=p||new n;var l=p.m;a=new g(a,b,c);d=new g(d,e,f);m=new g(k,m,q);k=a.subtract(d).unit();
m=m.cross(k).unit();q=k.cross(m).unit();l[0]=m.x;l[1]=m.y;l[2]=m.z;l[3]=-m.dot(a);l[4]=q.x;l[5]=q.y;l[6]=q.z;l[7]=-q.dot(a);l[8]=k.x;l[9]=k.y;l[10]=k.z;l[11]=-k.dot(a);l[12]=0;l[13]=0;l[14]=0;l[15]=1;return p};y.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};G.prototype={getRayForPixel:function(a,b){a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];var c=g.lerp(this.ray00,this.ray10,a),d=g.lerp(this.ray01,this.ray11,
a);return g.lerp(c,d,b).unit()}};G.hitTestBox=function(a,b,c,d){var e=c.subtract(a).divide(b),f=d.subtract(a).divide(b),k=g.min(e,f),e=g.max(e,f),k=k.max(),e=e.min();return 0<k&&k<e?(a=a.add(b.multiply(k)),c=c.add(1E-6),d=d.subtract(1E-6),new y(k,a,new g((a.x>d.x)-(a.x<c.x),(a.y>d.y)-(a.y<c.y),(a.z>d.z)-(a.z<c.z)))):null};G.hitTestSphere=function(a,b,c,d){var e=a.subtract(c),f=b.dot(b),g=2*b.dot(e),e=e.dot(e)-d*d,e=g*g-4*f*e;return 0<e?(f=(-g-Math.sqrt(e))/(2*f),a=a.add(b.multiply(f)),new y(f,a,a.subtract(c).divide(d))):
null};G.hitTestTriangle=function(a,b,c,d,e){var f=d.subtract(c),g=e.subtract(c);e=f.cross(g).unit();d=e.dot(c.subtract(a))/e.dot(b);if(0<d){a=a.add(b.multiply(d));var k=a.subtract(c);c=g.dot(g);b=g.dot(f);var g=g.dot(k),m=f.dot(f),f=f.dot(k),k=c*m-b*b,m=(m*g-b*f)/k,f=(c*f-b*g)/k;if(0<=m&&0<=f&&1>=m+f)return new y(d,a,e)}return null};return w}();Blockscad=Blockscad||{};Blockscad.Toolbox={};Blockly=Blockly||{};Blockscad.Toolbox.catIDs=[];Blockscad.Toolbox.allcats="HEX_3D_PRIMITIVE HEX_2D_PRIMITIVE HEX_TRANSFORM HEX_SETOP HEX_MATH HEX_LOGIC HEX_LOOP HEX_TEXT HEX_VARIABLE HEX_PROCEDURE".split(" ");Blockscad.Toolbox.whichCatsInSimple=[0,2,3,4,8,9];Blockscad.Toolbox.colorScheme={};Blockscad.Toolbox.colorScheme.one="#006205 #209303 #26549E #7450E2 #0186E2 #BF6920 #612485 #727272 #8C7149 #900355".split(" ");Blockscad.Toolbox.colorScheme.two="#885ee3 #82af5a #23901c #377eb8 #ba9969 #afaf13 #a66658 #d761bf #999999 #b02375".split(" ");
Blockscad.Toolbox.catHex=[];Blockscad.Toolbox.simpCatHex=[];Blockscad.Toolbox.setColorScheme=function(a){for(var b=0;b<Blockscad.Toolbox.allcats.length;b++)Blockscad.Toolbox[Blockscad.Toolbox.allcats[b]]=a[b],Blockscad.Toolbox.catHex[b]=a[b]};
Blockscad.Toolbox.setCatColors=function(){if(Blockscad.Toolbox.catIDs.length<Blockscad.Toolbox.allcats.length)for(var a=0;a<Blockscad.Toolbox.catIDs.length;a++){var b=document.getElementById(Blockscad.Toolbox.catIDs[a]);b.style.background=Blockscad.Toolbox.catHex[Blockscad.Toolbox.whichCatsInSimple[a]]}else for(a=0;a<Blockscad.Toolbox.catIDs.length;a++)b=document.getElementById(Blockscad.Toolbox.catIDs[a]),b.style.background=Blockscad.Toolbox.catHex[a]};
Blockscad.Toolbox.cat_3D='<category name="'+Blockscad.Msg.CATEGORY_3D_SHAPES+'"><block type="sphere"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cube"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cylinder"><value name="RAD1"><block type="math_number"><field name="NUM">10</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">10</field></block></value><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="torus"><value name="RAD1"><block type="math_number"><field name="NUM">4</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">1</field></block></value><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value><value name="FACES"><block type="math_number"><field name="NUM">16</field></block></value></block></category>';
Blockscad.Toolbox.cat_3D_sim='<category name="'+Blockscad.Msg.CATEGORY_3D_SHAPES+'"><block type="sphere"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cube"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="cylinder"><value name="RAD1"><block type="math_number"><field name="NUM">10</field></block></value><value name="RAD2"><block type="math_number"><field name="NUM">10</field></block></value><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value></block></category>';
Blockscad.Toolbox.cat2D='<category name="'+Blockscad.Msg.CATEGORY_2D_SHAPES+'"><block type="circle"><value name="RAD"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="square"><value name="XVAL"><block type="math_number"><field name="NUM">10</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">10</field></block></value></block></category>';
Blockscad.Toolbox.catTransform='<category name="'+Blockscad.Msg.CATEGORY_TRANSFORMATIONS+'"><block type="translate"><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="simplerotate"><value name="XVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_angle"><field name="NUM">0</field></block></value></block><block type="simplemirror_new"></block><block type="scale"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="color"><value name="COLOR"><block type="colour_picker"><field name="COLOUR">#ffcc00</field></block></value></block><block type="color_rgb"><value name="RED"><block type="math_number"><field name="NUM">100</field></block></value><value name="GREEN"><block type="math_number"><field name="NUM">100</field></block></value><value name="BLUE"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="$fn"><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value></block><block type="taper"><value name="FACTOR"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="linearextrude"><value name="HEIGHT"><block type="math_number"><field name="NUM">10</field></block></value><value name="TWIST"><block type="math_angle"><field name="NUM">0</field></block></value><value name="XSCALE"><block type="math_number"><field name="NUM">1</field></block></value><value name="YSCALE"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="rotateextrude"><value name="FACES"><block type="math_number"><field name="NUM">5</field></block></value></block><block type="fancyrotate"><value name="AVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="fancymirror"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block></category>';
Blockscad.Toolbox.catTransform_sim='<category name="'+Blockscad.Msg.CATEGORY_TRANSFORMATIONS+'"><block type="translate"><value name="XVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">0</field></block></value></block><block type="simplerotate"><value name="XVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="YVAL"><block type="math_angle"><field name="NUM">0</field></block></value><value name="ZVAL"><block type="math_angle"><field name="NUM">0</field></block></value></block><block type="scale"><value name="XVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="YVAL"><block type="math_number"><field name="NUM">1</field></block></value><value name="ZVAL"><block type="math_number"><field name="NUM">1</field></block></value></block><block type="color"><value name="COLOR"><block type="colour_picker"><field name="COLOUR">#ffcc00</field></block></value></block><block type="$fn"><value name="SIDES"><block type="math_number"><field name="NUM">8</field></block></value></block></category>';
Blockscad.Toolbox.catSetOps='<category name="'+Blockscad.Msg.CATEGORY_SET_OPERATIONS+'"><block type="union"></block><block type="difference"></block><block type="intersection"></block><block type="hull"></block></category>';Blockscad.Toolbox.catSetOps_sim='<category name="'+Blockscad.Msg.CATEGORY_SET_OPERATIONS+'"><block type="union"></block><block type="difference"></block><block type="intersection"></block></category>';
Blockscad.Toolbox.catMathLogic='<category name="'+Blockscad.Msg.CATEGORY_MATH+'"><block type="math_number"></block><block type="math_angle"></block><block type="math_arithmetic"></block><block type="math_single"></block><block type="math_trig"></block><block type="math_constant_bs"></block><block type="math_number_property"></block><block type="math_round"></block><block type="math_modulo"></block><block type="math_constrain"><value name="LOW"><block type="math_number"><field name="NUM">1</field></block></value><value name="HIGH"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="math_random_int"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block></value><value name="TO"><block type="math_number"><field name="NUM">100</field></block></value></block><block type="math_random_float"></block></category><category name="'+
Blockscad.Msg.CATEGORY_LOGIC+'"><block type="controls_if"></block><block type="logic_compare"></block><block type="logic_operation"></block><block type="logic_negate"></block><block type="logic_boolean"></block><block type="logic_ternary"></block></category>';Blockscad.Toolbox.catMathLogic_sim='<category name="'+Blockscad.Msg.CATEGORY_MATH+'"><block type="math_number"></block><block type="math_angle"></block><block type="math_arithmetic"></block><block type="math_single"></block><block type="math_random_int"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block></value><value name="TO"><block type="math_number"><field name="NUM">100</field></block></value></block></category>';
Blockscad.Toolbox.catLoops='<category name="'+Blockscad.Msg.CATEGORY_LOOPS+'"><block type="controls_for"><value name="FROM"><block type="math_number"><field name="NUM">1</field></block> </value><value name="TO"><block type="math_number"><field name="NUM">10</field></block></value><value name="BY"><block type="math_number"><field name="NUM">1</field></block></value></block></category>';
Blockscad.Toolbox.catOther='<category name="'+Blockscad.Msg.CATEGORY_TEXT+'"><block type="bs_text"><value name="TEXT"><block type="text"></block></value><value name="SIZE"><block type="math_number"><field name="NUM">10</field></block></value></block><block type="bs_3dtext"><value name="TEXT"><block type="text"></block></value><value name="SIZE"><block type="math_number"><field name="NUM">10</field></block></value><value name="THICKNESS"><block type="math_number"><field name="NUM">2</field></block></value></block></category><category name="'+Blockscad.Msg.CATEGORY_VARIBLES+
'" custom="VARIABLE"></category><category name="'+Blockscad.Msg.CATEGORY_PROCEDURES+'" custom="PROCEDURE"></category></xml>';Blockscad.Toolbox.catOther_sim='<category name="'+Blockscad.Msg.CATEGORY_VARIBLES+'" custom="VARIABLE"></category><category name="'+Blockscad.Msg.CATEGORY_PROCEDURES+'" custom="PROCEDURE"></category></xml>';Blockscad.Toolbox.adv='<xml id="toolbox" style="display: none">';Blockscad.Toolbox.adv+=Blockscad.Toolbox.cat_3D;Blockscad.Toolbox.adv+=Blockscad.Toolbox.cat2D;
Blockscad.Toolbox.adv+=Blockscad.Toolbox.catTransform;Blockscad.Toolbox.adv+=Blockscad.Toolbox.catSetOps;Blockscad.Toolbox.adv+=Blockscad.Toolbox.catMathLogic;Blockscad.Toolbox.adv+=Blockscad.Toolbox.catLoops;Blockscad.Toolbox.adv+=Blockscad.Toolbox.catOther;Blockscad.Toolbox.sim='<xml id="toolbox" style="display: none">';Blockscad.Toolbox.sim+=Blockscad.Toolbox.cat_3D_sim;Blockscad.Toolbox.sim+=Blockscad.Toolbox.catTransform_sim;Blockscad.Toolbox.sim+=Blockscad.Toolbox.catSetOps_sim;
Blockscad.Toolbox.sim+=Blockscad.Toolbox.catMathLogic_sim;Blockscad.Toolbox.sim+=Blockscad.Toolbox.catOther_sim;(function(a){var b,d,f=null,p,g,k,m,v,q,t,l,r,D,n,y,G,I,K,z=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],A=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],e=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],w=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],T=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],N=[16,17,18,0,8,7,9,6,
10,5,11,4,12,3,13,2,14,1,15],h=function(){this.list=this.next=null},u=function(){this.n=this.b=this.e=0;this.t=null},c=function(a,b,c,d,e,f){this.BMAX=16;this.N_MAX=288;this.status=0;this.root=null;this.m=0;var g=Array(this.BMAX+1),k,m,q,p,l,n,z,r=Array(this.BMAX+1),v,A,t,w=new u,y=Array(this.BMAX);p=Array(this.N_MAX);var x,B=Array(this.BMAX+1),D,C,G;G=this.root=null;for(l=0;l<g.length;l++)g[l]=0;for(l=0;l<r.length;l++)r[l]=0;for(l=0;l<y.length;l++)y[l]=null;for(l=0;l<p.length;l++)p[l]=0;for(l=0;l<
B.length;l++)B[l]=0;k=256<b?a[256]:this.BMAX;v=a;A=0;l=b;do g[v[A]]++,A++;while(0<--l);if(g[0]==b)this.root=null,this.status=this.m=0;else{for(n=1;n<=this.BMAX&&0==g[n];n++);z=n;f<n&&(f=n);for(l=this.BMAX;0!=l&&0==g[l];l--);q=l;f>l&&(f=l);for(D=1<<n;n<l;n++,D<<=1)if(0>(D-=g[n])){this.status=2;this.m=f;return}if(0>(D-=g[l]))this.status=2,this.m=f;else{g[l]+=D;B[1]=n=0;v=g;A=1;for(t=2;0<--l;)B[t++]=n+=v[A++];v=a;l=A=0;do 0!=(n=v[A++])&&(p[B[n]++]=l);while(++l<b);b=B[q];B[0]=l=0;v=p;A=0;p=-1;x=r[0]=
0;t=null;for(C=0;z<=q;z++)for(a=g[z];0<a--;){for(;z>x+r[1+p];){x+=r[1+p];p++;C=(C=q-x)>f?f:C;if((m=1<<(n=z-x))>a+1)for(m-=a+1,t=z;++n<C&&!((m<<=1)<=g[++t]);)m-=g[t];x+n>k&&x<k&&(n=k-x);C=1<<n;r[1+p]=n;t=Array(C);for(m=0;m<C;m++)t[m]=new u;G=null==G?this.root=new h:G.next=new h;G.next=null;G.list=t;y[p]=t;0<p&&(B[p]=l,w.b=r[p],w.e=16+n,w.t=t,n=(l&(1<<x)-1)>>x-r[p],y[p-1][n].e=w.e,y[p-1][n].b=w.b,y[p-1][n].n=w.n,y[p-1][n].t=w.t)}w.b=z-x;A>=b?w.e=99:v[A]<c?(w.e=256>v[A]?16:15,w.n=v[A++]):(w.e=e[v[A]-
c],w.n=d[v[A++]-c]);m=1<<z-x;for(n=l>>x;n<C;n+=m)t[n].e=w.e,t[n].b=w.b,t[n].n=w.n,t[n].t=w.t;for(n=1<<z-1;0!=(l&n);n>>=1)l^=n;for(l^=n;(l&(1<<x)-1)!=B[p];)x-=r[p],p--}this.m=r[1];this.status=0!=D&&1!=q?1:0}}},x=function(a){for(;v<a;){var b=m,c;c=I.length==K?-1:I.charCodeAt(K++)&255;m=b|c<<v;v+=8}},C=function(a){return m&z[a]},B=function(a){m>>=a;v-=a},O=function(a,c,e){var f,g,k;if(0==e)return 0;for(k=0;;){x(y);g=D.list[C(y)];for(f=g.e;16<f;){if(99==f)return-1;B(g.b);f-=16;x(f);g=g.t[C(f)];f=g.e}B(g.b);
if(16==f)d&=32767,a[c+k++]=b[d++]=g.n;else{if(15==f)break;x(f);l=g.n+C(f);B(f);x(G);g=n.list[C(G)];for(f=g.e;16<f;){if(99==f)return-1;B(g.b);f-=16;x(f);g=g.t[C(f)];f=g.e}B(g.b);x(f);r=d-g.n-C(f);for(B(f);0<l&&k<e;)l--,r&=32767,d&=32767,a[c+k++]=b[d++]=b[r++]}if(k==e)return e}q=-1;return k},P=function(a,b,d){var f,g,k,h,l,m,p,q=Array(316);for(f=0;f<q.length;f++)q[f]=0;x(5);m=257+C(5);B(5);x(5);p=1+C(5);B(5);x(4);f=4+C(4);B(4);if(286<m||30<p)return-1;for(g=0;g<f;g++)x(3),q[N[g]]=C(3),B(3);for(;19>g;g++)q[N[g]]=
0;y=7;g=new c(q,19,19,null,null,y);if(0!=g.status)return-1;D=g.root;y=g.m;h=m+p;for(f=k=0;f<h;)if(x(y),l=D.list[C(y)],g=l.b,B(g),g=l.n,16>g)q[f++]=k=g;else if(16==g){x(2);g=3+C(2);B(2);if(f+g>h)return-1;for(;0<g--;)q[f++]=k}else{17==g?(x(3),g=3+C(3),B(3)):(x(7),g=11+C(7),B(7));if(f+g>h)return-1;for(;0<g--;)q[f++]=0;k=0}y=9;g=new c(q,m,257,A,e,y);0==y&&(g.status=1);if(0!=g.status&&1==g.status)return-1;D=g.root;y=g.m;for(f=0;f<p;f++)q[f]=q[f+m];G=6;g=new c(q,p,0,w,T,G);n=g.root;G=g.m;return 0==G&&257<
m||0!=g.status?-1:O(a,b,d)},V=function(a,h,z){var u,F;for(u=0;u<z&&(!t||-1!=q);){if(0<l){if(0!=q)for(;0<l&&u<z;)l--,r&=32767,d&=32767,a[h+u++]=b[d++]=b[r++];else{for(;0<l&&u<z;)l--,d&=32767,x(8),a[h+u++]=b[d++]=C(8),B(8);0==l&&(q=-1)}if(u==z)break}if(-1==q){if(t)break;x(1);0!=C(1)&&(t=!0);B(1);x(2);q=C(2);B(2);D=null;l=0}switch(q){case 0:F=a;var H=h+u,I=z-u,J;J=v&7;B(J);x(16);J=C(16);B(16);x(16);if(J!=(~m&65535))F=-1;else{B(16);l=J;for(J=0;0<l&&J<I;)l--,d&=32767,x(8),F[H+J++]=b[d++]=C(8),B(8);0==
l&&(q=-1);F=J}break;case 1:if(null!=D)F=O(a,h+u,z-u);else a:{F=a;H=h+u;I=z-u;if(null==f){var E;J=Array(288);for(E=0;144>E;E++)J[E]=8;for(;256>E;E++)J[E]=9;for(;280>E;E++)J[E]=7;for(;288>E;E++)J[E]=8;g=7;E=new c(J,288,257,A,e,g);if(0!=E.status){alert("HufBuild error: "+E.status);F=-1;break a}f=E.root;g=E.m;for(E=0;30>E;E++)J[E]=5;k=5;E=new c(J,30,0,w,T,k);if(1<E.status){f=null;alert("HufBuild error: "+E.status);F=-1;break a}p=E.root;k=E.m}D=f;n=p;y=g;G=k;F=O(F,H,I)}break;case 2:F=null!=D?O(a,h+u,z-
u):P(a,h+u,z-u);break;default:F=-1}if(-1==F)return t?0:-1;u+=F}return u};a.RawDeflate||(a.RawDeflate={});a.RawDeflate.inflate=function(a){var c;null==b&&(b=Array(65536));v=m=d=0;q=-1;t=!1;l=r=0;D=null;I=a;K=0;for(var e=Array(1024),f=[];0<(a=V(e,0,e.length));){var g=Array(a);for(c=0;c<a;c++)g[c]=String.fromCharCode(e[c]);f[f.length]=g.join("")}I=null;return f.join("")}})(this);
(function(a){var b,d,f,p,g=null,k,m,v,q,t,l,r,D,n,y,G,I,K,z,A,e,w,T,N,h,u,c,x,C,B,O,P,V,L,R,S,M,F,H,W,J,E,ba,Z,qa,ga,ha,X,ia,ra,ca,ja,aa,ka,la,sa,da=function(){this.dl=this.fc=0},ta=function(){this.extra_bits=this.static_tree=this.dyn_tree=null;this.max_code=this.max_length=this.elems=this.extra_base=0},U=function(a,b,c,d){this.good_length=a;this.max_lazy=b;this.nice_length=c;this.max_chain=d},La=function(){this.next=null;this.len=0;this.ptr=Array(8192);this.off=0},ua=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,
2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ea=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Ma=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],za=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],va=[new U(0,0,0,0),new U(4,4,8,4),new U(4,5,16,8),new U(4,6,32,32),new U(4,4,16,16),new U(8,16,32,32),new U(8,16,128,128),new U(8,32,128,256),new U(32,128,258,1024),new U(32,258,258,4096)],ma=function(a){g[m+k++]=a;if(8192==m+k&&0!=k){var c;null!=b?(a=b,b=b.next):a=new La;a.next=null;a.len=a.off=0;null==
d?d=f=a:f=f.next=a;a.len=k-m;for(c=0;c<a.len;c++)a.ptr[c]=g[m+c];k=m=0}},na=function(a){a&=65535;8190>m+k?(g[m+k++]=a&255,g[m+k++]=a>>>8):(ma(a&255),ma(a>>>8))},oa=function(){G=(G<<5^q[w+3-1]&255)&8191;I=r[32768+G];r[w&32767]=I;r[32768+G]=w},Y=function(a,b){Q(b[a].fc,b[a].dl)},Aa=function(a,b,c){return a[b].fc<a[c].fc||a[b].fc==a[c].fc&&E[b]<=E[c]},Ba=function(a,b,c){var d;for(d=0;d<c&&sa<la.length;d++)a[b+d]=la.charCodeAt(sa++)&255;return d},Ca=function(a){var b=u,c=w,d,f=e,g=32506<w?w-32506:0,k=
w+258,h=q[c+f-1],l=q[c+f];e>=C&&(b>>=2);do if(d=a,q[d+f]==l&&q[d+f-1]==h&&q[d]==q[c]&&q[++d]==q[c+1]){c+=2;for(d++;q[++c]==q[++d]&&q[++c]==q[++d]&&q[++c]==q[++d]&&q[++c]==q[++d]&&q[++c]==q[++d]&&q[++c]==q[++d]&&q[++c]==q[++d]&&q[++c]==q[++d]&&c<k;);d=258-(k-c);c=k-258;if(d>f){T=a;f=d;if(258<=d)break;h=q[c+f-1];l=q[c+f]}}while((a=r[a&32767])>g&&0!=--b);return f},wa=function(){var a,b,c=65536-h-w;if(-1==c)c--;else if(65274<=w){for(a=0;32768>a;a++)q[a]=q[a+32768];T-=32768;w-=32768;y-=32768;for(a=0;8192>
a;a++)b=r[32768+a],r[32768+a]=32768<=b?b-32768:0;for(a=0;32768>a;a++)b=r[a],r[a]=32768<=b?b-32768:0;c+=32768}N||(a=Ba(q,w+h,c),0>=a?N=!0:h+=a)},Na=function(a,b,f){var g;if(!p){if(!N){n=D=0;var l,t;if(0==V[0].dl){R.dyn_tree=B;R.static_tree=P;R.extra_bits=ua;R.extra_base=257;R.elems=286;R.max_length=15;R.max_code=0;S.dyn_tree=O;S.static_tree=V;S.extra_bits=ea;S.extra_base=0;S.elems=30;S.max_length=15;S.max_code=0;M.dyn_tree=L;M.static_tree=null;M.extra_bits=Ma;M.extra_base=0;M.elems=19;M.max_length=
7;for(t=l=M.max_code=0;28>t;t++)for(qa[t]=l,g=0;g<1<<ua[t];g++)ba[l++]=t;ba[l-1]=t;for(t=l=0;16>t;t++)for(ga[t]=l,g=0;g<1<<ea[t];g++)Z[l++]=t;for(l>>=7;30>t;t++)for(ga[t]=l<<7,g=0;g<1<<ea[t]-7;g++)Z[256+l++]=t;for(g=0;15>=g;g++)F[g]=0;for(g=0;143>=g;)P[g++].dl=8,F[8]++;for(;255>=g;)P[g++].dl=9,F[9]++;for(;279>=g;)P[g++].dl=7,F[7]++;for(;287>=g;)P[g++].dl=8,F[8]++;Da(P,287);for(g=0;30>g;g++)V[g].dl=5,V[g].fc=Ea(g,5);Fa()}for(g=0;8192>g;g++)r[32768+g]=0;c=va[x].max_lazy;C=va[x].good_length;u=va[x].max_chain;
y=w=0;h=Ba(q,0,65536);if(0>=h)N=!0,h=0;else{for(N=!1;262>h&&!N;)wa();for(g=G=0;2>g;g++)G=(G<<5^q[g]&255)&8191}d=null;z=m=k=0;3>=x?(e=2,A=0):(A=2,z=z=0);v=!1}p=!0;if(0==h)return v=!0,0}if((g=Ga(a,b,f))==f)return f;if(v)return g;if(3>=x)for(;0!=h&&null==d;){oa();0!=I&&32506>=w-I&&(A=Ca(I),A>h&&(A=h));if(3<=A)if(t=fa(w-T,A-3),h-=A,A<=c){A--;do w++,oa();while(0!=--A);w++}else w+=A,A=0,G=q[w]&255,G=(G<<5^q[w+1]&255)&8191;else t=fa(0,q[w]&255),h--,w++;t&&(pa(0),y=w);for(;262>h&&!N;)wa()}else for(;0!=h&&
null==d;){oa();e=A;K=T;A=2;0!=I&&e<c&&32506>=w-I&&(A=Ca(I),A>h&&(A=h),3==A&&4096<w-T&&A--);if(3<=e&&A<=e){t=fa(w-1-K,e-3);h-=e-1;e-=2;do w++,oa();while(0!=--e);z=0;A=2;w++;t&&(pa(0),y=w)}else 0!=z?fa(0,q[w-1]&255)&&(pa(0),y=w):z=1,w++,h--;for(;262>h&&!N;)wa()}0==h&&(0!=z&&fa(0,q[w-1]&255),pa(1),v=!0);return g+Ga(a,g+b,f-g)},Ga=function(a,c,e){var f,h,l;for(f=0;null!=d&&f<e;){h=e-f;h>d.len&&(h=d.len);for(l=0;l<h;l++)a[c+f+l]=d.ptr[d.off+l];d.off+=h;d.len-=h;f+=h;0==d.len&&(h=d,d=d.next,h.next=b,b=
h)}if(f==e)return f;if(m<k){h=e-f;h>k-m&&(h=k-m);for(l=0;l<h;l++)a[c+f+l]=g[m+l];m+=h;f+=h;k==m&&(k=m=0)}return f},Fa=function(){var a;for(a=0;286>a;a++)B[a].fc=0;for(a=0;30>a;a++)O[a].fc=0;for(a=0;19>a;a++)L[a].fc=0;B[256].fc=1;ca=X=ia=ra=aa=ka=0;ja=1},xa=function(a,b){for(var c=H[b],d=b<<1;d<=W;){d<W&&Aa(a,H[d+1],H[d])&&d++;if(Aa(a,c,H[d]))break;H[b]=H[d];b=d;d<<=1}H[b]=c},Da=function(a,b){var c=Array(16),d=0,e;for(e=1;15>=e;e++)d=d+F[e-1]<<1,c[e]=d;for(d=0;d<=b;d++)e=a[d].dl,0!=e&&(a[d].fc=Ea(c[e]++,
e))},ya=function(a){var b=a.dyn_tree,c=a.static_tree,d=a.elems,e,f=-1,g=d;W=0;J=573;for(e=0;e<d;e++)0!=b[e].fc?(H[++W]=f=e,E[e]=0):b[e].dl=0;for(;2>W;)e=H[++W]=2>f?++f:0,b[e].fc=1,E[e]=0,aa--,null!=c&&(ka-=c[e].dl);a.max_code=f;for(e=W>>1;1<=e;e--)xa(b,e);do e=H[1],H[1]=H[W--],xa(b,1),c=H[1],H[--J]=e,H[--J]=c,b[g].fc=b[e].fc+b[c].fc,E[g]=E[e]>E[c]+1?E[e]:E[c]+1,b[e].dl=b[c].dl=g,H[1]=g++,xa(b,1);while(2<=W);H[--J]=H[1];g=a.dyn_tree;e=a.extra_bits;var d=a.extra_base,c=a.max_code,h=a.max_length,k=a.static_tree,
l,m,n,p,q=0;for(m=0;15>=m;m++)F[m]=0;g[H[J]].dl=0;for(a=J+1;573>a;a++)l=H[a],m=g[g[l].dl].dl+1,m>h&&(m=h,q++),g[l].dl=m,l>c||(F[m]++,n=0,l>=d&&(n=e[l-d]),p=g[l].fc,aa+=p*(m+n),null!=k&&(ka+=p*(k[l].dl+n)));if(0!=q){do{for(m=h-1;0==F[m];)m--;F[m]--;F[m+1]+=2;F[h]--;q-=2}while(0<q);for(m=h;0!=m;m--)for(l=F[m];0!=l;)e=H[--a],e>c||(g[e].dl!=m&&(aa+=(m-g[e].dl)*g[e].fc,g[e].fc=m),l--)}Da(b,f)},Ha=function(a,b){var c,d=-1,e,g=a[0].dl,f=0,h=7,k=4;0==g&&(h=138,k=3);a[b+1].dl=65535;for(c=0;c<=b;c++)e=g,g=
a[c+1].dl,++f<h&&e==g||(f<k?L[e].fc+=f:0!=e?(e!=d&&L[e].fc++,L[16].fc++):10>=f?L[17].fc++:L[18].fc++,f=0,d=e,0==g?(h=138,k=3):e==g?(h=6,k=3):(h=7,k=4))},Ia=function(a,b){var c,d=-1,e,g=a[0].dl,f=0,h=7,k=4;0==g&&(h=138,k=3);for(c=0;c<=b;c++)if(e=g,g=a[c+1].dl,!(++f<h&&e==g)){if(f<k){do Y(e,L);while(0!=--f)}else 0!=e?(e!=d&&(Y(e,L),f--),Y(16,L),Q(f-3,2)):10>=f?(Y(17,L),Q(f-3,3)):(Y(18,L),Q(f-11,7));f=0;d=e;0==g?(h=138,k=3):e==g?(h=6,k=3):(h=7,k=4)}},pa=function(a){var b,c,d,e;e=w-y;ha[ra]=ca;ya(R);
ya(S);Ha(B,R.max_code);Ha(O,S.max_code);ya(M);for(d=18;3<=d&&0==L[za[d]].dl;d--);aa+=3*(d+1)+14;b=aa+3+7>>3;c=ka+3+7>>3;c<=b&&(b=c);if(e+4<=b&&0<=y)for(Q(0+a,3),Ja(),na(e),na(~e),d=0;d<e;d++)ma(q[y+d]);else if(c==b)Q(2+a,3),Ka(P,V);else{Q(4+a,3);e=R.max_code+1;b=S.max_code+1;d+=1;Q(e-257,5);Q(b-1,5);Q(d-4,4);for(c=0;c<d;c++)Q(L[za[c]].dl,3);Ia(B,e-1);Ia(O,b-1);Ka(B,O)}Fa();0!=a&&Ja()},fa=function(a,b){l[X++]=b;0==a?B[b].fc++:(a--,B[ba[b]+256+1].fc++,O[(256>a?Z[a]:Z[256+(a>>7)])&255].fc++,t[ia++]=
a,ca|=ja);ja<<=1;0==(X&7)&&(ha[ra++]=ca,ca=0,ja=1);if(2<x&&0==(X&4095)){var c=8*X,d=w-y,e;for(e=0;30>e;e++)c+=O[e].fc*(5+ea[e]);c>>=3;if(ia<parseInt(X/2)&&c<parseInt(d/2))return!0}return 8191==X||8192==ia},Ka=function(a,b){var c,d=0,e=0,g=0,f=0,h,k;if(0!=X){do 0==(d&7)&&(f=ha[g++]),c=l[d++]&255,0==(f&1)?Y(c,a):(h=ba[c],Y(h+256+1,a),k=ua[h],0!=k&&(c-=qa[h],Q(c,k)),c=t[e++],h=(256>c?Z[c]:Z[256+(c>>7)])&255,Y(h,b),k=ea[h],0!=k&&(c-=ga[h],Q(c,k))),f>>=1;while(d<X)}Y(256,a)},Q=function(a,b){n>16-b?(D|=
a<<n,na(D),D=a>>16-n,n+=b-16):(D|=a<<n,n+=b)},Ea=function(a,b){var c=0;do c|=a&1,a>>=1,c<<=1;while(0<--b);return c>>1},Ja=function(){8<n?na(D):0<n&&ma(D);n=D=0};a.RawDeflate||(a.RawDeflate={});a.RawDeflate.deflate=function(a,c){var e,h;la=a;sa=0;"undefined"==typeof c&&(c=6);(e=c)?1>e?e=1:9<e&&(e=9):e=6;x=e;N=p=!1;if(null==g){b=d=f=null;g=Array(8192);q=Array(65536);t=Array(8192);l=Array(32832);r=Array(65536);B=Array(573);for(e=0;573>e;e++)B[e]=new da;O=Array(61);for(e=0;61>e;e++)O[e]=new da;P=Array(288);
for(e=0;288>e;e++)P[e]=new da;V=Array(30);for(e=0;30>e;e++)V[e]=new da;L=Array(39);for(e=0;39>e;e++)L[e]=new da;R=new ta;S=new ta;M=new ta;F=Array(16);H=Array(573);E=Array(573);ba=Array(256);Z=Array(512);qa=Array(29);ga=Array(30);ha=Array(1024)}for(var k=Array(1024),m=[];0<(e=Na(k,0,k.length));){var n=Array(e);for(h=0;h<e;h++)n[h]=String.fromCharCode(k[h]);m[m.length]=n.join("")}la=null;return m.join("")}})(this);
(function(a){if(!a.Base64){var b;"undefined"!==typeof module&&module.exports&&(b=require("buffer").Buffer);var d=function(a){for(var b={},d=0,f=a.length;d<f;d++)b[a.charAt(d)]=d;return b}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),f=String.fromCharCode,p=function(a){if(2>a.length){var b=a.charCodeAt(0);return 128>b?a:2048>b?f(192|b>>>6)+f(128|b&63):f(224|b>>>12&15)+f(128|b>>>6&63)+f(128|b&63)}b=65536+1024*(a.charCodeAt(0)-55296)+(a.charCodeAt(1)-56320);return f(240|b>>>18&
7)+f(128|b>>>12&63)+f(128|b>>>6&63)+f(128|b&63)},g=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,k=function(a){return a.replace(g,p)},m=function(a){var b=[0,2,1][a.length%3];a=a.charCodeAt(0)<<16|(1<a.length?a.charCodeAt(1):0)<<8|(2<a.length?a.charCodeAt(2):0);return["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>12&63),2<=b?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>
6&63),1<=b?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a&63)].join("")},v=a.btoa||function(a){return a.replace(/[\s\S]{1,3}/g,m)},q=b?function(a){return(new b(a)).toString("base64")}:function(a){return v(k(a))},t=function(a,b){return b?q(a).replace(/[+\/]/g,function(a){return"+"==a?"-":"_"}).replace(/=/g,""):q(a)},l=RegExp("[\u00c0-\u00df][\u0080-\u00bf]|[\u00e0-\u00ef][\u0080-\u00bf]{2}|[\u00f0-\u00f7][\u0080-\u00bf]{3}","g"),r=function(a){switch(a.length){case 4:return a=
((7&a.charCodeAt(0))<<18|(63&a.charCodeAt(1))<<12|(63&a.charCodeAt(2))<<6|63&a.charCodeAt(3))-65536,f((a>>>10)+55296)+f((a&1023)+56320);case 3:return f((15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2));default:return f((31&a.charCodeAt(0))<<6|63&a.charCodeAt(1))}},D=function(a){return a.replace(l,r)},n=function(a){var b=a.length,e=b%4;a=(0<b?d[a.charAt(0)]<<18:0)|(1<b?d[a.charAt(1)]<<12:0)|(2<b?d[a.charAt(2)]<<6:0)|(3<b?d[a.charAt(3)]:0);a=[f(a>>>16),f(a>>>8&255),f(a&255)];a.length-=
[0,0,2,1][e];return a.join("")},y=a.atob||function(a){return a.replace(/[\s\S]{1,4}/g,n)},G=b?function(a){return(new b(a,"base64")).toString()}:function(a){return D(y(a))},I=function(a){return G(a.replace(/[-_]/g,function(a){return"-"==a?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};a.Base64={VERSION:"2.1.1",atob:y,btoa:v,fromBase64:I,toBase64:t,utob:k,encode:t,encodeURI:function(a){return t(a,!0)},btou:D,decode:I};if("function"===typeof Object.defineProperty){var K=function(a){return{value:a,enumerable:!1,
writable:!0,configurable:!0}};a.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",K(function(){return I(this)}));Object.defineProperty(String.prototype,"toBase64",K(function(a){return t(this,a)}));Object.defineProperty(String.prototype,"toBase64URI",K(function(){return t(this,!0)}))}}}})(this);function importSTL(a,b){for(var d=!0,f=0;f<a.length;f++)if(0==a[f].charCodeAt(0)){d=!1;break}console.log("STL file is ascii: ",d);return d?importAsciiSTL(a,b):importBinarySTL(a,b)}
function importBinarySTL(a,b){var d=[],f=new BinaryReader(a);f.seek(80);for(var p=f.readUInt32(),g=[1E4,1E4,1E4],k=[-1E4,-1E4,-1E4],m=0;m<p;m++){f.readFloat();f.readFloat();f.readFloat();var v=[];v.push(f.readFloat());v.push(f.readFloat());v.push(f.readFloat());var q=[];q.push(f.readFloat());q.push(f.readFloat());q.push(f.readFloat());var t=[];t.push(f.readFloat());t.push(f.readFloat());t.push(f.readFloat());for(var l=0,r=0;3>r;r++)isNaN(v[r])&&l++,isNaN(q[r])&&l++,isNaN(t[r])&&l++;0<l&&console.log("this many bad vertices: ",
l);f.readUInt16();if(!l)for(d.push(v),d.push(q),d.push(t),r=0;3>r;r++)g[r]=Math.min(g[r],v[r]),g[r]=Math.min(g[r],q[r]),g[r]=Math.min(g[r],t[r]),k[r]=Math.max(k[r],v[r]),k[r]=Math.max(k[r],q[r]),k[r]=Math.max(k[r],t[r])}l&&console.log("WARNING: import errors: expect some missing or bad triangles\n");f=[Math.round(k[0]-(k[0]-g[0])/2),Math.round(k[1]-(k[1]-g[1])/2),Math.round(k[2]-(k[2]-g[2])/2)];return[vt2csg(d),f]}
function importAsciiSTL(a,b){for(var d="",f=[],p=0,g=0,k=[1E4,1E4,1E4],m=[-1E4,-1E4,-1E4],v=a.split("\n"),q=0;q<v.length;q++)if(!v[q].match(/facet/)&&!v[q].match(/endloop/))if(v[q].match(/outer/))var p=g=0,t=[[],[],[]];else if(v[q].match(/vertex/)){v[q]=v[q].replace(/^\s+|\s+$/g,"");var l=v[q].split(" ");t[g].push(parseFloat(l[1]));t[g].push(parseFloat(l[2]));t[g].push(parseFloat(l[3]));isNaN(t[g][0])&&p++;isNaN(t[g][1])&&p++;isNaN(t[g][2])&&p++;0<p&&(console.log("this many bad vertices: ",p),console.log("things are:",
l));if(!p&&3==++g)for(f.push(t[0]),f.push(t[1]),f.push(t[2]),l=0;3>l;l++)k[l]=Math.min(k[l],t[0][l]),k[l]=Math.min(k[l],t[1][l]),k[l]=Math.min(k[l],t[2][l]),m[l]=Math.max(m[l],t[0][l]),m[l]=Math.max(m[l],t[1][l]),m[l]=Math.max(m[l],t[2][l])}p=[Math.round(m[0]-(m[0]-k[0])/2),Math.round(m[1]-(m[1]-k[1])/2),Math.round(m[2]-(m[2]-k[2])/2)];d+=vt2csg(f);return[d,p]}
function vt2csg(a){var b;b="CSG.fromPolygons([";for(var d=0;d<a.length/3;d++){b+="new CSG.Polygon([";for(var f=0;3>f;f++)b+="new CSG.Vertex(new CSG.Vector3D([",b+=a[3*d+f]+"]))",2>f&&(b+=",");b+="])";d<a.length/3-1&&(b+=",")}return b+"])"}var BinaryReader=function(a){this._buffer=a;this._pos=0};
BinaryReader.prototype={readInt8:function(){return this._decodeInt(8,!0)},readUInt8:function(){return this._decodeInt(8,!1)},readInt16:function(){return this._decodeInt(16,!0)},readUInt16:function(){return this._decodeInt(16,!1)},readInt32:function(){return this._decodeInt(32,!0)},readUInt32:function(){return this._decodeInt(32,!1)},readFloat:function(){return this._decodeFloat(23,8)},readDouble:function(){return this._decodeFloat(52,11)},readChar:function(){return this.readString(1)},readString:function(a){this._checkSize(8*
a);var b=this._buffer.substr(this._pos,a);this._pos+=a;return b},seek:function(a){this._pos=a;this._checkSize(0)},getPosition:function(){return this._pos},getSize:function(){return this._buffer.length},_decodeFloat:function(a,b){var d=a+b+1,f=d>>3;this._checkSize(d);var d=Math.pow(2,b-1)-1,p=this._readBits(a+b,1,f),g=this._readBits(a,b,f),k=0,m=2,v=0;do for(var q=this._readByte(++v,f),t=a%8||8,l=1<<t;l>>=1;)q&l&&(k+=1/m),m*=2;while(a-=t);this._pos+=f;return g==(d<<1)+1?k?NaN:p?-Infinity:Infinity:
(1+-2*p)*(g||k?g?Math.pow(2,g-d)*(1+k):Math.pow(2,-d+1)*k:0)},_decodeInt:function(a,b){var d=this._readBits(0,a,a/8),f=Math.pow(2,a);this._pos+=a/8;return b&&d>=f/2?d-f:d},_shl:function(a,b){for(++b;--b;a=1073741824==((a%=2147483648)&1073741824)?2*a:2*(a-1073741824)+2147483648);return a},_readByte:function(a,b){return this._buffer.charCodeAt(this._pos+b-a-1)&255},_readBits:function(a,b,d){var f=(a+b)%8,p=a%8,g=d-(a>>3)-1;a=d+(-(a+b)>>3);var k=g-a;b=this._readByte(g,d)>>p&(1<<(k?8-p:b))-1;for(k&&f&&
(b+=(this._readByte(a++,d)&(1<<f)-1)<<(k--<<3)-p);k;)b+=this._shl(this._readByte(a++,d),(k--<<3)-p);return b},_checkSize:function(a){}};